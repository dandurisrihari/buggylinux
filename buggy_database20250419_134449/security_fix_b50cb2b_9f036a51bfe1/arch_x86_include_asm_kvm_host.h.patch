commit b50cb2b1555d8714e12a566b9b49fcac56a04a3f
Author: Sean Christopherson <seanjc@google.com>
Date:   Mon Sep 30 22:00:44 2024 -0700

    KVM: x86: Use a dedicated flow for queueing re-injected exceptions
    
    Open code the filling of vcpu->arch.exception in kvm_requeue_exception()
    instead of bouncing through kvm_multiple_exception(), as re-injection
    doesn't actually share that much code with "normal" injection, e.g. the
    VM-Exit interception check, payload delivery, and nested exception code
    is all bypassed as those flows only apply during initial injection.
    
    When FRED comes along, the special casing will only get worse, as FRED
    explicitly tracks nested exceptions and essentially delivers the payload
    on the stack frame, i.e. re-injection will need more inputs, and normal
    injection will have yet more code that needs to be bypassed when KVM is
    re-injecting an exception.
    
    No functional change intended.
    
    Signed-off-by: Xin Li (Intel) <xin@zytor.com>
    Tested-by: Shan Kang <shan.kang@intel.com>
    Link: https://lore.kernel.org/r/20241001050110.3643764-2-xin@zytor.com
    Signed-off-by: Sean Christopherson <seanjc@google.com>

diff --git a/arch/x86/include/asm/kvm_host.h b/arch/x86/include/asm/kvm_host.h
index fef8f07cdc82..97978ca62b7c 100644
--- a/arch/x86/include/asm/kvm_host.h
+++ b/arch/x86/include/asm/kvm_host.h
@@ -2161,8 +2161,8 @@ int kvm_emulate_rdpmc(struct kvm_vcpu *vcpu);
 void kvm_queue_exception(struct kvm_vcpu *vcpu, unsigned nr);
 void kvm_queue_exception_e(struct kvm_vcpu *vcpu, unsigned nr, u32 error_code);
 void kvm_queue_exception_p(struct kvm_vcpu *vcpu, unsigned nr, unsigned long payload);
-void kvm_requeue_exception(struct kvm_vcpu *vcpu, unsigned nr);
-void kvm_requeue_exception_e(struct kvm_vcpu *vcpu, unsigned nr, u32 error_code);
+void kvm_requeue_exception(struct kvm_vcpu *vcpu, unsigned int nr,
+			   bool has_error_code, u32 error_code);
 void kvm_inject_page_fault(struct kvm_vcpu *vcpu, struct x86_exception *fault);
 void kvm_inject_emulated_page_fault(struct kvm_vcpu *vcpu,
 				    struct x86_exception *fault);