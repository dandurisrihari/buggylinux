Commit Hash: 789c1093f02c436b320d78a739f9610c8271cb73
Subject: rtc: class: don't call cdev_device_del() when cdev_device_add() failed


Security Keywords:
- injection

Full commit message:
rtc: class: don't call cdev_device_del() when cdev_device_add() failed

I got a null-ptr-deref report when doing fault injection test:

general protection fault, probably for non-canonical address 0xdffffc0000000022: 0000 [#1] SMP KASAN PTI
KASAN: null-ptr-deref in range [0x0000000000000110-0x0000000000000117]
RIP: 0010:device_del+0x132/0xdc0
Call Trace:
 cdev_device_del+0x1a/0x80
 devm_rtc_unregister_device+0x37/0x80
 release_nodes+0xc3/0x3b0

If cdev_device_add() fails, 'dev->p' is not set, it causes
null-ptr-deref when calling cdev_device_del(). Registering
character device is optional, we don't return error code
here, so introduce a new flag 'RTC_NO_CDEV' to indicate
if it has character device, cdev_device_del() is called
when this bit is not set.

Reported-by: Hulk Robot <hulkci@huawei.com>
Signed-off-by: Yang Yingliang <yangyingliang@huawei.com>
Signed-off-by: Alexandre Belloni <alexandre.belloni@bootlin.com>
Link: https://lore.kernel.org/r/20211011132114.3663509-1-yangyingliang@huawei.com

Metadata:
Author: Yang Yingliang <yangyingliang@huawei.com>
Author Date: Mon Oct 11 21:21:14 2021 +0800
Committer: Alexandre Belloni <alexandre.belloni@bootlin.com>
Commit Date: Fri Oct 15 21:05:33 2021 +0200

Files Changed: 2
Lines Added: 7
Lines Removed: 3
Total Changes: 10
