{
  "hash": "edf410cb74dc612fd47ef5be319c5a0bcd6e6ccd",
  "hash_short": "edf410cb",
  "subject": "net: vmxnet3: fix possible NULL pointer dereference in vmxnet3_rq_cleanup()",
  "body": "In vmxnet3_rq_create(), when dma_alloc_coherent() fails,\nvmxnet3_rq_destroy() is called. It sets rq->rx_ring[i].base to NULL. Then\nvmxnet3_rq_create() returns an error to its callers mxnet3_rq_create_all()\n-> vmxnet3_change_mtu(). Then vmxnet3_change_mtu() calls\nvmxnet3_force_close() -> dev_close() in error handling code. And the driver\ncalls vmxnet3_close() -> vmxnet3_quiesce_dev() -> vmxnet3_rq_cleanup_all()\n-> vmxnet3_rq_cleanup(). In vmxnet3_rq_cleanup(),\nrq->rx_ring[ring_idx].base is accessed, but this variable is NULL, causing\na NULL pointer dereference.\n\nTo fix this possible bug, an if statement is added to check whether\nrq->rx_ring[0].base is NULL in vmxnet3_rq_cleanup() and exit early if so.\n\nThe error log in our fault-injection testing is shown as follows:\n\n[   65.220135] BUG: kernel NULL pointer dereference, address: 0000000000000008\n...\n[   65.222633] RIP: 0010:vmxnet3_rq_cleanup_all+0x396/0x4e0 [vmxnet3]\n...\n[   65.227977] Call Trace:\n...\n[   65.228262]  vmxnet3_quiesce_dev+0x80f/0x8a0 [vmxnet3]\n[   65.228580]  vmxnet3_close+0x2c4/0x3f0 [vmxnet3]\n[   65.228866]  __dev_close_many+0x288/0x350\n[   65.229607]  dev_close_many+0xa4/0x480\n[   65.231124]  dev_close+0x138/0x230\n[   65.231933]  vmxnet3_force_close+0x1f0/0x240 [vmxnet3]\n[   65.232248]  vmxnet3_change_mtu+0x75d/0x920 [vmxnet3]\n...\n\nFixes: d1a890fa37f27 (\"net: VMware virtual Ethernet NIC driver: vmxnet3\")\nReported-by: TOTE Robot <oslab@tsinghua.edu.cn>\nSigned-off-by: Zixuan Fu <r33s3n6@gmail.com>\nLink: https://lore.kernel.org/r/20220514050711.2636709-1-r33s3n6@gmail.com\nSigned-off-by: Paolo Abeni <pabeni@redhat.com>",
  "full_message": "net: vmxnet3: fix possible NULL pointer dereference in vmxnet3_rq_cleanup()\n\nIn vmxnet3_rq_create(), when dma_alloc_coherent() fails,\nvmxnet3_rq_destroy() is called. It sets rq->rx_ring[i].base to NULL. Then\nvmxnet3_rq_create() returns an error to its callers mxnet3_rq_create_all()\n-> vmxnet3_change_mtu(). Then vmxnet3_change_mtu() calls\nvmxnet3_force_close() -> dev_close() in error handling code. And the driver\ncalls vmxnet3_close() -> vmxnet3_quiesce_dev() -> vmxnet3_rq_cleanup_all()\n-> vmxnet3_rq_cleanup(). In vmxnet3_rq_cleanup(),\nrq->rx_ring[ring_idx].base is accessed, but this variable is NULL, causing\na NULL pointer dereference.\n\nTo fix this possible bug, an if statement is added to check whether\nrq->rx_ring[0].base is NULL in vmxnet3_rq_cleanup() and exit early if so.\n\nThe error log in our fault-injection testing is shown as follows:\n\n[   65.220135] BUG: kernel NULL pointer dereference, address: 0000000000000008\n...\n[   65.222633] RIP: 0010:vmxnet3_rq_cleanup_all+0x396/0x4e0 [vmxnet3]\n...\n[   65.227977] Call Trace:\n...\n[   65.228262]  vmxnet3_quiesce_dev+0x80f/0x8a0 [vmxnet3]\n[   65.228580]  vmxnet3_close+0x2c4/0x3f0 [vmxnet3]\n[   65.228866]  __dev_close_many+0x288/0x350\n[   65.229607]  dev_close_many+0xa4/0x480\n[   65.231124]  dev_close+0x138/0x230\n[   65.231933]  vmxnet3_force_close+0x1f0/0x240 [vmxnet3]\n[   65.232248]  vmxnet3_change_mtu+0x75d/0x920 [vmxnet3]\n...\n\nFixes: d1a890fa37f27 (\"net: VMware virtual Ethernet NIC driver: vmxnet3\")\nReported-by: TOTE Robot <oslab@tsinghua.edu.cn>\nSigned-off-by: Zixuan Fu <r33s3n6@gmail.com>\nLink: https://lore.kernel.org/r/20220514050711.2636709-1-r33s3n6@gmail.com\nSigned-off-by: Paolo Abeni <pabeni@redhat.com>",
  "author_name": "Zixuan Fu",
  "author_email": "r33s3n6@gmail.com",
  "author_date": "Sat May 14 13:07:11 2022 +0800",
  "author_date_iso": "2022-05-14T13:07:11+08:00",
  "committer_name": "Paolo Abeni",
  "committer_email": "pabeni@redhat.com",
  "committer_date": "Tue May 17 12:03:52 2022 +0200",
  "committer_date_iso": "2022-05-17T12:03:52+02:00",
  "files_changed": [
    "drivers/net/vmxnet3/vmxnet3_drv.c"
  ],
  "files_changed_count": 1,
  "stats": [
    {
      "file": "drivers/net/vmxnet3/vmxnet3_drv.c",
      "insertions": 4,
      "deletions": 0
    }
  ],
  "total_insertions": 4,
  "total_deletions": 0,
  "total_changes": 4,
  "parents": [
    "9e7fef9521e73ca8afd7da9e58c14654b02dfad8"
  ],
  "branches": [
    "* development",
    "remotes/origin/HEAD -> origin/master",
    "remotes/origin/master"
  ],
  "tags": [],
  "is_merge": false,
  "security_info": {
    "cve_ids": [],
    "security_keywords": [
      "injection"
    ]
  },
  "fix_type": "security",
  "file_results": [
    {
      "file": "drivers/net/vmxnet3/vmxnet3_drv.c",
      "pre_version": true,
      "post_version": true,
      "patch": true
    }
  ]
}