{
  "hash": "c03a0fd0b609e2f5c669c2b7f27c8e1928e9196e",
  "hash_short": "c03a0fd0",
  "subject": "kobject: Don't trigger kobject_uevent(KOBJ_REMOVE) twice.",
  "body": "syzbot is hitting use-after-free bug in uinput module [1]. This is because\nkobject_uevent(KOBJ_REMOVE) is called again due to commit 0f4dafc0563c6c49\n(\"Kobject: auto-cleanup on final unref\") after memory allocation fault\ninjection made kobject_uevent(KOBJ_REMOVE) from device_del() from\ninput_unregister_device() fail, while uinput_destroy_device() is expecting\nthat kobject_uevent(KOBJ_REMOVE) is not called after device_del() from\ninput_unregister_device() completed.\n\nThat commit intended to catch cases where nobody even attempted to send\n\"remove\" uevents. But there is no guarantee that an event will ultimately\nbe sent. We are at the point of no return as far as the rest of the kernel\nis concerned; there are no repeats or do-overs.\n\nAlso, it is not clear whether some subsystem depends on that commit.\nIf no subsystem depends on that commit, it will be better to remove\nthe state_{add,remove}_uevent_sent logic. But we don't want to risk\na regression (in a patch which will be backported) by trying to remove\nthat logic. Therefore, as a first step, let's avoid the use-after-free bug\nby making sure that kobject_uevent(KOBJ_REMOVE) won't be triggered twice.\n\n[1] https://syzkaller.appspot.com/bug?id=8b17c134fe938bbddd75a45afaa9e68af43a362d\n\nReported-by: syzbot <syzbot+f648cfb7e0b52bf7ae32@syzkaller.appspotmail.com>\nAnalyzed-by: Dmitry Torokhov <dmitry.torokhov@gmail.com>\nFixes: 0f4dafc0563c6c49 (\"Kobject: auto-cleanup on final unref\")\nCc: Kay Sievers <kay@vrfy.org>\nSigned-off-by: Tetsuo Handa <penguin-kernel@I-love.SAKURA.ne.jp>\nSigned-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>",
  "full_message": "kobject: Don't trigger kobject_uevent(KOBJ_REMOVE) twice.\n\nsyzbot is hitting use-after-free bug in uinput module [1]. This is because\nkobject_uevent(KOBJ_REMOVE) is called again due to commit 0f4dafc0563c6c49\n(\"Kobject: auto-cleanup on final unref\") after memory allocation fault\ninjection made kobject_uevent(KOBJ_REMOVE) from device_del() from\ninput_unregister_device() fail, while uinput_destroy_device() is expecting\nthat kobject_uevent(KOBJ_REMOVE) is not called after device_del() from\ninput_unregister_device() completed.\n\nThat commit intended to catch cases where nobody even attempted to send\n\"remove\" uevents. But there is no guarantee that an event will ultimately\nbe sent. We are at the point of no return as far as the rest of the kernel\nis concerned; there are no repeats or do-overs.\n\nAlso, it is not clear whether some subsystem depends on that commit.\nIf no subsystem depends on that commit, it will be better to remove\nthe state_{add,remove}_uevent_sent logic. But we don't want to risk\na regression (in a patch which will be backported) by trying to remove\nthat logic. Therefore, as a first step, let's avoid the use-after-free bug\nby making sure that kobject_uevent(KOBJ_REMOVE) won't be triggered twice.\n\n[1] https://syzkaller.appspot.com/bug?id=8b17c134fe938bbddd75a45afaa9e68af43a362d\n\nReported-by: syzbot <syzbot+f648cfb7e0b52bf7ae32@syzkaller.appspotmail.com>\nAnalyzed-by: Dmitry Torokhov <dmitry.torokhov@gmail.com>\nFixes: 0f4dafc0563c6c49 (\"Kobject: auto-cleanup on final unref\")\nCc: Kay Sievers <kay@vrfy.org>\nSigned-off-by: Tetsuo Handa <penguin-kernel@I-love.SAKURA.ne.jp>\nSigned-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>",
  "author_name": "Tetsuo Handa",
  "author_email": "penguin-kernel@I-love.SAKURA.ne.jp",
  "author_date": "Sun Mar 17 14:02:31 2019 +0900",
  "author_date_iso": "2019-03-17T14:02:31+09:00",
  "committer_name": "Greg Kroah-Hartman",
  "committer_email": "gregkh@linuxfoundation.org",
  "committer_date": "Mon Apr 1 07:37:12 2019 +0200",
  "committer_date_iso": "2019-04-01T07:37:12+02:00",
  "files_changed": [
    "lib/kobject_uevent.c"
  ],
  "files_changed_count": 1,
  "stats": [
    {
      "file": "lib/kobject_uevent.c",
      "insertions": 7,
      "deletions": 4
    }
  ],
  "total_insertions": 7,
  "total_deletions": 4,
  "total_changes": 11,
  "parents": [
    "1be01d4a57142ded23bdb9e0c8d9369e693b26cc"
  ],
  "branches": [
    "* development",
    "master",
    "remotes/origin/HEAD -> origin/master",
    "remotes/origin/master"
  ],
  "tags": [
    "v5.2",
    "v5.2-rc1",
    "v5.2-rc2",
    "v5.2-rc3",
    "v5.2-rc4",
    "v5.2-rc5",
    "v5.2-rc6",
    "v5.2-rc7",
    "v5.3",
    "v5.3-rc1"
  ],
  "is_merge": false,
  "security_info": {
    "cve_ids": [],
    "security_keywords": [
      "injection"
    ]
  },
  "fix_type": "security",
  "file_results": [
    {
      "file": "lib/kobject_uevent.c",
      "pre_version": false,
      "post_version": true,
      "patch": true
    }
  ]
}