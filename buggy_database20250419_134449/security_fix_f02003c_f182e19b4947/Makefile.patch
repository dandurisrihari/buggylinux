commit f02003c860d921171be4a27e2893766eb3bc6871
Author: Kees Cook <kees@kernel.org>
Date:   Tue Sep 14 12:49:03 2021 -0700

    hardening: Avoid harmless Clang option under CONFIG_INIT_STACK_ALL_ZERO
    
    Currently under Clang, CC_HAS_AUTO_VAR_INIT_ZERO requires an extra
    -enable flag compared to CC_HAS_AUTO_VAR_INIT_PATTERN. GCC 12[1] will
    not, and will happily ignore the Clang-specific flag. However, its
    presence on the command-line is both cumbersome and confusing. Due to
    GCC's tolerant behavior, though, we can continue to use a single Kconfig
    cc-option test for the feature on both compilers, but then drop the
    Clang-specific option in the Makefile.
    
    In other words, this patch does not change anything other than making the
    compiler command line shorter once GCC supports -ftrivial-auto-var-init=zero.
    
    [1] https://gcc.gnu.org/git/?p=gcc.git;a=commitdiff;h=a25e0b5e6ac8a77a71c229e0a7b744603365b0e9
    
    Cc: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
    Cc: Masahiro Yamada <masahiroy@kernel.org>
    Cc: llvm@lists.linux.dev
    Fixes: dcb7c0b9461c ("hardening: Clarify Kconfig text for auto-var-init")
    Suggested-by: Will Deacon <will@kernel.org>
    Link: https://lore.kernel.org/lkml/20210914102837.6172-1-will@kernel.org/
    Reviewed-by: Nick Desaulniers <ndesaulniers@google.com>
    Reviewed-by: Nathan Chancellor <nathan@kernel.org>
    Acked-by: Will Deacon <will@kernel.org>
    Signed-off-by: Kees Cook <keescook@chromium.org>

diff --git a/Makefile b/Makefile
index 5e7c1d854441..e20baaa838b1 100644
--- a/Makefile
+++ b/Makefile
@@ -831,12 +831,12 @@ endif
 
 # Initialize all stack variables with a zero value.
 ifdef CONFIG_INIT_STACK_ALL_ZERO
-# Future support for zero initialization is still being debated, see
-# https://bugs.llvm.org/show_bug.cgi?id=45497. These flags are subject to being
-# renamed or dropped.
 KBUILD_CFLAGS	+= -ftrivial-auto-var-init=zero
+ifdef CONFIG_CC_IS_CLANG
+# https://bugs.llvm.org/show_bug.cgi?id=45497
 KBUILD_CFLAGS	+= -enable-trivial-auto-var-init-zero-knowing-it-will-be-removed-from-clang
 endif
+endif
 
 # While VLAs have been removed, GCC produces unreachable stack probes
 # for the randomize_kstack_offset feature. Disable it for all compilers.