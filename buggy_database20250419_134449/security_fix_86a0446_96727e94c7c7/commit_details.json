{
  "hash": "86a04461a99fb857bd7d7f87b234cae27df07f8a",
  "hash_short": "86a04461",
  "subject": "perf/x86: Revamp PEBS event selection",
  "body": "The basic idea is that it does not make sense to list all PEBS\nevents individually. The list is very long, sometimes outdated\nand the hardware doesn't need it. If an event does not support\nPEBS it will just not count, there is no security issue.\n\nWe need to only list events that something special, like\nsupporting load or store addresses.\n\nThis vastly simplifies the PEBS event selection. It also\nspeeds up the scheduling because the scheduler doesn't\nhave to walk as many constraints.\n\nBugs fixed:\n\n - We do not allow setting forbidden flags with PEBS anymore\n   (SDM 18.9.4), except for the special cycle event.\n   This is done using a new constraint macro that also\n   matches on the event flags.\n\n - Correct DataLA and load/store/na flags reporting on Haswell\n   [Requires a followon patch]\n\n - We did not allow all PEBS events on Haswell:\n   We were missing some valid subevents in d1-d2 (MEM_LOAD_UOPS_RETIRED.*,\n   MEM_LOAD_UOPS_RETIRED_L3_HIT_RETIRED.*)\n\nThis includes the changes proposed by Stephane earlier and obsoletes\nhis patchkit (except for some changes on pre Sandy Bridge/Silvermont\nCPUs)\n\nI only did Sandy Bridge and Silvermont and later so far, mostly because these\nare the parts I could directly confirm the hardware behavior with hardware\narchitects. Also I do not believe the older CPUs have any\nmissing events in their PEBS list, so there's no pressing\nneed to change them.\n\nI did not implement the flag proposed by Peter to allow\nsetting forbidden flags. If really needed this could\nbe implemented on to of this patch.\n\nv2: Fix broken store events on SNB/IVB (Stephane Eranian)\nv3: More fixes. Rename some arguments (Stephane Eranian)\nv4: List most Haswell events individually again to report\nmemory operation type correctly.\nAdd new flags to describe load/store/na for datala.\nUpdate description.\n\nSigned-off-by: Andi Kleen <ak@linux.intel.com>\nReviewed-by: Stephane Eranian <eranian@google.com>\nSigned-off-by: Peter Zijlstra <peterz@infradead.org>\nLink: http://lkml.kernel.org/r/1407785233-32193-2-git-send-email-eranian@google.com\nCc: Arnaldo Carvalho de Melo <acme@kernel.org>\nCc: Kan Liang <kan.liang@intel.com>\nCc: Linus Torvalds <torvalds@linux-foundation.org>\nCc: Maria Dimakopoulou <maria.n.dimakopoulou@gmail.com>\nCc: Mark Davies <junk@eslaf.co.uk>\nCc: Paul Mackerras <paulus@samba.org>\nCc: Stephane Eranian <eranian@google.com>\nCc: Yan, Zheng <zheng.z.yan@intel.com>\nSigned-off-by: Ingo Molnar <mingo@kernel.org>",
  "full_message": "perf/x86: Revamp PEBS event selection\n\nThe basic idea is that it does not make sense to list all PEBS\nevents individually. The list is very long, sometimes outdated\nand the hardware doesn't need it. If an event does not support\nPEBS it will just not count, there is no security issue.\n\nWe need to only list events that something special, like\nsupporting load or store addresses.\n\nThis vastly simplifies the PEBS event selection. It also\nspeeds up the scheduling because the scheduler doesn't\nhave to walk as many constraints.\n\nBugs fixed:\n\n - We do not allow setting forbidden flags with PEBS anymore\n   (SDM 18.9.4), except for the special cycle event.\n   This is done using a new constraint macro that also\n   matches on the event flags.\n\n - Correct DataLA and load/store/na flags reporting on Haswell\n   [Requires a followon patch]\n\n - We did not allow all PEBS events on Haswell:\n   We were missing some valid subevents in d1-d2 (MEM_LOAD_UOPS_RETIRED.*,\n   MEM_LOAD_UOPS_RETIRED_L3_HIT_RETIRED.*)\n\nThis includes the changes proposed by Stephane earlier and obsoletes\nhis patchkit (except for some changes on pre Sandy Bridge/Silvermont\nCPUs)\n\nI only did Sandy Bridge and Silvermont and later so far, mostly because these\nare the parts I could directly confirm the hardware behavior with hardware\narchitects. Also I do not believe the older CPUs have any\nmissing events in their PEBS list, so there's no pressing\nneed to change them.\n\nI did not implement the flag proposed by Peter to allow\nsetting forbidden flags. If really needed this could\nbe implemented on to of this patch.\n\nv2: Fix broken store events on SNB/IVB (Stephane Eranian)\nv3: More fixes. Rename some arguments (Stephane Eranian)\nv4: List most Haswell events individually again to report\nmemory operation type correctly.\nAdd new flags to describe load/store/na for datala.\nUpdate description.\n\nSigned-off-by: Andi Kleen <ak@linux.intel.com>\nReviewed-by: Stephane Eranian <eranian@google.com>\nSigned-off-by: Peter Zijlstra <peterz@infradead.org>\nLink: http://lkml.kernel.org/r/1407785233-32193-2-git-send-email-eranian@google.com\nCc: Arnaldo Carvalho de Melo <acme@kernel.org>\nCc: Kan Liang <kan.liang@intel.com>\nCc: Linus Torvalds <torvalds@linux-foundation.org>\nCc: Maria Dimakopoulou <maria.n.dimakopoulou@gmail.com>\nCc: Mark Davies <junk@eslaf.co.uk>\nCc: Paul Mackerras <paulus@samba.org>\nCc: Stephane Eranian <eranian@google.com>\nCc: Yan, Zheng <zheng.z.yan@intel.com>\nSigned-off-by: Ingo Molnar <mingo@kernel.org>",
  "author_name": "Andi Kleen",
  "author_email": "ak@linux.intel.com",
  "author_date": "Mon Aug 11 21:27:10 2014 +0200",
  "author_date_iso": "2014-08-11T21:27:10+02:00",
  "committer_name": "Ingo Molnar",
  "committer_email": "mingo@kernel.org",
  "committer_date": "Wed Aug 13 07:51:13 2014 +0200",
  "committer_date_iso": "2014-08-13T07:51:13+02:00",
  "files_changed": [
    "arch/x86/include/asm/perf_event.h",
    "arch/x86/kernel/cpu/perf_event.h",
    "arch/x86/kernel/cpu/perf_event_intel_ds.c"
  ],
  "files_changed_count": 3,
  "stats": [
    {
      "file": "arch/x86/include/asm/perf_event.h",
      "insertions": 8,
      "deletions": 0
    },
    {
      "file": "arch/x86/kernel/cpu/perf_event.h",
      "insertions": 42,
      "deletions": 6
    },
    {
      "file": "arch/x86/kernel/cpu/perf_event_intel_ds.c",
      "insertions": 35,
      "deletions": 72
    }
  ],
  "total_insertions": 85,
  "total_deletions": 78,
  "total_changes": 163,
  "parents": [
    "03de874aa76ac0adcf6f56ebf3de623d09a5dde3"
  ],
  "branches": [
    "* development",
    "master",
    "remotes/origin/HEAD -> origin/master",
    "remotes/origin/master"
  ],
  "tags": [
    "v3.18",
    "v3.18-rc1",
    "v3.18-rc2",
    "v3.18-rc3",
    "v3.18-rc4",
    "v3.18-rc5",
    "v3.18-rc6",
    "v3.18-rc7",
    "v3.19",
    "v3.19-rc1"
  ],
  "is_merge": false,
  "security_info": {
    "cve_ids": [],
    "security_keywords": [
      "security issue"
    ]
  },
  "fix_type": "security",
  "file_results": [
    {
      "file": "arch/x86/include/asm/perf_event.h",
      "pre_version": false,
      "post_version": true,
      "patch": true
    },
    {
      "file": "arch/x86/kernel/cpu/perf_event.h",
      "pre_version": false,
      "post_version": true,
      "patch": true
    },
    {
      "file": "arch/x86/kernel/cpu/perf_event_intel_ds.c",
      "pre_version": false,
      "post_version": true,
      "patch": true
    }
  ]
}