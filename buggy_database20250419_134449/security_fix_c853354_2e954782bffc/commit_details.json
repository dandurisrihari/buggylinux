{
  "hash": "c853354429f7ec88f9cdde4e46e69a2c0e3c8310",
  "hash_short": "c8533544",
  "subject": "KVM: LAPIC: Fix lapic timer injection delay",
  "body": "If the TSC deadline timer is programmed really close to the deadline or\neven in the past, the computation in vmx_set_hv_timer will program the\nabsolute target tsc value to vmcs preemption timer field w/ delta == 0,\nthen plays a vmentry and an upcoming vmx preemption timer fire vmexit\ndance, the lapic timer injection is delayed due to this duration. Actually\nthe lapic timer which is emulated by hrtimer can handle this correctly.\n\nThis patch fixes it by firing the lapic timer and injecting a timer interrupt\nimmediately during the next vmentry if the TSC deadline timer is programmed\nreally close to the deadline or even in the past. This saves ~300 cycles on\nthe tsc_deadline_timer test of apic.flat.\n\nCc: Paolo Bonzini <pbonzini@redhat.com>\nCc: Radim Kr\u010dm\u00e1\u0159 <rkrcmar@redhat.com>\nSigned-off-by: Wanpeng Li <wanpeng.li@hotmail.com>\nSigned-off-by: Paolo Bonzini <pbonzini@redhat.com>",
  "full_message": "KVM: LAPIC: Fix lapic timer injection delay\n\nIf the TSC deadline timer is programmed really close to the deadline or\neven in the past, the computation in vmx_set_hv_timer will program the\nabsolute target tsc value to vmcs preemption timer field w/ delta == 0,\nthen plays a vmentry and an upcoming vmx preemption timer fire vmexit\ndance, the lapic timer injection is delayed due to this duration. Actually\nthe lapic timer which is emulated by hrtimer can handle this correctly.\n\nThis patch fixes it by firing the lapic timer and injecting a timer interrupt\nimmediately during the next vmentry if the TSC deadline timer is programmed\nreally close to the deadline or even in the past. This saves ~300 cycles on\nthe tsc_deadline_timer test of apic.flat.\n\nCc: Paolo Bonzini <pbonzini@redhat.com>\nCc: Radim Kr\u010dm\u00e1\u0159 <rkrcmar@redhat.com>\nSigned-off-by: Wanpeng Li <wanpeng.li@hotmail.com>\nSigned-off-by: Paolo Bonzini <pbonzini@redhat.com>",
  "author_name": "Wanpeng Li",
  "author_email": "wanpeng.li@hotmail.com",
  "author_date": "Thu Jun 29 06:28:09 2017 -0700",
  "author_date_iso": "2017-06-29T06:28:09-07:00",
  "committer_name": "Paolo Bonzini",
  "committer_email": "pbonzini@redhat.com",
  "committer_date": "Thu Jun 29 18:21:13 2017 +0200",
  "committer_date_iso": "2017-06-29T18:21:13+02:00",
  "files_changed": [
    "arch/x86/kvm/lapic.c",
    "arch/x86/kvm/vmx.c"
  ],
  "files_changed_count": 2,
  "stats": [
    {
      "file": "arch/x86/kvm/lapic.c",
      "insertions": 4,
      "deletions": 1
    },
    {
      "file": "arch/x86/kvm/vmx.c",
      "insertions": 2,
      "deletions": 1
    }
  ],
  "total_insertions": 6,
  "total_deletions": 2,
  "total_changes": 8,
  "parents": [
    "a749e247f745f609fd1106f1400ea063fe9b18ba"
  ],
  "branches": [
    "* development",
    "master",
    "remotes/origin/HEAD -> origin/master",
    "remotes/origin/master"
  ],
  "tags": [
    "v4.13",
    "v4.13-rc1",
    "v4.13-rc2",
    "v4.13-rc3",
    "v4.13-rc4",
    "v4.13-rc5",
    "v4.13-rc6",
    "v4.13-rc7",
    "v4.14",
    "v4.14-rc1"
  ],
  "is_merge": false,
  "security_info": {
    "cve_ids": [],
    "security_keywords": [
      "injection"
    ]
  },
  "fix_type": "security",
  "file_results": [
    {
      "file": "arch/x86/kvm/lapic.c",
      "pre_version": true,
      "post_version": true,
      "patch": true
    },
    {
      "file": "arch/x86/kvm/vmx.c",
      "pre_version": false,
      "post_version": true,
      "patch": true
    }
  ]
}