Commit Hash: c853354429f7ec88f9cdde4e46e69a2c0e3c8310
Subject: KVM: LAPIC: Fix lapic timer injection delay


Security Keywords:
- injection

Full commit message:
KVM: LAPIC: Fix lapic timer injection delay

If the TSC deadline timer is programmed really close to the deadline or
even in the past, the computation in vmx_set_hv_timer will program the
absolute target tsc value to vmcs preemption timer field w/ delta == 0,
then plays a vmentry and an upcoming vmx preemption timer fire vmexit
dance, the lapic timer injection is delayed due to this duration. Actually
the lapic timer which is emulated by hrtimer can handle this correctly.

This patch fixes it by firing the lapic timer and injecting a timer interrupt
immediately during the next vmentry if the TSC deadline timer is programmed
really close to the deadline or even in the past. This saves ~300 cycles on
the tsc_deadline_timer test of apic.flat.

Cc: Paolo Bonzini <pbonzini@redhat.com>
Cc: Radim Krčmář <rkrcmar@redhat.com>
Signed-off-by: Wanpeng Li <wanpeng.li@hotmail.com>
Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>

Metadata:
Author: Wanpeng Li <wanpeng.li@hotmail.com>
Author Date: Thu Jun 29 06:28:09 2017 -0700
Committer: Paolo Bonzini <pbonzini@redhat.com>
Commit Date: Thu Jun 29 18:21:13 2017 +0200

Files Changed: 2
Lines Added: 6
Lines Removed: 2
Total Changes: 8
