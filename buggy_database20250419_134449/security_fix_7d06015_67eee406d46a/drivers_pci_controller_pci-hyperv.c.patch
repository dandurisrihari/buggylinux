commit 7d06015d936c861160803e020f68f413b5c3cd9d
Merge: 0c86b42439b6 dea140198b84
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Fri Mar 28 19:36:53 2025 -0700

    Merge tag 'pci-v6.15-changes' of git://git.kernel.org/pub/scm/linux/kernel/git/pci/pci
    
    Pull pci updates from Bjorn Helgaas:
     "Enumeration:
    
       - Enable Configuration RRS SV, which makes device readiness visible,
         early instead of during child bus scanning (Bjorn Helgaas)
    
       - Log debug messages about reset methods being used (Bjorn Helgaas)
    
       - Avoid reset when it has been disabled via sysfs (Nishanth
         Aravamudan)
    
       - Add common pci-ep-bus.yaml schema for exporting several peripherals
         of a single PCI function via devicetree (Andrea della Porta)
    
       - Create DT nodes for PCI host bridges to enable loading device tree
         overlays to create platform devices for PCI devices that have
         several features that require multiple drivers (Herve Codina)
    
      Resource management:
    
       - Enlarge devres table[] to accommodate bridge windows, ROM, IOV
         BARs, etc., and validate BAR index in devres interfaces (Philipp
         Stanner)
    
       - Fix typo that repeatedly distributed resources to a bridge instead
         of iterating over subordinate bridges, which resulted in too little
         space to assign some BARs (Kai-Heng Feng)
    
       - Relax bridge window tail sizing for optional resources, e.g., IOV
         BARs, to avoid failures when removing and re-adding devices (Ilpo
         Järvinen)
    
       - Allow drivers to enable devices even if we haven't assigned
         optional IOV resources to them (Ilpo Järvinen)
    
       - Rework handling of optional resources (IOV BARs, ROMs) to reduce
         failures if we can't allocate them (Ilpo Järvinen)
    
       - Fix a NULL dereference in the SR-IOV VF creation error path (Shay
         Drory)
    
       - Fix s390 mmio_read/write syscalls, which didn't cause page faults
         in some cases, which broke vfio-pci lazy mapping on first access
         (Niklas Schnelle)
    
       - Add pdev->non_mappable_bars to replace CONFIG_VFIO_PCI_MMAP, which
         was disabled only for s390 (Niklas Schnelle)
    
       - Support mmap of PCI resources on s390 except for ISM devices
         (Niklas Schnelle)
    
      ASPM:
    
       - Delay pcie_link_state deallocation to avoid dangling pointers that
         cause invalid references during hot-unplug (Daniel Stodden)
    
      Power management:
    
       - Allow PCI bridges to go to D3Hot when suspending on all non-x86
         systems (Manivannan Sadhasivam)
    
      Power control:
    
       - Create pwrctrl devices in pci_scan_device() to make it more
         symmetric with pci_pwrctrl_unregister() and make pwrctrl devices
         for PCI bridges possible (Manivannan Sadhasivam)
    
       - Unregister pwrctrl devices in pci_destroy_dev() so DOE, ASPM, etc.
         can still access devices after pci_stop_dev() (Manivannan
         Sadhasivam)
    
       - If there's a pwrctrl device for a PCI device, skip scanning it
         because the pwrctrl core will rescan the bus after the device is
         powered on (Manivannan Sadhasivam)
    
       - Add a pwrctrl driver for PCI slots based on voltage regulators
         described via devicetree (Manivannan Sadhasivam)
    
      Bandwidth control:
    
       - Add set_pcie_speed.sh to TEST_PROGS to fix issue when executing the
         set_pcie_cooling_state.sh test case (Yi Lai)
    
       - Avoid a NULL pointer dereference when we run out of bus numbers to
         assign for a bridge secondary bus (Lukas Wunner)
    
      Hotplug:
    
       - Drop superfluous pci_hotplug_slot_list, try_module_get() calls, and
         NULL pointer checks (Lukas Wunner)
    
       - Drop shpchp module init/exit logging, replace shpchp dbg() with
         ctrl_dbg(), and remove unused dbg(), err(), info(), warn() wrappers
         (Ilpo Järvinen)
    
       - Drop 'shpchp_debug' module parameter in favor of standard dynamic
         debugging (Ilpo Järvinen)
    
       - Drop unused cpcihp .get_power(), .set_power() function pointers
         (Guilherme Giacomo Simoes)
    
       - Disable hotplug interrupts in portdrv only when pciehp is not
         enabled to avoid issuing two hotplug commands too close together
         (Feng Tang)
    
       - Skip pciehp 'device replaced' check if the device has been removed
         to address a deadlock when resuming after a device was removed
         during system sleep (Lukas Wunner)
    
       - Don't enable pciehp hotplug interupt when resuming in poll mode
         (Ilpo Järvinen)
    
      Virtualization:
    
       - Fix bugs in 'pci=config_acs=' kernel command line parameter (Tushar
         Dave)
    
      DOE:
    
       - Expose supported DOE features via sysfs (Alistair Francis)
    
       - Allow DOE support to be enabled even if CXL isn't enabled (Alistair
         Francis)
    
      Endpoint framework:
    
       - Convert PCI device data so pci-epf-test works correctly on
         big-endian endpoint systems (Niklas Cassel)
    
       - Add BAR_RESIZABLE type to endpoint framework and add DWC core
         support for EPF drivers to set BAR_RESIZABLE type and size (Niklas
         Cassel)
    
       - Fix pci-epf-test double free that causes an oops if the host
         reboots and PERST# deassertion restarts endpoint BAR allocation
         (Christian Bruel)
    
       - Fix endpoint BAR testing so tests can skip disabled BARs instead of
         reporting them as failures (Niklas Cassel)
    
       - Widen endpoint test BAR size variable to accommodate BARs larger
         than INT_MAX (Niklas Cassel)
    
       - Remove unused tools 'pci' build target left over after moving tests
         to tools/testing/selftests/pci_endpoint (Jianfeng Liu)
    
      Altera PCIe controller driver:
    
       - Add DT binding and driver support for Agilex family (P-Tile,
         F-Tile, R-Tile) (Matthew Gerlach and D M, Sharath Kumar)
    
      AMD MDB PCIe controller driver:
    
       - Add DT binding and driver for AMD MDB (Multimedia DMA Bridge)
         (Thippeswamy Havalige)
    
      Broadcom STB PCIe controller driver:
    
       - Add BCM2712 MSI-X DT binding and interrupt controller drivers and
         add softdep on irq_bcm2712_mip driver to ensure that it is loaded
         first (Stanimir Varbanov)
    
       - Expand inbound window map to 64GB so it can accommodate BCM2712
         (Stanimir Varbanov)
    
       - Add BCM2712 support and DT updates (Stanimir Varbanov)
    
       - Apply link speed restriction before bringing link up, not after
         (Jim Quinlan)
    
       - Update Max Link Speed in Link Capabilities via the internal
         writable register, not the read-only config register (Jim Quinlan)
    
       - Handle regulator_bulk_get() error to avoid panic when we call
         regulator_bulk_free() later (Jim Quinlan)
    
       - Disable regulators only when removing the bus immediately below a
         Root Port because we don't support regulators deeper in the
         hierarchy (Jim Quinlan)
    
       - Make const read-only arrays static (Colin Ian King)
    
      Cadence PCIe endpoint driver:
    
       - Correct MSG TLP generation so endpoints can generate INTx messages
         (Hans Zhang)
    
      Freescale i.MX6 PCIe controller driver:
    
       - Identify the second controller on i.MX8MQ based on devicetree
         'linux,pci-domain' instead of DBI 'reg' address (Richard Zhu)
    
       - Remove imx_pcie_cpu_addr_fixup() since dwc core can now derive the
         ATU input address (using parent_bus_offset) from devicetree (Frank
         Li)
    
      Freescale Layerscape PCIe controller driver:
    
       - Drop deprecated 'num-ib-windows' and 'num-ob-windows' and
         unnecessary 'status' from example (Krzysztof Kozlowski)
    
       - Correct the syscon_regmap_lookup_by_phandle_args("fsl,pcie-scfg")
         arg_count to fix probe failure on LS1043A (Ioana Ciornei)
    
      HiSilicon STB PCIe controller driver:
    
       - Call phy_exit() to clean up if histb_pcie_probe() fails (Christophe
         JAILLET)
    
      Intel Gateway PCIe controller driver:
    
       - Remove intel_pcie_cpu_addr() since dwc core can now derive the ATU
         input address (using parent_bus_offset) from devicetree (Frank Li)
    
      Intel VMD host bridge driver:
    
       - Convert vmd_dev.cfg_lock from spinlock_t to raw_spinlock_t so
         pci_ops.read() will never sleep, even on PREEMPT_RT where
         spinlock_t becomes a sleepable lock, to avoid calling a sleeping
         function from invalid context (Ryo Takakura)
    
      MediaTek PCIe Gen3 controller driver:
    
       - Remove leftover mac_reset assert for Airoha EN7581 SoC (Lorenzo
         Bianconi)
    
       - Add EN7581 PBUS controller 'mediatek,pbus-csr' DT property and
         program host bridge memory aperture to this syscon node (Lorenzo
         Bianconi)
    
      Qualcomm PCIe controller driver:
    
       - Add qcom,pcie-ipq5332 binding (Varadarajan Narayanan)
    
       - Add qcom i.MX8QM and i.MX8QXP/DXP optional DMA interrupt (Alexander
         Stein)
    
       - Add optional dma-coherent DT property for Qualcomm SA8775P (Dmitry
         Baryshkov)
    
       - Make DT iommu property required for SA8775P and prohibited for
         SDX55 (Dmitry Baryshkov)
    
       - Add DT IOMMU and DMA-related properties for Qualcomm SM8450 (Dmitry
         Baryshkov)
    
       - Add endpoint DT properties for SAR2130P and enable endpoint mode in
         driver (Dmitry Baryshkov)
    
       - Describe endpoint BAR0 and BAR2 as 64-bit only and BAR1 and BAR3 as
         RESERVED (Manivannan Sadhasivam)
    
      Rockchip DesignWare PCIe controller driver:
    
       - Describe rk3568 and rk3588 BARs as Resizable, not Fixed (Niklas
         Cassel)
    
      Synopsys DesignWare PCIe controller driver:
    
       - Add debugfs-based Silicon Debug, Error Injection, Statistical
         Counter support for DWC (Shradha Todi)
    
       - Add debugfs property to expose LTSSM status of DWC PCIe link (Hans
         Zhang)
    
       - Add Rockchip support for DWC debugfs features (Niklas Cassel)
    
       - Add dw_pcie_parent_bus_offset() to look up the parent bus address
         of a specified 'reg' property and return the offset from the CPU
         physical address (Frank Li)
    
       - Use dw_pcie_parent_bus_offset() to derive CPU -> ATU addr offset
         via 'reg[config]' for host controllers and 'reg[addr_space]' for
         endpoint controllers (Frank Li)
    
       - Apply struct dw_pcie.parent_bus_offset in ATU users to remove use
         of .cpu_addr_fixup() when programming ATU (Frank Li)
    
      TI J721E PCIe driver:
    
       - Correct the 'link down' interrupt bit for J784S4 (Siddharth
         Vadapalli)
    
      TI Keystone PCIe controller driver:
    
       - Describe AM65x BARs 2 and 5 as Resizable (not Fixed) and reduce
         alignment requirement from 1MB to 64KB (Niklas Cassel)
    
      Xilinx Versal CPM PCIe controller driver:
    
       - Free IRQ domain in probe error path to avoid leaking it
         (Thippeswamy Havalige)
    
       - Add DT .compatible "xlnx,versal-cpm5nc-host" and driver support for
         Versal Net CPM5NC Root Port controller (Thippeswamy Havalige)
    
       - Add driver support for CPM5_HOST1 (Thippeswamy Havalige)
    
      Miscellaneous:
    
       - Convert fsl,mpc83xx-pcie binding to YAML (J. Neuschäfer)
    
       - Use for_each_available_child_of_node_scoped() to simplify apple,
         kirin, mediatek, mt7621, tegra drivers (Zhang Zekun)"
    
    * tag 'pci-v6.15-changes' of git://git.kernel.org/pub/scm/linux/kernel/git/pci/pci: (197 commits)
      PCI: layerscape: Fix arg_count to syscon_regmap_lookup_by_phandle_args()
      PCI: j721e: Fix the value of .linkdown_irq_regfield for J784S4
      misc: pci_endpoint_test: Add support for PCITEST_IRQ_TYPE_AUTO
      PCI: endpoint: pci-epf-test: Expose supported IRQ types in CAPS register
      PCI: dw-rockchip: Endpoint mode cannot raise INTx interrupts
      PCI: endpoint: Add intx_capable to epc_features struct
      dt-bindings: PCI: Add common schema for devices accessible through PCI BARs
      PCI: intel-gw: Remove intel_pcie_cpu_addr()
      PCI: imx6: Remove imx_pcie_cpu_addr_fixup()
      PCI: dwc: Use parent_bus_offset to remove need for .cpu_addr_fixup()
      PCI: dwc: ep: Ensure proper iteration over outbound map windows
      PCI: dwc: ep: Use devicetree 'reg[addr_space]' to derive CPU -> ATU addr offset
      PCI: dwc: ep: Consolidate devicetree handling in dw_pcie_ep_get_resources()
      PCI: dwc: ep: Call epc_create() early in dw_pcie_ep_init()
      PCI: dwc: Use devicetree 'reg[config]' to derive CPU -> ATU addr offset
      PCI: dwc: Add dw_pcie_parent_bus_offset() checking and debug
      PCI: dwc: Add dw_pcie_parent_bus_offset()
      PCI/bwctrl: Fix NULL pointer dereference on bus number exhaustion
      PCI: xilinx-cpm: Add cpm_csr register mapping for CPM5_HOST1 variant
      PCI: brcmstb: Make const read-only arrays static
      ...