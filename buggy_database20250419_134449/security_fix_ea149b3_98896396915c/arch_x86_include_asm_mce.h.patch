commit ea149b36c7f511d17dd89fee734cb09778a91fa0
Author: Andi Kleen <ak@linux.intel.com>
Date:   Wed Apr 29 19:31:00 2009 +0200

    x86, mce: add basic error injection infrastructure
    
    Allow user programs to write mce records into /dev/mcelog. When they do
    that a fake machine check is triggered to test the machine check code.
    
    This uses the MCE MSR wrappers added earlier.
    
    The implementation is straight forward. There is a struct mce record
    per CPU and the MCE MSR accesses get data from there if there is valid
    data injected there. This allows to test the machine check code
    relatively realistically because only the lowest layer of hardware
    access is intercepted.
    
    The test suite and injector are available at
    git://git.kernel.org/pub/scm/utils/cpu/mce/mce-test.git
    git://git.kernel.org/pub/scm/utils/cpu/mce/mce-inject.git
    
    Signed-off-by: Andi Kleen <ak@linux.intel.com>
    Signed-off-by: H. Peter Anvin <hpa@zytor.com>
    Signed-off-by: Hidetoshi Seto <seto.hidetoshi@jp.fujitsu.com>
    Signed-off-by: H. Peter Anvin <hpa@zytor.com>

diff --git a/arch/x86/include/asm/mce.h b/arch/x86/include/asm/mce.h
index c3c7ee701753..e7d2372301ef 100644
--- a/arch/x86/include/asm/mce.h
+++ b/arch/x86/include/asm/mce.h
@@ -141,6 +141,9 @@ extern void machine_check_poll(enum mcp_flags flags, mce_banks_t *b);
 
 extern int mce_notify_user(void);
 
+DECLARE_PER_CPU(struct mce, injectm);
+extern struct file_operations mce_chrdev_ops;
+
 #ifdef CONFIG_X86_MCE
 extern void mcheck_init(struct cpuinfo_x86 *c);
 #else