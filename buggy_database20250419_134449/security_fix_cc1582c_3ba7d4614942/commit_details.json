{
  "hash": "cc1582c231ea041fbc68861dfaf957eaf902b829",
  "hash_short": "cc1582c2",
  "subject": "perf/core: Drop kernel samples even though :u is specified",
  "body": "When doing sampling, for example:\n\n  perf record -e cycles:u ...\n\nOn workloads that do a lot of kernel entry/exits we see kernel\nsamples, even though :u is specified. This is due to skid existing.\n\nThis might be a security issue because it can leak kernel addresses even\nthough kernel sampling support is disabled.\n\nThe patch drops the kernel samples if exclude_kernel is specified.\n\nFor example, test on Haswell desktop:\n\n  perf record -e cycles:u <mgen>\n  perf report --stdio\n\nBefore patch applied:\n\n    99.77%  mgen     mgen              [.] buf_read\n     0.20%  mgen     mgen              [.] rand_buf_init\n     0.01%  mgen     [kernel.vmlinux]  [k] apic_timer_interrupt\n     0.00%  mgen     mgen              [.] last_free_elem\n     0.00%  mgen     libc-2.23.so      [.] __random_r\n     0.00%  mgen     libc-2.23.so      [.] _int_malloc\n     0.00%  mgen     mgen              [.] rand_array_init\n     0.00%  mgen     [kernel.vmlinux]  [k] page_fault\n     0.00%  mgen     libc-2.23.so      [.] __random\n     0.00%  mgen     libc-2.23.so      [.] __strcasestr\n     0.00%  mgen     ld-2.23.so        [.] strcmp\n     0.00%  mgen     ld-2.23.so        [.] _dl_start\n     0.00%  mgen     libc-2.23.so      [.] sched_setaffinity@@GLIBC_2.3.4\n     0.00%  mgen     ld-2.23.so        [.] _start\n\nWe can see kernel symbols apic_timer_interrupt and page_fault.\n\nAfter patch applied:\n\n    99.79%  mgen     mgen           [.] buf_read\n     0.19%  mgen     mgen           [.] rand_buf_init\n     0.00%  mgen     libc-2.23.so   [.] __random_r\n     0.00%  mgen     mgen           [.] rand_array_init\n     0.00%  mgen     mgen           [.] last_free_elem\n     0.00%  mgen     libc-2.23.so   [.] vfprintf\n     0.00%  mgen     libc-2.23.so   [.] rand\n     0.00%  mgen     libc-2.23.so   [.] __random\n     0.00%  mgen     libc-2.23.so   [.] _int_malloc\n     0.00%  mgen     libc-2.23.so   [.] _IO_doallocbuf\n     0.00%  mgen     ld-2.23.so     [.] do_lookup_x\n     0.00%  mgen     ld-2.23.so     [.] open_verify.constprop.7\n     0.00%  mgen     ld-2.23.so     [.] _dl_important_hwcaps\n     0.00%  mgen     libc-2.23.so   [.] sched_setaffinity@@GLIBC_2.3.4\n     0.00%  mgen     ld-2.23.so     [.] _start\n\nThere are only userspace symbols.\n\nSigned-off-by: Jin Yao <yao.jin@linux.intel.com>\nSigned-off-by: Peter Zijlstra (Intel) <peterz@infradead.org>\nCc: <stable@vger.kernel.org>\nCc: Alexander Shishkin <alexander.shishkin@linux.intel.com>\nCc: Arnaldo Carvalho de Melo <acme@redhat.com>\nCc: Jiri Olsa <jolsa@redhat.com>\nCc: Linus Torvalds <torvalds@linux-foundation.org>\nCc: Namhyung Kim <namhyung@kernel.org>\nCc: Peter Zijlstra <peterz@infradead.org>\nCc: Stephane Eranian <eranian@google.com>\nCc: Thomas Gleixner <tglx@linutronix.de>\nCc: Vince Weaver <vincent.weaver@maine.edu>\nCc: acme@kernel.org\nCc: jolsa@kernel.org\nCc: kan.liang@intel.com\nCc: mark.rutland@arm.com\nCc: will.deacon@arm.com\nCc: yao.jin@intel.com\nLink: http://lkml.kernel.org/r/1495706947-3744-1-git-send-email-yao.jin@linux.intel.com\nSigned-off-by: Ingo Molnar <mingo@kernel.org>",
  "full_message": "perf/core: Drop kernel samples even though :u is specified\n\nWhen doing sampling, for example:\n\n  perf record -e cycles:u ...\n\nOn workloads that do a lot of kernel entry/exits we see kernel\nsamples, even though :u is specified. This is due to skid existing.\n\nThis might be a security issue because it can leak kernel addresses even\nthough kernel sampling support is disabled.\n\nThe patch drops the kernel samples if exclude_kernel is specified.\n\nFor example, test on Haswell desktop:\n\n  perf record -e cycles:u <mgen>\n  perf report --stdio\n\nBefore patch applied:\n\n    99.77%  mgen     mgen              [.] buf_read\n     0.20%  mgen     mgen              [.] rand_buf_init\n     0.01%  mgen     [kernel.vmlinux]  [k] apic_timer_interrupt\n     0.00%  mgen     mgen              [.] last_free_elem\n     0.00%  mgen     libc-2.23.so      [.] __random_r\n     0.00%  mgen     libc-2.23.so      [.] _int_malloc\n     0.00%  mgen     mgen              [.] rand_array_init\n     0.00%  mgen     [kernel.vmlinux]  [k] page_fault\n     0.00%  mgen     libc-2.23.so      [.] __random\n     0.00%  mgen     libc-2.23.so      [.] __strcasestr\n     0.00%  mgen     ld-2.23.so        [.] strcmp\n     0.00%  mgen     ld-2.23.so        [.] _dl_start\n     0.00%  mgen     libc-2.23.so      [.] sched_setaffinity@@GLIBC_2.3.4\n     0.00%  mgen     ld-2.23.so        [.] _start\n\nWe can see kernel symbols apic_timer_interrupt and page_fault.\n\nAfter patch applied:\n\n    99.79%  mgen     mgen           [.] buf_read\n     0.19%  mgen     mgen           [.] rand_buf_init\n     0.00%  mgen     libc-2.23.so   [.] __random_r\n     0.00%  mgen     mgen           [.] rand_array_init\n     0.00%  mgen     mgen           [.] last_free_elem\n     0.00%  mgen     libc-2.23.so   [.] vfprintf\n     0.00%  mgen     libc-2.23.so   [.] rand\n     0.00%  mgen     libc-2.23.so   [.] __random\n     0.00%  mgen     libc-2.23.so   [.] _int_malloc\n     0.00%  mgen     libc-2.23.so   [.] _IO_doallocbuf\n     0.00%  mgen     ld-2.23.so     [.] do_lookup_x\n     0.00%  mgen     ld-2.23.so     [.] open_verify.constprop.7\n     0.00%  mgen     ld-2.23.so     [.] _dl_important_hwcaps\n     0.00%  mgen     libc-2.23.so   [.] sched_setaffinity@@GLIBC_2.3.4\n     0.00%  mgen     ld-2.23.so     [.] _start\n\nThere are only userspace symbols.\n\nSigned-off-by: Jin Yao <yao.jin@linux.intel.com>\nSigned-off-by: Peter Zijlstra (Intel) <peterz@infradead.org>\nCc: <stable@vger.kernel.org>\nCc: Alexander Shishkin <alexander.shishkin@linux.intel.com>\nCc: Arnaldo Carvalho de Melo <acme@redhat.com>\nCc: Jiri Olsa <jolsa@redhat.com>\nCc: Linus Torvalds <torvalds@linux-foundation.org>\nCc: Namhyung Kim <namhyung@kernel.org>\nCc: Peter Zijlstra <peterz@infradead.org>\nCc: Stephane Eranian <eranian@google.com>\nCc: Thomas Gleixner <tglx@linutronix.de>\nCc: Vince Weaver <vincent.weaver@maine.edu>\nCc: acme@kernel.org\nCc: jolsa@kernel.org\nCc: kan.liang@intel.com\nCc: mark.rutland@arm.com\nCc: will.deacon@arm.com\nCc: yao.jin@intel.com\nLink: http://lkml.kernel.org/r/1495706947-3744-1-git-send-email-yao.jin@linux.intel.com\nSigned-off-by: Ingo Molnar <mingo@kernel.org>",
  "author_name": "Jin Yao",
  "author_email": "yao.jin@linux.intel.com",
  "author_date": "Thu May 25 18:09:07 2017 +0800",
  "author_date_iso": "2017-05-25T18:09:07+08:00",
  "committer_name": "Ingo Molnar",
  "committer_email": "mingo@kernel.org",
  "committer_date": "Thu Jun 8 10:11:50 2017 +0200",
  "committer_date_iso": "2017-06-08T10:11:50+02:00",
  "files_changed": [
    "kernel/events/core.c"
  ],
  "files_changed_count": 1,
  "stats": [
    {
      "file": "kernel/events/core.c",
      "insertions": 21,
      "deletions": 0
    }
  ],
  "total_insertions": 21,
  "total_deletions": 0,
  "total_changes": 21,
  "parents": [
    "3e411b0ee7c7bf0cbe2bd5961f84a02f0451ad57"
  ],
  "branches": [
    "* development",
    "master",
    "remotes/origin/HEAD -> origin/master",
    "remotes/origin/master"
  ],
  "tags": [
    "v4.12",
    "v4.12-rc5",
    "v4.12-rc6",
    "v4.12-rc7",
    "v4.13",
    "v4.13-rc1",
    "v4.13-rc2",
    "v4.13-rc3",
    "v4.13-rc4",
    "v4.13-rc5"
  ],
  "is_merge": false,
  "security_info": {
    "cve_ids": [],
    "security_keywords": [
      "security issue"
    ]
  },
  "fix_type": "security",
  "file_results": [
    {
      "file": "kernel/events/core.c",
      "pre_version": false,
      "post_version": true,
      "patch": true
    }
  ]
}