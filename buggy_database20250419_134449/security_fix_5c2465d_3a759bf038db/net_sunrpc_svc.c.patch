commit 5c2465dfd457f3015eebcc3ace50570e1d896aeb
Author: Chuck Lever <chuck.lever@oracle.com>
Date:   Thu Jul 15 15:52:12 2021 -0400

    SUNRPC: Set rq_auth_stat in the pg_authenticate() callout
    
    In a few moments, rq_auth_stat will need to be explicitly set to
    rpc_auth_ok before execution gets to the dispatcher.
    
    svc_authenticate() already sets it, but it often gets reset to
    rpc_autherr_badcred right after that call, even when authentication
    is successful. Let's ensure that the pg_authenticate callout and
    svc_set_client() set it properly in every case.
    
    Signed-off-by: Chuck Lever <chuck.lever@oracle.com>
    Signed-off-by: Anna Schumaker <Anna.Schumaker@Netapp.com>

diff --git a/net/sunrpc/svc.c b/net/sunrpc/svc.c
index 360dab62b6b4..2019d1203641 100644
--- a/net/sunrpc/svc.c
+++ b/net/sunrpc/svc.c
@@ -1328,10 +1328,8 @@ svc_process_common(struct svc_rqst *rqstp, struct kvec *argv, struct kvec *resv)
 	 */
 	auth_res = svc_authenticate(rqstp);
 	/* Also give the program a chance to reject this call: */
-	if (auth_res == SVC_OK && progp) {
-		rqstp->rq_auth_stat = rpc_autherr_badcred;
+	if (auth_res == SVC_OK && progp)
 		auth_res = progp->pg_authenticate(rqstp);
-	}
 	if (auth_res != SVC_OK)
 		trace_svc_authenticate(rqstp, auth_res);
 	switch (auth_res) {