{
  "hash": "57dfd7b53dec740afe402135fdd1c5708ec337f0",
  "hash_short": "57dfd7b5",
  "subject": "KVM: x86: Move delivery of non-APICv interrupt into vendor code",
  "body": "Handle non-APICv interrupt delivery in vendor code, even though it means\nVMX and SVM will temporarily have duplicate code.  SVM's AVIC has a race\ncondition that requires KVM to fall back to legacy interrupt injection\n_after_ the interrupt has been logged in the vIRR, i.e. to fix the race,\nSVM will need to open code the full flow anyways[*].  Refactor the code\nso that the SVM bug without introducing other issues, e.g. SVM would\nreturn \"success\" and thus invoke trace_kvm_apicv_accept_irq() even when\ndelivery through the AVIC failed, and to opportunistically prepare for\nusing KVM_X86_OP to fill each vendor's kvm_x86_ops struct, which will\nrely on the vendor function matching the kvm_x86_op pointer name.\n\nNo functional change intended.\n\n[*] https://lore.kernel.org/all/20211213104634.199141-4-mlevitsk@redhat.com\n\nSigned-off-by: Sean Christopherson <seanjc@google.com>\nMessage-Id: <20220128005208.4008533-3-seanjc@google.com>\nSigned-off-by: Paolo Bonzini <pbonzini@redhat.com>",
  "full_message": "KVM: x86: Move delivery of non-APICv interrupt into vendor code\n\nHandle non-APICv interrupt delivery in vendor code, even though it means\nVMX and SVM will temporarily have duplicate code.  SVM's AVIC has a race\ncondition that requires KVM to fall back to legacy interrupt injection\n_after_ the interrupt has been logged in the vIRR, i.e. to fix the race,\nSVM will need to open code the full flow anyways[*].  Refactor the code\nso that the SVM bug without introducing other issues, e.g. SVM would\nreturn \"success\" and thus invoke trace_kvm_apicv_accept_irq() even when\ndelivery through the AVIC failed, and to opportunistically prepare for\nusing KVM_X86_OP to fill each vendor's kvm_x86_ops struct, which will\nrely on the vendor function matching the kvm_x86_op pointer name.\n\nNo functional change intended.\n\n[*] https://lore.kernel.org/all/20211213104634.199141-4-mlevitsk@redhat.com\n\nSigned-off-by: Sean Christopherson <seanjc@google.com>\nMessage-Id: <20220128005208.4008533-3-seanjc@google.com>\nSigned-off-by: Paolo Bonzini <pbonzini@redhat.com>",
  "author_name": "Sean Christopherson",
  "author_email": "seanjc@google.com",
  "author_date": "Fri Jan 28 00:51:48 2022 +0000",
  "author_date_iso": "2022-01-28T00:51:48+00:00",
  "committer_name": "Paolo Bonzini",
  "committer_email": "pbonzini@redhat.com",
  "committer_date": "Tue Feb 1 06:03:41 2022 -0500",
  "committer_date_iso": "2022-02-01T06:03:41-05:00",
  "files_changed": [
    "arch/x86/include/asm/kvm-x86-ops.h",
    "arch/x86/include/asm/kvm_host.h",
    "arch/x86/kvm/lapic.c",
    "arch/x86/kvm/svm/svm.c",
    "arch/x86/kvm/vmx/vmx.c"
  ],
  "files_changed_count": 5,
  "stats": [
    {
      "file": "arch/x86/include/asm/kvm-x86-ops.h",
      "insertions": 1,
      "deletions": 1
    },
    {
      "file": "arch/x86/include/asm/kvm_host.h",
      "insertions": 2,
      "deletions": 1
    },
    {
      "file": "arch/x86/kvm/lapic.c",
      "insertions": 2,
      "deletions": 8
    },
    {
      "file": "arch/x86/kvm/svm/svm.c",
      "insertions": 16,
      "deletions": 1
    },
    {
      "file": "arch/x86/kvm/vmx/vmx.c",
      "insertions": 16,
      "deletions": 1
    }
  ],
  "total_insertions": 37,
  "total_deletions": 12,
  "total_changes": 49,
  "parents": [
    "f6c6804c43fa18d3cee64b55490dfbd3bef1363a"
  ],
  "branches": [
    "* development",
    "remotes/origin/HEAD -> origin/master",
    "remotes/origin/master"
  ],
  "tags": [],
  "is_merge": false,
  "security_info": {
    "cve_ids": [],
    "security_keywords": [
      "injection"
    ]
  },
  "fix_type": "security",
  "file_results": [
    {
      "file": "arch/x86/include/asm/kvm-x86-ops.h",
      "pre_version": false,
      "post_version": true,
      "patch": true
    },
    {
      "file": "arch/x86/include/asm/kvm_host.h",
      "pre_version": false,
      "post_version": true,
      "patch": true
    },
    {
      "file": "arch/x86/kvm/lapic.c",
      "pre_version": false,
      "post_version": true,
      "patch": true
    },
    {
      "file": "arch/x86/kvm/svm/svm.c",
      "pre_version": false,
      "post_version": true,
      "patch": true
    },
    {
      "file": "arch/x86/kvm/vmx/vmx.c",
      "pre_version": false,
      "post_version": true,
      "patch": true
    }
  ]
}