diff --cc kernel/trace/trace.c
index b5815a022ecc,f5e8e39d6f57..e295c413580e
--- a/kernel/trace/trace.c
+++ b/kernel/trace/trace.c
@@@ -2745,8 -2740,8 +2740,8 @@@ trace_event_buffer_lock_reserve(struct 
  	    (entry = this_cpu_read(trace_buffered_event))) {
  		/* Try to use the per cpu buffer first */
  		val = this_cpu_inc_return(trace_buffered_event_cnt);
 -		if (val == 1) {
 +		if ((len < (PAGE_SIZE - sizeof(*entry))) && val == 1) {
- 			trace_event_setup(entry, type, flags, pc);
+ 			trace_event_setup(entry, type, trace_ctx);
  			entry->array[0] = len;
  			return entry;
  		}