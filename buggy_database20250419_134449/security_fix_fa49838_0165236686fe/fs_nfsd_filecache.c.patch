commit fa4983862e506d395acc1b8d14dbebf63acc2e82
Author: Weston Andros Adamson <dros@primarydata.com>
Date:   Thu Sep 5 15:09:50 2024 -0400

    nfsd: add LOCALIO support
    
    Add server support for bypassing NFS for localhost reads, writes, and
    commits. This is only useful when both the client and server are
    running on the same host.
    
    If nfsd_open_local_fh() fails then the NFS client will both retry and
    fallback to normal network-based read, write and commit operations if
    localio is no longer supported.
    
    Care is taken to ensure the same NFS security mechanisms are used
    (authentication, etc) regardless of whether localio or regular NFS
    access is used.  The auth_domain established as part of the traditional
    NFS client access to the NFS server is also used for localio.  Store
    auth_domain for localio in nfsd_uuid_t and transfer it to the client
    if it is local to the server.
    
    Relative to containers, localio gives the client access to the network
    namespace the server has.  This is required to allow the client to
    access the server's per-namespace nfsd_net struct.
    
    This commit also introduces the use of NFSD's percpu_ref to interlock
    nfsd_destroy_serv and nfsd_open_local_fh, to ensure nn->nfsd_serv is
    not destroyed while in use by nfsd_open_local_fh and other LOCALIO
    client code.
    
    CONFIG_NFS_LOCALIO enables NFS server support for LOCALIO.
    
    Signed-off-by: Weston Andros Adamson <dros@primarydata.com>
    Signed-off-by: Trond Myklebust <trond.myklebust@hammerspace.com>
    Co-developed-by: Mike Snitzer <snitzer@kernel.org>
    Signed-off-by: Mike Snitzer <snitzer@kernel.org>
    Co-developed-by: NeilBrown <neilb@suse.de>
    Signed-off-by: NeilBrown <neilb@suse.de>
    Reviewed-by: Jeff Layton <jlayton@kernel.org>
    Acked-by: Chuck Lever <chuck.lever@oracle.com>
    Signed-off-by: Anna Schumaker <anna.schumaker@oracle.com>

diff --git a/fs/nfsd/filecache.c b/fs/nfsd/filecache.c
index 414b5bf738df..19bb88c7eebd 100644
--- a/fs/nfsd/filecache.c
+++ b/fs/nfsd/filecache.c
@@ -52,7 +52,7 @@
 #define NFSD_FILE_CACHE_UP		     (0)
 
 /* We only care about NFSD_MAY_READ/WRITE for this cache */
-#define NFSD_FILE_MAY_MASK	(NFSD_MAY_READ|NFSD_MAY_WRITE)
+#define NFSD_FILE_MAY_MASK	(NFSD_MAY_READ|NFSD_MAY_WRITE|NFSD_MAY_LOCALIO)
 
 static DEFINE_PER_CPU(unsigned long, nfsd_file_cache_hits);
 static DEFINE_PER_CPU(unsigned long, nfsd_file_acquisitions);