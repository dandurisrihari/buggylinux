{
  "hash": "8ec7791bae1327b1c279c5cd6e929c3b12daaf0a",
  "hash_short": "8ec7791b",
  "subject": "powerpc/64s: Fix crashes when toggling stf barrier",
  "body": "The STF (store-to-load forwarding) barrier mitigation can be\nenabled/disabled at runtime via a debugfs file (stf_barrier), which\ncauses the kernel to patch itself to enable/disable the relevant\nmitigations.\n\nHowever depending on which mitigation we're using, it may not be safe to\ndo that patching while other CPUs are active. For example the following\ncrash:\n\n  User access of kernel address (c00000003fff5af0) - exploit attempt? (uid: 0)\n  segfault (11) at c00000003fff5af0 nip 7fff8ad12198 lr 7fff8ad121f8 code 1\n  code: 40820128 e93c00d0 e9290058 7c292840 40810058 38600000 4bfd9a81 e8410018\n  code: 2c030006 41810154 3860ffb6 e9210098 <e94d8ff0> 7d295279 39400000 40820a3c\n\nShows that we returned to userspace without restoring the user r13\nvalue, due to executing the partially patched STF exit code.\n\nFix it by doing the patching under stop machine. The CPUs that aren't\ndoing the patching will be spinning in the core of the stop machine\nlogic. That is currently sufficient for our purposes, because none of\nthe patching we do is to that code or anywhere in the vicinity.\n\nFixes: a048a07d7f45 (\"powerpc/64s: Add support for a store forwarding barrier at kernel entry/exit\")\nCc: stable@vger.kernel.org # v4.17+\nSigned-off-by: Michael Ellerman <mpe@ellerman.id.au>\nLink: https://lore.kernel.org/r/20210506044959.1298123-1-mpe@ellerman.id.au",
  "full_message": "powerpc/64s: Fix crashes when toggling stf barrier\n\nThe STF (store-to-load forwarding) barrier mitigation can be\nenabled/disabled at runtime via a debugfs file (stf_barrier), which\ncauses the kernel to patch itself to enable/disable the relevant\nmitigations.\n\nHowever depending on which mitigation we're using, it may not be safe to\ndo that patching while other CPUs are active. For example the following\ncrash:\n\n  User access of kernel address (c00000003fff5af0) - exploit attempt? (uid: 0)\n  segfault (11) at c00000003fff5af0 nip 7fff8ad12198 lr 7fff8ad121f8 code 1\n  code: 40820128 e93c00d0 e9290058 7c292840 40810058 38600000 4bfd9a81 e8410018\n  code: 2c030006 41810154 3860ffb6 e9210098 <e94d8ff0> 7d295279 39400000 40820a3c\n\nShows that we returned to userspace without restoring the user r13\nvalue, due to executing the partially patched STF exit code.\n\nFix it by doing the patching under stop machine. The CPUs that aren't\ndoing the patching will be spinning in the core of the stop machine\nlogic. That is currently sufficient for our purposes, because none of\nthe patching we do is to that code or anywhere in the vicinity.\n\nFixes: a048a07d7f45 (\"powerpc/64s: Add support for a store forwarding barrier at kernel entry/exit\")\nCc: stable@vger.kernel.org # v4.17+\nSigned-off-by: Michael Ellerman <mpe@ellerman.id.au>\nLink: https://lore.kernel.org/r/20210506044959.1298123-1-mpe@ellerman.id.au",
  "author_name": "Michael Ellerman",
  "author_email": "mpe@ellerman.id.au",
  "author_date": "Thu May 6 14:49:58 2021 +1000",
  "author_date_iso": "2021-05-06T14:49:58+10:00",
  "committer_name": "Michael Ellerman",
  "committer_email": "mpe@ellerman.id.au",
  "committer_date": "Fri May 14 17:27:36 2021 +1000",
  "committer_date_iso": "2021-05-14T17:27:36+10:00",
  "files_changed": [
    "arch/powerpc/lib/feature-fixups.c"
  ],
  "files_changed_count": 1,
  "stats": [
    {
      "file": "arch/powerpc/lib/feature-fixups.c",
      "insertions": 17,
      "deletions": 2
    }
  ],
  "total_insertions": 17,
  "total_deletions": 2,
  "total_changes": 19,
  "parents": [
    "da3bb206c9ceb0736d9e2897ea697acabad35833"
  ],
  "branches": [
    "* development",
    "remotes/origin/HEAD -> origin/master",
    "remotes/origin/master"
  ],
  "tags": [],
  "is_merge": false,
  "security_info": {
    "cve_ids": [],
    "security_keywords": [
      "exploit"
    ]
  },
  "fix_type": "security",
  "file_results": [
    {
      "file": "arch/powerpc/lib/feature-fixups.c",
      "pre_version": false,
      "post_version": true,
      "patch": true
    }
  ]
}