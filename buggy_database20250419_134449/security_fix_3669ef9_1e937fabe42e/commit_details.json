{
  "hash": "3669ef9fa7d35f573ec9c0e0341b29251c2734a7",
  "hash_short": "3669ef9f",
  "subject": "x86, tls: Interpret an all-zero struct user_desc as \"no segment\"",
  "body": "The Witcher 2 did something like this to allocate a TLS segment index:\n\n        struct user_desc u_info;\n        bzero(&u_info, sizeof(u_info));\n        u_info.entry_number = (uint32_t)-1;\n\n        syscall(SYS_set_thread_area, &u_info);\n\nStrictly speaking, this code was never correct.  It should have set\nread_exec_only and seg_not_present to 1 to indicate that it wanted\nto find a free slot without putting anything there, or it should\nhave put something sensible in the TLS slot if it wanted to allocate\na TLS entry for real.  The actual effect of this code was to\nallocate a bogus segment that could be used to exploit espfix.\n\nThe set_thread_area hardening patches changed the behavior, causing\nset_thread_area to return -EINVAL and crashing the game.\n\nThis changes set_thread_area to interpret this as a request to find\na free slot and to leave it empty, which isn't *quite* what the game\nexpects but should be close enough to keep it working.  In\nparticular, using the code above to allocate two segments will\nallocate the same segment both times.\n\nAccording to FrostbittenKing on Github, this fixes The Witcher 2.\n\nIf this somehow still causes problems, we could instead allocate\na limit==0 32-bit data segment, but that seems rather ugly to me.\n\nFixes: 41bdc78544b8 x86/tls: Validate TLS entries to protect espfix\nSigned-off-by: Andy Lutomirski <luto@amacapital.net>\nCc: stable@vger.kernel.org\nCc: torvalds@linux-foundation.org\nLink: http://lkml.kernel.org/r/0cb251abe1ff0958b8e468a9a9a905b80ae3a746.1421954363.git.luto@amacapital.net\nSigned-off-by: Thomas Gleixner <tglx@linutronix.de>",
  "full_message": "x86, tls: Interpret an all-zero struct user_desc as \"no segment\"\n\nThe Witcher 2 did something like this to allocate a TLS segment index:\n\n        struct user_desc u_info;\n        bzero(&u_info, sizeof(u_info));\n        u_info.entry_number = (uint32_t)-1;\n\n        syscall(SYS_set_thread_area, &u_info);\n\nStrictly speaking, this code was never correct.  It should have set\nread_exec_only and seg_not_present to 1 to indicate that it wanted\nto find a free slot without putting anything there, or it should\nhave put something sensible in the TLS slot if it wanted to allocate\na TLS entry for real.  The actual effect of this code was to\nallocate a bogus segment that could be used to exploit espfix.\n\nThe set_thread_area hardening patches changed the behavior, causing\nset_thread_area to return -EINVAL and crashing the game.\n\nThis changes set_thread_area to interpret this as a request to find\na free slot and to leave it empty, which isn't *quite* what the game\nexpects but should be close enough to keep it working.  In\nparticular, using the code above to allocate two segments will\nallocate the same segment both times.\n\nAccording to FrostbittenKing on Github, this fixes The Witcher 2.\n\nIf this somehow still causes problems, we could instead allocate\na limit==0 32-bit data segment, but that seems rather ugly to me.\n\nFixes: 41bdc78544b8 x86/tls: Validate TLS entries to protect espfix\nSigned-off-by: Andy Lutomirski <luto@amacapital.net>\nCc: stable@vger.kernel.org\nCc: torvalds@linux-foundation.org\nLink: http://lkml.kernel.org/r/0cb251abe1ff0958b8e468a9a9a905b80ae3a746.1421954363.git.luto@amacapital.net\nSigned-off-by: Thomas Gleixner <tglx@linutronix.de>",
  "author_name": "Andy Lutomirski",
  "author_email": "luto@amacapital.net",
  "author_date": "Thu Jan 22 11:27:59 2015 -0800",
  "author_date_iso": "2015-01-22T11:27:59-08:00",
  "committer_name": "Thomas Gleixner",
  "committer_email": "tglx@linutronix.de",
  "committer_date": "Thu Jan 22 21:45:07 2015 +0100",
  "committer_date_iso": "2015-01-22T21:45:07+01:00",
  "files_changed": [
    "arch/x86/include/asm/desc.h",
    "arch/x86/kernel/tls.c"
  ],
  "files_changed_count": 2,
  "stats": [
    {
      "file": "arch/x86/include/asm/desc.h",
      "insertions": 13,
      "deletions": 0
    },
    {
      "file": "arch/x86/kernel/tls.c",
      "insertions": 23,
      "deletions": 2
    }
  ],
  "total_insertions": 36,
  "total_deletions": 2,
  "total_changes": 38,
  "parents": [
    "e30ab185c490e9a9381385529e0fd32f0a399495"
  ],
  "branches": [
    "* development",
    "master",
    "remotes/origin/HEAD -> origin/master",
    "remotes/origin/master"
  ],
  "tags": [
    "v3.19",
    "v3.19-rc6",
    "v3.19-rc7",
    "v4.0",
    "v4.0-rc1",
    "v4.0-rc2",
    "v4.0-rc3",
    "v4.0-rc4",
    "v4.0-rc5",
    "v4.0-rc6"
  ],
  "is_merge": false,
  "security_info": {
    "cve_ids": [],
    "security_keywords": [
      "hardening",
      "exploit"
    ]
  },
  "fix_type": "security",
  "file_results": [
    {
      "file": "arch/x86/include/asm/desc.h",
      "pre_version": true,
      "post_version": true,
      "patch": true
    },
    {
      "file": "arch/x86/kernel/tls.c",
      "pre_version": false,
      "post_version": true,
      "patch": true
    }
  ]
}