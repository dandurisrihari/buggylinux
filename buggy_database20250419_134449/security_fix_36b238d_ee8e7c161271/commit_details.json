{
  "hash": "36b238d5717279163859fb6ba0f4360abcafab83",
  "hash_short": "36b238d5",
  "subject": "psi: Optimize switching tasks inside shared cgroups",
  "body": "When switching tasks running on a CPU, the psi state of a cgroup\ncontaining both of these tasks does not change. Right now, we don't\nexploit that, and can perform many unnecessary state changes in nested\nhierarchies, especially when most activity comes from one leaf cgroup.\n\nThis patch implements an optimization where we only update cgroups\nwhose state actually changes during a task switch. These are all\ncgroups that contain one task but not the other, up to the first\nshared ancestor. When both tasks are in the same group, we don't need\nto update anything at all.\n\nWe can identify the first shared ancestor by walking the groups of the\nincoming task until we see TSK_ONCPU set on the local CPU; that's the\nfirst group that also contains the outgoing task.\n\nThe new psi_task_switch() is similar to psi_task_change(). To allow\ncode reuse, move the task flag maintenance code into a new function\nand the poll/avg worker wakeups into the shared psi_group_change().\n\nSuggested-by: Peter Zijlstra <peterz@infradead.org>\nSigned-off-by: Johannes Weiner <hannes@cmpxchg.org>\nSigned-off-by: Peter Zijlstra (Intel) <peterz@infradead.org>\nLink: https://lkml.kernel.org/r/20200316191333.115523-3-hannes@cmpxchg.org",
  "full_message": "psi: Optimize switching tasks inside shared cgroups\n\nWhen switching tasks running on a CPU, the psi state of a cgroup\ncontaining both of these tasks does not change. Right now, we don't\nexploit that, and can perform many unnecessary state changes in nested\nhierarchies, especially when most activity comes from one leaf cgroup.\n\nThis patch implements an optimization where we only update cgroups\nwhose state actually changes during a task switch. These are all\ncgroups that contain one task but not the other, up to the first\nshared ancestor. When both tasks are in the same group, we don't need\nto update anything at all.\n\nWe can identify the first shared ancestor by walking the groups of the\nincoming task until we see TSK_ONCPU set on the local CPU; that's the\nfirst group that also contains the outgoing task.\n\nThe new psi_task_switch() is similar to psi_task_change(). To allow\ncode reuse, move the task flag maintenance code into a new function\nand the poll/avg worker wakeups into the shared psi_group_change().\n\nSuggested-by: Peter Zijlstra <peterz@infradead.org>\nSigned-off-by: Johannes Weiner <hannes@cmpxchg.org>\nSigned-off-by: Peter Zijlstra (Intel) <peterz@infradead.org>\nLink: https://lkml.kernel.org/r/20200316191333.115523-3-hannes@cmpxchg.org",
  "author_name": "Johannes Weiner",
  "author_email": "hannes@cmpxchg.org",
  "author_date": "Mon Mar 16 15:13:32 2020 -0400",
  "author_date_iso": "2020-03-16T15:13:32-04:00",
  "committer_name": "Peter Zijlstra",
  "committer_email": "peterz@infradead.org",
  "committer_date": "Fri Mar 20 13:06:19 2020 +0100",
  "committer_date_iso": "2020-03-20T13:06:19+01:00",
  "files_changed": [
    "include/linux/psi.h",
    "kernel/sched/psi.c",
    "kernel/sched/stats.h"
  ],
  "files_changed_count": 3,
  "stats": [
    {
      "file": "include/linux/psi.h",
      "insertions": 2,
      "deletions": 0
    },
    {
      "file": "kernel/sched/psi.c",
      "insertions": 67,
      "deletions": 20
    },
    {
      "file": "kernel/sched/stats.h",
      "insertions": 1,
      "deletions": 8
    }
  ],
  "total_insertions": 70,
  "total_deletions": 28,
  "total_changes": 98,
  "parents": [
    "b05e75d611380881e73edc58a20fd8c6bb71720b"
  ],
  "branches": [
    "* development",
    "master",
    "remotes/origin/HEAD -> origin/master",
    "remotes/origin/master"
  ],
  "tags": [
    "v5.7-rc1"
  ],
  "is_merge": false,
  "security_info": {
    "cve_ids": [],
    "security_keywords": [
      "exploit"
    ]
  },
  "fix_type": "security",
  "file_results": [
    {
      "file": "include/linux/psi.h",
      "pre_version": false,
      "post_version": true,
      "patch": true
    },
    {
      "file": "kernel/sched/psi.c",
      "pre_version": true,
      "post_version": true,
      "patch": true
    },
    {
      "file": "kernel/sched/stats.h",
      "pre_version": true,
      "post_version": true,
      "patch": true
    }
  ]
}