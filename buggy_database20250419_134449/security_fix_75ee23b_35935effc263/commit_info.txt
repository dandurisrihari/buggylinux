Commit Hash: 75ee23b30dc712d80d2421a9a547e7ab6e379b44
Subject: KVM: x86: Don't update RIP or do single-step on faulting emulation


Security Keywords:
- inject

Full commit message:
KVM: x86: Don't update RIP or do single-step on faulting emulation

Don't advance RIP or inject a single-step #DB if emulation signals a
fault.  This logic applies to all state updates that are conditional on
clean retirement of the emulation instruction, e.g. updating RFLAGS was
previously handled by commit 38827dbd3fb85 ("KVM: x86: Do not update
EFLAGS on faulting emulation").

Not advancing RIP is likely a nop, i.e. ctxt->eip isn't updated with
ctxt->_eip until emulation "retires" anyways.  Skipping #DB injection
fixes a bug reported by Andy Lutomirski where a #UD on SYSCALL due to
invalid state with EFLAGS.TF=1 would loop indefinitely due to emulation
overwriting the #UD with #DB and thus restarting the bad SYSCALL over
and over.

Cc: Nadav Amit <nadav.amit@gmail.com>
Cc: stable@vger.kernel.org
Reported-by: Andy Lutomirski <luto@kernel.org>
Fixes: 663f4c61b803 ("KVM: x86: handle singlestep during emulation")
Signed-off-by: Sean Christopherson <sean.j.christopherson@intel.com>
Signed-off-by: Radim Krčmář <rkrcmar@redhat.com>

Metadata:
Author: Sean Christopherson <sean.j.christopherson@intel.com>
Author Date: Fri Aug 23 13:55:44 2019 -0700
Committer: Radim Krčmář <rkrcmar@redhat.com>
Commit Date: Tue Aug 27 20:59:04 2019 +0200

Files Changed: 1
Lines Added: 5
Lines Removed: 4
Total Changes: 9
