Commit Hash: e2cb6b891ad2b8caa9131e3be70f45243df82a80
Subject: bluetooth: eliminate the potential race condition when removing the HCI controller


Security Keywords:
- vulnerability

Full commit message:
bluetooth: eliminate the potential race condition when removing the HCI controller

There is a possible race condition vulnerability between issuing a HCI
command and removing the cont.  Specifically, functions hci_req_sync()
and hci_dev_do_close() can race each other like below:

thread-A in hci_req_sync()      |   thread-B in hci_dev_do_close()
                                |   hci_req_sync_lock(hdev);
test_bit(HCI_UP, &hdev->flags); |
...                             |   test_and_clear_bit(HCI_UP, &hdev->flags)
hci_req_sync_lock(hdev);        |
                                |
In this commit we alter the sequence in function hci_req_sync(). Hence,
the thread-A cannot issue th.

Signed-off-by: Lin Ma <linma@zju.edu.cn>
Cc: Marcel Holtmann <marcel@holtmann.org>
Fixes: 7c6a329e4447 ("[Bluetooth] Fix regression from using default link policy")
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

Metadata:
Author: Lin Ma <linma@zju.edu.cn>
Author Date: Mon Apr 12 19:17:57 2021 +0800
Committer: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
Commit Date: Fri Apr 23 13:25:04 2021 +0200

Files Changed: 1
Lines Added: 8
Lines Removed: 4
Total Changes: 12
