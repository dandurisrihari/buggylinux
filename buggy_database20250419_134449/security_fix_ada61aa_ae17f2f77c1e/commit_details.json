{
  "hash": "ada61aa0b1184a8fda1a89a340c7d6cc4e59aee5",
  "hash_short": "ada61aa0",
  "subject": "hwmon: Fix possible memleak in __hwmon_device_register()",
  "body": "I got memory leak as follows when doing fault injection test:\n\nunreferenced object 0xffff888102740438 (size 8):\n  comm \"27\", pid 859, jiffies 4295031351 (age 143.992s)\n  hex dump (first 8 bytes):\n    68 77 6d 6f 6e 30 00 00                          hwmon0..\n  backtrace:\n    [<00000000544b5996>] __kmalloc_track_caller+0x1a6/0x300\n    [<00000000df0d62b9>] kvasprintf+0xad/0x140\n    [<00000000d3d2a3da>] kvasprintf_const+0x62/0x190\n    [<000000005f8f0f29>] kobject_set_name_vargs+0x56/0x140\n    [<00000000b739e4b9>] dev_set_name+0xb0/0xe0\n    [<0000000095b69c25>] __hwmon_device_register+0xf19/0x1e50 [hwmon]\n    [<00000000a7e65b52>] hwmon_device_register_with_info+0xcb/0x110 [hwmon]\n    [<000000006f181e86>] devm_hwmon_device_register_with_info+0x85/0x100 [hwmon]\n    [<0000000081bdc567>] tmp421_probe+0x2d2/0x465 [tmp421]\n    [<00000000502cc3f8>] i2c_device_probe+0x4e1/0xbb0\n    [<00000000f90bda3b>] really_probe+0x285/0xc30\n    [<000000007eac7b77>] __driver_probe_device+0x35f/0x4f0\n    [<000000004953d43d>] driver_probe_device+0x4f/0x140\n    [<000000002ada2d41>] __device_attach_driver+0x24c/0x330\n    [<00000000b3977977>] bus_for_each_drv+0x15d/0x1e0\n    [<000000005bf2a8e3>] __device_attach+0x267/0x410\n\nWhen device_register() returns an error, the name allocated in\ndev_set_name() will be leaked, the put_device() should be used\ninstead of calling hwmon_dev_release() to give up the device\nreference, then the name will be freed in kobject_cleanup().\n\nReported-by: Hulk Robot <hulkci@huawei.com>\nFixes: bab2243ce189 (\"hwmon: Introduce hwmon_device_register_with_groups\")\nSigned-off-by: Yang Yingliang <yangyingliang@huawei.com>\nLink: https://lore.kernel.org/r/20211012112758.2681084-1-yangyingliang@huawei.com\nSigned-off-by: Guenter Roeck <linux@roeck-us.net>",
  "full_message": "hwmon: Fix possible memleak in __hwmon_device_register()\n\nI got memory leak as follows when doing fault injection test:\n\nunreferenced object 0xffff888102740438 (size 8):\n  comm \"27\", pid 859, jiffies 4295031351 (age 143.992s)\n  hex dump (first 8 bytes):\n    68 77 6d 6f 6e 30 00 00                          hwmon0..\n  backtrace:\n    [<00000000544b5996>] __kmalloc_track_caller+0x1a6/0x300\n    [<00000000df0d62b9>] kvasprintf+0xad/0x140\n    [<00000000d3d2a3da>] kvasprintf_const+0x62/0x190\n    [<000000005f8f0f29>] kobject_set_name_vargs+0x56/0x140\n    [<00000000b739e4b9>] dev_set_name+0xb0/0xe0\n    [<0000000095b69c25>] __hwmon_device_register+0xf19/0x1e50 [hwmon]\n    [<00000000a7e65b52>] hwmon_device_register_with_info+0xcb/0x110 [hwmon]\n    [<000000006f181e86>] devm_hwmon_device_register_with_info+0x85/0x100 [hwmon]\n    [<0000000081bdc567>] tmp421_probe+0x2d2/0x465 [tmp421]\n    [<00000000502cc3f8>] i2c_device_probe+0x4e1/0xbb0\n    [<00000000f90bda3b>] really_probe+0x285/0xc30\n    [<000000007eac7b77>] __driver_probe_device+0x35f/0x4f0\n    [<000000004953d43d>] driver_probe_device+0x4f/0x140\n    [<000000002ada2d41>] __device_attach_driver+0x24c/0x330\n    [<00000000b3977977>] bus_for_each_drv+0x15d/0x1e0\n    [<000000005bf2a8e3>] __device_attach+0x267/0x410\n\nWhen device_register() returns an error, the name allocated in\ndev_set_name() will be leaked, the put_device() should be used\ninstead of calling hwmon_dev_release() to give up the device\nreference, then the name will be freed in kobject_cleanup().\n\nReported-by: Hulk Robot <hulkci@huawei.com>\nFixes: bab2243ce189 (\"hwmon: Introduce hwmon_device_register_with_groups\")\nSigned-off-by: Yang Yingliang <yangyingliang@huawei.com>\nLink: https://lore.kernel.org/r/20211012112758.2681084-1-yangyingliang@huawei.com\nSigned-off-by: Guenter Roeck <linux@roeck-us.net>",
  "author_name": "Yang Yingliang",
  "author_email": "yangyingliang@huawei.com",
  "author_date": "Tue Oct 12 19:27:58 2021 +0800",
  "author_date_iso": "2021-10-12T19:27:58+08:00",
  "committer_name": "Guenter Roeck",
  "committer_email": "linux@roeck-us.net",
  "committer_date": "Tue Oct 12 07:22:01 2021 -0700",
  "committer_date_iso": "2021-10-12T07:22:01-07:00",
  "files_changed": [
    "drivers/hwmon/hwmon.c"
  ],
  "files_changed_count": 1,
  "stats": [
    {
      "file": "drivers/hwmon/hwmon.c",
      "insertions": 4,
      "deletions": 2
    }
  ],
  "total_insertions": 4,
  "total_deletions": 2,
  "total_changes": 6,
  "parents": [
    "9e1ff307c779ce1f0f810c7ecce3d95bbae40896"
  ],
  "branches": [
    "* development",
    "remotes/origin/HEAD -> origin/master",
    "remotes/origin/master"
  ],
  "tags": [],
  "is_merge": false,
  "security_info": {
    "cve_ids": [],
    "security_keywords": [
      "injection"
    ]
  },
  "fix_type": "security",
  "file_results": [
    {
      "file": "drivers/hwmon/hwmon.c",
      "pre_version": false,
      "post_version": true,
      "patch": true
    }
  ]
}