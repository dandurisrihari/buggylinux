Commit Hash: 42e15d12070b4ff9af2b980f1b65774c2dab0507
Subject: dm-crypt: recheck the integrity tag after a failure


Security Keywords:
- authentication

Full commit message:
dm-crypt: recheck the integrity tag after a failure

If a userspace process reads (with O_DIRECT) multiple blocks into the same
buffer, dm-crypt reports an authentication error [1]. The error is
reported in a log and it may cause RAID leg being kicked out of the
array.

This commit fixes dm-crypt, so that if integrity verification fails, the
data is read again into a kernel buffer (where userspace can't modify it)
and the integrity tag is rechecked. If the recheck succeeds, the content
of the kernel buffer is copied into the user buffer; if the recheck fails,
an integrity error is reported.

[1] https://people.redhat.com/~mpatocka/testcases/blk-auth-modify/read2.c

Signed-off-by: Mikulas Patocka <mpatocka@redhat.com>
Cc: stable@vger.kernel.org
Signed-off-by: Mike Snitzer <snitzer@kernel.org>

Metadata:
Author: Mikulas Patocka <mpatocka@redhat.com>
Author Date: Mon Feb 19 21:31:11 2024 +0100
Committer: Mike Snitzer <snitzer@kernel.org>
Commit Date: Tue Feb 20 13:34:32 2024 -0500

Files Changed: 1
Lines Added: 73
Lines Removed: 16
Total Changes: 89
