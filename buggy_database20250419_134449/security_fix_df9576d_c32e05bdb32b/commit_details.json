{
  "hash": "df9576def004d2cd5beedc00cb6e8901427634b9",
  "hash_short": "df9576de",
  "subject": "Revert \"kmemleak: allow to coexist with fault injection\"",
  "body": "When running ltp's oom test with kmemleak enabled, the below warning was\ntriggerred since kernel detects __GFP_NOFAIL & ~__GFP_DIRECT_RECLAIM is\npassed in:\n\n  WARNING: CPU: 105 PID: 2138 at mm/page_alloc.c:4608 __alloc_pages_nodemask+0x1c31/0x1d50\n  Modules linked in: loop dax_pmem dax_pmem_core ip_tables x_tables xfs virtio_net net_failover virtio_blk failover ata_generic virtio_pci virtio_ring virtio libata\n  CPU: 105 PID: 2138 Comm: oom01 Not tainted 5.2.0-next-20190710+ #7\n  Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS rel-1.10.2-0-g5f4c7b1-prebuilt.qemu-project.org 04/01/2014\n  RIP: 0010:__alloc_pages_nodemask+0x1c31/0x1d50\n  ...\n   kmemleak_alloc+0x4e/0xb0\n   kmem_cache_alloc+0x2a7/0x3e0\n   mempool_alloc_slab+0x2d/0x40\n   mempool_alloc+0x118/0x2b0\n   bio_alloc_bioset+0x19d/0x350\n   get_swap_bio+0x80/0x230\n   __swap_writepage+0x5ff/0xb20\n\nThe mempool_alloc_slab() clears __GFP_DIRECT_RECLAIM, however kmemleak\nhas __GFP_NOFAIL set all the time due to d9570ee3bd1d4f2 (\"kmemleak:\nallow to coexist with fault injection\").  But, it doesn't make any sense\nto have __GFP_NOFAIL and ~__GFP_DIRECT_RECLAIM specified at the same\ntime.\n\nAccording to the discussion on the mailing list, the commit should be\nreverted for short term solution.  Catalin Marinas would follow up with\na better solution for longer term.\n\nThe failure rate of kmemleak metadata allocation may increase in some\ncircumstances, but this should be expected side effect.\n\nLink: http://lkml.kernel.org/r/1563299431-111710-1-git-send-email-yang.shi@linux.alibaba.com\nFixes: d9570ee3bd1d4f2 (\"kmemleak: allow to coexist with fault injection\")\nSigned-off-by: Yang Shi <yang.shi@linux.alibaba.com>\nSuggested-by: Catalin Marinas <catalin.marinas@arm.com>\nAcked-by: Michal Hocko <mhocko@suse.com>\nCc: Dmitry Vyukov <dvyukov@google.com>\nCc: David Rientjes <rientjes@google.com>\nCc: Matthew Wilcox <willy@infradead.org>\nCc: Qian Cai <cai@lca.pw>\nSigned-off-by: Andrew Morton <akpm@linux-foundation.org>\nSigned-off-by: Linus Torvalds <torvalds@linux-foundation.org>",
  "full_message": "Revert \"kmemleak: allow to coexist with fault injection\"\n\nWhen running ltp's oom test with kmemleak enabled, the below warning was\ntriggerred since kernel detects __GFP_NOFAIL & ~__GFP_DIRECT_RECLAIM is\npassed in:\n\n  WARNING: CPU: 105 PID: 2138 at mm/page_alloc.c:4608 __alloc_pages_nodemask+0x1c31/0x1d50\n  Modules linked in: loop dax_pmem dax_pmem_core ip_tables x_tables xfs virtio_net net_failover virtio_blk failover ata_generic virtio_pci virtio_ring virtio libata\n  CPU: 105 PID: 2138 Comm: oom01 Not tainted 5.2.0-next-20190710+ #7\n  Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS rel-1.10.2-0-g5f4c7b1-prebuilt.qemu-project.org 04/01/2014\n  RIP: 0010:__alloc_pages_nodemask+0x1c31/0x1d50\n  ...\n   kmemleak_alloc+0x4e/0xb0\n   kmem_cache_alloc+0x2a7/0x3e0\n   mempool_alloc_slab+0x2d/0x40\n   mempool_alloc+0x118/0x2b0\n   bio_alloc_bioset+0x19d/0x350\n   get_swap_bio+0x80/0x230\n   __swap_writepage+0x5ff/0xb20\n\nThe mempool_alloc_slab() clears __GFP_DIRECT_RECLAIM, however kmemleak\nhas __GFP_NOFAIL set all the time due to d9570ee3bd1d4f2 (\"kmemleak:\nallow to coexist with fault injection\").  But, it doesn't make any sense\nto have __GFP_NOFAIL and ~__GFP_DIRECT_RECLAIM specified at the same\ntime.\n\nAccording to the discussion on the mailing list, the commit should be\nreverted for short term solution.  Catalin Marinas would follow up with\na better solution for longer term.\n\nThe failure rate of kmemleak metadata allocation may increase in some\ncircumstances, but this should be expected side effect.\n\nLink: http://lkml.kernel.org/r/1563299431-111710-1-git-send-email-yang.shi@linux.alibaba.com\nFixes: d9570ee3bd1d4f2 (\"kmemleak: allow to coexist with fault injection\")\nSigned-off-by: Yang Shi <yang.shi@linux.alibaba.com>\nSuggested-by: Catalin Marinas <catalin.marinas@arm.com>\nAcked-by: Michal Hocko <mhocko@suse.com>\nCc: Dmitry Vyukov <dvyukov@google.com>\nCc: David Rientjes <rientjes@google.com>\nCc: Matthew Wilcox <willy@infradead.org>\nCc: Qian Cai <cai@lca.pw>\nSigned-off-by: Andrew Morton <akpm@linux-foundation.org>\nSigned-off-by: Linus Torvalds <torvalds@linux-foundation.org>",
  "author_name": "Yang Shi",
  "author_email": "yang.shi@linux.alibaba.com",
  "author_date": "Fri Aug 2 21:48:37 2019 -0700",
  "author_date_iso": "2019-08-02T21:48:37-07:00",
  "committer_name": "Linus Torvalds",
  "committer_email": "torvalds@linux-foundation.org",
  "committer_date": "Sat Aug 3 07:02:00 2019 -0700",
  "committer_date_iso": "2019-08-03T07:02:00-07:00",
  "files_changed": [
    "mm/kmemleak.c"
  ],
  "files_changed_count": 1,
  "stats": [
    {
      "file": "mm/kmemleak.c",
      "insertions": 1,
      "deletions": 1
    }
  ],
  "total_insertions": 1,
  "total_deletions": 1,
  "total_changes": 2,
  "parents": [
    "68d8681e97bd1c90259f341c1695af05002070ef"
  ],
  "branches": [
    "* development",
    "master",
    "remotes/origin/HEAD -> origin/master",
    "remotes/origin/master"
  ],
  "tags": [
    "v5.3",
    "v5.3-rc3",
    "v5.3-rc4",
    "v5.3-rc5",
    "v5.3-rc6",
    "v5.3-rc7",
    "v5.3-rc8",
    "v5.4",
    "v5.4-rc1",
    "v5.4-rc2"
  ],
  "is_merge": false,
  "security_info": {
    "cve_ids": [],
    "security_keywords": [
      "injection"
    ]
  },
  "fix_type": "security",
  "file_results": [
    {
      "file": "mm/kmemleak.c",
      "pre_version": false,
      "post_version": true,
      "patch": true
    }
  ]
}