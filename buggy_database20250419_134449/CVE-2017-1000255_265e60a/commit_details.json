{
  "hash": "265e60a170d0a0ecfc2d20490134ed2c48dd45ab",
  "hash_short": "265e60a1",
  "subject": "powerpc/64s: Use emergency stack for kernel TM Bad Thing program checks",
  "body": "When using transactional memory (TM), the CPU can be in one of six\nstates as far as TM is concerned, encoded in the Machine State\nRegister (MSR). Certain state transitions are illegal and if attempted\ntrigger a \"TM Bad Thing\" type program check exception.\n\nIf we ever hit one of these exceptions it's treated as a bug, ie. we\noops, and kill the process and/or panic, depending on configuration.\n\nOne case where we can trigger a TM Bad Thing, is when returning to\nuserspace after a system call or interrupt, using RFID. When this\nhappens the CPU first restores the user register state, in particular\nr1 (the stack pointer) and then attempts to update the MSR. However\nthe MSR update is not allowed and so we take the program check with\nthe user register state, but the kernel MSR.\n\nThis tricks the exception entry code into thinking we have a bad\nkernel stack pointer, because the MSR says we're coming from the\nkernel, but r1 is pointing to userspace.\n\nTo avoid this we instead always switch to the emergency stack if we\ntake a TM Bad Thing from the kernel. That way none of the user\nregister values are used, other than for printing in the oops message.\n\nThis is the fix for CVE-2017-1000255.\n\nFixes: 5d176f751ee3 (\"powerpc: tm: Enable transactional memory (TM) lazily for userspace\")\nCc: stable@vger.kernel.org # v4.9+\nSigned-off-by: Cyril Bur <cyrilbur@gmail.com>\n[mpe: Rewrite change log & comments, tweak asm slightly]\nSigned-off-by: Michael Ellerman <mpe@ellerman.id.au>",
  "full_message": "powerpc/64s: Use emergency stack for kernel TM Bad Thing program checks\n\nWhen using transactional memory (TM), the CPU can be in one of six\nstates as far as TM is concerned, encoded in the Machine State\nRegister (MSR). Certain state transitions are illegal and if attempted\ntrigger a \"TM Bad Thing\" type program check exception.\n\nIf we ever hit one of these exceptions it's treated as a bug, ie. we\noops, and kill the process and/or panic, depending on configuration.\n\nOne case where we can trigger a TM Bad Thing, is when returning to\nuserspace after a system call or interrupt, using RFID. When this\nhappens the CPU first restores the user register state, in particular\nr1 (the stack pointer) and then attempts to update the MSR. However\nthe MSR update is not allowed and so we take the program check with\nthe user register state, but the kernel MSR.\n\nThis tricks the exception entry code into thinking we have a bad\nkernel stack pointer, because the MSR says we're coming from the\nkernel, but r1 is pointing to userspace.\n\nTo avoid this we instead always switch to the emergency stack if we\ntake a TM Bad Thing from the kernel. That way none of the user\nregister values are used, other than for printing in the oops message.\n\nThis is the fix for CVE-2017-1000255.\n\nFixes: 5d176f751ee3 (\"powerpc: tm: Enable transactional memory (TM) lazily for userspace\")\nCc: stable@vger.kernel.org # v4.9+\nSigned-off-by: Cyril Bur <cyrilbur@gmail.com>\n[mpe: Rewrite change log & comments, tweak asm slightly]\nSigned-off-by: Michael Ellerman <mpe@ellerman.id.au>",
  "author_name": "Cyril Bur",
  "author_email": "cyrilbur@gmail.com",
  "author_date": "Thu Aug 17 20:42:26 2017 +1000",
  "author_date_iso": "2017-08-17T20:42:26+10:00",
  "committer_name": "Michael Ellerman",
  "committer_email": "mpe@ellerman.id.au",
  "committer_date": "Fri Oct 6 22:12:16 2017 +1100",
  "committer_date_iso": "2017-10-06T22:12:16+11:00",
  "files_changed": [
    "arch/powerpc/kernel/exceptions-64s.S"
  ],
  "files_changed_count": 1,
  "stats": [
    {
      "file": "arch/powerpc/kernel/exceptions-64s.S",
      "insertions": 23,
      "deletions": 1
    }
  ],
  "total_insertions": 23,
  "total_deletions": 1,
  "total_changes": 24,
  "parents": [
    "53ecde0b9126ff140abe3aefd7f0ec64d6fa36b0"
  ],
  "branches": [
    "* development",
    "master",
    "remotes/origin/HEAD -> origin/master",
    "remotes/origin/master"
  ],
  "tags": [
    "v4.14",
    "v4.14-rc5",
    "v4.14-rc6",
    "v4.14-rc7",
    "v4.14-rc8",
    "v4.15",
    "v4.15-rc1",
    "v4.15-rc2",
    "v4.15-rc3",
    "v4.15-rc4"
  ],
  "is_merge": false,
  "security_info": {
    "cve_ids": [
      "CVE-2017-1000255"
    ],
    "security_keywords": []
  },
  "fix_type": "cve",
  "file_results": [
    {
      "file": "arch/powerpc/kernel/exceptions-64s.S",
      "pre_version": false,
      "post_version": true,
      "patch": true
    }
  ]
}