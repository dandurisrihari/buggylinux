commit 699bb2e0c6f3796549dabac329501df7ffd99439
Author: Marc Zyngier <maz@kernel.org>
Date:   Sat May 28 12:38:18 2022 +0100

    KVM: arm64: Move vcpu PC/Exception flags to the input flag set
    
    The PC update flags (which also deal with exception injection)
    is one of the most complicated use of the flag we have. Make it
    more fool prof by:
    
    - moving it over to the new accessors and assign it to the
      input flag set
    
    - turn the combination of generic ELx flags with another flag
      indicating the target EL itself into an explicit set of
      flags for each EL and vector combination
    
    - add a new accessor to pend the exception
    
    This is otherwise a pretty straightformward conversion.
    
    Reviewed-by: Fuad Tabba <tabba@google.com>
    Reviewed-by: Reiji Watanabe <reijiw@google.com>
    Signed-off-by: Marc Zyngier <maz@kernel.org>

diff --git a/arch/arm64/kvm/arm.c b/arch/arm64/kvm/arm.c
index 400bb0fe2745..5beabbe69585 100644
--- a/arch/arm64/kvm/arm.c
+++ b/arch/arm64/kvm/arm.c
@@ -1013,8 +1013,8 @@ int kvm_arch_vcpu_ioctl_run(struct kvm_vcpu *vcpu)
 	 * the vcpu state. Note that this relies on __kvm_adjust_pc()
 	 * being preempt-safe on VHE.
 	 */
-	if (unlikely(vcpu->arch.flags & (KVM_ARM64_PENDING_EXCEPTION |
-					 KVM_ARM64_INCREMENT_PC)))
+	if (unlikely(vcpu_get_flag(vcpu, PENDING_EXCEPTION) ||
+		     vcpu_get_flag(vcpu, INCREMENT_PC)))
 		kvm_call_hyp(__kvm_adjust_pc, vcpu);
 
 	vcpu_put(vcpu);