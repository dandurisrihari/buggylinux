Commit Hash: 5676e7b6db02b80eafc2e3ad316d5f2fee817ecb
Subject: blk-mq: cleanup after blk_mq_init_rq_map failures


Security Keywords:
- injection

Full commit message:
blk-mq: cleanup after blk_mq_init_rq_map failures

In blk-mq.c blk_mq_alloc_tag_set, if:
	set->tags = kmalloc_node()
succeeds, but one of the blk_mq_init_rq_map() calls fails,
	goto out_unwind;
needs to free set->tags so the caller is not obligated
to do so.  None of the current callers (null_blk,
virtio_blk, virtio_blk, or the forthcoming scsi-mq)
do so.

set->tags needs to be set to NULL after doing so,
so other tag cleanup logic doesn't try to free
a stale pointer later.  Also set it to NULL
in blk_mq_free_tag_set.

Tested with error injection on the forthcoming
scsi-mq + hpsa combination.

Signed-off-by: Robert Elliott <elliott@hp.com>
Signed-off-by: Jens Axboe <axboe@fb.com>

Metadata:
Author: Robert Elliott <elliott@hp.com>
Author Date: Tue Sep 2 11:38:44 2014 -0500
Committer: Jens Axboe <axboe@fb.com>
Commit Date: Wed Sep 3 10:44:15 2014 -0600

Files Changed: 1
Lines Added: 3
Lines Removed: 0
Total Changes: 3
