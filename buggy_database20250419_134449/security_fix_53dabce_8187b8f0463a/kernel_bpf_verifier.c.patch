commit 53dabce2652fb854eae84609ce9c37429d5d87ba
Author: Vlastimil Babka <vbabka@suse.cz>
Date:   Thu Jul 11 18:35:31 2024 +0200

    mm, page_alloc: put should_fail_alloc_page() back behing CONFIG_FAIL_PAGE_ALLOC
    
    This mostly reverts commit af3b854492f3 ("mm/page_alloc.c: allow error
    injection").  The commit made should_fail_alloc_page() a noinline function
    that's always called from the page allocation hotpath, even if it's empty
    because CONFIG_FAIL_PAGE_ALLOC is not enabled, and there is no option to
    disable it and prevent the associated function call overhead.
    
    As with the preceding patch "mm, slab: put should_failslab back behind
    CONFIG_SHOULD_FAILSLAB" and for the same reasons, put the
    should_fail_alloc_page() back behind the config option.  When enabled, the
    ALLOW_ERROR_INJECTION and BTF_ID records are preserved so it's not a
    complete revert.
    
    Link: https://lkml.kernel.org/r/20240711-b4-fault-injection-reverts-v1-2-9e2651945d68@suse.cz
    Signed-off-by: Vlastimil Babka <vbabka@suse.cz>
    Cc: Akinobu Mita <akinobu.mita@gmail.com>
    Cc: Alexei Starovoitov <ast@kernel.org>
    Cc: Andrii Nakryiko <andrii@kernel.org>
    Cc: Christoph Lameter <cl@linux.com>
    Cc: Daniel Borkmann <daniel@iogearbox.net>
    Cc: David Rientjes <rientjes@google.com>
    Cc: Eduard Zingerman <eddyz87@gmail.com>
    Cc: Hao Luo <haoluo@google.com>
    Cc: Hyeonggon Yoo <42.hyeyoo@gmail.com>
    Cc: Jiri Olsa <jolsa@kernel.org>
    Cc: John Fastabend <john.fastabend@gmail.com>
    Cc: KP Singh <kpsingh@kernel.org>
    Cc: Martin KaFai Lau <martin.lau@linux.dev>
    Cc: Mateusz Guzik <mjguzik@gmail.com>
    Cc: Roman Gushchin <roman.gushchin@linux.dev>
    Cc: Song Liu <song@kernel.org>
    Cc: Stanislav Fomichev <sdf@fomichev.me>
    Cc: Yonghong Song <yonghong.song@linux.dev>
    Signed-off-by: Andrew Morton <akpm@linux-foundation.org>

diff --git a/kernel/bpf/verifier.c b/kernel/bpf/verifier.c
index e455654f3b91..a81e18409ec9 100644
--- a/kernel/bpf/verifier.c
+++ b/kernel/bpf/verifier.c
@@ -21122,7 +21122,9 @@ BTF_SET_START(btf_non_sleepable_error_inject)
  * Assume non-sleepable from bpf safety point of view.
  */
 BTF_ID(func, __filemap_add_folio)
+#ifdef CONFIG_FAIL_PAGE_ALLOC
 BTF_ID(func, should_fail_alloc_page)
+#endif
 #ifdef CONFIG_FAILSLAB
 BTF_ID(func, should_failslab)
 #endif