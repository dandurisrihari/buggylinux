Commit Hash: 8e138e0d92c6c9d3d481674fb14e3439b495be37
Subject: btrfs: clear space cache inode generation always


Security Keywords:
- injection

Full commit message:
btrfs: clear space cache inode generation always

We discovered a box that had double allocations, and suspected the space
cache may be to blame.  While auditing the write out path I noticed that
if we've already setup the space cache we will just carry on.  This
means that any error we hit after cache_save_setup before we go to
actually write the cache out we won't reset the inode generation, so
whatever was already written will be considered correct, except it'll be
stale.  Fix this by _always_ resetting the generation on the block group
inode, this way we only ever have valid or invalid cache.

With this patch I was no longer able to reproduce cache corruption with
dm-log-writes and my bpf error injection tool.

Cc: stable@vger.kernel.org
Signed-off-by: Josef Bacik <jbacik@fb.com>
Signed-off-by: David Sterba <dsterba@suse.com>

Metadata:
Author: Josef Bacik <jbacik@fb.com>
Author Date: Fri Nov 17 14:50:46 2017 -0500
Committer: David Sterba <dsterba@suse.com>
Commit Date: Mon Nov 20 20:43:39 2017 +0100

Files Changed: 1
Lines Added: 7
Lines Removed: 7
Total Changes: 14
