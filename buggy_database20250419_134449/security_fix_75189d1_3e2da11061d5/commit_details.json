{
  "hash": "75189d1de1b377e580ebd2d2c55914631eac9c64",
  "hash_short": "75189d1d",
  "subject": "KVM: x86/pmu: Update AMD PMC sample period to fix guest NMI-watchdog",
  "body": "NMI-watchdog is one of the favorite features of kernel developers,\nbut it does not work in AMD guest even with vPMU enabled and worse,\nthe system misrepresents this capability via /proc.\n\nThis is a PMC emulation error. KVM does not pass the latest valid\nvalue to perf_event in time when guest NMI-watchdog is running, thus\nthe perf_event corresponding to the watchdog counter will enter the\nold state at some point after the first guest NMI injection, forcing\nthe hardware register PMC0 to be constantly written to 0x800000000001.\n\nMeanwhile, the running counter should accurately reflect its new value\nbased on the latest coordinated pmc->counter (from vPMC's point of view)\nrather than the value written directly by the guest.\n\nFixes: 168d918f2643 (\"KVM: x86: Adjust counter sample period after a wrmsr\")\nReported-by: Dongli Cao <caodongli@kingsoft.com>\nSigned-off-by: Like Xu <likexu@tencent.com>\nReviewed-by: Yanan Wang <wangyanan55@huawei.com>\nTested-by: Yanan Wang <wangyanan55@huawei.com>\nReviewed-by: Jim Mattson <jmattson@google.com>\nMessage-Id: <20220409015226.38619-1-likexu@tencent.com>\nCc: stable@vger.kernel.org\nSigned-off-by: Paolo Bonzini <pbonzini@redhat.com>",
  "full_message": "KVM: x86/pmu: Update AMD PMC sample period to fix guest NMI-watchdog\n\nNMI-watchdog is one of the favorite features of kernel developers,\nbut it does not work in AMD guest even with vPMU enabled and worse,\nthe system misrepresents this capability via /proc.\n\nThis is a PMC emulation error. KVM does not pass the latest valid\nvalue to perf_event in time when guest NMI-watchdog is running, thus\nthe perf_event corresponding to the watchdog counter will enter the\nold state at some point after the first guest NMI injection, forcing\nthe hardware register PMC0 to be constantly written to 0x800000000001.\n\nMeanwhile, the running counter should accurately reflect its new value\nbased on the latest coordinated pmc->counter (from vPMC's point of view)\nrather than the value written directly by the guest.\n\nFixes: 168d918f2643 (\"KVM: x86: Adjust counter sample period after a wrmsr\")\nReported-by: Dongli Cao <caodongli@kingsoft.com>\nSigned-off-by: Like Xu <likexu@tencent.com>\nReviewed-by: Yanan Wang <wangyanan55@huawei.com>\nTested-by: Yanan Wang <wangyanan55@huawei.com>\nReviewed-by: Jim Mattson <jmattson@google.com>\nMessage-Id: <20220409015226.38619-1-likexu@tencent.com>\nCc: stable@vger.kernel.org\nSigned-off-by: Paolo Bonzini <pbonzini@redhat.com>",
  "author_name": "Like Xu",
  "author_email": "likexu@tencent.com",
  "author_date": "Sat Apr 9 09:52:26 2022 +0800",
  "author_date_iso": "2022-04-09T09:52:26+08:00",
  "committer_name": "Paolo Bonzini",
  "committer_email": "pbonzini@redhat.com",
  "committer_date": "Thu Apr 21 13:16:14 2022 -0400",
  "committer_date_iso": "2022-04-21T13:16:14-04:00",
  "files_changed": [
    "arch/x86/kvm/pmu.h",
    "arch/x86/kvm/svm/pmu.c",
    "arch/x86/kvm/vmx/pmu_intel.c"
  ],
  "files_changed_count": 3,
  "stats": [
    {
      "file": "arch/x86/kvm/pmu.h",
      "insertions": 9,
      "deletions": 0
    },
    {
      "file": "arch/x86/kvm/svm/pmu.c",
      "insertions": 1,
      "deletions": 0
    },
    {
      "file": "arch/x86/kvm/vmx/pmu_intel.c",
      "insertions": 2,
      "deletions": 6
    }
  ],
  "total_insertions": 12,
  "total_deletions": 6,
  "total_changes": 18,
  "parents": [
    "0361bdfddca20c8855ea3bdbbbc9c999912b10ff"
  ],
  "branches": [
    "* development",
    "remotes/origin/HEAD -> origin/master",
    "remotes/origin/master"
  ],
  "tags": [],
  "is_merge": false,
  "security_info": {
    "cve_ids": [],
    "security_keywords": [
      "injection"
    ]
  },
  "fix_type": "security",
  "file_results": [
    {
      "file": "arch/x86/kvm/pmu.h",
      "pre_version": false,
      "post_version": true,
      "patch": true
    },
    {
      "file": "arch/x86/kvm/svm/pmu.c",
      "pre_version": false,
      "post_version": true,
      "patch": true
    },
    {
      "file": "arch/x86/kvm/vmx/pmu_intel.c",
      "pre_version": false,
      "post_version": true,
      "patch": true
    }
  ]
}