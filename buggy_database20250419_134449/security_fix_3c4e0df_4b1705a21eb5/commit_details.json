{
  "hash": "3c4e0dff2095c579b142d5a0693257f1c58b4804",
  "hash_short": "3c4e0dff",
  "subject": "vt: Disable KD_FONT_OP_COPY",
  "body": "It's buggy:\n\nOn Fri, Nov 06, 2020 at 10:30:08PM +0800, Minh Yuan wrote:\n> We recently discovered a slab-out-of-bounds read in fbcon in the latest\n> kernel ( v5.10-rc2 for now ).  The root cause of this vulnerability is that\n> \"fbcon_do_set_font\" did not handle \"vc->vc_font.data\" and\n> \"vc->vc_font.height\" correctly, and the patch\n> <https://lkml.org/lkml/2020/9/27/223> for VT_RESIZEX can't handle this\n> issue.\n>\n> Specifically, we use KD_FONT_OP_SET to set a small font.data for tty6, and\n> use  KD_FONT_OP_SET again to set a large font.height for tty1. After that,\n> we use KD_FONT_OP_COPY to assign tty6's vc_font.data to tty1's vc_font.data\n> in \"fbcon_do_set_font\", while tty1 retains the original larger\n> height. Obviously, this will cause an out-of-bounds read, because we can\n> access a smaller vc_font.data with a larger vc_font.height.\n\nFurther there was only one user ever.\n- Android's loadfont, busybox and console-tools only ever use OP_GET\n  and OP_SET\n- fbset documentation only mentions the kernel cmdline font: option,\n  not anything else.\n- systemd used OP_COPY before release 232 published in Nov 2016\n\nNow unfortunately the crucial report seems to have gone down with\ngmane, and the commit message doesn't say much. But the pull request\nhints at OP_COPY being broken\n\nhttps://github.com/systemd/systemd/pull/3651\n\nSo in other words, this never worked, and the only project which\nfoolishly every tried to use it, realized that rather quickly too.\n\nInstead of trying to fix security issues here on dead code by adding\nmissing checks, fix the entire thing by removing the functionality.\n\nNote that systemd code using the OP_COPY function ignored the return\nvalue, so it doesn't matter what we're doing here really - just in\ncase a lone server somewhere happens to be extremely unlucky and\nrunning an affected old version of systemd. The relevant code from\nfont_copy_to_all_vcs() in systemd was:\n\n\t/* copy font from active VT, where the font was uploaded to */\n\tcfo.op = KD_FONT_OP_COPY;\n\tcfo.height = vcs.v_active-1; /* tty1 == index 0 */\n\t(void) ioctl(vcfd, KDFONTOP, &cfo);\n\nNote this just disables the ioctl, garbage collecting the now unused\ncallbacks is left for -next.\n\nv2: Tetsuo found the old mail, which allowed me to find it on another\narchive. Add the link too.\n\nAcked-by: Peilin Ye <yepeilin.cs@gmail.com>\nReported-by: Minh Yuan <yuanmingbuaa@gmail.com>\nReferences: https://lists.freedesktop.org/archives/systemd-devel/2016-June/036935.html\nReferences: https://github.com/systemd/systemd/pull/3651\nCc: Greg KH <greg@kroah.com>\nCc: Peilin Ye <yepeilin.cs@gmail.com>\nCc: Tetsuo Handa <penguin-kernel@i-love.sakura.ne.jp>\nSigned-off-by: Daniel Vetter <daniel.vetter@intel.com>\nLink: https://lore.kernel.org/r/20201108153806.3140315-1-daniel.vetter@ffwll.ch\nSigned-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>",
  "full_message": "vt: Disable KD_FONT_OP_COPY\n\nIt's buggy:\n\nOn Fri, Nov 06, 2020 at 10:30:08PM +0800, Minh Yuan wrote:\n> We recently discovered a slab-out-of-bounds read in fbcon in the latest\n> kernel ( v5.10-rc2 for now ).  The root cause of this vulnerability is that\n> \"fbcon_do_set_font\" did not handle \"vc->vc_font.data\" and\n> \"vc->vc_font.height\" correctly, and the patch\n> <https://lkml.org/lkml/2020/9/27/223> for VT_RESIZEX can't handle this\n> issue.\n>\n> Specifically, we use KD_FONT_OP_SET to set a small font.data for tty6, and\n> use  KD_FONT_OP_SET again to set a large font.height for tty1. After that,\n> we use KD_FONT_OP_COPY to assign tty6's vc_font.data to tty1's vc_font.data\n> in \"fbcon_do_set_font\", while tty1 retains the original larger\n> height. Obviously, this will cause an out-of-bounds read, because we can\n> access a smaller vc_font.data with a larger vc_font.height.\n\nFurther there was only one user ever.\n- Android's loadfont, busybox and console-tools only ever use OP_GET\n  and OP_SET\n- fbset documentation only mentions the kernel cmdline font: option,\n  not anything else.\n- systemd used OP_COPY before release 232 published in Nov 2016\n\nNow unfortunately the crucial report seems to have gone down with\ngmane, and the commit message doesn't say much. But the pull request\nhints at OP_COPY being broken\n\nhttps://github.com/systemd/systemd/pull/3651\n\nSo in other words, this never worked, and the only project which\nfoolishly every tried to use it, realized that rather quickly too.\n\nInstead of trying to fix security issues here on dead code by adding\nmissing checks, fix the entire thing by removing the functionality.\n\nNote that systemd code using the OP_COPY function ignored the return\nvalue, so it doesn't matter what we're doing here really - just in\ncase a lone server somewhere happens to be extremely unlucky and\nrunning an affected old version of systemd. The relevant code from\nfont_copy_to_all_vcs() in systemd was:\n\n\t/* copy font from active VT, where the font was uploaded to */\n\tcfo.op = KD_FONT_OP_COPY;\n\tcfo.height = vcs.v_active-1; /* tty1 == index 0 */\n\t(void) ioctl(vcfd, KDFONTOP, &cfo);\n\nNote this just disables the ioctl, garbage collecting the now unused\ncallbacks is left for -next.\n\nv2: Tetsuo found the old mail, which allowed me to find it on another\narchive. Add the link too.\n\nAcked-by: Peilin Ye <yepeilin.cs@gmail.com>\nReported-by: Minh Yuan <yuanmingbuaa@gmail.com>\nReferences: https://lists.freedesktop.org/archives/systemd-devel/2016-June/036935.html\nReferences: https://github.com/systemd/systemd/pull/3651\nCc: Greg KH <greg@kroah.com>\nCc: Peilin Ye <yepeilin.cs@gmail.com>\nCc: Tetsuo Handa <penguin-kernel@i-love.sakura.ne.jp>\nSigned-off-by: Daniel Vetter <daniel.vetter@intel.com>\nLink: https://lore.kernel.org/r/20201108153806.3140315-1-daniel.vetter@ffwll.ch\nSigned-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>",
  "author_name": "Daniel Vetter",
  "author_email": "daniel.vetter@ffwll.ch",
  "author_date": "Sun Nov 8 16:38:06 2020 +0100",
  "author_date_iso": "2020-11-08T16:38:06+01:00",
  "committer_name": "Greg Kroah-Hartman",
  "committer_email": "gregkh@linuxfoundation.org",
  "committer_date": "Sun Nov 8 19:35:06 2020 +0100",
  "committer_date_iso": "2020-11-08T19:35:06+01:00",
  "files_changed": [
    "drivers/tty/vt/vt.c"
  ],
  "files_changed_count": 1,
  "stats": [
    {
      "file": "drivers/tty/vt/vt.c",
      "insertions": 2,
      "deletions": 22
    }
  ],
  "total_insertions": 2,
  "total_deletions": 22,
  "total_changes": 24,
  "parents": [
    "4466d6d2f80c1193e0845d110277c56da77a6418"
  ],
  "branches": [
    "* development",
    "remotes/origin/HEAD -> origin/master",
    "remotes/origin/master"
  ],
  "tags": [],
  "is_merge": false,
  "security_info": {
    "cve_ids": [],
    "security_keywords": [
      "vulnerability"
    ]
  },
  "fix_type": "security",
  "file_results": [
    {
      "file": "drivers/tty/vt/vt.c",
      "pre_version": false,
      "post_version": true,
      "patch": true
    }
  ]
}