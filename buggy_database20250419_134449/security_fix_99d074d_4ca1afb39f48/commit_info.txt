Commit Hash: 99d074d6b135ae2927b6130d448f5b7159f8dbe1
Subject: SUNRPC: Check rq_auth_stat when preparing to wrap a response


Security Keywords:
- authentication

Full commit message:
SUNRPC: Check rq_auth_stat when preparing to wrap a response

Commit 5b304bc5bfcc ("[PATCH] knfsd: svcrpc: gss: fix failure on
SVC_DENIED in integrity case") added a check to prevent wrapping an
RPC response if reply_stat == MSG_DENIED, assuming that the only way
to get to svcauth_gss_release() with that reply_stat value was if
the reject_stat was AUTH_ERROR (reject_stat == MISMATCH is handled
earlier in svc_process_common()).

The code there is somewhat confusing. For one thing, rpc_success is
an accept_stat value, not a reply_stat value. The correct reply_stat
value to look for is RPC_MSG_DENIED. It happens to be the same value
as rpc_success, so it all works out, but it's not terribly readable.

Since commit 438623a06bac ("SUNRPC: Add svc_rqst::rq_auth_stat"),
the actual auth_stat value is stored in the svc_rqst, so that value
is now available to svcauth_gss_prepare_to_wrap() to make its
decision to wrap, based on direct information about the
authentication status of the RPC caller.

No behavior change is intended, this simply replaces some old code
with something that should be more self-documenting.

Reviewed-by: Jeff Layton <jlayton@kernel.org>
Signed-off-by: Chuck Lever <chuck.lever@oracle.com>

Metadata:
Author: Chuck Lever <chuck.lever@oracle.com>
Author Date: Sun Jan 8 11:29:26 2023 -0500
Committer: Chuck Lever <chuck.lever@oracle.com>
Commit Date: Mon Feb 20 09:20:25 2023 -0500

Files Changed: 1
Lines Added: 7
Lines Removed: 5
Total Changes: 12
