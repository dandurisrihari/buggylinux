{
  "hash": "6a3edd29395631a010d6760792824a44986e57fe",
  "hash_short": "6a3edd29",
  "subject": "mm: release private data before split THP",
  "body": "If there is private data attached to a THP, the refcount of THP will be\nincreased and will prevent the THP from being split.  Attempt to release\nany private data attached to the THP before attempting the split to\nincrease the chance of splitting successfully.\n\nThere was a memory failure issue hit during HW error injection testing\nwith 5.18 kernel + xfs as rootfs.  The test was killed and a system reboot\nwas required to re-run the test.\n\nThe issue was tracked down to a THP split failure caused by the memory\nfailure not being handled.  The page dump showed:\n\n[ 1785.433075] page:0000000025f9530b refcount:18 mapcount:0 mapping:000000008162eea7 index:0xa10 pfn:0x2f0200\n[ 1785.443954] head:0000000025f9530b order:4 compound_mapcount:0 compound_pincount:0\n[ 1785.452408] memcg:ff4247f2d28e9000\n[ 1785.456304] aops:xfs_address_space_operations ino:8555182 dentry name:\"baseos-filenames.solvx\"\n[ 1785.466612] flags: 0x1000000000012036(referenced|uptodate|lru|active|private|head|node=0|zone=2)\n[ 1785.476514] raw: 1000000000012036 ffb9460f8bc07c08 ffb9460f8bc08408 ff4247f22e6299f8\n[ 1785.485268] raw: 0000000000000a10 ff4247f194ade900 00000012ffffffff ff4247f2d28e9000\n\nIt was like the error was injected to a large folio for xfs with private\ndata attached.\n\nWith private data released before splitting the THP, the test case could\nbe run successfully many times without rebooting the system.\n\nLink: https://lkml.kernel.org/r/20220810064907.582899-1-fengwei.yin@intel.com\nCo-developed-by: Qiuxu Zhuo <qiuxu.zhuo@intel.com>\nSigned-off-by: Qiuxu Zhuo <qiuxu.zhuo@intel.com>\nSigned-off-by: Yin Fengwei <fengwei.yin@intel.com>\nSuggested-by: Matthew Wilcox <willy@infradead.org>\nReviewed-by: Yang Shi <shy828301@gmail.com>\nReviewed-by: Miaohe Lin <linmiaohe@huawei.com>\nReviewed-by: Aaron Lu <aaron.lu@intel.com>\nSigned-off-by: Andrew Morton <akpm@linux-foundation.org>",
  "full_message": "mm: release private data before split THP\n\nIf there is private data attached to a THP, the refcount of THP will be\nincreased and will prevent the THP from being split.  Attempt to release\nany private data attached to the THP before attempting the split to\nincrease the chance of splitting successfully.\n\nThere was a memory failure issue hit during HW error injection testing\nwith 5.18 kernel + xfs as rootfs.  The test was killed and a system reboot\nwas required to re-run the test.\n\nThe issue was tracked down to a THP split failure caused by the memory\nfailure not being handled.  The page dump showed:\n\n[ 1785.433075] page:0000000025f9530b refcount:18 mapcount:0 mapping:000000008162eea7 index:0xa10 pfn:0x2f0200\n[ 1785.443954] head:0000000025f9530b order:4 compound_mapcount:0 compound_pincount:0\n[ 1785.452408] memcg:ff4247f2d28e9000\n[ 1785.456304] aops:xfs_address_space_operations ino:8555182 dentry name:\"baseos-filenames.solvx\"\n[ 1785.466612] flags: 0x1000000000012036(referenced|uptodate|lru|active|private|head|node=0|zone=2)\n[ 1785.476514] raw: 1000000000012036 ffb9460f8bc07c08 ffb9460f8bc08408 ff4247f22e6299f8\n[ 1785.485268] raw: 0000000000000a10 ff4247f194ade900 00000012ffffffff ff4247f2d28e9000\n\nIt was like the error was injected to a large folio for xfs with private\ndata attached.\n\nWith private data released before splitting the THP, the test case could\nbe run successfully many times without rebooting the system.\n\nLink: https://lkml.kernel.org/r/20220810064907.582899-1-fengwei.yin@intel.com\nCo-developed-by: Qiuxu Zhuo <qiuxu.zhuo@intel.com>\nSigned-off-by: Qiuxu Zhuo <qiuxu.zhuo@intel.com>\nSigned-off-by: Yin Fengwei <fengwei.yin@intel.com>\nSuggested-by: Matthew Wilcox <willy@infradead.org>\nReviewed-by: Yang Shi <shy828301@gmail.com>\nReviewed-by: Miaohe Lin <linmiaohe@huawei.com>\nReviewed-by: Aaron Lu <aaron.lu@intel.com>\nSigned-off-by: Andrew Morton <akpm@linux-foundation.org>",
  "author_name": "Yin Fengwei",
  "author_email": "fengwei.yin@intel.com",
  "author_date": "Wed Aug 10 14:49:07 2022 +0800",
  "author_date_iso": "2022-08-10T14:49:07+08:00",
  "committer_name": "Andrew Morton",
  "committer_email": "akpm@linux-foundation.org",
  "committer_date": "Sun Sep 11 20:25:59 2022 -0700",
  "committer_date_iso": "2022-09-11T20:25:59-07:00",
  "files_changed": [
    "mm/huge_memory.c"
  ],
  "files_changed_count": 1,
  "stats": [
    {
      "file": "mm/huge_memory.c",
      "insertions": 12,
      "deletions": 2
    }
  ],
  "total_insertions": 12,
  "total_deletions": 2,
  "total_changes": 14,
  "parents": [
    "c8bb41631bc2ecc6434e93232c031c7a218ebe81"
  ],
  "branches": [
    "* development",
    "remotes/origin/HEAD -> origin/master",
    "remotes/origin/master"
  ],
  "tags": [],
  "is_merge": false,
  "security_info": {
    "cve_ids": [],
    "security_keywords": [
      "injection"
    ]
  },
  "fix_type": "security",
  "file_results": [
    {
      "file": "mm/huge_memory.c",
      "pre_version": true,
      "post_version": true,
      "patch": true
    }
  ]
}