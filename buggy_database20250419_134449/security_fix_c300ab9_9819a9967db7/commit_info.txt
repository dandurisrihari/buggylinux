Commit Hash: c300ab9f08df9e4b9f39d53a0691e234330df124
Subject: KVM: x86: Replace late check_nested_events() hack with more precise fix


Security Keywords:
- injection

Full commit message:
KVM: x86: Replace late check_nested_events() hack with more precise fix

Add an argument to interrupt_allowed and nmi_allowed, to checking if
interrupt injection is blocked.  Use the hook to handle the case where
an interrupt arrives between check_nested_events() and the injection
logic.  Drop the retry of check_nested_events() that hack-a-fixed the
same condition.

Blocking injection is also a bit of a hack, e.g. KVM should do exiting
and non-exiting interrupt processing in a single pass, but it's a more
precise hack.  The old comment is also misleading, e.g. KVM_REQ_EVENT is
purely an optimization, setting it on every run loop (which KVM doesn't
do) should not affect functionality, only performance.

Signed-off-by: Sean Christopherson <sean.j.christopherson@intel.com>
Message-Id: <20200423022550.15113-13-sean.j.christopherson@intel.com>
[Extend to SVM, add SMI and NMI.  Even though NMI and SMI cannot come
 asynchronously right now, making the fix generic is easy and removes a
 special case. - Paolo]
Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>

Metadata:
Author: Paolo Bonzini <pbonzini@redhat.com>
Author Date: Thu Apr 23 14:08:58 2020 -0400
Committer: Paolo Bonzini <pbonzini@redhat.com>
Commit Date: Wed May 13 12:14:49 2020 -0400

Files Changed: 4
Lines Added: 49
Lines Removed: 35
Total Changes: 84
