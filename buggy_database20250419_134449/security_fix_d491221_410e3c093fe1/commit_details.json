{
  "hash": "d4912215d1031e4fb3d1038d2e1857218dba0d0a",
  "hash_short": "d4912215",
  "subject": "KVM: nVMX: Fix exception injection",
  "body": "WARNING: CPU: 3 PID: 2840 at arch/x86/kvm/vmx.c:10966 nested_vmx_vmexit+0xdcd/0xde0 [kvm_intel]\n CPU: 3 PID: 2840 Comm: qemu-system-x86 Tainted: G           OE   4.12.0-rc3+ #23\n RIP: 0010:nested_vmx_vmexit+0xdcd/0xde0 [kvm_intel]\n Call Trace:\n  ? kvm_check_async_pf_completion+0xef/0x120 [kvm]\n  ? rcu_read_lock_sched_held+0x79/0x80\n  vmx_queue_exception+0x104/0x160 [kvm_intel]\n  ? vmx_queue_exception+0x104/0x160 [kvm_intel]\n  kvm_arch_vcpu_ioctl_run+0x1171/0x1ce0 [kvm]\n  ? kvm_arch_vcpu_load+0x47/0x240 [kvm]\n  ? kvm_arch_vcpu_load+0x62/0x240 [kvm]\n  kvm_vcpu_ioctl+0x384/0x7b0 [kvm]\n  ? kvm_vcpu_ioctl+0x384/0x7b0 [kvm]\n  ? __fget+0xf3/0x210\n  do_vfs_ioctl+0xa4/0x700\n  ? __fget+0x114/0x210\n  SyS_ioctl+0x79/0x90\n  do_syscall_64+0x81/0x220\n  entry_SYSCALL64_slow_path+0x25/0x25\n\nThis is triggered occasionally by running both win7 and win2016 in L2, in\naddition, EPT is disabled on both L1 and L2. It can't be reproduced easily.\n\nCommit 0b6ac343fc (KVM: nVMX: Correct handling of exception injection) mentioned\nthat \"KVM wants to inject page-faults which it got to the guest. This function\nassumes it is called with the exit reason in vmcs02 being a #PF exception\".\nCommit e011c663 (KVM: nVMX: Check all exceptions for intercept during delivery to\nL2) allows to check all exceptions for intercept during delivery to L2. However,\nthere is no guarantee the exit reason is exception currently, when there is an\nexternal interrupt occurred on host, maybe a time interrupt for host which should\nnot be injected to guest, and somewhere queues an exception, then the function\nnested_vmx_check_exception() will be called and the vmexit emulation codes will\ntry to emulate the \"Acknowledge interrupt on exit\" behavior, the warning is\ntriggered.\n\nReusing the exit reason from the L2->L0 vmexit is wrong in this case,\nthe reason must always be EXCEPTION_NMI when injecting an exception into\nL1 as a nested vmexit.\n\nCc: Paolo Bonzini <pbonzini@redhat.com>\nCc: Radim Kr\u010dm\u00e1\u0159 <rkrcmar@redhat.com>\nSigned-off-by: Wanpeng Li <wanpeng.li@hotmail.com>\nFixes: e011c663b9c7 (\"KVM: nVMX: Check all exceptions for intercept during delivery to L2\")\nSigned-off-by: Radim Kr\u010dm\u00e1\u0159 <rkrcmar@redhat.com>",
  "full_message": "KVM: nVMX: Fix exception injection\n\n WARNING: CPU: 3 PID: 2840 at arch/x86/kvm/vmx.c:10966 nested_vmx_vmexit+0xdcd/0xde0 [kvm_intel]\n CPU: 3 PID: 2840 Comm: qemu-system-x86 Tainted: G           OE   4.12.0-rc3+ #23\n RIP: 0010:nested_vmx_vmexit+0xdcd/0xde0 [kvm_intel]\n Call Trace:\n  ? kvm_check_async_pf_completion+0xef/0x120 [kvm]\n  ? rcu_read_lock_sched_held+0x79/0x80\n  vmx_queue_exception+0x104/0x160 [kvm_intel]\n  ? vmx_queue_exception+0x104/0x160 [kvm_intel]\n  kvm_arch_vcpu_ioctl_run+0x1171/0x1ce0 [kvm]\n  ? kvm_arch_vcpu_load+0x47/0x240 [kvm]\n  ? kvm_arch_vcpu_load+0x62/0x240 [kvm]\n  kvm_vcpu_ioctl+0x384/0x7b0 [kvm]\n  ? kvm_vcpu_ioctl+0x384/0x7b0 [kvm]\n  ? __fget+0xf3/0x210\n  do_vfs_ioctl+0xa4/0x700\n  ? __fget+0x114/0x210\n  SyS_ioctl+0x79/0x90\n  do_syscall_64+0x81/0x220\n  entry_SYSCALL64_slow_path+0x25/0x25\n\nThis is triggered occasionally by running both win7 and win2016 in L2, in\naddition, EPT is disabled on both L1 and L2. It can't be reproduced easily.\n\nCommit 0b6ac343fc (KVM: nVMX: Correct handling of exception injection) mentioned\nthat \"KVM wants to inject page-faults which it got to the guest. This function\nassumes it is called with the exit reason in vmcs02 being a #PF exception\".\nCommit e011c663 (KVM: nVMX: Check all exceptions for intercept during delivery to\nL2) allows to check all exceptions for intercept during delivery to L2. However,\nthere is no guarantee the exit reason is exception currently, when there is an\nexternal interrupt occurred on host, maybe a time interrupt for host which should\nnot be injected to guest, and somewhere queues an exception, then the function\nnested_vmx_check_exception() will be called and the vmexit emulation codes will\ntry to emulate the \"Acknowledge interrupt on exit\" behavior, the warning is\ntriggered.\n\nReusing the exit reason from the L2->L0 vmexit is wrong in this case,\nthe reason must always be EXCEPTION_NMI when injecting an exception into\nL1 as a nested vmexit.\n\nCc: Paolo Bonzini <pbonzini@redhat.com>\nCc: Radim Kr\u010dm\u00e1\u0159 <rkrcmar@redhat.com>\nSigned-off-by: Wanpeng Li <wanpeng.li@hotmail.com>\nFixes: e011c663b9c7 (\"KVM: nVMX: Check all exceptions for intercept during delivery to L2\")\nSigned-off-by: Radim Kr\u010dm\u00e1\u0159 <rkrcmar@redhat.com>",
  "author_name": "Wanpeng Li",
  "author_email": "wanpeng.li@hotmail.com",
  "author_date": "Mon Jun 5 05:19:09 2017 -0700",
  "author_date_iso": "2017-06-05T05:19:09-07:00",
  "committer_name": "Radim Kr\u010dm\u00e1\u0159",
  "committer_email": "rkrcmar@redhat.com",
  "committer_date": "Tue Jun 6 15:21:50 2017 +0200",
  "committer_date_iso": "2017-06-06T15:21:50+02:00",
  "files_changed": [
    "arch/x86/kvm/vmx.c"
  ],
  "files_changed_count": 1,
  "stats": [
    {
      "file": "arch/x86/kvm/vmx.c",
      "insertions": 1,
      "deletions": 1
    }
  ],
  "total_insertions": 1,
  "total_deletions": 1,
  "total_changes": 2,
  "parents": [
    "bbaf0e2b1c1b4f88abd6ef49576f0efb1734eae5"
  ],
  "branches": [
    "* development",
    "master",
    "remotes/origin/HEAD -> origin/master",
    "remotes/origin/master"
  ],
  "tags": [
    "v4.12",
    "v4.12-rc5",
    "v4.12-rc6",
    "v4.12-rc7",
    "v4.13",
    "v4.13-rc1",
    "v4.13-rc2",
    "v4.13-rc3",
    "v4.13-rc4",
    "v4.13-rc5"
  ],
  "is_merge": false,
  "security_info": {
    "cve_ids": [],
    "security_keywords": [
      "injection"
    ]
  },
  "fix_type": "security",
  "file_results": [
    {
      "file": "arch/x86/kvm/vmx.c",
      "pre_version": false,
      "post_version": true,
      "patch": true
    }
  ]
}