{
  "hash": "6d6e54fc71ad1ab0a87047fd9c211e75d86084a3",
  "hash_short": "6d6e54fc",
  "subject": "aoe: fix the potential use-after-free problem in more places",
  "body": "For fixing CVE-2023-6270, f98364e92662 (\"aoe: fix the potential\nuse-after-free problem in aoecmd_cfg_pkts\") makes tx() calling dev_put()\ninstead of doing in aoecmd_cfg_pkts(). It avoids that the tx() runs\ninto use-after-free.\n\nThen Nicolai Stange found more places in aoe have potential use-after-free\nproblem with tx(). e.g. revalidate(), aoecmd_ata_rw(), resend(), probe()\nand aoecmd_cfg_rsp(). Those functions also use aoenet_xmit() to push\npacket to tx queue. So they should also use dev_hold() to increase the\nrefcnt of skb->dev.\n\nOn the other hand, moving dev_put() to tx() causes that the refcnt of\nskb->dev be reduced to a negative value, because corresponding\ndev_hold() are not called in revalidate(), aoecmd_ata_rw(), resend(),\nprobe(), and aoecmd_cfg_rsp(). This patch fixed this issue.\n\nCc: stable@vger.kernel.org\nLink: https://nvd.nist.gov/vuln/detail/CVE-2023-6270\nFixes: f98364e92662 (\"aoe: fix the potential use-after-free problem in aoecmd_cfg_pkts\")\nReported-by: Nicolai Stange <nstange@suse.com>\nSigned-off-by: Chun-Yi Lee <jlee@suse.com>\nLink: https://lore.kernel.org/stable/20240624064418.27043-1-jlee%40suse.com\nLink: https://lore.kernel.org/r/20241002035458.24401-1-jlee@suse.com\nSigned-off-by: Jens Axboe <axboe@kernel.dk>",
  "full_message": "aoe: fix the potential use-after-free problem in more places\n\nFor fixing CVE-2023-6270, f98364e92662 (\"aoe: fix the potential\nuse-after-free problem in aoecmd_cfg_pkts\") makes tx() calling dev_put()\ninstead of doing in aoecmd_cfg_pkts(). It avoids that the tx() runs\ninto use-after-free.\n\nThen Nicolai Stange found more places in aoe have potential use-after-free\nproblem with tx(). e.g. revalidate(), aoecmd_ata_rw(), resend(), probe()\nand aoecmd_cfg_rsp(). Those functions also use aoenet_xmit() to push\npacket to tx queue. So they should also use dev_hold() to increase the\nrefcnt of skb->dev.\n\nOn the other hand, moving dev_put() to tx() causes that the refcnt of\nskb->dev be reduced to a negative value, because corresponding\ndev_hold() are not called in revalidate(), aoecmd_ata_rw(), resend(),\nprobe(), and aoecmd_cfg_rsp(). This patch fixed this issue.\n\nCc: stable@vger.kernel.org\nLink: https://nvd.nist.gov/vuln/detail/CVE-2023-6270\nFixes: f98364e92662 (\"aoe: fix the potential use-after-free problem in aoecmd_cfg_pkts\")\nReported-by: Nicolai Stange <nstange@suse.com>\nSigned-off-by: Chun-Yi Lee <jlee@suse.com>\nLink: https://lore.kernel.org/stable/20240624064418.27043-1-jlee%40suse.com\nLink: https://lore.kernel.org/r/20241002035458.24401-1-jlee@suse.com\nSigned-off-by: Jens Axboe <axboe@kernel.dk>",
  "author_name": "Chun-Yi Lee",
  "author_email": "joeyli.kernel@gmail.com",
  "author_date": "Wed Oct 2 11:54:58 2024 +0800",
  "author_date_iso": "2024-10-02T11:54:58+08:00",
  "committer_name": "Jens Axboe",
  "committer_email": "axboe@kernel.dk",
  "committer_date": "Wed Oct 2 07:16:44 2024 -0600",
  "committer_date_iso": "2024-10-02T07:16:44-06:00",
  "files_changed": [
    "drivers/block/aoe/aoecmd.c"
  ],
  "files_changed_count": 1,
  "stats": [
    {
      "file": "drivers/block/aoe/aoecmd.c",
      "insertions": 12,
      "deletions": 1
    }
  ],
  "total_insertions": 12,
  "total_deletions": 1,
  "total_changes": 13,
  "parents": [
    "14d57ec3b86369d0037567f12caae0c9e9eaad9e"
  ],
  "branches": [
    "* development",
    "remotes/origin/HEAD -> origin/master",
    "remotes/origin/master"
  ],
  "tags": [],
  "is_merge": false,
  "security_info": {
    "cve_ids": [
      "CVE-2023-6270",
      "CVE-2023-6270"
    ],
    "security_keywords": []
  },
  "fix_type": "cve",
  "file_results": [
    {
      "file": "drivers/block/aoe/aoecmd.c",
      "pre_version": false,
      "post_version": true,
      "patch": true
    }
  ]
}