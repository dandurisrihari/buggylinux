Commit Hash: f563db4bdb8ef5ea73d0f5ea2b20384c10fbd617
Subject: KVM: SVM: fix interrupt injection (apic->isr_count always 0)


Security Keywords:
- injection

Full commit message:
KVM: SVM: fix interrupt injection (apic->isr_count always 0)

In commit b4eef9b36db4, we started to use hwapic_isr_update() != NULL
instead of kvm_apic_vid_enabled(vcpu->kvm).  This didn't work because
SVM had it defined and "apicv" path in apic_{set,clear}_isr() does not
change apic->isr_count, because it should always be 1.  The initial
value of apic->isr_count was based on kvm_apic_vid_enabled(vcpu->kvm),
which is always 0 for SVM, so KVM could have injected interrupts when it
shouldn't.

Fix it by implicitly setting SVM's hwapic_isr_update to NULL and make the
initial isr_count depend on hwapic_isr_update() for good measure.

Fixes: b4eef9b36db4 ("kvm: x86: vmx: NULL out hwapic_isr_update() in case of !enable_apicv")
Reported-and-tested-by: Borislav Petkov <bp@suse.de>
Signed-off-by: Radim Krčmář <rkrcmar@redhat.com>
Signed-off-by: Marcelo Tosatti <mtosatti@redhat.com>

Metadata:
Author: Radim Krčmář <rkrcmar@redhat.com>
Author Date: Fri Feb 27 16:32:38 2015 +0100
Committer: Marcelo Tosatti <mtosatti@redhat.com>
Commit Date: Mon Mar 2 19:04:40 2015 -0300

Files Changed: 2
Lines Added: 2
Lines Removed: 8
Total Changes: 10
