commit ef246a1480cc484cd2aeda75737cb0848616ddf3
Author: Johannes Berg <johannes.berg@intel.com>
Date:   Wed Sep 20 21:25:26 2023 +0300

    wifi: mac80211: support antenna control in injection
    
    Support antenna control for injection by parsing the antenna
    radiotap field (which may be presented multiple times) and
    telling the driver about the resulting antenna bitmap. Of
    course there's no guarantee the driver will actually honour
    this, just like any other injection control.
    
    If misconfigured, i.e. the injected HT/VHT MCS needs more
    chains than antennas are configured, the bitmap is reset to
    zero, indicating no selection.
    
    For now this is only set up for two anntenas so we keep more
    free bits, but that can be trivially extended if any driver
    implements support for it that can deal with hardware with
    more antennas.
    
    Signed-off-by: Johannes Berg <johannes.berg@intel.com>
    Signed-off-by: Gregory Greenman <gregory.greenman@intel.com>
    Link: https://lore.kernel.org/r/20230920211508.f71001aa4da9.I00ccb762a806ea62bc3d728fa3a0d29f4f285eeb@changeid
    Signed-off-by: Johannes Berg <johannes.berg@intel.com>

diff --git a/include/linux/ieee80211.h b/include/linux/ieee80211.h
index f2965ff3d7c1..3b02f038d509 100644
--- a/include/linux/ieee80211.h
+++ b/include/linux/ieee80211.h
@@ -1705,6 +1705,8 @@ struct ieee80211_mcs_info {
 #define		IEEE80211_HT_MCS_TX_MAX_STREAMS	4
 #define IEEE80211_HT_MCS_TX_UNEQUAL_MODULATION	0x10
 
+#define IEEE80211_HT_MCS_CHAINS(mcs) ((mcs) == 32 ? 1 : (1 + ((mcs) >> 3)))
+
 /*
  * 802.11n D5.0 20.3.5 / 20.6 says:
  * - indices 0 to 7 and 32 are single spatial stream