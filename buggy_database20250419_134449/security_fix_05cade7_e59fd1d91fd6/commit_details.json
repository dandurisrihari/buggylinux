{
  "hash": "05cade71cf3b925042569c3e8dc1fa68a2b26995",
  "hash_short": "05cade71",
  "subject": "KVM: nSVM: fix SMI injection in guest mode",
  "body": "Entering SMM while running in guest mode wasn't working very well because several\npieces of the vcpu state were left set up for nested operation.\n\nSome of the issues observed:\n\n* L1 was getting unexpected VM exits (using L1 interception controls but running\n  in SMM execution environment)\n* MMU was confused (walk_mmu was still set to nested_mmu)\n* INTERCEPT_SMI was not emulated for L1 (KVM never injected SVM_EXIT_SMI)\n\nIntel SDM actually prescribes the logical processor to \"leave VMX operation\" upon\nentering SMM in 34.14.1 Default Treatment of SMI Delivery. AMD doesn't seem to\ndocument this but they provide fields in the SMM state-save area to stash the\ncurrent state of SVM. What we need to do is basically get out of guest mode for\nthe duration of SMM. All this completely transparent to L1, i.e. L1 is not given\ncontrol and no L1 observable state changes.\n\nTo avoid code duplication this commit takes advantage of the existing nested\nvmexit and run functionality, perhaps at the cost of efficiency. To get out of\nguest mode, nested_svm_vmexit is called, unchanged. Re-entering is performed using\nenter_svm_guest_mode.\n\nThis commit fixes running Windows Server 2016 with Hyper-V enabled in a VM with\nOVMF firmware (OVMF_CODE-need-smm.fd).\n\nSigned-off-by: Ladi Prosek <lprosek@redhat.com>\nSigned-off-by: Paolo Bonzini <pbonzini@redhat.com>",
  "full_message": "KVM: nSVM: fix SMI injection in guest mode\n\nEntering SMM while running in guest mode wasn't working very well because several\npieces of the vcpu state were left set up for nested operation.\n\nSome of the issues observed:\n\n* L1 was getting unexpected VM exits (using L1 interception controls but running\n  in SMM execution environment)\n* MMU was confused (walk_mmu was still set to nested_mmu)\n* INTERCEPT_SMI was not emulated for L1 (KVM never injected SVM_EXIT_SMI)\n\nIntel SDM actually prescribes the logical processor to \"leave VMX operation\" upon\nentering SMM in 34.14.1 Default Treatment of SMI Delivery. AMD doesn't seem to\ndocument this but they provide fields in the SMM state-save area to stash the\ncurrent state of SVM. What we need to do is basically get out of guest mode for\nthe duration of SMM. All this completely transparent to L1, i.e. L1 is not given\ncontrol and no L1 observable state changes.\n\nTo avoid code duplication this commit takes advantage of the existing nested\nvmexit and run functionality, perhaps at the cost of efficiency. To get out of\nguest mode, nested_svm_vmexit is called, unchanged. Re-entering is performed using\nenter_svm_guest_mode.\n\nThis commit fixes running Windows Server 2016 with Hyper-V enabled in a VM with\nOVMF firmware (OVMF_CODE-need-smm.fd).\n\nSigned-off-by: Ladi Prosek <lprosek@redhat.com>\nSigned-off-by: Paolo Bonzini <pbonzini@redhat.com>",
  "author_name": "Ladi Prosek",
  "author_email": "lprosek@redhat.com",
  "author_date": "Wed Oct 11 16:54:45 2017 +0200",
  "author_date_iso": "2017-10-11T16:54:45+02:00",
  "committer_name": "Paolo Bonzini",
  "committer_email": "pbonzini@redhat.com",
  "committer_date": "Thu Oct 12 14:01:56 2017 +0200",
  "committer_date_iso": "2017-10-12T14:01:56+02:00",
  "files_changed": [
    "arch/x86/include/asm/kvm_host.h",
    "arch/x86/kvm/svm.c",
    "arch/x86/kvm/x86.c"
  ],
  "files_changed_count": 3,
  "stats": [
    {
      "file": "arch/x86/include/asm/kvm_host.h",
      "insertions": 3,
      "deletions": 0
    },
    {
      "file": "arch/x86/kvm/svm.c",
      "insertions": 55,
      "deletions": 3
    },
    {
      "file": "arch/x86/kvm/x86.c",
      "insertions": 0,
      "deletions": 3
    }
  ],
  "total_insertions": 58,
  "total_deletions": 6,
  "total_changes": 64,
  "parents": [
    "c26340651b75d649bea585eba45e32b871188e6e"
  ],
  "branches": [
    "* development",
    "master",
    "remotes/origin/HEAD -> origin/master",
    "remotes/origin/master"
  ],
  "tags": [
    "v4.15",
    "v4.15-rc1",
    "v4.15-rc2",
    "v4.15-rc3",
    "v4.15-rc4",
    "v4.15-rc5",
    "v4.15-rc6",
    "v4.15-rc7",
    "v4.15-rc8",
    "v4.15-rc9"
  ],
  "is_merge": false,
  "security_info": {
    "cve_ids": [],
    "security_keywords": [
      "injection"
    ]
  },
  "fix_type": "security",
  "file_results": [
    {
      "file": "arch/x86/include/asm/kvm_host.h",
      "pre_version": false,
      "post_version": true,
      "patch": true
    },
    {
      "file": "arch/x86/kvm/svm.c",
      "pre_version": true,
      "post_version": true,
      "patch": true
    },
    {
      "file": "arch/x86/kvm/x86.c",
      "pre_version": false,
      "post_version": true,
      "patch": true
    }
  ]
}