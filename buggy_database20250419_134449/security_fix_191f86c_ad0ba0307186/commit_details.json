{
  "hash": "191f86ca8ef27f7a492fd1c03620498c6e94f0ac",
  "hash_short": "191f86ca",
  "subject": "ipv6: sr: fix scheduling in RCU when creating seg6 lwtunnel state",
  "body": "The seg6_build_state() function is called with RCU read lock held,\nso we cannot use GFP_KERNEL. This patch uses GFP_ATOMIC instead.\n\n[   92.770271] =============================\n[   92.770628] WARNING: suspicious RCU usage\n[   92.770921] 4.16.0-rc4+ #12 Not tainted\n[   92.771277] -----------------------------\n[   92.771585] ./include/linux/rcupdate.h:302 Illegal context switch in RCU read-side critical section!\n[   92.772279]\n[   92.772279] other info that might help us debug this:\n[   92.772279]\n[   92.773067]\n[   92.773067] rcu_scheduler_active = 2, debug_locks = 1\n[   92.773514] 2 locks held by ip/2413:\n[   92.773765]  #0:  (rtnl_mutex){+.+.}, at: [<00000000e5461720>] rtnetlink_rcv_msg+0x441/0x4d0\n[   92.774377]  #1:  (rcu_read_lock){....}, at: [<00000000df4f161e>] lwtunnel_build_state+0x59/0x210\n[   92.775065]\n[   92.775065] stack backtrace:\n[   92.775371] CPU: 0 PID: 2413 Comm: ip Not tainted 4.16.0-rc4+ #12\n[   92.775791] Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.10.2-1.fc27 04/01/2014\n[   92.776608] Call Trace:\n[   92.776852]  dump_stack+0x7d/0xbc\n[   92.777130]  __schedule+0x133/0xf00\n[   92.777393]  ? unwind_get_return_address_ptr+0x50/0x50\n[   92.777783]  ? __sched_text_start+0x8/0x8\n[   92.778073]  ? rcu_is_watching+0x19/0x30\n[   92.778383]  ? kernel_text_address+0x49/0x60\n[   92.778800]  ? __kernel_text_address+0x9/0x30\n[   92.779241]  ? unwind_get_return_address+0x29/0x40\n[   92.779727]  ? pcpu_alloc+0x102/0x8f0\n[   92.780101]  _cond_resched+0x23/0x50\n[   92.780459]  __mutex_lock+0xbd/0xad0\n[   92.780818]  ? pcpu_alloc+0x102/0x8f0\n[   92.781194]  ? seg6_build_state+0x11d/0x240\n[   92.781611]  ? save_stack+0x9b/0xb0\n[   92.781965]  ? __ww_mutex_wakeup_for_backoff+0xf0/0xf0\n[   92.782480]  ? seg6_build_state+0x11d/0x240\n[   92.782925]  ? lwtunnel_build_state+0x1bd/0x210\n[   92.783393]  ? ip6_route_info_create+0x687/0x1640\n[   92.783846]  ? ip6_route_add+0x74/0x110\n[   92.784236]  ? inet6_rtm_newroute+0x8a/0xd0\n\nFixes: 6c8702c60b886 (\"ipv6: sr: add support for SRH encapsulation and injection with lwtunnels\")\nSigned-off-by: David Lebrun <dlebrun@google.com>\nSigned-off-by: David S. Miller <davem@davemloft.net>",
  "full_message": "ipv6: sr: fix scheduling in RCU when creating seg6 lwtunnel state\n\nThe seg6_build_state() function is called with RCU read lock held,\nso we cannot use GFP_KERNEL. This patch uses GFP_ATOMIC instead.\n\n[   92.770271] =============================\n[   92.770628] WARNING: suspicious RCU usage\n[   92.770921] 4.16.0-rc4+ #12 Not tainted\n[   92.771277] -----------------------------\n[   92.771585] ./include/linux/rcupdate.h:302 Illegal context switch in RCU read-side critical section!\n[   92.772279]\n[   92.772279] other info that might help us debug this:\n[   92.772279]\n[   92.773067]\n[   92.773067] rcu_scheduler_active = 2, debug_locks = 1\n[   92.773514] 2 locks held by ip/2413:\n[   92.773765]  #0:  (rtnl_mutex){+.+.}, at: [<00000000e5461720>] rtnetlink_rcv_msg+0x441/0x4d0\n[   92.774377]  #1:  (rcu_read_lock){....}, at: [<00000000df4f161e>] lwtunnel_build_state+0x59/0x210\n[   92.775065]\n[   92.775065] stack backtrace:\n[   92.775371] CPU: 0 PID: 2413 Comm: ip Not tainted 4.16.0-rc4+ #12\n[   92.775791] Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.10.2-1.fc27 04/01/2014\n[   92.776608] Call Trace:\n[   92.776852]  dump_stack+0x7d/0xbc\n[   92.777130]  __schedule+0x133/0xf00\n[   92.777393]  ? unwind_get_return_address_ptr+0x50/0x50\n[   92.777783]  ? __sched_text_start+0x8/0x8\n[   92.778073]  ? rcu_is_watching+0x19/0x30\n[   92.778383]  ? kernel_text_address+0x49/0x60\n[   92.778800]  ? __kernel_text_address+0x9/0x30\n[   92.779241]  ? unwind_get_return_address+0x29/0x40\n[   92.779727]  ? pcpu_alloc+0x102/0x8f0\n[   92.780101]  _cond_resched+0x23/0x50\n[   92.780459]  __mutex_lock+0xbd/0xad0\n[   92.780818]  ? pcpu_alloc+0x102/0x8f0\n[   92.781194]  ? seg6_build_state+0x11d/0x240\n[   92.781611]  ? save_stack+0x9b/0xb0\n[   92.781965]  ? __ww_mutex_wakeup_for_backoff+0xf0/0xf0\n[   92.782480]  ? seg6_build_state+0x11d/0x240\n[   92.782925]  ? lwtunnel_build_state+0x1bd/0x210\n[   92.783393]  ? ip6_route_info_create+0x687/0x1640\n[   92.783846]  ? ip6_route_add+0x74/0x110\n[   92.784236]  ? inet6_rtm_newroute+0x8a/0xd0\n\nFixes: 6c8702c60b886 (\"ipv6: sr: add support for SRH encapsulation and injection with lwtunnels\")\nSigned-off-by: David Lebrun <dlebrun@google.com>\nSigned-off-by: David S. Miller <davem@davemloft.net>",
  "author_name": "David Lebrun",
  "author_email": "dlebrun@google.com",
  "author_date": "Tue Mar 20 14:44:55 2018 +0000",
  "author_date_iso": "2018-03-20T14:44:55+00:00",
  "committer_name": "David S. Miller",
  "committer_email": "davem@davemloft.net",
  "committer_date": "Thu Mar 22 12:21:11 2018 -0400",
  "committer_date_iso": "2018-03-22T12:21:11-04:00",
  "files_changed": [
    "net/ipv6/seg6_iptunnel.c"
  ],
  "files_changed_count": 1,
  "stats": [
    {
      "file": "net/ipv6/seg6_iptunnel.c",
      "insertions": 1,
      "deletions": 1
    }
  ],
  "total_insertions": 1,
  "total_deletions": 1,
  "total_changes": 2,
  "parents": [
    "9b894cdd025e8bfe539879839dbb478f47d12c68"
  ],
  "branches": [
    "* development",
    "master",
    "remotes/origin/HEAD -> origin/master",
    "remotes/origin/master"
  ],
  "tags": [
    "v4.16",
    "v4.16-rc7",
    "v4.17",
    "v4.17-rc1",
    "v4.17-rc2",
    "v4.17-rc3",
    "v4.17-rc4",
    "v4.17-rc5",
    "v4.17-rc6",
    "v4.17-rc7"
  ],
  "is_merge": false,
  "security_info": {
    "cve_ids": [],
    "security_keywords": [
      "injection"
    ]
  },
  "fix_type": "security",
  "file_results": [
    {
      "file": "net/ipv6/seg6_iptunnel.c",
      "pre_version": false,
      "post_version": true,
      "patch": true
    }
  ]
}