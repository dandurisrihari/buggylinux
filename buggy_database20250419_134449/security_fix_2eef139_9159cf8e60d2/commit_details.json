{
  "hash": "2eef1399a866c57687962e15142b141a4f8e7862",
  "hash_short": "2eef1399",
  "subject": "modules: fix BUG when load module with rodata=n",
  "body": "When loading a module with rodata=n, it causes an executing\nNX-protected page BUG.\n\n[   32.379191] kernel tried to execute NX-protected page - exploit attempt? (uid: 0)\n[   32.382917] BUG: unable to handle page fault for address: ffffffffc0005000\n[   32.385947] #PF: supervisor instruction fetch in kernel mode\n[   32.387662] #PF: error_code(0x0011) - permissions violation\n[   32.389352] PGD 240c067 P4D 240c067 PUD 240e067 PMD 421a52067 PTE 8000000421a53063\n[   32.391396] Oops: 0011 [#1] SMP PTI\n[   32.392478] CPU: 7 PID: 2697 Comm: insmod Tainted: G           O      5.2.0-rc5+ #202\n[   32.394588] Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS rel-1.12.1-0-ga5cab58e9a3f-prebuilt.qemu.org 04/01/2014\n[   32.398157] RIP: 0010:ko_test_init+0x0/0x1000 [ko_test]\n[   32.399662] Code: Bad RIP value.\n[   32.400621] RSP: 0018:ffffc900029f3ca8 EFLAGS: 00010246\n[   32.402171] RAX: 0000000000000000 RBX: 0000000000000000 RCX: 0000000000000000\n[   32.404332] RDX: 00000000000004c7 RSI: 0000000000000cc0 RDI: ffffffffc0005000\n[   32.406347] RBP: ffffffffc0005000 R08: ffff88842fbebc40 R09: ffffffff810ede4a\n[   32.408392] R10: ffffea00108e3480 R11: 0000000000000000 R12: ffff88842bee21a0\n[   32.410472] R13: 0000000000000001 R14: 0000000000000001 R15: ffffc900029f3e78\n[   32.412609] FS:  00007fb4f0c0a700(0000) GS:ffff88842fbc0000(0000) knlGS:0000000000000000\n[   32.414722] CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033\n[   32.416290] CR2: ffffffffc0004fd6 CR3: 0000000421a90004 CR4: 0000000000020ee0\n[   32.418471] Call Trace:\n[   32.419136]  do_one_initcall+0x41/0x1df\n[   32.420199]  ? _cond_resched+0x10/0x40\n[   32.421433]  ? kmem_cache_alloc_trace+0x36/0x160\n[   32.422827]  do_init_module+0x56/0x1f7\n[   32.423946]  load_module+0x1e67/0x2580\n[   32.424947]  ? __alloc_pages_nodemask+0x150/0x2c0\n[   32.426413]  ? map_vm_area+0x2d/0x40\n[   32.427530]  ? __vmalloc_node_range+0x1ef/0x260\n[   32.428850]  ? __do_sys_init_module+0x135/0x170\n[   32.430060]  ? _cond_resched+0x10/0x40\n[   32.431249]  __do_sys_init_module+0x135/0x170\n[   32.432547]  do_syscall_64+0x43/0x120\n[   32.433853]  entry_SYSCALL_64_after_hwframe+0x44/0xa9\n\nBecause if rodata=n, set_memory_x() can't be called, fix this by\ncalling set_memory_x in complete_formation();\n\nFixes: f2c65fb3221a (\"x86/modules: Avoid breaking W^X while loading modules\")\nSuggested-by: Jian Cheng <cj.chengjian@huawei.com>\nReviewed-by: Nadav Amit <namit@vmware.com>\nSigned-off-by: Yang Yingliang <yangyingliang@huawei.com>\nSigned-off-by: Jessica Yu <jeyu@kernel.org>",
  "full_message": "modules: fix BUG when load module with rodata=n\n\nWhen loading a module with rodata=n, it causes an executing\nNX-protected page BUG.\n\n[   32.379191] kernel tried to execute NX-protected page - exploit attempt? (uid: 0)\n[   32.382917] BUG: unable to handle page fault for address: ffffffffc0005000\n[   32.385947] #PF: supervisor instruction fetch in kernel mode\n[   32.387662] #PF: error_code(0x0011) - permissions violation\n[   32.389352] PGD 240c067 P4D 240c067 PUD 240e067 PMD 421a52067 PTE 8000000421a53063\n[   32.391396] Oops: 0011 [#1] SMP PTI\n[   32.392478] CPU: 7 PID: 2697 Comm: insmod Tainted: G           O      5.2.0-rc5+ #202\n[   32.394588] Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS rel-1.12.1-0-ga5cab58e9a3f-prebuilt.qemu.org 04/01/2014\n[   32.398157] RIP: 0010:ko_test_init+0x0/0x1000 [ko_test]\n[   32.399662] Code: Bad RIP value.\n[   32.400621] RSP: 0018:ffffc900029f3ca8 EFLAGS: 00010246\n[   32.402171] RAX: 0000000000000000 RBX: 0000000000000000 RCX: 0000000000000000\n[   32.404332] RDX: 00000000000004c7 RSI: 0000000000000cc0 RDI: ffffffffc0005000\n[   32.406347] RBP: ffffffffc0005000 R08: ffff88842fbebc40 R09: ffffffff810ede4a\n[   32.408392] R10: ffffea00108e3480 R11: 0000000000000000 R12: ffff88842bee21a0\n[   32.410472] R13: 0000000000000001 R14: 0000000000000001 R15: ffffc900029f3e78\n[   32.412609] FS:  00007fb4f0c0a700(0000) GS:ffff88842fbc0000(0000) knlGS:0000000000000000\n[   32.414722] CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033\n[   32.416290] CR2: ffffffffc0004fd6 CR3: 0000000421a90004 CR4: 0000000000020ee0\n[   32.418471] Call Trace:\n[   32.419136]  do_one_initcall+0x41/0x1df\n[   32.420199]  ? _cond_resched+0x10/0x40\n[   32.421433]  ? kmem_cache_alloc_trace+0x36/0x160\n[   32.422827]  do_init_module+0x56/0x1f7\n[   32.423946]  load_module+0x1e67/0x2580\n[   32.424947]  ? __alloc_pages_nodemask+0x150/0x2c0\n[   32.426413]  ? map_vm_area+0x2d/0x40\n[   32.427530]  ? __vmalloc_node_range+0x1ef/0x260\n[   32.428850]  ? __do_sys_init_module+0x135/0x170\n[   32.430060]  ? _cond_resched+0x10/0x40\n[   32.431249]  __do_sys_init_module+0x135/0x170\n[   32.432547]  do_syscall_64+0x43/0x120\n[   32.433853]  entry_SYSCALL_64_after_hwframe+0x44/0xa9\n\nBecause if rodata=n, set_memory_x() can't be called, fix this by\ncalling set_memory_x in complete_formation();\n\nFixes: f2c65fb3221a (\"x86/modules: Avoid breaking W^X while loading modules\")\nSuggested-by: Jian Cheng <cj.chengjian@huawei.com>\nReviewed-by: Nadav Amit <namit@vmware.com>\nSigned-off-by: Yang Yingliang <yangyingliang@huawei.com>\nSigned-off-by: Jessica Yu <jeyu@kernel.org>",
  "author_name": "Yang Yingliang",
  "author_email": "yangyingliang@huawei.com",
  "author_date": "Thu Jun 20 10:18:14 2019 +0800",
  "author_date_iso": "2019-06-20T10:18:14+08:00",
  "committer_name": "Jessica Yu",
  "committer_email": "jeyu@kernel.org",
  "committer_date": "Mon Jun 24 12:11:41 2019 +0200",
  "committer_date_iso": "2019-06-24T12:11:41+02:00",
  "files_changed": [
    "kernel/module.c"
  ],
  "files_changed_count": 1,
  "stats": [
    {
      "file": "kernel/module.c",
      "insertions": 7,
      "deletions": 4
    }
  ],
  "total_insertions": 7,
  "total_deletions": 4,
  "total_changes": 11,
  "parents": [
    "bc6f2a757d525e001268c3658bd88822e768f8db"
  ],
  "branches": [
    "* development",
    "master",
    "remotes/origin/HEAD -> origin/master",
    "remotes/origin/master"
  ],
  "tags": [
    "v5.3",
    "v5.3-rc1",
    "v5.3-rc2",
    "v5.3-rc3",
    "v5.3-rc4",
    "v5.3-rc5",
    "v5.3-rc6",
    "v5.3-rc7",
    "v5.3-rc8",
    "v5.4"
  ],
  "is_merge": false,
  "security_info": {
    "cve_ids": [],
    "security_keywords": [
      "exploit"
    ]
  },
  "fix_type": "security",
  "file_results": [
    {
      "file": "kernel/module.c",
      "pre_version": true,
      "post_version": true,
      "patch": true
    }
  ]
}