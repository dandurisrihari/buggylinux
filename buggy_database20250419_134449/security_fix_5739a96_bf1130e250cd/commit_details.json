{
  "hash": "5739a961b542530626cb3afb721efa688b290cce",
  "hash_short": "5739a961",
  "subject": "KVM: arm64: Force SRE traps when SRE access is not enabled",
  "body": "We so far only write the ICH_HCR_EL2 config in two situations:\n\n- when we need to emulate the GICv3 CPU interface due to HW bugs\n\n- when we do direct injection, as the virtual CPU interface needs\n  to be enabled\n\nThis is all good. But it also means that we don't do anything special\nwhen we emulate a GICv2, or that there is no GIC at all.\n\nWhat happens in this case when the guest uses the GICv3 system\nregisters? The *guest* gets a trap for a sysreg access (EC=0x18)\nwhile we'd really like it to get an UNDEF.\n\nFixing this is a bit involved:\n\n- we need to set all the required trap bits (TC, TALL0, TALL1, TDIR)\n\n- for these traps to take effect, we need to (counter-intuitively)\n  set ICC_SRE_EL1.SRE to 1 so that the above traps take priority.\n\nNote that doesn't fully work when GICv2 emulation is enabled, as\nwe cannot set ICC_SRE_EL1.SRE to 1 (it breaks Group0 delivery as\nIRQ).\n\nReviewed-by: Oliver Upton <oliver.upton@linux.dev>\nLink: https://lore.kernel.org/r/20240827152517.3909653-3-maz@kernel.org\nSigned-off-by: Marc Zyngier <maz@kernel.org>",
  "full_message": "KVM: arm64: Force SRE traps when SRE access is not enabled\n\nWe so far only write the ICH_HCR_EL2 config in two situations:\n\n- when we need to emulate the GICv3 CPU interface due to HW bugs\n\n- when we do direct injection, as the virtual CPU interface needs\n  to be enabled\n\nThis is all good. But it also means that we don't do anything special\nwhen we emulate a GICv2, or that there is no GIC at all.\n\nWhat happens in this case when the guest uses the GICv3 system\nregisters? The *guest* gets a trap for a sysreg access (EC=0x18)\nwhile we'd really like it to get an UNDEF.\n\nFixing this is a bit involved:\n\n- we need to set all the required trap bits (TC, TALL0, TALL1, TDIR)\n\n- for these traps to take effect, we need to (counter-intuitively)\n  set ICC_SRE_EL1.SRE to 1 so that the above traps take priority.\n\nNote that doesn't fully work when GICv2 emulation is enabled, as\nwe cannot set ICC_SRE_EL1.SRE to 1 (it breaks Group0 delivery as\nIRQ).\n\nReviewed-by: Oliver Upton <oliver.upton@linux.dev>\nLink: https://lore.kernel.org/r/20240827152517.3909653-3-maz@kernel.org\nSigned-off-by: Marc Zyngier <maz@kernel.org>",
  "author_name": "Marc Zyngier",
  "author_email": "maz@kernel.org",
  "author_date": "Tue Aug 27 16:25:08 2024 +0100",
  "author_date_iso": "2024-08-27T16:25:08+01:00",
  "committer_name": "Marc Zyngier",
  "committer_email": "maz@kernel.org",
  "committer_date": "Tue Aug 27 18:32:55 2024 +0100",
  "committer_date_iso": "2024-08-27T18:32:55+01:00",
  "files_changed": [
    "arch/arm64/kvm/hyp/vgic-v3-sr.c",
    "arch/arm64/kvm/vgic/vgic-v3.c"
  ],
  "files_changed_count": 2,
  "stats": [
    {
      "file": "arch/arm64/kvm/hyp/vgic-v3-sr.c",
      "insertions": 16,
      "deletions": 6
    },
    {
      "file": "arch/arm64/kvm/vgic/vgic-v3.c",
      "insertions": 4,
      "deletions": 1
    }
  ],
  "total_insertions": 20,
  "total_deletions": 7,
  "total_changes": 27,
  "parents": [
    "d2137ba8d8fe56cd2470c82b98e494cbcababd76"
  ],
  "branches": [
    "* development",
    "remotes/origin/HEAD -> origin/master",
    "remotes/origin/master"
  ],
  "tags": [],
  "is_merge": false,
  "security_info": {
    "cve_ids": [],
    "security_keywords": [
      "injection"
    ]
  },
  "fix_type": "security",
  "file_results": [
    {
      "file": "arch/arm64/kvm/hyp/vgic-v3-sr.c",
      "pre_version": false,
      "post_version": true,
      "patch": true
    },
    {
      "file": "arch/arm64/kvm/vgic/vgic-v3.c",
      "pre_version": true,
      "post_version": true,
      "patch": true
    }
  ]
}