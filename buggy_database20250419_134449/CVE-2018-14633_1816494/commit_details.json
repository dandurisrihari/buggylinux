{
  "hash": "1816494330a83f2a064499d8ed2797045641f92c",
  "hash_short": "18164943",
  "subject": "scsi: target: iscsi: Use hex2bin instead of a re-implementation",
  "body": "This change has the following effects, in order of descreasing importance:\n\n1) Prevent a stack buffer overflow\n\n2) Do not append an unnecessary NULL to an anyway binary buffer, which\n   is writing one byte past client_digest when caller is:\n   chap_string_to_hex(client_digest, chap_r, strlen(chap_r));\n\nThe latter was found by KASAN (see below) when input value hes expected size\n(32 hex chars), and further analysis revealed a stack buffer overflow can\nhappen when network-received value is longer, allowing an unauthenticated\nremote attacker to smash up to 17 bytes after destination buffer (16 bytes\nattacker-controlled and one null).  As switching to hex2bin requires\nspecifying destination buffer length, and does not internally append any null,\nit solves both issues.\n\nThis addresses CVE-2018-14633.\n\nBeyond this:\n\n- Validate received value length and check hex2bin accepted the input, to log\n  this rejection reason instead of just failing authentication.\n\n- Only log received CHAP_R and CHAP_C values once they passed sanity checks.\n\n==================================================================\nBUG: KASAN: stack-out-of-bounds in chap_string_to_hex+0x32/0x60 [iscsi_target_mod]\nWrite of size 1 at addr ffff8801090ef7c8 by task kworker/0:0/1021\n\nCPU: 0 PID: 1021 Comm: kworker/0:0 Tainted: G           O      4.17.8kasan.sess.connops+ #2\nHardware name: To be filled by O.E.M. To be filled by O.E.M./Aptio CRB, BIOS 5.6.5 05/19/2014\nWorkqueue: events iscsi_target_do_login_rx [iscsi_target_mod]\nCall Trace:\n dump_stack+0x71/0xac\n print_address_description+0x65/0x22e\n ? chap_string_to_hex+0x32/0x60 [iscsi_target_mod]\n kasan_report.cold.6+0x241/0x2fd\n chap_string_to_hex+0x32/0x60 [iscsi_target_mod]\n chap_server_compute_md5.isra.2+0x2cb/0x860 [iscsi_target_mod]\n ? chap_binaryhex_to_asciihex.constprop.5+0x50/0x50 [iscsi_target_mod]\n ? ftrace_caller_op_ptr+0xe/0xe\n ? __orc_find+0x6f/0xc0\n ? unwind_next_frame+0x231/0x850\n ? kthread+0x1a0/0x1c0\n ? ret_from_fork+0x35/0x40\n ? ret_from_fork+0x35/0x40\n ? iscsi_target_do_login_rx+0x3bc/0x4c0 [iscsi_target_mod]\n ? deref_stack_reg+0xd0/0xd0\n ? iscsi_target_do_login_rx+0x3bc/0x4c0 [iscsi_target_mod]\n ? is_module_text_address+0xa/0x11\n ? kernel_text_address+0x4c/0x110\n ? __save_stack_trace+0x82/0x100\n ? ret_from_fork+0x35/0x40\n ? save_stack+0x8c/0xb0\n ? 0xffffffffc1660000\n ? iscsi_target_do_login+0x155/0x8d0 [iscsi_target_mod]\n ? iscsi_target_do_login_rx+0x3bc/0x4c0 [iscsi_target_mod]\n ? process_one_work+0x35c/0x640\n ? worker_thread+0x66/0x5d0\n ? kthread+0x1a0/0x1c0\n ? ret_from_fork+0x35/0x40\n ? iscsi_update_param_value+0x80/0x80 [iscsi_target_mod]\n ? iscsit_release_cmd+0x170/0x170 [iscsi_target_mod]\n chap_main_loop+0x172/0x570 [iscsi_target_mod]\n ? chap_server_compute_md5.isra.2+0x860/0x860 [iscsi_target_mod]\n ? rx_data+0xd6/0x120 [iscsi_target_mod]\n ? iscsit_print_session_params+0xd0/0xd0 [iscsi_target_mod]\n ? cyc2ns_read_begin.part.2+0x90/0x90\n ? _raw_spin_lock_irqsave+0x25/0x50\n ? memcmp+0x45/0x70\n iscsi_target_do_login+0x875/0x8d0 [iscsi_target_mod]\n ? iscsi_target_check_first_request.isra.5+0x1a0/0x1a0 [iscsi_target_mod]\n ? del_timer+0xe0/0xe0\n ? memset+0x1f/0x40\n ? flush_sigqueue+0x29/0xd0\n iscsi_target_do_login_rx+0x3bc/0x4c0 [iscsi_target_mod]\n ? iscsi_target_nego_release+0x80/0x80 [iscsi_target_mod]\n ? iscsi_target_restore_sock_callbacks+0x130/0x130 [iscsi_target_mod]\n process_one_work+0x35c/0x640\n worker_thread+0x66/0x5d0\n ? flush_rcu_work+0x40/0x40\n kthread+0x1a0/0x1c0\n ? kthread_bind+0x30/0x30\n ret_from_fork+0x35/0x40\n\nThe buggy address belongs to the page:\npage:ffffea0004243bc0 count:0 mapcount:0 mapping:0000000000000000 index:0x0\nflags: 0x17fffc000000000()\nraw: 017fffc000000000 0000000000000000 0000000000000000 00000000ffffffff\nraw: ffffea0004243c20 ffffea0004243ba0 0000000000000000 0000000000000000\npage dumped because: kasan: bad access detected\n\nMemory state around the buggy address:\n ffff8801090ef680: f2 f2 f2 f2 f2 f2 f2 01 f2 f2 f2 f2 f2 f2 f2 00\n ffff8801090ef700: f2 f2 f2 f2 f2 f2 f2 00 02 f2 f2 f2 f2 f2 f2 00\n>ffff8801090ef780: 00 f2 f2 f2 f2 f2 f2 00 00 f2 f2 f2 f2 f2 f2 00\n                                              ^\n ffff8801090ef800: 00 f2 f2 f2 f2 f2 f2 00 00 00 00 02 f2 f2 f2 f2\n ffff8801090ef880: f2 f2 f2 00 00 00 00 00 00 00 00 f2 f2 f2 f2 00\n==================================================================\n\nSigned-off-by: Vincent Pelletier <plr.vincent@gmail.com>\nReviewed-by: Mike Christie <mchristi@redhat.com>\nSigned-off-by: Martin K. Petersen <martin.petersen@oracle.com>",
  "full_message": "scsi: target: iscsi: Use hex2bin instead of a re-implementation\n\nThis change has the following effects, in order of descreasing importance:\n\n1) Prevent a stack buffer overflow\n\n2) Do not append an unnecessary NULL to an anyway binary buffer, which\n   is writing one byte past client_digest when caller is:\n   chap_string_to_hex(client_digest, chap_r, strlen(chap_r));\n\nThe latter was found by KASAN (see below) when input value hes expected size\n(32 hex chars), and further analysis revealed a stack buffer overflow can\nhappen when network-received value is longer, allowing an unauthenticated\nremote attacker to smash up to 17 bytes after destination buffer (16 bytes\nattacker-controlled and one null).  As switching to hex2bin requires\nspecifying destination buffer length, and does not internally append any null,\nit solves both issues.\n\nThis addresses CVE-2018-14633.\n\nBeyond this:\n\n- Validate received value length and check hex2bin accepted the input, to log\n  this rejection reason instead of just failing authentication.\n\n- Only log received CHAP_R and CHAP_C values once they passed sanity checks.\n\n==================================================================\nBUG: KASAN: stack-out-of-bounds in chap_string_to_hex+0x32/0x60 [iscsi_target_mod]\nWrite of size 1 at addr ffff8801090ef7c8 by task kworker/0:0/1021\n\nCPU: 0 PID: 1021 Comm: kworker/0:0 Tainted: G           O      4.17.8kasan.sess.connops+ #2\nHardware name: To be filled by O.E.M. To be filled by O.E.M./Aptio CRB, BIOS 5.6.5 05/19/2014\nWorkqueue: events iscsi_target_do_login_rx [iscsi_target_mod]\nCall Trace:\n dump_stack+0x71/0xac\n print_address_description+0x65/0x22e\n ? chap_string_to_hex+0x32/0x60 [iscsi_target_mod]\n kasan_report.cold.6+0x241/0x2fd\n chap_string_to_hex+0x32/0x60 [iscsi_target_mod]\n chap_server_compute_md5.isra.2+0x2cb/0x860 [iscsi_target_mod]\n ? chap_binaryhex_to_asciihex.constprop.5+0x50/0x50 [iscsi_target_mod]\n ? ftrace_caller_op_ptr+0xe/0xe\n ? __orc_find+0x6f/0xc0\n ? unwind_next_frame+0x231/0x850\n ? kthread+0x1a0/0x1c0\n ? ret_from_fork+0x35/0x40\n ? ret_from_fork+0x35/0x40\n ? iscsi_target_do_login_rx+0x3bc/0x4c0 [iscsi_target_mod]\n ? deref_stack_reg+0xd0/0xd0\n ? iscsi_target_do_login_rx+0x3bc/0x4c0 [iscsi_target_mod]\n ? is_module_text_address+0xa/0x11\n ? kernel_text_address+0x4c/0x110\n ? __save_stack_trace+0x82/0x100\n ? ret_from_fork+0x35/0x40\n ? save_stack+0x8c/0xb0\n ? 0xffffffffc1660000\n ? iscsi_target_do_login+0x155/0x8d0 [iscsi_target_mod]\n ? iscsi_target_do_login_rx+0x3bc/0x4c0 [iscsi_target_mod]\n ? process_one_work+0x35c/0x640\n ? worker_thread+0x66/0x5d0\n ? kthread+0x1a0/0x1c0\n ? ret_from_fork+0x35/0x40\n ? iscsi_update_param_value+0x80/0x80 [iscsi_target_mod]\n ? iscsit_release_cmd+0x170/0x170 [iscsi_target_mod]\n chap_main_loop+0x172/0x570 [iscsi_target_mod]\n ? chap_server_compute_md5.isra.2+0x860/0x860 [iscsi_target_mod]\n ? rx_data+0xd6/0x120 [iscsi_target_mod]\n ? iscsit_print_session_params+0xd0/0xd0 [iscsi_target_mod]\n ? cyc2ns_read_begin.part.2+0x90/0x90\n ? _raw_spin_lock_irqsave+0x25/0x50\n ? memcmp+0x45/0x70\n iscsi_target_do_login+0x875/0x8d0 [iscsi_target_mod]\n ? iscsi_target_check_first_request.isra.5+0x1a0/0x1a0 [iscsi_target_mod]\n ? del_timer+0xe0/0xe0\n ? memset+0x1f/0x40\n ? flush_sigqueue+0x29/0xd0\n iscsi_target_do_login_rx+0x3bc/0x4c0 [iscsi_target_mod]\n ? iscsi_target_nego_release+0x80/0x80 [iscsi_target_mod]\n ? iscsi_target_restore_sock_callbacks+0x130/0x130 [iscsi_target_mod]\n process_one_work+0x35c/0x640\n worker_thread+0x66/0x5d0\n ? flush_rcu_work+0x40/0x40\n kthread+0x1a0/0x1c0\n ? kthread_bind+0x30/0x30\n ret_from_fork+0x35/0x40\n\nThe buggy address belongs to the page:\npage:ffffea0004243bc0 count:0 mapcount:0 mapping:0000000000000000 index:0x0\nflags: 0x17fffc000000000()\nraw: 017fffc000000000 0000000000000000 0000000000000000 00000000ffffffff\nraw: ffffea0004243c20 ffffea0004243ba0 0000000000000000 0000000000000000\npage dumped because: kasan: bad access detected\n\nMemory state around the buggy address:\n ffff8801090ef680: f2 f2 f2 f2 f2 f2 f2 01 f2 f2 f2 f2 f2 f2 f2 00\n ffff8801090ef700: f2 f2 f2 f2 f2 f2 f2 00 02 f2 f2 f2 f2 f2 f2 00\n>ffff8801090ef780: 00 f2 f2 f2 f2 f2 f2 00 00 f2 f2 f2 f2 f2 f2 00\n                                              ^\n ffff8801090ef800: 00 f2 f2 f2 f2 f2 f2 00 00 00 00 02 f2 f2 f2 f2\n ffff8801090ef880: f2 f2 f2 00 00 00 00 00 00 00 00 f2 f2 f2 f2 00\n==================================================================\n\nSigned-off-by: Vincent Pelletier <plr.vincent@gmail.com>\nReviewed-by: Mike Christie <mchristi@redhat.com>\nSigned-off-by: Martin K. Petersen <martin.petersen@oracle.com>",
  "author_name": "Vincent Pelletier",
  "author_email": "plr.vincent@gmail.com",
  "author_date": "Sun Sep 9 04:09:26 2018 +0000",
  "author_date_iso": "2018-09-09T04:09:26+00:00",
  "committer_name": "Martin K. Petersen",
  "committer_email": "martin.petersen@oracle.com",
  "committer_date": "Fri Sep 21 12:31:13 2018 -0400",
  "committer_date_iso": "2018-09-21T12:31:13-04:00",
  "files_changed": [
    "drivers/target/iscsi/iscsi_target_auth.c"
  ],
  "files_changed_count": 1,
  "stats": [
    {
      "file": "drivers/target/iscsi/iscsi_target_auth.c",
      "insertions": 14,
      "deletions": 16
    }
  ],
  "total_insertions": 14,
  "total_deletions": 16,
  "total_changes": 30,
  "parents": [
    "9e210178267b80c4eeb832fade7e146a18c84915"
  ],
  "branches": [
    "* development",
    "master",
    "remotes/origin/HEAD -> origin/master",
    "remotes/origin/master"
  ],
  "tags": [
    "v4.19",
    "v4.19-rc6",
    "v4.19-rc7",
    "v4.19-rc8",
    "v4.20",
    "v4.20-rc1",
    "v4.20-rc2",
    "v4.20-rc3",
    "v4.20-rc4",
    "v4.20-rc5"
  ],
  "is_merge": false,
  "security_info": {
    "cve_ids": [
      "CVE-2018-14633"
    ],
    "security_keywords": [
      "authentication"
    ]
  },
  "fix_type": "cve",
  "file_results": [
    {
      "file": "drivers/target/iscsi/iscsi_target_auth.c",
      "pre_version": false,
      "post_version": true,
      "patch": true
    }
  ]
}