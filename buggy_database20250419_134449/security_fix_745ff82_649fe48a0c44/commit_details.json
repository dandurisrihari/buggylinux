{
  "hash": "745ff82199b1d68585040a36f2f8c3a7987274cd",
  "hash_short": "745ff821",
  "subject": "KVM: SVM: Require AP's \"requested\" SEV_FEATURES to match KVM's view",
  "body": "When handling an \"AP Create\" event, return an error if the \"requested\" SEV\nfeatures for the vCPU don't exactly match KVM's view of the VM-scoped\nfeatures.  There is no known use case for heterogeneous SEV features across\nvCPUs, and while KVM can't actually enforce an exact match since the value\nin RAX isn't guaranteed to match what the guest shoved into the VMSA, KVM\ncan at least avoid knowingly letting the guest run in an unsupported state.\n\nE.g. if a VM is created with DebugSwap disabled, KVM will intercept #DBs\nand DRs for all vCPUs, even if an AP is \"created\" with DebugSwap enabled in\nits VMSA.\n\nNote, the GHCB spec only \"requires\" that \"AP use the same interrupt\ninjection mechanism as the BSP\", but given the disaster that is DebugSwap\nand SEV_FEATURES in general, it's safe to say that AMD didn't consider all\npossible complications with mismatching features between the BSP and APs.\n\nOpportunistically fold the check into the relevant request flavors; the\n\"request < AP_DESTROY\" check is just a bizarre way of implementing the\nAP_CREATE_ON_INIT => AP_CREATE fallthrough.\n\nFixes: e366f92ea99e (\"KVM: SEV: Support SEV-SNP AP Creation NAE event\")\nReviewed-by: Tom Lendacky <thomas.lendacky@amd.com>\nReviewed-by: Pankaj Gupta <pankaj.gupta@amd.com>\nLink: https://lore.kernel.org/r/20250227012541.3234589-6-seanjc@google.com\nSigned-off-by: Sean Christopherson <seanjc@google.com>",
  "full_message": "KVM: SVM: Require AP's \"requested\" SEV_FEATURES to match KVM's view\n\nWhen handling an \"AP Create\" event, return an error if the \"requested\" SEV\nfeatures for the vCPU don't exactly match KVM's view of the VM-scoped\nfeatures.  There is no known use case for heterogeneous SEV features across\nvCPUs, and while KVM can't actually enforce an exact match since the value\nin RAX isn't guaranteed to match what the guest shoved into the VMSA, KVM\ncan at least avoid knowingly letting the guest run in an unsupported state.\n\nE.g. if a VM is created with DebugSwap disabled, KVM will intercept #DBs\nand DRs for all vCPUs, even if an AP is \"created\" with DebugSwap enabled in\nits VMSA.\n\nNote, the GHCB spec only \"requires\" that \"AP use the same interrupt\ninjection mechanism as the BSP\", but given the disaster that is DebugSwap\nand SEV_FEATURES in general, it's safe to say that AMD didn't consider all\npossible complications with mismatching features between the BSP and APs.\n\nOpportunistically fold the check into the relevant request flavors; the\n\"request < AP_DESTROY\" check is just a bizarre way of implementing the\nAP_CREATE_ON_INIT => AP_CREATE fallthrough.\n\nFixes: e366f92ea99e (\"KVM: SEV: Support SEV-SNP AP Creation NAE event\")\nReviewed-by: Tom Lendacky <thomas.lendacky@amd.com>\nReviewed-by: Pankaj Gupta <pankaj.gupta@amd.com>\nLink: https://lore.kernel.org/r/20250227012541.3234589-6-seanjc@google.com\nSigned-off-by: Sean Christopherson <seanjc@google.com>",
  "author_name": "Sean Christopherson",
  "author_email": "seanjc@google.com",
  "author_date": "Wed Feb 26 17:25:36 2025 -0800",
  "author_date_iso": "2025-02-26T17:25:36-08:00",
  "committer_name": "Sean Christopherson",
  "committer_email": "seanjc@google.com",
  "committer_date": "Mon Mar 3 07:34:50 2025 -0800",
  "committer_date_iso": "2025-03-03T07:34:50-08:00",
  "files_changed": [
    "arch/x86/include/asm/svm.h",
    "arch/x86/kvm/svm/sev.c"
  ],
  "files_changed_count": 2,
  "stats": [
    {
      "file": "arch/x86/include/asm/svm.h",
      "insertions": 0,
      "deletions": 4
    },
    {
      "file": "arch/x86/kvm/svm/sev.c",
      "insertions": 8,
      "deletions": 15
    }
  ],
  "total_insertions": 8,
  "total_deletions": 19,
  "total_changes": 27,
  "parents": [
    "d26638bfcdfc5c8c4e085dc3f5976a0443abab3c"
  ],
  "branches": [
    "* development",
    "remotes/origin/HEAD -> origin/master",
    "remotes/origin/master"
  ],
  "tags": [],
  "is_merge": false,
  "security_info": {
    "cve_ids": [],
    "security_keywords": [
      "injection"
    ]
  },
  "fix_type": "security",
  "file_results": [
    {
      "file": "arch/x86/include/asm/svm.h",
      "pre_version": false,
      "post_version": true,
      "patch": true
    },
    {
      "file": "arch/x86/kvm/svm/sev.c",
      "pre_version": true,
      "post_version": true,
      "patch": true
    }
  ]
}