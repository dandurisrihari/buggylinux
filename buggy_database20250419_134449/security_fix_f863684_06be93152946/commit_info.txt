Commit Hash: f86368493ec038218e8663cc1b6e5393cd8e008a
Subject: KVM: Fix race between nmi injection and enabling nmi window


Security Keywords:
- injection

Full commit message:
KVM: Fix race between nmi injection and enabling nmi window

The interrupt injection logic looks something like

  if an nmi is pending, and nmi injection allowed
    inject nmi
  if an nmi is pending
    request exit on nmi window

the problem is that "nmi is pending" can be set asynchronously by
the PIT; if it happens to fire between the two if statements, we
will request an nmi window even though nmi injection is allowed.  On
SVM, this has disasterous results, since it causes eflags.TF to be
set in random guest code.

The fix is simple; make nmi_pending synchronous using the standard
vcpu->requests mechanism; this ensures the code above is completely
synchronous wrt nmi_pending.

Signed-off-by: Avi Kivity <avi@redhat.com>

Metadata:
Author: Avi Kivity <avi@redhat.com>
Author Date: Thu Feb 3 15:07:07 2011 +0200
Committer: Marcelo Tosatti <mtosatti@redhat.com>
Commit Date: Thu Mar 17 13:08:30 2011 -0300

Files Changed: 2
Lines Added: 4
Lines Removed: 1
Total Changes: 5
