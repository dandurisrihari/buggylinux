{
  "hash": "0da9dfdd2cd9889201bc6f6f43580c99165cd087",
  "hash_short": "0da9dfdd",
  "subject": "keys: fix race with concurrent install_user_keyrings()",
  "body": "This fixes CVE-2013-1792.\n\nThere is a race in install_user_keyrings() that can cause a NULL pointer\ndereference when called concurrently for the same user if the uid and\nuid-session keyrings are not yet created.  It might be possible for an\nunprivileged user to trigger this by calling keyctl() from userspace in\nparallel immediately after logging in.\n\nAssume that we have two threads both executing lookup_user_key(), both\nlooking for KEY_SPEC_USER_SESSION_KEYRING.\n\n\tTHREAD A\t\t\tTHREAD B\n\t===============================\t===============================\n\t\t\t\t\t==>call install_user_keyrings();\n\tif (!cred->user->session_keyring)\n\t==>call install_user_keyrings()\n\t\t\t\t\t...\n\t\t\t\t\tuser->uid_keyring = uid_keyring;\n\tif (user->uid_keyring)\n\t\treturn 0;\n\t<==\n\tkey = cred->user->session_keyring [== NULL]\n\t\t\t\t\tuser->session_keyring = session_keyring;\n\tatomic_inc(&key->usage); [oops]\n\nAt the point thread A dereferences cred->user->session_keyring, thread B\nhasn't updated user->session_keyring yet, but thread A assumes it is\npopulated because install_user_keyrings() returned ok.\n\nThe race window is really small but can be exploited if, for example,\nthread B is interrupted or preempted after initializing uid_keyring, but\nbefore doing setting session_keyring.\n\nThis couldn't be reproduced on a stock kernel.  However, after placing\nsystemtap probe on 'user->session_keyring = session_keyring;' that\nintroduced some delay, the kernel could be crashed reliably.\n\nFix this by checking both pointers before deciding whether to return.\nAlternatively, the test could be done away with entirely as it is checked\ninside the mutex - but since the mutex is global, that may not be the best\nway.\n\nSigned-off-by: David Howells <dhowells@redhat.com>\nReported-by: Mateusz Guzik <mguzik@redhat.com>\nCc: <stable@kernel.org>\nSigned-off-by: Andrew Morton <akpm@linux-foundation.org>\nSigned-off-by: James Morris <james.l.morris@oracle.com>",
  "full_message": "keys: fix race with concurrent install_user_keyrings()\n\nThis fixes CVE-2013-1792.\n\nThere is a race in install_user_keyrings() that can cause a NULL pointer\ndereference when called concurrently for the same user if the uid and\nuid-session keyrings are not yet created.  It might be possible for an\nunprivileged user to trigger this by calling keyctl() from userspace in\nparallel immediately after logging in.\n\nAssume that we have two threads both executing lookup_user_key(), both\nlooking for KEY_SPEC_USER_SESSION_KEYRING.\n\n\tTHREAD A\t\t\tTHREAD B\n\t===============================\t===============================\n\t\t\t\t\t==>call install_user_keyrings();\n\tif (!cred->user->session_keyring)\n\t==>call install_user_keyrings()\n\t\t\t\t\t...\n\t\t\t\t\tuser->uid_keyring = uid_keyring;\n\tif (user->uid_keyring)\n\t\treturn 0;\n\t<==\n\tkey = cred->user->session_keyring [== NULL]\n\t\t\t\t\tuser->session_keyring = session_keyring;\n\tatomic_inc(&key->usage); [oops]\n\nAt the point thread A dereferences cred->user->session_keyring, thread B\nhasn't updated user->session_keyring yet, but thread A assumes it is\npopulated because install_user_keyrings() returned ok.\n\nThe race window is really small but can be exploited if, for example,\nthread B is interrupted or preempted after initializing uid_keyring, but\nbefore doing setting session_keyring.\n\nThis couldn't be reproduced on a stock kernel.  However, after placing\nsystemtap probe on 'user->session_keyring = session_keyring;' that\nintroduced some delay, the kernel could be crashed reliably.\n\nFix this by checking both pointers before deciding whether to return.\nAlternatively, the test could be done away with entirely as it is checked\ninside the mutex - but since the mutex is global, that may not be the best\nway.\n\nSigned-off-by: David Howells <dhowells@redhat.com>\nReported-by: Mateusz Guzik <mguzik@redhat.com>\nCc: <stable@kernel.org>\nSigned-off-by: Andrew Morton <akpm@linux-foundation.org>\nSigned-off-by: James Morris <james.l.morris@oracle.com>",
  "author_name": "David Howells",
  "author_email": "dhowells@redhat.com",
  "author_date": "Tue Mar 12 16:44:31 2013 +1100",
  "author_date_iso": "2013-03-12T16:44:31+11:00",
  "committer_name": "James Morris",
  "committer_email": "james.l.morris@oracle.com",
  "committer_date": "Tue Mar 12 16:44:31 2013 +1100",
  "committer_date_iso": "2013-03-12T16:44:31+11:00",
  "files_changed": [
    "security/keys/process_keys.c"
  ],
  "files_changed_count": 1,
  "stats": [
    {
      "file": "security/keys/process_keys.c",
      "insertions": 1,
      "deletions": 1
    }
  ],
  "total_insertions": 1,
  "total_deletions": 1,
  "total_changes": 2,
  "parents": [
    "7c6baa304b841673d3a55ea4fcf9a5cbf7a1674b"
  ],
  "branches": [
    "* development",
    "master",
    "remotes/origin/HEAD -> origin/master",
    "remotes/origin/master"
  ],
  "tags": [
    "v3.10",
    "v3.10-rc1",
    "v3.10-rc2",
    "v3.10-rc3",
    "v3.10-rc4",
    "v3.10-rc5",
    "v3.10-rc6",
    "v3.10-rc7",
    "v3.11",
    "v3.11-rc1"
  ],
  "is_merge": false,
  "security_info": {
    "cve_ids": [
      "CVE-2013-1792"
    ],
    "security_keywords": []
  },
  "fix_type": "cve",
  "file_results": [
    {
      "file": "security/keys/process_keys.c",
      "pre_version": false,
      "post_version": true,
      "patch": true
    }
  ]
}