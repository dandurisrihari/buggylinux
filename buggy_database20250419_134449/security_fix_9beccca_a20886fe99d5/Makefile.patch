commit 9beccca0984022a844850e32f0d7dd80d4a225de
Author: Ard Biesheuvel <ardb@kernel.org>
Date:   Thu Oct 27 17:59:07 2022 +0200

    scs: add support for dynamic shadow call stacks
    
    In order to allow arches to use code patching to conditionally emit the
    shadow stack pushes and pops, rather than always taking the performance
    hit even on CPUs that implement alternatives such as stack pointer
    authentication on arm64, add a Kconfig symbol that can be set by the
    arch to omit the SCS codegen itself, without otherwise affecting how
    support code for SCS and compiler options (for register reservation, for
    instance) are emitted.
    
    Also, add a static key and some plumbing to omit the allocation of
    shadow call stack for dynamic SCS configurations if SCS is disabled at
    runtime.
    
    Signed-off-by: Ard Biesheuvel <ardb@kernel.org>
    Reviewed-by: Nick Desaulniers <ndesaulniers@google.com>
    Reviewed-by: Kees Cook <keescook@chromium.org>
    Reviewed-by: Sami Tolvanen <samitolvanen@google.com>
    Tested-by: Sami Tolvanen <samitolvanen@google.com>
    Link: https://lore.kernel.org/r/20221027155908.1940624-3-ardb@kernel.org
    Signed-off-by: Will Deacon <will@kernel.org>

diff --git a/Makefile b/Makefile
index ac2ec990422d..69b40b629f3c 100644
--- a/Makefile
+++ b/Makefile
@@ -966,8 +966,10 @@ LDFLAGS_vmlinux += --gc-sections
 endif
 
 ifdef CONFIG_SHADOW_CALL_STACK
+ifndef CONFIG_DYNAMIC_SCS
 CC_FLAGS_SCS	:= -fsanitize=shadow-call-stack
 KBUILD_CFLAGS	+= $(CC_FLAGS_SCS)
+endif
 export CC_FLAGS_SCS
 endif