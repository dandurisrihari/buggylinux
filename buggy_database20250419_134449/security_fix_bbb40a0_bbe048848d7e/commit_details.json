{
  "hash": "bbb40a0b75209734ff9286f3326171638c9f6569",
  "hash_short": "bbb40a0b",
  "subject": "ipv6: sr: fix memory OOB access in seg6_do_srh_encap/inline",
  "body": "seg6_do_srh_encap and seg6_do_srh_inline can possibly do an\nout-of-bounds access when adding the SRH to the packet. This no longer\nhappen when expanding the skb not only by the size of the SRH (+\nouter IPv6 header), but also by skb->mac_len.\n\n[   53.793056] BUG: KASAN: use-after-free in seg6_do_srh_encap+0x284/0x620\n[   53.794564] Write of size 14 at addr ffff88011975ecfa by task ping/674\n\n[   53.796665] CPU: 0 PID: 674 Comm: ping Not tainted 4.17.0-rc3-ARCH+ #90\n[   53.796670] Hardware name: QEMU Standard PC (i440FX + PIIX, 1996),\nBIOS 1.11.0-20171110_100015-anatol 04/01/2014\n[   53.796673] Call Trace:\n[   53.796679]  <IRQ>\n[   53.796689]  dump_stack+0x71/0xab\n[   53.796700]  print_address_description+0x6a/0x270\n[   53.796707]  kasan_report+0x258/0x380\n[   53.796715]  ? seg6_do_srh_encap+0x284/0x620\n[   53.796722]  memmove+0x34/0x50\n[   53.796730]  seg6_do_srh_encap+0x284/0x620\n[   53.796741]  ? seg6_do_srh+0x29b/0x360\n[   53.796747]  seg6_do_srh+0x29b/0x360\n[   53.796756]  seg6_input+0x2e/0x2e0\n[   53.796765]  lwtunnel_input+0x93/0xd0\n[   53.796774]  ipv6_rcv+0x690/0x920\n[   53.796783]  ? ip6_input+0x170/0x170\n[   53.796791]  ? eth_gro_receive+0x2d0/0x2d0\n[   53.796800]  ? ip6_input+0x170/0x170\n[   53.796809]  __netif_receive_skb_core+0xcc0/0x13f0\n[   53.796820]  ? netdev_info+0x110/0x110\n[   53.796827]  ? napi_complete_done+0xb6/0x170\n[   53.796834]  ? e1000_clean+0x6da/0xf70\n[   53.796845]  ? process_backlog+0x129/0x2a0\n[   53.796853]  process_backlog+0x129/0x2a0\n[   53.796862]  net_rx_action+0x211/0x5c0\n[   53.796870]  ? napi_complete_done+0x170/0x170\n[   53.796887]  ? run_rebalance_domains+0x11f/0x150\n[   53.796891]  __do_softirq+0x10e/0x39e\n[   53.796894]  do_softirq_own_stack+0x2a/0x40\n[   53.796895]  </IRQ>\n[   53.796898]  do_softirq.part.16+0x54/0x60\n[   53.796900]  __local_bh_enable_ip+0x5b/0x60\n[   53.796903]  ip6_finish_output2+0x416/0x9f0\n[   53.796906]  ? ip6_dst_lookup_flow+0x110/0x110\n[   53.796909]  ? ip6_sk_dst_lookup_flow+0x390/0x390\n[   53.796911]  ? __rcu_read_unlock+0x66/0x80\n[   53.796913]  ? ip6_mtu+0x44/0xf0\n[   53.796916]  ? ip6_output+0xfc/0x220\n[   53.796918]  ip6_output+0xfc/0x220\n[   53.796921]  ? ip6_finish_output+0x2b0/0x2b0\n[   53.796923]  ? memcpy+0x34/0x50\n[   53.796926]  ip6_send_skb+0x43/0xc0\n[   53.796929]  rawv6_sendmsg+0x1216/0x1530\n[   53.796932]  ? __orc_find+0x6b/0xc0\n[   53.796934]  ? rawv6_rcv_skb+0x160/0x160\n[   53.796937]  ? __rcu_read_unlock+0x66/0x80\n[   53.796939]  ? __rcu_read_unlock+0x66/0x80\n[   53.796942]  ? is_bpf_text_address+0x1e/0x30\n[   53.796944]  ? kernel_text_address+0xec/0x100\n[   53.796946]  ? __kernel_text_address+0xe/0x30\n[   53.796948]  ? unwind_get_return_address+0x2f/0x50\n[   53.796950]  ? __save_stack_trace+0x92/0x100\n[   53.796954]  ? save_stack+0x89/0xb0\n[   53.796956]  ? kasan_kmalloc+0xa0/0xd0\n[   53.796958]  ? kmem_cache_alloc+0xd2/0x1f0\n[   53.796961]  ? prepare_creds+0x23/0x160\n[   53.796963]  ? __x64_sys_capset+0x252/0x3e0\n[   53.796966]  ? do_syscall_64+0x69/0x160\n[   53.796968]  ? entry_SYSCALL_64_after_hwframe+0x44/0xa9\n[   53.796971]  ? __alloc_pages_nodemask+0x170/0x380\n[   53.796973]  ? __alloc_pages_slowpath+0x12c0/0x12c0\n[   53.796977]  ? tty_vhangup+0x20/0x20\n[   53.796979]  ? policy_nodemask+0x1a/0x90\n[   53.796982]  ? __mod_node_page_state+0x8d/0xa0\n[   53.796986]  ? __check_object_size+0xe7/0x240\n[   53.796989]  ? __sys_sendto+0x229/0x290\n[   53.796991]  ? rawv6_rcv_skb+0x160/0x160\n[   53.796993]  __sys_sendto+0x229/0x290\n[   53.796996]  ? __ia32_sys_getpeername+0x50/0x50\n[   53.796999]  ? commit_creds+0x2de/0x520\n[   53.797002]  ? security_capset+0x57/0x70\n[   53.797004]  ? __x64_sys_capset+0x29f/0x3e0\n[   53.797007]  ? __x64_sys_rt_sigsuspend+0xe0/0xe0\n[   53.797011]  ? __do_page_fault+0x664/0x770\n[   53.797014]  __x64_sys_sendto+0x74/0x90\n[   53.797017]  do_syscall_64+0x69/0x160\n[   53.797019]  entry_SYSCALL_64_after_hwframe+0x44/0xa9\n[   53.797022] RIP: 0033:0x7f43b7a6714a\n[   53.797023] RSP: 002b:00007ffd891bd368 EFLAGS: 00000246 ORIG_RAX:\n000000000000002c\n[   53.797026] RAX: ffffffffffffffda RBX: 00000000006129c0 RCX: 00007f43b7a6714a\n[   53.797028] RDX: 0000000000000040 RSI: 00000000006129c0 RDI: 0000000000000004\n[   53.797029] RBP: 00007ffd891be640 R08: 0000000000610940 R09: 000000000000001c\n[   53.797030] R10: 0000000000000000 R11: 0000000000000246 R12: 0000000000000040\n[   53.797032] R13: 000000000060e6a0 R14: 0000000000008004 R15: 000000000040b661\n\n[   53.797171] Allocated by task 642:\n[   53.797460]  kasan_kmalloc+0xa0/0xd0\n[   53.797463]  kmem_cache_alloc+0xd2/0x1f0\n[   53.797465]  getname_flags+0x40/0x210\n[   53.797467]  user_path_at_empty+0x1d/0x40\n[   53.797469]  do_faccessat+0x12a/0x320\n[   53.797471]  do_syscall_64+0x69/0x160\n[   53.797473]  entry_SYSCALL_64_after_hwframe+0x44/0xa9\n\n[   53.797607] Freed by task 642:\n[   53.797869]  __kasan_slab_free+0x130/0x180\n[   53.797871]  kmem_cache_free+0xa8/0x230\n[   53.797872]  filename_lookup+0x15b/0x230\n[   53.797874]  do_faccessat+0x12a/0x320\n[   53.797876]  do_syscall_64+0x69/0x160\n[   53.797878]  entry_SYSCALL_64_after_hwframe+0x44/0xa9\n\n[   53.798014] The buggy address belongs to the object at ffff88011975e600\n                which belongs to the cache names_cache of size 4096\n[   53.799043] The buggy address is located 1786 bytes inside of\n                4096-byte region [ffff88011975e600, ffff88011975f600)\n[   53.800013] The buggy address belongs to the page:\n[   53.800414] page:ffffea000465d600 count:1 mapcount:0\nmapping:0000000000000000 index:0x0 compound_mapcount: 0\n[   53.801259] flags: 0x17fff0000008100(slab|head)\n[   53.801640] raw: 017fff0000008100 0000000000000000 0000000000000000\n0000000100070007\n[   53.803147] raw: dead000000000100 dead000000000200 ffff88011b185a40\n0000000000000000\n[   53.803787] page dumped because: kasan: bad access detected\n\n[   53.804384] Memory state around the buggy address:\n[   53.804788]  ffff88011975eb80: fb fb fb fb fb fb fb fb fb fb fb fb\nfb fb fb fb\n[   53.805384]  ffff88011975ec00: fb fb fb fb fb fb fb fb fb fb fb fb\nfb fb fb fb\n[   53.805979] >ffff88011975ec80: fb fb fb fb fb fb fb fb fb fb fb fb\nfb fb fb fb\n[   53.806577]                                                                 ^\n[   53.807165]  ffff88011975ed00: fb fb fb fb fb fb fb fb fb fb fb fb\nfb fb fb fb\n[   53.807762]  ffff88011975ed80: fb fb fb fb fb fb fb fb fb fb fb fb\nfb fb fb fb\n[   53.808356] ==================================================================\n[   53.808949] Disabling lock debugging due to kernel taint\n\nFixes: 6c8702c60b88 (\"ipv6: sr: add support for SRH encapsulation and injection with lwtunnels\")\nSigned-off-by: David Lebrun <dlebrun@google.com>\nSigned-off-by: Mathieu Xhonneux <m.xhonneux@gmail.com>\nSigned-off-by: David S. Miller <davem@davemloft.net>",
  "full_message": "ipv6: sr: fix memory OOB access in seg6_do_srh_encap/inline\n\nseg6_do_srh_encap and seg6_do_srh_inline can possibly do an\nout-of-bounds access when adding the SRH to the packet. This no longer\nhappen when expanding the skb not only by the size of the SRH (+\nouter IPv6 header), but also by skb->mac_len.\n\n[   53.793056] BUG: KASAN: use-after-free in seg6_do_srh_encap+0x284/0x620\n[   53.794564] Write of size 14 at addr ffff88011975ecfa by task ping/674\n\n[   53.796665] CPU: 0 PID: 674 Comm: ping Not tainted 4.17.0-rc3-ARCH+ #90\n[   53.796670] Hardware name: QEMU Standard PC (i440FX + PIIX, 1996),\nBIOS 1.11.0-20171110_100015-anatol 04/01/2014\n[   53.796673] Call Trace:\n[   53.796679]  <IRQ>\n[   53.796689]  dump_stack+0x71/0xab\n[   53.796700]  print_address_description+0x6a/0x270\n[   53.796707]  kasan_report+0x258/0x380\n[   53.796715]  ? seg6_do_srh_encap+0x284/0x620\n[   53.796722]  memmove+0x34/0x50\n[   53.796730]  seg6_do_srh_encap+0x284/0x620\n[   53.796741]  ? seg6_do_srh+0x29b/0x360\n[   53.796747]  seg6_do_srh+0x29b/0x360\n[   53.796756]  seg6_input+0x2e/0x2e0\n[   53.796765]  lwtunnel_input+0x93/0xd0\n[   53.796774]  ipv6_rcv+0x690/0x920\n[   53.796783]  ? ip6_input+0x170/0x170\n[   53.796791]  ? eth_gro_receive+0x2d0/0x2d0\n[   53.796800]  ? ip6_input+0x170/0x170\n[   53.796809]  __netif_receive_skb_core+0xcc0/0x13f0\n[   53.796820]  ? netdev_info+0x110/0x110\n[   53.796827]  ? napi_complete_done+0xb6/0x170\n[   53.796834]  ? e1000_clean+0x6da/0xf70\n[   53.796845]  ? process_backlog+0x129/0x2a0\n[   53.796853]  process_backlog+0x129/0x2a0\n[   53.796862]  net_rx_action+0x211/0x5c0\n[   53.796870]  ? napi_complete_done+0x170/0x170\n[   53.796887]  ? run_rebalance_domains+0x11f/0x150\n[   53.796891]  __do_softirq+0x10e/0x39e\n[   53.796894]  do_softirq_own_stack+0x2a/0x40\n[   53.796895]  </IRQ>\n[   53.796898]  do_softirq.part.16+0x54/0x60\n[   53.796900]  __local_bh_enable_ip+0x5b/0x60\n[   53.796903]  ip6_finish_output2+0x416/0x9f0\n[   53.796906]  ? ip6_dst_lookup_flow+0x110/0x110\n[   53.796909]  ? ip6_sk_dst_lookup_flow+0x390/0x390\n[   53.796911]  ? __rcu_read_unlock+0x66/0x80\n[   53.796913]  ? ip6_mtu+0x44/0xf0\n[   53.796916]  ? ip6_output+0xfc/0x220\n[   53.796918]  ip6_output+0xfc/0x220\n[   53.796921]  ? ip6_finish_output+0x2b0/0x2b0\n[   53.796923]  ? memcpy+0x34/0x50\n[   53.796926]  ip6_send_skb+0x43/0xc0\n[   53.796929]  rawv6_sendmsg+0x1216/0x1530\n[   53.796932]  ? __orc_find+0x6b/0xc0\n[   53.796934]  ? rawv6_rcv_skb+0x160/0x160\n[   53.796937]  ? __rcu_read_unlock+0x66/0x80\n[   53.796939]  ? __rcu_read_unlock+0x66/0x80\n[   53.796942]  ? is_bpf_text_address+0x1e/0x30\n[   53.796944]  ? kernel_text_address+0xec/0x100\n[   53.796946]  ? __kernel_text_address+0xe/0x30\n[   53.796948]  ? unwind_get_return_address+0x2f/0x50\n[   53.796950]  ? __save_stack_trace+0x92/0x100\n[   53.796954]  ? save_stack+0x89/0xb0\n[   53.796956]  ? kasan_kmalloc+0xa0/0xd0\n[   53.796958]  ? kmem_cache_alloc+0xd2/0x1f0\n[   53.796961]  ? prepare_creds+0x23/0x160\n[   53.796963]  ? __x64_sys_capset+0x252/0x3e0\n[   53.796966]  ? do_syscall_64+0x69/0x160\n[   53.796968]  ? entry_SYSCALL_64_after_hwframe+0x44/0xa9\n[   53.796971]  ? __alloc_pages_nodemask+0x170/0x380\n[   53.796973]  ? __alloc_pages_slowpath+0x12c0/0x12c0\n[   53.796977]  ? tty_vhangup+0x20/0x20\n[   53.796979]  ? policy_nodemask+0x1a/0x90\n[   53.796982]  ? __mod_node_page_state+0x8d/0xa0\n[   53.796986]  ? __check_object_size+0xe7/0x240\n[   53.796989]  ? __sys_sendto+0x229/0x290\n[   53.796991]  ? rawv6_rcv_skb+0x160/0x160\n[   53.796993]  __sys_sendto+0x229/0x290\n[   53.796996]  ? __ia32_sys_getpeername+0x50/0x50\n[   53.796999]  ? commit_creds+0x2de/0x520\n[   53.797002]  ? security_capset+0x57/0x70\n[   53.797004]  ? __x64_sys_capset+0x29f/0x3e0\n[   53.797007]  ? __x64_sys_rt_sigsuspend+0xe0/0xe0\n[   53.797011]  ? __do_page_fault+0x664/0x770\n[   53.797014]  __x64_sys_sendto+0x74/0x90\n[   53.797017]  do_syscall_64+0x69/0x160\n[   53.797019]  entry_SYSCALL_64_after_hwframe+0x44/0xa9\n[   53.797022] RIP: 0033:0x7f43b7a6714a\n[   53.797023] RSP: 002b:00007ffd891bd368 EFLAGS: 00000246 ORIG_RAX:\n000000000000002c\n[   53.797026] RAX: ffffffffffffffda RBX: 00000000006129c0 RCX: 00007f43b7a6714a\n[   53.797028] RDX: 0000000000000040 RSI: 00000000006129c0 RDI: 0000000000000004\n[   53.797029] RBP: 00007ffd891be640 R08: 0000000000610940 R09: 000000000000001c\n[   53.797030] R10: 0000000000000000 R11: 0000000000000246 R12: 0000000000000040\n[   53.797032] R13: 000000000060e6a0 R14: 0000000000008004 R15: 000000000040b661\n\n[   53.797171] Allocated by task 642:\n[   53.797460]  kasan_kmalloc+0xa0/0xd0\n[   53.797463]  kmem_cache_alloc+0xd2/0x1f0\n[   53.797465]  getname_flags+0x40/0x210\n[   53.797467]  user_path_at_empty+0x1d/0x40\n[   53.797469]  do_faccessat+0x12a/0x320\n[   53.797471]  do_syscall_64+0x69/0x160\n[   53.797473]  entry_SYSCALL_64_after_hwframe+0x44/0xa9\n\n[   53.797607] Freed by task 642:\n[   53.797869]  __kasan_slab_free+0x130/0x180\n[   53.797871]  kmem_cache_free+0xa8/0x230\n[   53.797872]  filename_lookup+0x15b/0x230\n[   53.797874]  do_faccessat+0x12a/0x320\n[   53.797876]  do_syscall_64+0x69/0x160\n[   53.797878]  entry_SYSCALL_64_after_hwframe+0x44/0xa9\n\n[   53.798014] The buggy address belongs to the object at ffff88011975e600\n                which belongs to the cache names_cache of size 4096\n[   53.799043] The buggy address is located 1786 bytes inside of\n                4096-byte region [ffff88011975e600, ffff88011975f600)\n[   53.800013] The buggy address belongs to the page:\n[   53.800414] page:ffffea000465d600 count:1 mapcount:0\nmapping:0000000000000000 index:0x0 compound_mapcount: 0\n[   53.801259] flags: 0x17fff0000008100(slab|head)\n[   53.801640] raw: 017fff0000008100 0000000000000000 0000000000000000\n0000000100070007\n[   53.803147] raw: dead000000000100 dead000000000200 ffff88011b185a40\n0000000000000000\n[   53.803787] page dumped because: kasan: bad access detected\n\n[   53.804384] Memory state around the buggy address:\n[   53.804788]  ffff88011975eb80: fb fb fb fb fb fb fb fb fb fb fb fb\nfb fb fb fb\n[   53.805384]  ffff88011975ec00: fb fb fb fb fb fb fb fb fb fb fb fb\nfb fb fb fb\n[   53.805979] >ffff88011975ec80: fb fb fb fb fb fb fb fb fb fb fb fb\nfb fb fb fb\n[   53.806577]                                                                 ^\n[   53.807165]  ffff88011975ed00: fb fb fb fb fb fb fb fb fb fb fb fb\nfb fb fb fb\n[   53.807762]  ffff88011975ed80: fb fb fb fb fb fb fb fb fb fb fb fb\nfb fb fb fb\n[   53.808356] ==================================================================\n[   53.808949] Disabling lock debugging due to kernel taint\n\nFixes: 6c8702c60b88 (\"ipv6: sr: add support for SRH encapsulation and injection with lwtunnels\")\nSigned-off-by: David Lebrun <dlebrun@google.com>\nSigned-off-by: Mathieu Xhonneux <m.xhonneux@gmail.com>\nSigned-off-by: David S. Miller <davem@davemloft.net>",
  "author_name": "Mathieu Xhonneux",
  "author_email": "m.xhonneux@gmail.com",
  "author_date": "Fri May 25 13:29:41 2018 +0100",
  "author_date_iso": "2018-05-25T13:29:41+01:00",
  "committer_name": "David S. Miller",
  "committer_email": "davem@davemloft.net",
  "committer_date": "Mon May 28 23:09:49 2018 -0400",
  "committer_date_iso": "2018-05-28T23:09:49-04:00",
  "files_changed": [
    "net/ipv6/seg6_iptunnel.c"
  ],
  "files_changed_count": 1,
  "stats": [
    {
      "file": "net/ipv6/seg6_iptunnel.c",
      "insertions": 2,
      "deletions": 2
    }
  ],
  "total_insertions": 2,
  "total_deletions": 2,
  "total_changes": 4,
  "parents": [
    "513acc5b746b8b86eb4f97efe2d874fd3087ff99"
  ],
  "branches": [
    "* development",
    "master",
    "remotes/origin/HEAD -> origin/master",
    "remotes/origin/master"
  ],
  "tags": [
    "v4.17",
    "v4.18",
    "v4.18-rc1",
    "v4.18-rc2",
    "v4.18-rc3",
    "v4.18-rc4",
    "v4.18-rc5",
    "v4.18-rc6",
    "v4.18-rc7",
    "v4.18-rc8"
  ],
  "is_merge": false,
  "security_info": {
    "cve_ids": [],
    "security_keywords": [
      "injection"
    ]
  },
  "fix_type": "security",
  "file_results": [
    {
      "file": "net/ipv6/seg6_iptunnel.c",
      "pre_version": false,
      "post_version": true,
      "patch": true
    }
  ]
}