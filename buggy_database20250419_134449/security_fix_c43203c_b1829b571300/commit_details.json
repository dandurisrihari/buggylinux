{
  "hash": "c43203cab1e2e193c43f8295f01dfb2a0721d9e5",
  "hash_short": "c43203ca",
  "subject": "KVM: x86: avoid simultaneous queueing of both IRQ and SMI",
  "body": "If the processor exits to KVM while delivering an interrupt,\nthe hypervisor then requeues the interrupt for the next vmentry.\nTrying to enter SMM in this same window causes to enter non-root\nmode in emulated SMM (i.e. with IF=0) and with a request to\ninject an IRQ (i.e. with a valid VM-entry interrupt info field).\nThis is invalid guest state (SDM 26.3.1.4 \"Check on Guest RIP\nand RFLAGS\") and the processor fails vmentry.\n\nThe fix is to defer the injection from KVM_REQ_SMI to KVM_REQ_EVENT,\nlike we already do for e.g. NMIs.  This patch doesn't change the\nname of the process_smi function so that it can be applied to\nstable releases.  The next patch will modify the names so that\nprocess_nmi and process_smi handle respectively KVM_REQ_NMI and\nKVM_REQ_SMI.\n\nThis is especially common with Windows, probably due to the\nself-IPI trick that it uses to deliver deferred procedure\ncalls (DPCs).\n\nReported-by: Laszlo Ersek <lersek@redhat.com>\nReported-by: Micha\u0142 Zegan <webczat_200@poczta.onet.pl>\nFixes: 64d6067057d9658acb8675afcfba549abdb7fc16\nCc: stable@vger.kernel.org\nSigned-off-by: Paolo Bonzini <pbonzini@redhat.com>\nSigned-off-by: Radim Kr\u010dm\u00e1\u0159 <rkrcmar@redhat.com>",
  "full_message": "KVM: x86: avoid simultaneous queueing of both IRQ and SMI\n\nIf the processor exits to KVM while delivering an interrupt,\nthe hypervisor then requeues the interrupt for the next vmentry.\nTrying to enter SMM in this same window causes to enter non-root\nmode in emulated SMM (i.e. with IF=0) and with a request to\ninject an IRQ (i.e. with a valid VM-entry interrupt info field).\nThis is invalid guest state (SDM 26.3.1.4 \"Check on Guest RIP\nand RFLAGS\") and the processor fails vmentry.\n\nThe fix is to defer the injection from KVM_REQ_SMI to KVM_REQ_EVENT,\nlike we already do for e.g. NMIs.  This patch doesn't change the\nname of the process_smi function so that it can be applied to\nstable releases.  The next patch will modify the names so that\nprocess_nmi and process_smi handle respectively KVM_REQ_NMI and\nKVM_REQ_SMI.\n\nThis is especially common with Windows, probably due to the\nself-IPI trick that it uses to deliver deferred procedure\ncalls (DPCs).\n\nReported-by: Laszlo Ersek <lersek@redhat.com>\nReported-by: Micha\u0142 Zegan <webczat_200@poczta.onet.pl>\nFixes: 64d6067057d9658acb8675afcfba549abdb7fc16\nCc: stable@vger.kernel.org\nSigned-off-by: Paolo Bonzini <pbonzini@redhat.com>\nSigned-off-by: Radim Kr\u010dm\u00e1\u0159 <rkrcmar@redhat.com>",
  "author_name": "Paolo Bonzini",
  "author_email": "pbonzini@redhat.com",
  "author_date": "Wed Jun 1 22:26:00 2016 +0200",
  "author_date_iso": "2016-06-01T22:26:00+02:00",
  "committer_name": "Radim Kr\u010dm\u00e1\u0159",
  "committer_email": "rkrcmar@redhat.com",
  "committer_date": "Fri Jun 3 15:28:19 2016 +0200",
  "committer_date_iso": "2016-06-03T15:28:19+02:00",
  "files_changed": [
    "arch/x86/kvm/x86.c"
  ],
  "files_changed_count": 1,
  "stats": [
    {
      "file": "arch/x86/kvm/x86.c",
      "insertions": 29,
      "deletions": 16
    }
  ],
  "total_insertions": 29,
  "total_deletions": 16,
  "total_changes": 45,
  "parents": [
    "4340fa55298d17049e71c7a34e04647379c269f3"
  ],
  "branches": [
    "* development",
    "master",
    "remotes/origin/HEAD -> origin/master",
    "remotes/origin/master"
  ],
  "tags": [
    "v4.10",
    "v4.10-rc1",
    "v4.10-rc2",
    "v4.10-rc3",
    "v4.10-rc4",
    "v4.10-rc5",
    "v4.10-rc6",
    "v4.10-rc7",
    "v4.10-rc8",
    "v4.11"
  ],
  "is_merge": false,
  "security_info": {
    "cve_ids": [],
    "security_keywords": [
      "inject"
    ]
  },
  "fix_type": "security",
  "file_results": [
    {
      "file": "arch/x86/kvm/x86.c",
      "pre_version": false,
      "post_version": true,
      "patch": true
    }
  ]
}