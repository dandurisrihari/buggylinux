{
  "hash": "87be949912eedb73690d8eaeb086f24bfe17438d",
  "hash_short": "87be9499",
  "subject": "Merge tag 'xfs-6.2-merge-8' of git://git.kernel.org/pub/scm/fs/xfs/xfs-linux",
  "body": "Pull XFS updates from Darrick Wong:\n \"The highlight of this is a batch of fixes for the online metadata\n  checking code as we start the loooong march towards merging online\n  repair. I aim to merge that in time for the 2023 LTS.\n\n  There are also a large number of data corruption and race condition\n  fixes in this patchset. Most notably fixed are write() calls to\n  unwritten extents racing with writeback, which required some late(r\n  than I prefer) code changes to iomap to support the necessary\n  revalidations. I don't really like iomap changes going in past -rc4,\n  but Dave and I have been working on it long enough that I chose to\n  push it for 6.2 anyway.\n\n  There are also a number of other subtle problems fixed, including the\n  log racing with inode writeback to write inodes with incorrect link\n  count to disk; file data mapping corruptions as a result of incorrect\n  lock cycling when attaching dquots; refcount metadata corruption if\n  one actually manages to share a block 2^32 times; and the log\n  clobbering cow staging extents if they were formerly metadata blocks.\n\n  Summary:\n\n   - Fix a race condition w.r.t. percpu inode free counters\n\n   - Fix a broken error return in xfs_remove\n\n   - Print FS UUID at mount/unmount time\n\n   - Numerous fixes to the online fsck code\n\n   - Fix inode locking inconsistency problems when dealing with realtime\n     metadata files\n\n   - Actually merge pull requests so that we capture the cover letter\n     contents\n\n   - Fix a race between rebuilding VFS inode state and the AIL flushing\n     inodes that could cause corrupt inodes to be written to the\n     filesystem\n\n   - Fix a data corruption problem resulting from a write() to an\n     unwritten extent racing with writeback started on behalf of memory\n     reclaim changing the extent state\n\n   - Add debugging knobs so that we can test iomap invalidation\n\n   - Fix the blockdev pagecache contents being stale after unmounting\n     the filesystem, leading to spurious xfs_db errors and corrupt\n     metadumps\n\n   - Fix a file mapping corruption bug due to ilock cycling when\n     attaching dquots to a file during delalloc reservation\n\n   - Fix a refcount btree corruption problem due to the refcount\n     adjustment code not handling MAXREFCOUNT correctly, resulting in\n     unnecessary record splits\n\n   - Fix COW staging extent alloctions not being classified as USERDATA,\n     which results in filestreams being ignored and possible data\n     corruption if the allocation was filled from the AGFL and the block\n     buffer is still being tracked in the AIL\n\n   - Fix new duplicated includes\n\n   - Fix a race between the dquot shrinker and dquot freeing that could\n     cause a UAF\"\n\n* tag 'xfs-6.2-merge-8' of git://git.kernel.org/pub/scm/fs/xfs/xfs-linux: (50 commits)\n  xfs: dquot shrinker doesn't check for XFS_DQFLAG_FREEING\n  xfs: Remove duplicated include in xfs_iomap.c\n  xfs: invalidate xfs_bufs when allocating cow extents\n  xfs: get rid of assert from xfs_btree_islastblock\n  xfs: estimate post-merge refcounts correctly\n  xfs: hoist refcount record merge predicates\n  xfs: fix super block buf log item UAF during force shutdown\n  xfs: wait iclog complete before tearing down AIL\n  xfs: attach dquots to inode before reading data/cow fork mappings\n  xfs: shut up -Wuninitialized in xfsaild_push\n  xfs: use memcpy, not strncpy, to format the attr prefix during listxattr\n  xfs: invalidate block device page cache during unmount\n  xfs: add debug knob to slow down write for fun\n  xfs: add debug knob to slow down writeback for fun\n  xfs: drop write error injection is unfixable, remove it\n  xfs: use iomap_valid method to detect stale cached iomaps\n  iomap: write iomap validity checks\n  xfs: xfs_bmap_punch_delalloc_range() should take a byte range\n  iomap: buffered write failure should not truncate the page cache\n  xfs,iomap: move delalloc punching to iomap\n  ...",
  "full_message": "Merge tag 'xfs-6.2-merge-8' of git://git.kernel.org/pub/scm/fs/xfs/xfs-linux\n\nPull XFS updates from Darrick Wong:\n \"The highlight of this is a batch of fixes for the online metadata\n  checking code as we start the loooong march towards merging online\n  repair. I aim to merge that in time for the 2023 LTS.\n\n  There are also a large number of data corruption and race condition\n  fixes in this patchset. Most notably fixed are write() calls to\n  unwritten extents racing with writeback, which required some late(r\n  than I prefer) code changes to iomap to support the necessary\n  revalidations. I don't really like iomap changes going in past -rc4,\n  but Dave and I have been working on it long enough that I chose to\n  push it for 6.2 anyway.\n\n  There are also a number of other subtle problems fixed, including the\n  log racing with inode writeback to write inodes with incorrect link\n  count to disk; file data mapping corruptions as a result of incorrect\n  lock cycling when attaching dquots; refcount metadata corruption if\n  one actually manages to share a block 2^32 times; and the log\n  clobbering cow staging extents if they were formerly metadata blocks.\n\n  Summary:\n\n   - Fix a race condition w.r.t. percpu inode free counters\n\n   - Fix a broken error return in xfs_remove\n\n   - Print FS UUID at mount/unmount time\n\n   - Numerous fixes to the online fsck code\n\n   - Fix inode locking inconsistency problems when dealing with realtime\n     metadata files\n\n   - Actually merge pull requests so that we capture the cover letter\n     contents\n\n   - Fix a race between rebuilding VFS inode state and the AIL flushing\n     inodes that could cause corrupt inodes to be written to the\n     filesystem\n\n   - Fix a data corruption problem resulting from a write() to an\n     unwritten extent racing with writeback started on behalf of memory\n     reclaim changing the extent state\n\n   - Add debugging knobs so that we can test iomap invalidation\n\n   - Fix the blockdev pagecache contents being stale after unmounting\n     the filesystem, leading to spurious xfs_db errors and corrupt\n     metadumps\n\n   - Fix a file mapping corruption bug due to ilock cycling when\n     attaching dquots to a file during delalloc reservation\n\n   - Fix a refcount btree corruption problem due to the refcount\n     adjustment code not handling MAXREFCOUNT correctly, resulting in\n     unnecessary record splits\n\n   - Fix COW staging extent alloctions not being classified as USERDATA,\n     which results in filestreams being ignored and possible data\n     corruption if the allocation was filled from the AGFL and the block\n     buffer is still being tracked in the AIL\n\n   - Fix new duplicated includes\n\n   - Fix a race between the dquot shrinker and dquot freeing that could\n     cause a UAF\"\n\n* tag 'xfs-6.2-merge-8' of git://git.kernel.org/pub/scm/fs/xfs/xfs-linux: (50 commits)\n  xfs: dquot shrinker doesn't check for XFS_DQFLAG_FREEING\n  xfs: Remove duplicated include in xfs_iomap.c\n  xfs: invalidate xfs_bufs when allocating cow extents\n  xfs: get rid of assert from xfs_btree_islastblock\n  xfs: estimate post-merge refcounts correctly\n  xfs: hoist refcount record merge predicates\n  xfs: fix super block buf log item UAF during force shutdown\n  xfs: wait iclog complete before tearing down AIL\n  xfs: attach dquots to inode before reading data/cow fork mappings\n  xfs: shut up -Wuninitialized in xfsaild_push\n  xfs: use memcpy, not strncpy, to format the attr prefix during listxattr\n  xfs: invalidate block device page cache during unmount\n  xfs: add debug knob to slow down write for fun\n  xfs: add debug knob to slow down writeback for fun\n  xfs: drop write error injection is unfixable, remove it\n  xfs: use iomap_valid method to detect stale cached iomaps\n  iomap: write iomap validity checks\n  xfs: xfs_bmap_punch_delalloc_range() should take a byte range\n  iomap: buffered write failure should not truncate the page cache\n  xfs,iomap: move delalloc punching to iomap\n  ...",
  "author_name": "Linus Torvalds",
  "author_email": "torvalds@linux-foundation.org",
  "author_date": "Wed Dec 14 10:11:51 2022 -0800",
  "author_date_iso": "2022-12-14T10:11:51-08:00",
  "committer_name": "Linus Torvalds",
  "committer_email": "torvalds@linux-foundation.org",
  "committer_date": "Wed Dec 14 10:11:51 2022 -0800",
  "committer_date_iso": "2022-12-14T10:11:51-08:00",
  "files_changed": [
    "fs/xfs/xfs_error.c",
    "fs/xfs/xfs_iomap.c"
  ],
  "files_changed_count": 2,
  "stats": [
    {
      "file": "fs/iomap/buffered-io.c",
      "insertions": 253,
      "deletions": 1
    },
    {
      "file": "fs/iomap/iter.c",
      "insertions": 18,
      "deletions": 1
    },
    {
      "file": "fs/xfs/libxfs/xfs_bmap.c",
      "insertions": 5,
      "deletions": 3
    },
    {
      "file": "fs/xfs/libxfs/xfs_btree.h",
      "insertions": 0,
      "deletions": 1
    },
    {
      "file": "fs/xfs/libxfs/xfs_errortag.h",
      "insertions": 10,
      "deletions": 8
    },
    {
      "file": "fs/xfs/libxfs/xfs_refcount.c",
      "insertions": 130,
      "deletions": 16
    },
    {
      "file": "fs/xfs/libxfs/xfs_sb.c",
      "insertions": 3,
      "deletions": 1
    },
    {
      "file": "fs/xfs/scrub/agheader.c",
      "insertions": 29,
      "deletions": 18
    },
    {
      "file": "fs/xfs/scrub/agheader_repair.c",
      "insertions": 67,
      "deletions": 14
    },
    {
      "file": "fs/xfs/scrub/attr.c",
      "insertions": 5,
      "deletions": 6
    },
    {
      "file": "fs/xfs/scrub/bitmap.c",
      "insertions": 6,
      "deletions": 5
    },
    {
      "file": "fs/xfs/scrub/bmap.c",
      "insertions": 119,
      "deletions": 28
    },
    {
      "file": "fs/xfs/scrub/btree.c",
      "insertions": 8,
      "deletions": 6
    },
    {
      "file": "fs/xfs/scrub/common.c",
      "insertions": 34,
      "deletions": 14
    },
    {
      "file": "fs/xfs/scrub/common.h",
      "insertions": 1,
      "deletions": 1
    },
    {
      "file": "fs/xfs/scrub/dabtree.c",
      "insertions": 2,
      "deletions": 2
    },
    {
      "file": "fs/xfs/scrub/dir.c",
      "insertions": 6,
      "deletions": 4
    },
    {
      "file": "fs/xfs/scrub/fscounters.c",
      "insertions": 105,
      "deletions": 4
    },
    {
      "file": "fs/xfs/scrub/inode.c",
      "insertions": 1,
      "deletions": 1
    },
    {
      "file": "fs/xfs/scrub/quota.c",
      "insertions": 5,
      "deletions": 3
    },
    {
      "file": "fs/xfs/scrub/refcount.c",
      "insertions": 6,
      "deletions": 6
    },
    {
      "file": "fs/xfs/scrub/repair.c",
      "insertions": 34,
      "deletions": 17
    },
    {
      "file": "fs/xfs/scrub/scrub.c",
      "insertions": 3,
      "deletions": 3
    },
    {
      "file": "fs/xfs/scrub/scrub.h",
      "insertions": 9,
      "deletions": 9
    },
    {
      "file": "fs/xfs/scrub/symlink.c",
      "insertions": 1,
      "deletions": 1
    },
    {
      "file": "fs/xfs/xfs_aops.c",
      "insertions": 19,
      "deletions": 13
    },
    {
      "file": "fs/xfs/xfs_bmap_util.c",
      "insertions": 6,
      "deletions": 4
    },
    {
      "file": "fs/xfs/xfs_bmap_util.h",
      "insertions": 1,
      "deletions": 1
    },
    {
      "file": "fs/xfs/xfs_buf.c",
      "insertions": 1,
      "deletions": 0
    },
    {
      "file": "fs/xfs/xfs_buf_item.c",
      "insertions": 2,
      "deletions": 0
    },
    {
      "file": "fs/xfs/xfs_error.c",
      "insertions": 39,
      "deletions": 7
    },
    {
      "file": "fs/xfs/xfs_error.h",
      "insertions": 13,
      "deletions": 0
    },
    {
      "file": "fs/xfs/xfs_file.c",
      "insertions": 1,
      "deletions": 1
    },
    {
      "file": "fs/xfs/xfs_fsmap.c",
      "insertions": 2,
      "deletions": 2
    },
    {
      "file": "fs/xfs/xfs_icache.c",
      "insertions": 6,
      "deletions": 0
    },
    {
      "file": "fs/xfs/xfs_inode.c",
      "insertions": 1,
      "deletions": 1
    },
    {
      "file": "fs/xfs/xfs_iomap.c",
      "insertions": 114,
      "deletions": 71
    },
    {
      "file": "fs/xfs/xfs_iomap.h",
      "insertions": 4,
      "deletions": 2
    },
    {
      "file": "fs/xfs/xfs_log.c",
      "insertions": 31,
      "deletions": 15
    },
    {
      "file": "fs/xfs/xfs_mount.c",
      "insertions": 15,
      "deletions": 0
    },
    {
      "file": "fs/xfs/xfs_pnfs.c",
      "insertions": 4,
      "deletions": 2
    },
    {
      "file": "fs/xfs/xfs_qm.c",
      "insertions": 12,
      "deletions": 4
    },
    {
      "file": "fs/xfs/xfs_rtalloc.c",
      "insertions": 54,
      "deletions": 6
    },
    {
      "file": "fs/xfs/xfs_super.c",
      "insertions": 1,
      "deletions": 1
    },
    {
      "file": "fs/xfs/xfs_trace.c",
      "insertions": 2,
      "deletions": 0
    },
    {
      "file": "fs/xfs/xfs_trace.h",
      "insertions": 86,
      "deletions": 0
    },
    {
      "file": "fs/xfs/xfs_trans_ail.c",
      "insertions": 3,
      "deletions": 1
    },
    {
      "file": "fs/xfs/xfs_xattr.c",
      "insertions": 1,
      "deletions": 1
    },
    {
      "file": "include/linux/iomap.h",
      "insertions": 39,
      "deletions": 8
    }
  ],
  "total_insertions": 1317,
  "total_deletions": 313,
  "total_changes": 1630,
  "parents": [
    "c7020e1b346d5840e93b58cc4f2c67fc645d8df9",
    "52f31ed228212ba572c44e15e818a3a5c74122c0"
  ],
  "branches": [
    "* development",
    "remotes/origin/HEAD -> origin/master",
    "remotes/origin/master"
  ],
  "tags": [],
  "is_merge": true,
  "security_info": {
    "cve_ids": [],
    "security_keywords": [
      "injection"
    ]
  },
  "fix_type": "security",
  "file_results": [
    {
      "file": "fs/xfs/xfs_error.c",
      "pre_version": false,
      "post_version": true,
      "patch": true
    },
    {
      "file": "fs/xfs/xfs_iomap.c",
      "pre_version": false,
      "post_version": true,
      "patch": true
    }
  ]
}