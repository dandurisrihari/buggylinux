Commit Hash: 5787fcaab9eb5930f5378d6a1dd03d916d146622
Subject: nilfs2: fix missing cleanup on rollforward recovery error


Security Keywords:
- injection

Full commit message:
nilfs2: fix missing cleanup on rollforward recovery error

In an error injection test of a routine for mount-time recovery, KASAN
found a use-after-free bug.

It turned out that if data recovery was performed using partial logs
created by dsync writes, but an error occurred before starting the log
writer to create a recovered checkpoint, the inodes whose data had been
recovered were left in the ns_dirty_files list of the nilfs object and
were not freed.

Fix this issue by cleaning up inodes that have read the recovery data if
the recovery routine fails midway before the log writer starts.

Link: https://lkml.kernel.org/r/20240810065242.3701-1-konishi.ryusuke@gmail.com
Fixes: 0f3e1c7f23f8 ("nilfs2: recovery functions")
Signed-off-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Tested-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>

Metadata:
Author: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Author Date: Sat Aug 10 15:52:42 2024 +0900
Committer: Andrew Morton <akpm@linux-foundation.org>
Commit Date: Sun Sep 1 17:59:00 2024 -0700

Files Changed: 1
Lines Added: 33
Lines Removed: 2
Total Changes: 35
