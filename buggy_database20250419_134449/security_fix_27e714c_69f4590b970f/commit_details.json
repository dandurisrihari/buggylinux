{
  "hash": "27e714c007e4ad01837bf0fac5c11913a38d7695",
  "hash_short": "27e714c0",
  "subject": "ext2: unbugger ext2_empty_dir()",
  "body": "In 27cfa258951a \"ext2: fix fs corruption when trying to remove\na non-empty directory with IO error\" a funny thing has happened:\n\n-               page = ext2_get_page(inode, i, dir_has_error, &page_addr);\n+               page = ext2_get_page(inode, i, 0, &page_addr);\n\n -               if (IS_ERR(page)) {\n -                       dir_has_error = 1;\n -                       continue;\n -               }\n +               if (IS_ERR(page))\n +                       goto not_empty;\n\nAnd at not_empty: we hit ext2_put_page(page, page_addr), which does\nput_page(page).  Which, unless I'm very mistaken, should oops\nimmediately when given ERR_PTR(-E...) as page.\n\nOK, shit happens, insufficiently tested patches included.  But when\ncommit in question describes the fault-injection test that exercised\nthat particular failure exit...\n\nOw.\n\nCC: stable@vger.kernel.org\nFixes: 27cfa258951a (\"ext2: fix fs corruption when trying to remove a non-empty directory with IO error\")\nSigned-off-by: Al Viro <viro@zeniv.linux.org.uk>\nSigned-off-by: Jan Kara <jack@suse.cz>",
  "full_message": "ext2: unbugger ext2_empty_dir()\n\nIn 27cfa258951a \"ext2: fix fs corruption when trying to remove\na non-empty directory with IO error\" a funny thing has happened:\n\n-               page = ext2_get_page(inode, i, dir_has_error, &page_addr);\n+               page = ext2_get_page(inode, i, 0, &page_addr);\n\n -               if (IS_ERR(page)) {\n -                       dir_has_error = 1;\n -                       continue;\n -               }\n +               if (IS_ERR(page))\n +                       goto not_empty;\n\nAnd at not_empty: we hit ext2_put_page(page, page_addr), which does\nput_page(page).  Which, unless I'm very mistaken, should oops\nimmediately when given ERR_PTR(-E...) as page.\n\nOK, shit happens, insufficiently tested patches included.  But when\ncommit in question describes the fault-injection test that exercised\nthat particular failure exit...\n\nOw.\n\nCC: stable@vger.kernel.org\nFixes: 27cfa258951a (\"ext2: fix fs corruption when trying to remove a non-empty directory with IO error\")\nSigned-off-by: Al Viro <viro@zeniv.linux.org.uk>\nSigned-off-by: Jan Kara <jack@suse.cz>",
  "author_name": "Al Viro",
  "author_email": "viro@zeniv.linux.org.uk",
  "author_date": "Sat Nov 26 03:17:17 2022 +0000",
  "author_date_iso": "2022-11-26T03:17:17+00:00",
  "committer_name": "Jan Kara",
  "committer_email": "jack@suse.cz",
  "committer_date": "Mon Nov 28 11:41:43 2022 +0100",
  "committer_date_iso": "2022-11-28T11:41:43+01:00",
  "files_changed": [
    "fs/ext2/dir.c"
  ],
  "files_changed_count": 1,
  "stats": [
    {
      "file": "fs/ext2/dir.c",
      "insertions": 1,
      "deletions": 1
    }
  ],
  "total_insertions": 1,
  "total_deletions": 1,
  "total_changes": 2,
  "parents": [
    "36273e5b4e3a934c6d346c8f0b16b97e018094af"
  ],
  "branches": [
    "* development",
    "remotes/origin/HEAD -> origin/master",
    "remotes/origin/master"
  ],
  "tags": [],
  "is_merge": false,
  "security_info": {
    "cve_ids": [],
    "security_keywords": [
      "injection"
    ]
  },
  "fix_type": "security",
  "file_results": [
    {
      "file": "fs/ext2/dir.c",
      "pre_version": false,
      "post_version": true,
      "patch": true
    }
  ]
}