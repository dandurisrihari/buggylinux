Commit Hash: 27e714c007e4ad01837bf0fac5c11913a38d7695
Subject: ext2: unbugger ext2_empty_dir()


Security Keywords:
- injection

Full commit message:
ext2: unbugger ext2_empty_dir()

In 27cfa258951a "ext2: fix fs corruption when trying to remove
a non-empty directory with IO error" a funny thing has happened:

-               page = ext2_get_page(inode, i, dir_has_error, &page_addr);
+               page = ext2_get_page(inode, i, 0, &page_addr);

 -               if (IS_ERR(page)) {
 -                       dir_has_error = 1;
 -                       continue;
 -               }
 +               if (IS_ERR(page))
 +                       goto not_empty;

And at not_empty: we hit ext2_put_page(page, page_addr), which does
put_page(page).  Which, unless I'm very mistaken, should oops
immediately when given ERR_PTR(-E...) as page.

OK, shit happens, insufficiently tested patches included.  But when
commit in question describes the fault-injection test that exercised
that particular failure exit...

Ow.

CC: stable@vger.kernel.org
Fixes: 27cfa258951a ("ext2: fix fs corruption when trying to remove a non-empty directory with IO error")
Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
Signed-off-by: Jan Kara <jack@suse.cz>

Metadata:
Author: Al Viro <viro@zeniv.linux.org.uk>
Author Date: Sat Nov 26 03:17:17 2022 +0000
Committer: Jan Kara <jack@suse.cz>
Commit Date: Mon Nov 28 11:41:43 2022 +0100

Files Changed: 1
Lines Added: 1
Lines Removed: 1
Total Changes: 2
