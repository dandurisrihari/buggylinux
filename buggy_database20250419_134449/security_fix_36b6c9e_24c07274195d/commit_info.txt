Commit Hash: 36b6c9ed45afe89045973e8dee1b004dd5372d40
Subject: drm/vkms: fix use-after-free when drm_gem_handle_create() fails


Security Keywords:
- injection

Full commit message:
drm/vkms: fix use-after-free when drm_gem_handle_create() fails

If drm_gem_handle_create() fails in vkms_gem_create(), then the
vkms_gem_object is freed twice: once when the reference is dropped by
drm_gem_object_put_unlocked(), and again by the extra calls to
drm_gem_object_release() and kfree().

Fix it by skipping the second release and free.

This bug was originally found in the vgem driver by syzkaller using
fault injection, but I noticed it's also present in the vkms driver.

Fixes: 559e50fd34d1 ("drm/vkms: Add dumb operations")
Cc: Rodrigo Siqueira <rodrigosiqueiramelo@gmail.com>
Cc: Haneen Mohammed <hamohammed.sa@gmail.com>
Cc: Daniel Vetter <daniel.vetter@ffwll.ch>
Cc: Chris Wilson <chris@chris-wilson.co.uk>
Cc: stable@vger.kernel.org
Signed-off-by: Eric Biggers <ebiggers@google.com>
Reviewed-by: Chris Wilson <chris@chris-wilson.co.uk>
Reviewed-by: Rodrigo Siqueira <rodrigosiqueiramelo@gmail.com>
Signed-off-by: Rodrigo Siqueira <rodrigosiqueiramelo@gmail.com>
Link: https://patchwork.freedesktop.org/patch/msgid/20190226220858.214438-1-ebiggers@kernel.org
Signed-off-by: Maxime Ripard <maxime.ripard@bootlin.com>

Metadata:
Author: Eric Biggers <ebiggers@google.com>
Author Date: Tue Feb 26 14:08:58 2019 -0800
Committer: Maxime Ripard <maxime.ripard@bootlin.com>
Commit Date: Mon Mar 18 08:45:57 2019 +0100

Files Changed: 1
Lines Added: 1
Lines Removed: 4
Total Changes: 5
