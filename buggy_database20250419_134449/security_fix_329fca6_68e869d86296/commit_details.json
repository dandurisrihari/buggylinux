{
  "hash": "329fca60a95981ea7e22ab69243f0a59c6ca2eca",
  "hash_short": "329fca60",
  "subject": "Merge branch 'BPF-directed-error-injection'",
  "body": "Josef Bacik says:\n\n====================\nAdd the ability to do BPF directed error injection\n\nI'm sending this through Dave since it'll conflict with other BPF changes in his\ntree, but since it touches tracing as well Dave would like a review from\nsomebody on the tracing side.\n\nv4->v5:\n- disallow kprobe_override programs from being put in the prog map array so we\n  don't tail call into something we didn't check.  This allows us to make the\n  normal path still fast without a bunch of percpu operations.\n\nv3->v4:\n- fix a build error found by kbuild test bot (I didn't wait long enough\n  apparently.)\n- Added a warning message as per Daniels suggestion.\n\nv2->v3:\n- added a ->kprobe_override flag to bpf_prog.\n- added some sanity checks to disallow attaching bpf progs that have\n  ->kprobe_override set that aren't for ftrace kprobes.\n- added the trace_kprobe_ftrace helper to check if the trace_event_call is a\n  ftrace kprobe.\n- renamed bpf_kprobe_state to bpf_kprobe_override, fixed it so we only read this\n  value in the kprobe path, and thus only write to it if we're overriding or\n  clearing the override.\n\nv1->v2:\n- moved things around to make sure that bpf_override_return could really only be\n  used for an ftrace kprobe.\n- killed the special return values from trace_call_bpf.\n- renamed pc_modified to bpf_kprobe_state so bpf_override_return could tell if\n  it was being called from an ftrace kprobe context.\n- reworked the logic in kprobe_perf_func to take advantage of bpf_kprobe_state.\n- updated the test as per Alexei's review.\n\n- Original message -\n\nA lot of our error paths are not well tested because we have no good way of\ninjecting errors generically.  Some subystems (block, memory) have ways to\ninject errors, but they are random so it's hard to get reproduceable results.\n\nWith BPF we can add determinism to our error injection.  We can use kprobes and\nother things to verify we are injecting errors at the exact case we are trying\nto test.  This patch gives us the tool to actual do the error injection part.\nIt is very simple, we just set the return value of the pt_regs we're given to\nwhatever we provide, and then override the PC with a dummy function that simply\nreturns.\n\nRight now this only works on x86, but it would be simple enough to expand to\nother architectures.  Thanks,\n====================\n\nSigned-off-by: David S. Miller <davem@davemloft.net>",
  "full_message": "Merge branch 'BPF-directed-error-injection'\n\nJosef Bacik says:\n\n====================\nAdd the ability to do BPF directed error injection\n\nI'm sending this through Dave since it'll conflict with other BPF changes in his\ntree, but since it touches tracing as well Dave would like a review from\nsomebody on the tracing side.\n\nv4->v5:\n- disallow kprobe_override programs from being put in the prog map array so we\n  don't tail call into something we didn't check.  This allows us to make the\n  normal path still fast without a bunch of percpu operations.\n\nv3->v4:\n- fix a build error found by kbuild test bot (I didn't wait long enough\n  apparently.)\n- Added a warning message as per Daniels suggestion.\n\nv2->v3:\n- added a ->kprobe_override flag to bpf_prog.\n- added some sanity checks to disallow attaching bpf progs that have\n  ->kprobe_override set that aren't for ftrace kprobes.\n- added the trace_kprobe_ftrace helper to check if the trace_event_call is a\n  ftrace kprobe.\n- renamed bpf_kprobe_state to bpf_kprobe_override, fixed it so we only read this\n  value in the kprobe path, and thus only write to it if we're overriding or\n  clearing the override.\n\nv1->v2:\n- moved things around to make sure that bpf_override_return could really only be\n  used for an ftrace kprobe.\n- killed the special return values from trace_call_bpf.\n- renamed pc_modified to bpf_kprobe_state so bpf_override_return could tell if\n  it was being called from an ftrace kprobe context.\n- reworked the logic in kprobe_perf_func to take advantage of bpf_kprobe_state.\n- updated the test as per Alexei's review.\n\n- Original message -\n\nA lot of our error paths are not well tested because we have no good way of\ninjecting errors generically.  Some subystems (block, memory) have ways to\ninject errors, but they are random so it's hard to get reproduceable results.\n\nWith BPF we can add determinism to our error injection.  We can use kprobes and\nother things to verify we are injecting errors at the exact case we are trying\nto test.  This patch gives us the tool to actual do the error injection part.\nIt is very simple, we just set the return value of the pt_regs we're given to\nwhatever we provide, and then override the PC with a dummy function that simply\nreturns.\n\nRight now this only works on x86, but it would be simple enough to expand to\nother architectures.  Thanks,\n====================\n\nSigned-off-by: David S. Miller <davem@davemloft.net>",
  "author_name": "David S. Miller",
  "author_email": "davem@davemloft.net",
  "author_date": "Sat Nov 11 12:18:06 2017 +0900",
  "author_date_iso": "2017-11-11T12:18:06+09:00",
  "committer_name": "David S. Miller",
  "committer_email": "davem@davemloft.net",
  "committer_date": "Sat Nov 11 12:18:06 2017 +0900",
  "committer_date_iso": "2017-11-11T12:18:06+09:00",
  "files_changed": [],
  "files_changed_count": 0,
  "stats": [
    {
      "file": "arch/Kconfig",
      "insertions": 3,
      "deletions": 0
    },
    {
      "file": "arch/x86/Kconfig",
      "insertions": 1,
      "deletions": 0
    },
    {
      "file": "arch/x86/include/asm/kprobes.h",
      "insertions": 4,
      "deletions": 0
    },
    {
      "file": "arch/x86/include/asm/ptrace.h",
      "insertions": 5,
      "deletions": 0
    },
    {
      "file": "arch/x86/kernel/kprobes/ftrace.c",
      "insertions": 14,
      "deletions": 0
    },
    {
      "file": "include/linux/filter.h",
      "insertions": 2,
      "deletions": 1
    },
    {
      "file": "include/linux/trace_events.h",
      "insertions": 1,
      "deletions": 0
    },
    {
      "file": "include/uapi/linux/bpf.h",
      "insertions": 6,
      "deletions": 1
    },
    {
      "file": "kernel/bpf/core.c",
      "insertions": 3,
      "deletions": 0
    },
    {
      "file": "kernel/bpf/verifier.c",
      "insertions": 2,
      "deletions": 0
    },
    {
      "file": "kernel/events/core.c",
      "insertions": 7,
      "deletions": 0
    },
    {
      "file": "kernel/trace/Kconfig",
      "insertions": 11,
      "deletions": 0
    },
    {
      "file": "kernel/trace/bpf_trace.c",
      "insertions": 35,
      "deletions": 0
    },
    {
      "file": "kernel/trace/trace_kprobe.c",
      "insertions": 33,
      "deletions": 7
    },
    {
      "file": "kernel/trace/trace_probe.h",
      "insertions": 6,
      "deletions": 0
    },
    {
      "file": "samples/bpf/Makefile",
      "insertions": 4,
      "deletions": 0
    },
    {
      "file": "samples/bpf/test_override_return.sh",
      "insertions": 15,
      "deletions": 0
    },
    {
      "file": "samples/bpf/tracex7_kern.c",
      "insertions": 16,
      "deletions": 0
    },
    {
      "file": "samples/bpf/tracex7_user.c",
      "insertions": 28,
      "deletions": 0
    },
    {
      "file": "tools/include/uapi/linux/bpf.h",
      "insertions": 6,
      "deletions": 1
    },
    {
      "file": "tools/testing/selftests/bpf/bpf_helpers.h",
      "insertions": 2,
      "deletions": 1
    }
  ],
  "total_insertions": 204,
  "total_deletions": 11,
  "total_changes": 215,
  "parents": [
    "54985120a1c461b74f9510e5d730971f2a2383b1",
    "eafb3401faf243f7dca0e23325242cb8c2269ee9"
  ],
  "branches": [
    "* development",
    "master",
    "remotes/origin/HEAD -> origin/master",
    "remotes/origin/master"
  ],
  "tags": [
    "v4.15",
    "v4.15-rc1",
    "v4.15-rc2",
    "v4.15-rc3",
    "v4.15-rc4",
    "v4.15-rc5",
    "v4.15-rc6",
    "v4.15-rc7",
    "v4.15-rc8",
    "v4.15-rc9"
  ],
  "is_merge": true,
  "security_info": {
    "cve_ids": [],
    "security_keywords": [
      "injection"
    ]
  },
  "fix_type": "security",
  "file_results": []
}