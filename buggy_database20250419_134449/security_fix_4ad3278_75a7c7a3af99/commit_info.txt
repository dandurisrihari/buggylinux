Commit Hash: 4ad3278df6fe2b0852b00d5757fc2ccd8e92c26e
Subject: x86/speculation: Disable RRSBA behavior


Security Keywords:
- Injection

Full commit message:
x86/speculation: Disable RRSBA behavior

Some Intel processors may use alternate predictors for RETs on
RSB-underflow. This condition may be vulnerable to Branch History
Injection (BHI) and intramode-BTI.

Kernel earlier added spectre_v2 mitigation modes (eIBRS+Retpolines,
eIBRS+LFENCE, Retpolines) which protect indirect CALLs and JMPs against
such attacks. However, on RSB-underflow, RET target prediction may
fallback to alternate predictors. As a result, RET's predicted target
may get influenced by branch history.

A new MSR_IA32_SPEC_CTRL bit (RRSBA_DIS_S) controls this fallback
behavior when in kernel mode. When set, RETs will not take predictions
from alternate predictors, hence mitigating RETs as well. Support for
this is enumerated by CPUID.7.2.EDX[RRSBA_CTRL] (bit2).

For spectre v2 mitigation, when a user selects a mitigation that
protects indirect CALLs and JMPs against BHI and intramode-BTI, set
RRSBA_DIS_S also to protect RETs for RSB-underflow case.

Signed-off-by: Pawan Gupta <pawan.kumar.gupta@linux.intel.com>
Signed-off-by: Borislav Petkov <bp@suse.de>

Metadata:
Author: Pawan Gupta <pawan.kumar.gupta@linux.intel.com>
Author Date: Fri Jul 8 13:36:09 2022 -0700
Committer: Borislav Petkov <bp@suse.de>
Commit Date: Sat Jul 9 13:12:45 2022 +0200

Files Changed: 5
Lines Added: 46
Lines Removed: 1
Total Changes: 47
