Commit Hash: d3b6372c5881cb54925212abb62c521df8ba4809
Subject: xen/gntalloc: don't use gnttab_query_foreign_access()

CVE Identifiers:
- CVE-2022-23039

Full commit message:
xen/gntalloc: don't use gnttab_query_foreign_access()

Using gnttab_query_foreign_access() is unsafe, as it is racy by design.

The use case in the gntalloc driver is not needed at all. While at it
replace the call of gnttab_end_foreign_access_ref() with a call of
gnttab_end_foreign_access(), which is what is really wanted there. In
case the grant wasn't used due to an allocation failure, just free the
grant via gnttab_free_grant_reference().

This is CVE-2022-23039 / part of XSA-396.

Reported-by: Demi Marie Obenour <demi@invisiblethingslab.com>
Signed-off-by: Juergen Gross <jgross@suse.com>
Reviewed-by: Jan Beulich <jbeulich@suse.com>
---
V3:
- fix __del_gref() (Jan Beulich)

Metadata:
Author: Juergen Gross <jgross@suse.com>
Author Date: Mon Mar 7 09:48:54 2022 +0100
Committer: Juergen Gross <jgross@suse.com>
Commit Date: Mon Mar 7 09:48:54 2022 +0100

Files Changed: 1
Lines Added: 7
Lines Removed: 18
Total Changes: 25
