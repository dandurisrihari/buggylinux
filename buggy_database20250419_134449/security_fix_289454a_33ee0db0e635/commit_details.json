{
  "hash": "289454ad26a2d752e04b07234a175feda9ec0f4e",
  "hash_short": "289454ad",
  "subject": "btrfs: clear bio reference after submit_one_bio()",
  "body": "After submit_one_bio(), `bio' can go away. However submit_extent_page()\nleave `bio' referable if submit_one_bio() failed (e.g. -ENOMEM on OOM).\nIt will cause invalid paging request when submit_extent_page() is called\nnext time.\n\nI reproduced ENOMEM case with the following script (need\nCONFIG_FAIL_PAGE_ALLOC, and CONFIG_FAULT_INJECTION_DEBUG_FS).\n\n  #!/bin/bash\n\n  dmesgout=dmesg.txt\n  start=100000\n  end=300000\n  step=1000\n\n  # btrfs options\n  device=/dev/vdb1\n  directory=/mnt/btrfs\n\n  # fault-injection options\n  percent=100\n  times=3\n\n  mkdir -p $directory || exit 1\n  mount -o compress $device $directory || exit 1\n\n  rm -f $directory/file || exit 1\n  dd if=/dev/zero of=$directory/file bs=1M count=512 || exit 1\n\n  for interval in `seq $start $step $end`; do\n          dmesg -C\n          echo 1 > /proc/sys/vm/drop_caches\n          sync\n          export FAILCMD_TYPE=fail_page_alloc\n          ./failcmd.sh -p $percent -t $times -i $interval \\\n                  --ignore-gfp-highmem=N --ignore-gfp-wait=N --min-order=0 \\\n                  -- \\\n                  cat $directory/file > /dev/null\n          dmesg > ${dmesgout}\n          if grep -q BUG: ${dmesgout}; then\n                  cat ${dmesgout}\n                  exit 1\n          fi\n  done\n\n  umount $directory\n  exit 0\n\nSigned-off-by: Naohiro Aota <naota@elisp.net>\nTested-by: Satoru Takeuchi <takeuchi_satoru@jp.fujitsu.com>\nSigned-off-by: Chris Mason <clm@fb.com>",
  "full_message": "btrfs: clear bio reference after submit_one_bio()\n\nAfter submit_one_bio(), `bio' can go away. However submit_extent_page()\nleave `bio' referable if submit_one_bio() failed (e.g. -ENOMEM on OOM).\nIt will cause invalid paging request when submit_extent_page() is called\nnext time.\n\nI reproduced ENOMEM case with the following script (need\nCONFIG_FAIL_PAGE_ALLOC, and CONFIG_FAULT_INJECTION_DEBUG_FS).\n\n  #!/bin/bash\n\n  dmesgout=dmesg.txt\n  start=100000\n  end=300000\n  step=1000\n\n  # btrfs options\n  device=/dev/vdb1\n  directory=/mnt/btrfs\n\n  # fault-injection options\n  percent=100\n  times=3\n\n  mkdir -p $directory || exit 1\n  mount -o compress $device $directory || exit 1\n\n  rm -f $directory/file || exit 1\n  dd if=/dev/zero of=$directory/file bs=1M count=512 || exit 1\n\n  for interval in `seq $start $step $end`; do\n          dmesg -C\n          echo 1 > /proc/sys/vm/drop_caches\n          sync\n          export FAILCMD_TYPE=fail_page_alloc\n          ./failcmd.sh -p $percent -t $times -i $interval \\\n                  --ignore-gfp-highmem=N --ignore-gfp-wait=N --min-order=0 \\\n                  -- \\\n                  cat $directory/file > /dev/null\n          dmesg > ${dmesgout}\n          if grep -q BUG: ${dmesgout}; then\n                  cat ${dmesgout}\n                  exit 1\n          fi\n  done\n\n  umount $directory\n  exit 0\n\nSigned-off-by: Naohiro Aota <naota@elisp.net>\nTested-by: Satoru Takeuchi <takeuchi_satoru@jp.fujitsu.com>\nSigned-off-by: Chris Mason <clm@fb.com>",
  "author_name": "Naohiro Aota",
  "author_email": "naota@elisp.net",
  "author_date": "Tue Jan 6 01:01:03 2015 +0900",
  "author_date_iso": "2015-01-06T01:01:03+09:00",
  "committer_name": "Chris Mason",
  "committer_email": "clm@fb.com",
  "committer_date": "Mon Feb 2 19:24:51 2015 -0800",
  "committer_date_iso": "2015-02-02T19:24:51-08:00",
  "files_changed": [
    "fs/btrfs/extent_io.c"
  ],
  "files_changed_count": 1,
  "stats": [
    {
      "file": "fs/btrfs/extent_io.c",
      "insertions": 3,
      "deletions": 1
    }
  ],
  "total_insertions": 3,
  "total_deletions": 1,
  "total_changes": 4,
  "parents": [
    "de554a4fa61d77df2704be5b6b47472b2dbd1875"
  ],
  "branches": [
    "* development",
    "master",
    "remotes/origin/HEAD -> origin/master",
    "remotes/origin/master"
  ],
  "tags": [
    "v4.0",
    "v4.0-rc1",
    "v4.0-rc2",
    "v4.0-rc3",
    "v4.0-rc4",
    "v4.0-rc5",
    "v4.0-rc6",
    "v4.0-rc7",
    "v4.1",
    "v4.1-rc1"
  ],
  "is_merge": false,
  "security_info": {
    "cve_ids": [],
    "security_keywords": [
      "injection"
    ]
  },
  "fix_type": "security",
  "file_results": [
    {
      "file": "fs/btrfs/extent_io.c",
      "pre_version": false,
      "post_version": true,
      "patch": true
    }
  ]
}