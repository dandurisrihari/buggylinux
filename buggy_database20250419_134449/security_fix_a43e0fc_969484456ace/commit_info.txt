Commit Hash: a43e0fc5e9134a46515de2f2f8d4100b74e50de3
Subject: pstore: inode: Only d_invalidate() is needed


Security Keywords:
- hardening

Full commit message:
pstore: inode: Only d_invalidate() is needed

Unloading a modular pstore backend with records in pstorefs would
trigger the dput() double-drop warning:

  WARNING: CPU: 0 PID: 2569 at fs/dcache.c:762 dput.part.0+0x3f3/0x410

Using the combo of d_drop()/dput() (as mentioned in
Documentation/filesystems/vfs.rst) isn't the right approach here, and
leads to the reference counting problem seen above. Use d_invalidate()
and update the code to not bother checking for error codes that can
never happen.

Suggested-by: Alexander Viro <viro@zeniv.linux.org.uk>
Fixes: 609e28bb139e ("pstore: Remove filesystem records when backend is unregistered")
Signed-off-by: Kees Cook <keescook@chromium.org>
---
Cc: "Guilherme G. Piccoli" <gpiccoli@igalia.com>
Cc: Tony Luck <tony.luck@intel.com>
Cc: linux-hardening@vger.kernel.org

Metadata:
Author: Kees Cook <keescook@chromium.org>
Author Date: Thu Feb 22 09:48:46 2024 -0800
Committer: Kees Cook <keescook@chromium.org>
Commit Date: Thu Feb 22 10:37:21 2024 -0800

Files Changed: 1
Lines Added: 3
Lines Removed: 7
Total Changes: 10
