commit ed5d44d42c95e8a13bb54e614d2269c8740667f9
Author: Frederick Lawler <fred@cloudflare.com>
Date:   Mon Aug 15 11:20:28 2022 -0500

    selinux: Implement userns_create hook
    
    Unprivileged user namespace creation is an intended feature to enable
    sandboxing, however this feature is often used to as an initial step to
    perform a privilege escalation attack.
    
    This patch implements a new user_namespace { create } access control
    permission to restrict which domains allow or deny user namespace
    creation. This is necessary for system administrators to quickly protect
    their systems while waiting for vulnerability patches to be applied.
    
    This permission can be used in the following way:
    
            allow domA_t domA_t : user_namespace { create };
    
    Signed-off-by: Frederick Lawler <fred@cloudflare.com>
    Signed-off-by: Paul Moore <paul@paul-moore.com>

diff --git a/security/selinux/hooks.c b/security/selinux/hooks.c
index 79573504783b..b9f1078450b3 100644
--- a/security/selinux/hooks.c
+++ b/security/selinux/hooks.c
@@ -4221,6 +4221,14 @@ static void selinux_task_to_inode(struct task_struct *p,
 	spin_unlock(&isec->lock);
 }
 
+static int selinux_userns_create(const struct cred *cred)
+{
+	u32 sid = current_sid();
+
+	return avc_has_perm(&selinux_state, sid, sid, SECCLASS_USER_NAMESPACE,
+						USER_NAMESPACE__CREATE, NULL);
+}
+
 /* Returns error only if unable to parse addresses */
 static int selinux_parse_skb_ipv4(struct sk_buff *skb,
 			struct common_audit_data *ad, u8 *proto)
@@ -7111,6 +7119,7 @@ static struct security_hook_list selinux_hooks[] __lsm_ro_after_init = {
 	LSM_HOOK_INIT(task_movememory, selinux_task_movememory),
 	LSM_HOOK_INIT(task_kill, selinux_task_kill),
 	LSM_HOOK_INIT(task_to_inode, selinux_task_to_inode),
+	LSM_HOOK_INIT(userns_create, selinux_userns_create),
 
 	LSM_HOOK_INIT(ipc_permission, selinux_ipc_permission),
 	LSM_HOOK_INIT(ipc_getsecid, selinux_ipc_getsecid),