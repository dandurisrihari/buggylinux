Commit Hash: 8336a64eb75cba4cc4749d9c4770fef53afdc1ad
Subject: xfs: don't complain about unfixed metadata when repairs were injected


Security Keywords:
- injection

Full commit message:
xfs: don't complain about unfixed metadata when repairs were injected

While debugging other parts of online repair, I noticed that if someone
injects FORCE_SCRUB_REPAIR, starts an IFLAG_REPAIR scrub on a piece of
metadata, and the metadata repair fails, we'll log a message about
uncorrected errors in the filesystem.

This isn't strictly true if the scrub function didn't set OFLAG_CORRUPT
and we're only doing the repair because the error injection knob is set.
Repair functions are allowed to abort the entire operation at any point
before committing new metadata, in which case the piece of metadata is
in the same state as it was before.  Therefore, the log message should
be gated on the results of the scrub.  Refactor the predicate and
rearrange the code flow to make this happen.

Note: If the repair function errors out after it commits the new
metadata, the transaction cancellation will shut down the filesystem,
which is an obvious sign of corrupt metadata.

Signed-off-by: Darrick J. Wong <djwong@kernel.org>
Reviewed-by: Dave Chinner <dchinner@redhat.com>

Metadata:
Author: Darrick J. Wong <djwong@kernel.org>
Author Date: Thu Aug 10 07:48:10 2023 -0700
Committer: Darrick J. Wong <djwong@kernel.org>
Commit Date: Thu Aug 10 07:48:10 2023 -0700

Files Changed: 2
Lines Added: 14
Lines Removed: 5
Total Changes: 19
