commit cacea62fcdda5656cb5b8104e73a00e043b61730
Author: Vladimir Oltean <vladimir.oltean@nxp.com>
Date:   Fri Jan 29 03:00:03 2021 +0200

    net: mscc: ocelot: don't use NPI tag prefix for the CPU port module
    
    Context: Ocelot switches put the injection/extraction frame header in
    front of the Ethernet header. When used in NPI mode, a DSA master would
    see junk instead of the destination MAC address, and it would most
    likely drop the packets. So the Ocelot frame header can have an optional
    prefix, which is just "ff:ff:ff:ff:ff:fe > ff:ff:ff:ff:ff:ff" padding
    put before the actual tag (still before the real Ethernet header) such
    that the DSA master thinks it's looking at a broadcast frame with a
    strange EtherType.
    
    Unfortunately, a lesson learned in commit 69df578c5f4b ("net: mscc:
    ocelot: eliminate confusion between CPU and NPI port") seems to have
    been forgotten in the meanwhile.
    
    The CPU port module and the NPI port have independent settings for the
    length of the tag prefix. However, the driver is using the same variable
    to program both of them.
    
    There is no reason really to use any tag prefix with the CPU port
    module, since that is not connected to any Ethernet port. So this patch
    makes the inj_prefix and xtr_prefix variables apply only to the NPI
    port (which the switchdev ocelot_vsc7514 driver does not use).
    
    Signed-off-by: Vladimir Oltean <vladimir.oltean@nxp.com>
    Reviewed-by: Florian Fainelli <f.fainelli@gmail.com>
    Signed-off-by: Jakub Kicinski <kuba@kernel.org>

diff --git a/drivers/net/dsa/ocelot/felix.c b/drivers/net/dsa/ocelot/felix.c
index 767cbdccdb3e..054e57dd4383 100644
--- a/drivers/net/dsa/ocelot/felix.c
+++ b/drivers/net/dsa/ocelot/felix.c
@@ -425,8 +425,8 @@ static int felix_init_structs(struct felix *felix, int num_phys_ports)
 	ocelot->num_mact_rows	= felix->info->num_mact_rows;
 	ocelot->vcap		= felix->info->vcap;
 	ocelot->ops		= felix->info->ops;
-	ocelot->inj_prefix	= OCELOT_TAG_PREFIX_SHORT;
-	ocelot->xtr_prefix	= OCELOT_TAG_PREFIX_SHORT;
+	ocelot->npi_inj_prefix	= OCELOT_TAG_PREFIX_SHORT;
+	ocelot->npi_xtr_prefix	= OCELOT_TAG_PREFIX_SHORT;
 	ocelot->devlink		= felix->ds->devlink;
 
 	port_phy_modes = kcalloc(num_phys_ports, sizeof(phy_interface_t),
@@ -541,9 +541,9 @@ static void felix_npi_port_init(struct ocelot *ocelot, int port)
 
 	/* NPI port Injection/Extraction configuration */
 	ocelot_fields_write(ocelot, port, SYS_PORT_MODE_INCL_XTR_HDR,
-			    ocelot->xtr_prefix);
+			    ocelot->npi_xtr_prefix);
 	ocelot_fields_write(ocelot, port, SYS_PORT_MODE_INCL_INJ_HDR,
-			    ocelot->inj_prefix);
+			    ocelot->npi_inj_prefix);
 
 	/* Disable transmission of pause frames */
 	ocelot_fields_write(ocelot, port, SYS_PAUSE_CFG_PAUSE_ENA, 0);