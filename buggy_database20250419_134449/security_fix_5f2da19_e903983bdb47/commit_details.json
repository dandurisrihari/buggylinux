{
  "hash": "5f2da19714465739da2449253b13ac06cb353a26",
  "hash_short": "5f2da197",
  "subject": "cxl/pci: Fix sanitize notifier setup",
  "body": "Fix a race condition between the mailbox-background command interrupt\nfiring and the security-state sysfs attribute being removed.\n\nThe race is difficult to see due to the awkward placement of the\nsanitize-notifier setup code and the multiple places the teardown calls\nare made, cxl_memdev_security_init() and cxl_memdev_security_shutdown().\n\nUnify setup in one place, cxl_sanitize_setup_notifier(). Arrange for\nthe paired cxl_sanitize_teardown_notifier() to safely quiet the notifier\nand let the cxl_memdev + irq be unregistered later in the flow.\n\nNote: The special wrinkle of the sanitize notifier is that it interacts\nwith interrupts, which are enabled early in the flow, and it interacts\nwith memdev sysfs which is not initialized until late in the flow. Hence\nwhy this setup routine takes an @cxlmd argument, and not just @mds.\n\nThis fix is also needed as a preparation fix for a memdev unregistration\ncrash.\n\nReported-by: Jonathan Cameron <Jonathan.Cameron@Huawei.com>\nCloses: http://lore.kernel.org/r/20230929100316.00004546@Huawei.com\nCc: Dave Jiang <dave.jiang@intel.com>\nCc: Davidlohr Bueso <dave@stgolabs.net>\nFixes: 0c36b6ad436a (\"cxl/mbox: Add sanitization handling machinery\")\nReviewed-by: Dave Jiang <dave.jiang@intel.com>\nReviewed-by: Ira Weiny <ira.weiny@intel.com>\nReviewed-by: Davidlohr Bueso <dave@stgolabs.net>\nReviewed-by: Jonathan Cameron <Jonathan.Cameron@huawei.com>\nSigned-off-by: Dan Williams <dan.j.williams@intel.com>",
  "full_message": "cxl/pci: Fix sanitize notifier setup\n\nFix a race condition between the mailbox-background command interrupt\nfiring and the security-state sysfs attribute being removed.\n\nThe race is difficult to see due to the awkward placement of the\nsanitize-notifier setup code and the multiple places the teardown calls\nare made, cxl_memdev_security_init() and cxl_memdev_security_shutdown().\n\nUnify setup in one place, cxl_sanitize_setup_notifier(). Arrange for\nthe paired cxl_sanitize_teardown_notifier() to safely quiet the notifier\nand let the cxl_memdev + irq be unregistered later in the flow.\n\nNote: The special wrinkle of the sanitize notifier is that it interacts\nwith interrupts, which are enabled early in the flow, and it interacts\nwith memdev sysfs which is not initialized until late in the flow. Hence\nwhy this setup routine takes an @cxlmd argument, and not just @mds.\n\nThis fix is also needed as a preparation fix for a memdev unregistration\ncrash.\n\nReported-by: Jonathan Cameron <Jonathan.Cameron@Huawei.com>\nCloses: http://lore.kernel.org/r/20230929100316.00004546@Huawei.com\nCc: Dave Jiang <dave.jiang@intel.com>\nCc: Davidlohr Bueso <dave@stgolabs.net>\nFixes: 0c36b6ad436a (\"cxl/mbox: Add sanitization handling machinery\")\nReviewed-by: Dave Jiang <dave.jiang@intel.com>\nReviewed-by: Ira Weiny <ira.weiny@intel.com>\nReviewed-by: Davidlohr Bueso <dave@stgolabs.net>\nReviewed-by: Jonathan Cameron <Jonathan.Cameron@huawei.com>\nSigned-off-by: Dan Williams <dan.j.williams@intel.com>",
  "author_name": "Dan Williams",
  "author_email": "dan.j.williams@intel.com",
  "author_date": "Wed Oct 4 16:49:36 2023 -0700",
  "author_date_iso": "2023-10-04T16:49:36-07:00",
  "committer_name": "Dan Williams",
  "committer_email": "dan.j.williams@intel.com",
  "committer_date": "Fri Oct 6 00:12:45 2023 -0700",
  "committer_date_iso": "2023-10-06T00:12:45-07:00",
  "files_changed": [
    "drivers/cxl/core/memdev.c",
    "drivers/cxl/cxlmem.h",
    "drivers/cxl/pci.c"
  ],
  "files_changed_count": 3,
  "stats": [
    {
      "file": "drivers/cxl/core/memdev.c",
      "insertions": 44,
      "deletions": 42
    },
    {
      "file": "drivers/cxl/cxlmem.h",
      "insertions": 2,
      "deletions": 0
    },
    {
      "file": "drivers/cxl/pci.c",
      "insertions": 4,
      "deletions": 0
    }
  ],
  "total_insertions": 50,
  "total_deletions": 42,
  "total_changes": 92,
  "parents": [
    "f29a824b0b6710328a78b018de3c2cfa9db65876"
  ],
  "branches": [
    "* development",
    "remotes/origin/HEAD -> origin/master",
    "remotes/origin/master"
  ],
  "tags": [],
  "is_merge": false,
  "security_info": {
    "cve_ids": [],
    "security_keywords": [
      "sanitize"
    ]
  },
  "fix_type": "security",
  "file_results": [
    {
      "file": "drivers/cxl/core/memdev.c",
      "pre_version": true,
      "post_version": true,
      "patch": true
    },
    {
      "file": "drivers/cxl/cxlmem.h",
      "pre_version": true,
      "post_version": true,
      "patch": true
    },
    {
      "file": "drivers/cxl/pci.c",
      "pre_version": true,
      "post_version": true,
      "patch": true
    }
  ]
}