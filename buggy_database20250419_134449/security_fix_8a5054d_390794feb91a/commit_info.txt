Commit Hash: 8a5054d8cbbe03c68dcb0957c291c942132e4101
Subject: powerpc/64s/exception: Fix machine check no-loss idle wakeup


Security Keywords:
- injection

Full commit message:
powerpc/64s/exception: Fix machine check no-loss idle wakeup

The architecture allows for machine check exceptions to cause idle
wakeups which resume at the 0x200 address which has to return via
the idle wakeup code, but the early machine check handler is run
first.

The case of a no state-loss sleep is broken because the early
handler uses non-volatile register r1 , which is needed for the wakeup
protocol, but it is not restored.

Fix this by loading r1 from the MCE exception frame before returning
to the idle wakeup code. Also update the comment which has become
stale since the idle rewrite in C.

This crash was found and fix confirmed with a machine check injection
test in qemu powernv model (which is not upstream in qemu yet).

Fixes: 10d91611f426d ("powerpc/64s: Reimplement book3s idle code in C")
Signed-off-by: Nicholas Piggin <npiggin@gmail.com>
Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
Link: https://lore.kernel.org/r/20200508043408.886394-2-npiggin@gmail.com

Metadata:
Author: Nicholas Piggin <npiggin@gmail.com>
Author Date: Fri May 8 14:33:53 2020 +1000
Committer: Michael Ellerman <mpe@ellerman.id.au>
Commit Date: Mon May 18 21:58:44 2020 +1000

Files Changed: 1
Lines Added: 8
Lines Removed: 6
Total Changes: 14
