{
  "hash": "17122c06b86c9f77f45b86b8e62c3ed440847a59",
  "hash_short": "17122c06",
  "subject": "KVM: x86: Fail emulation during EMULTYPE_SKIP on any exception",
  "body": "Treat any exception during instruction decode for EMULTYPE_SKIP as a\n\"full\" emulation failure, i.e. signal failure instead of queuing the\nexception.  When decoding purely to skip an instruction, KVM and/or the\nCPU has already done some amount of emulation that cannot be unwound,\ne.g. on an EPT misconfig VM-Exit KVM has already processeed the emulated\nMMIO.  KVM already does this if a #UD is encountered, but not for other\nexceptions, e.g. if a #PF is encountered during fetch.\n\nIn SVM's soft-injection use case, queueing the exception is particularly\nproblematic as queueing exceptions while injecting events can put KVM\ninto an infinite loop due to bailing from VM-Enter to service the newly\npending exception.  E.g. multiple warnings to detect such behavior fire:\n\n  ------------[ cut here ]------------\n  WARNING: CPU: 3 PID: 1017 at arch/x86/kvm/x86.c:9873 kvm_arch_vcpu_ioctl_run+0x1de5/0x20a0 [kvm]\n  Modules linked in: kvm_amd ccp kvm irqbypass\n  CPU: 3 PID: 1017 Comm: svm_nested_soft Not tainted 6.0.0-rc1+ #220\n  Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS 0.0.0 02/06/2015\n  RIP: 0010:kvm_arch_vcpu_ioctl_run+0x1de5/0x20a0 [kvm]\n  Call Trace:\n   kvm_vcpu_ioctl+0x223/0x6d0 [kvm]\n   __x64_sys_ioctl+0x85/0xc0\n   do_syscall_64+0x2b/0x50\n   entry_SYSCALL_64_after_hwframe+0x46/0xb0\n  ---[ end trace 0000000000000000 ]---\n  ------------[ cut here ]------------\n  WARNING: CPU: 3 PID: 1017 at arch/x86/kvm/x86.c:9987 kvm_arch_vcpu_ioctl_run+0x12a3/0x20a0 [kvm]\n  Modules linked in: kvm_amd ccp kvm irqbypass\n  CPU: 3 PID: 1017 Comm: svm_nested_soft Tainted: G        W          6.0.0-rc1+ #220\n  Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS 0.0.0 02/06/2015\n  RIP: 0010:kvm_arch_vcpu_ioctl_run+0x12a3/0x20a0 [kvm]\n  Call Trace:\n   kvm_vcpu_ioctl+0x223/0x6d0 [kvm]\n   __x64_sys_ioctl+0x85/0xc0\n   do_syscall_64+0x2b/0x50\n   entry_SYSCALL_64_after_hwframe+0x46/0xb0\n  ---[ end trace 0000000000000000 ]---\n\nFixes: 6ea6e84309ca (\"KVM: x86: inject exceptions produced by x86_decode_insn\")\nSigned-off-by: Sean Christopherson <seanjc@google.com>\nLink: https://lore.kernel.org/r/20220930233632.1725475-1-seanjc@google.com",
  "full_message": "KVM: x86: Fail emulation during EMULTYPE_SKIP on any exception\n\nTreat any exception during instruction decode for EMULTYPE_SKIP as a\n\"full\" emulation failure, i.e. signal failure instead of queuing the\nexception.  When decoding purely to skip an instruction, KVM and/or the\nCPU has already done some amount of emulation that cannot be unwound,\ne.g. on an EPT misconfig VM-Exit KVM has already processeed the emulated\nMMIO.  KVM already does this if a #UD is encountered, but not for other\nexceptions, e.g. if a #PF is encountered during fetch.\n\nIn SVM's soft-injection use case, queueing the exception is particularly\nproblematic as queueing exceptions while injecting events can put KVM\ninto an infinite loop due to bailing from VM-Enter to service the newly\npending exception.  E.g. multiple warnings to detect such behavior fire:\n\n  ------------[ cut here ]------------\n  WARNING: CPU: 3 PID: 1017 at arch/x86/kvm/x86.c:9873 kvm_arch_vcpu_ioctl_run+0x1de5/0x20a0 [kvm]\n  Modules linked in: kvm_amd ccp kvm irqbypass\n  CPU: 3 PID: 1017 Comm: svm_nested_soft Not tainted 6.0.0-rc1+ #220\n  Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS 0.0.0 02/06/2015\n  RIP: 0010:kvm_arch_vcpu_ioctl_run+0x1de5/0x20a0 [kvm]\n  Call Trace:\n   kvm_vcpu_ioctl+0x223/0x6d0 [kvm]\n   __x64_sys_ioctl+0x85/0xc0\n   do_syscall_64+0x2b/0x50\n   entry_SYSCALL_64_after_hwframe+0x46/0xb0\n  ---[ end trace 0000000000000000 ]---\n  ------------[ cut here ]------------\n  WARNING: CPU: 3 PID: 1017 at arch/x86/kvm/x86.c:9987 kvm_arch_vcpu_ioctl_run+0x12a3/0x20a0 [kvm]\n  Modules linked in: kvm_amd ccp kvm irqbypass\n  CPU: 3 PID: 1017 Comm: svm_nested_soft Tainted: G        W          6.0.0-rc1+ #220\n  Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS 0.0.0 02/06/2015\n  RIP: 0010:kvm_arch_vcpu_ioctl_run+0x12a3/0x20a0 [kvm]\n  Call Trace:\n   kvm_vcpu_ioctl+0x223/0x6d0 [kvm]\n   __x64_sys_ioctl+0x85/0xc0\n   do_syscall_64+0x2b/0x50\n   entry_SYSCALL_64_after_hwframe+0x46/0xb0\n  ---[ end trace 0000000000000000 ]---\n\nFixes: 6ea6e84309ca (\"KVM: x86: inject exceptions produced by x86_decode_insn\")\nSigned-off-by: Sean Christopherson <seanjc@google.com>\nLink: https://lore.kernel.org/r/20220930233632.1725475-1-seanjc@google.com",
  "author_name": "Sean Christopherson",
  "author_email": "seanjc@google.com",
  "author_date": "Fri Sep 30 23:36:32 2022 +0000",
  "author_date_iso": "2022-09-30T23:36:32+00:00",
  "committer_name": "Sean Christopherson",
  "committer_email": "seanjc@google.com",
  "committer_date": "Wed Nov 30 16:11:51 2022 -0800",
  "committer_date_iso": "2022-11-30T16:11:51-08:00",
  "files_changed": [
    "arch/x86/kvm/x86.c"
  ],
  "files_changed_count": 1,
  "stats": [
    {
      "file": "arch/x86/kvm/x86.c",
      "insertions": 3,
      "deletions": 1
    }
  ],
  "total_insertions": 3,
  "total_deletions": 1,
  "total_changes": 4,
  "parents": [
    "4265df667bbdc71c640e43c905bd9aeeead92365"
  ],
  "branches": [
    "* development",
    "remotes/origin/HEAD -> origin/master",
    "remotes/origin/master"
  ],
  "tags": [],
  "is_merge": false,
  "security_info": {
    "cve_ids": [],
    "security_keywords": [
      "injection"
    ]
  },
  "fix_type": "security",
  "file_results": [
    {
      "file": "arch/x86/kvm/x86.c",
      "pre_version": false,
      "post_version": true,
      "patch": true
    }
  ]
}