{
  "hash": "0e24f6d84b4ca50780c0c55dcdfc5bdeda5c7014",
  "hash_short": "0e24f6d8",
  "subject": "btrfs: do not infinite loop in data reclaim if we aborted",
  "body": "Error injection stressing uncovered a busy loop in our data reclaim\nloop.  There are two cases here, one where we loop creating block groups\nuntil space_info->full is set, or in the main loop we will skip erroring\nout any tickets if space_info->full == 0.  Unfortunately if we aborted\nthe transaction then we will never allocate chunks or reclaim any space\nand thus never get ->full, and you'll see stack traces like this:\n\n  watchdog: BUG: soft lockup - CPU#0 stuck for 26s! [kworker/u4:4:139]\n  CPU: 0 PID: 139 Comm: kworker/u4:4 Tainted: G        W         5.13.0-rc1+ #328\n  Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS 1.13.0-2.fc32 04/01/2014\n  Workqueue: events_unbound btrfs_async_reclaim_data_space\n  RIP: 0010:btrfs_join_transaction+0x12/0x20\n  RSP: 0018:ffffb2b780b77de0 EFLAGS: 00000246\n  RAX: ffffb2b781863d58 RBX: 0000000000000000 RCX: 0000000000000000\n  RDX: 0000000000000801 RSI: ffff987952b57400 RDI: ffff987940aa3000\n  RBP: ffff987954d55000 R08: 0000000000000001 R09: ffff98795539e8f0\n  R10: 000000000000000f R11: 000000000000000f R12: ffffffffffffffff\n  R13: ffff987952b574c8 R14: ffff987952b57400 R15: 0000000000000008\n  FS:  0000000000000000(0000) GS:ffff9879bbc00000(0000) knlGS:0000000000000000\n  CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033\n  CR2: 00007f0703da4000 CR3: 0000000113398004 CR4: 0000000000370ef0\n  Call Trace:\n   flush_space+0x4a8/0x660\n   btrfs_async_reclaim_data_space+0x55/0x130\n   process_one_work+0x1e9/0x380\n   worker_thread+0x53/0x3e0\n   ? process_one_work+0x380/0x380\n   kthread+0x118/0x140\n   ? __kthread_bind_mask+0x60/0x60\n   ret_from_fork+0x1f/0x30\n\nFix this by checking to see if we have a btrfs fs error in either of the\nreclaim loops, and if so fail the tickets and bail.  In addition to\nthis, fix maybe_fail_all_tickets() to not try to grant tickets if we've\naborted, simply fail everything.\n\nReviewed-by: Nikolay Borisov <nborisov@suse.com>\nReviewed-by: Filipe Manana <fdmanana@suse.com>\nSigned-off-by: Josef Bacik <josef@toxicpanda.com>\nSigned-off-by: David Sterba <dsterba@suse.com>",
  "full_message": "btrfs: do not infinite loop in data reclaim if we aborted\n\nError injection stressing uncovered a busy loop in our data reclaim\nloop.  There are two cases here, one where we loop creating block groups\nuntil space_info->full is set, or in the main loop we will skip erroring\nout any tickets if space_info->full == 0.  Unfortunately if we aborted\nthe transaction then we will never allocate chunks or reclaim any space\nand thus never get ->full, and you'll see stack traces like this:\n\n  watchdog: BUG: soft lockup - CPU#0 stuck for 26s! [kworker/u4:4:139]\n  CPU: 0 PID: 139 Comm: kworker/u4:4 Tainted: G        W         5.13.0-rc1+ #328\n  Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS 1.13.0-2.fc32 04/01/2014\n  Workqueue: events_unbound btrfs_async_reclaim_data_space\n  RIP: 0010:btrfs_join_transaction+0x12/0x20\n  RSP: 0018:ffffb2b780b77de0 EFLAGS: 00000246\n  RAX: ffffb2b781863d58 RBX: 0000000000000000 RCX: 0000000000000000\n  RDX: 0000000000000801 RSI: ffff987952b57400 RDI: ffff987940aa3000\n  RBP: ffff987954d55000 R08: 0000000000000001 R09: ffff98795539e8f0\n  R10: 000000000000000f R11: 000000000000000f R12: ffffffffffffffff\n  R13: ffff987952b574c8 R14: ffff987952b57400 R15: 0000000000000008\n  FS:  0000000000000000(0000) GS:ffff9879bbc00000(0000) knlGS:0000000000000000\n  CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033\n  CR2: 00007f0703da4000 CR3: 0000000113398004 CR4: 0000000000370ef0\n  Call Trace:\n   flush_space+0x4a8/0x660\n   btrfs_async_reclaim_data_space+0x55/0x130\n   process_one_work+0x1e9/0x380\n   worker_thread+0x53/0x3e0\n   ? process_one_work+0x380/0x380\n   kthread+0x118/0x140\n   ? __kthread_bind_mask+0x60/0x60\n   ret_from_fork+0x1f/0x30\n\nFix this by checking to see if we have a btrfs fs error in either of the\nreclaim loops, and if so fail the tickets and bail.  In addition to\nthis, fix maybe_fail_all_tickets() to not try to grant tickets if we've\naborted, simply fail everything.\n\nReviewed-by: Nikolay Borisov <nborisov@suse.com>\nReviewed-by: Filipe Manana <fdmanana@suse.com>\nSigned-off-by: Josef Bacik <josef@toxicpanda.com>\nSigned-off-by: David Sterba <dsterba@suse.com>",
  "author_name": "Josef Bacik",
  "author_email": "josef@toxicpanda.com",
  "author_date": "Tue Oct 5 16:35:26 2021 -0400",
  "author_date_iso": "2021-10-05T16:35:26-04:00",
  "committer_name": "David Sterba",
  "committer_email": "dsterba@suse.com",
  "committer_date": "Tue Oct 26 19:08:05 2021 +0200",
  "committer_date_iso": "2021-10-26T19:08:05+02:00",
  "files_changed": [
    "fs/btrfs/space-info.c"
  ],
  "files_changed_count": 1,
  "stats": [
    {
      "file": "fs/btrfs/space-info.c",
      "insertions": 24,
      "deletions": 4
    }
  ],
  "total_insertions": 24,
  "total_deletions": 4,
  "total_changes": 28,
  "parents": [
    "849615394515cce02add9c5b931179162e251aab"
  ],
  "branches": [
    "* development",
    "remotes/origin/HEAD -> origin/master",
    "remotes/origin/master"
  ],
  "tags": [],
  "is_merge": false,
  "security_info": {
    "cve_ids": [],
    "security_keywords": [
      "injection"
    ]
  },
  "fix_type": "security",
  "file_results": [
    {
      "file": "fs/btrfs/space-info.c",
      "pre_version": false,
      "post_version": true,
      "patch": true
    }
  ]
}