{
  "hash": "ff4b9df877b30b8a371d706d3552999dee450738",
  "hash_short": "ff4b9df8",
  "subject": "KVM: IOAPIC: only set remote_irr if interrupt was injected",
  "body": "There's a bug in the IOAPIC code for level-triggered interrupts. Its\nrelatively easy to trigger by sharing (virtio-blk + usbtablet was the\ntestcase, initially reported by Gerd von Egidy).\n\nThe \"remote_irr\" variable is used to indicate accepted but not yet acked\ninterrupts. Its cleared from the EOI handler.\n\nProblem is that the EOI handler clears remote_irr unconditionally, even\nif it reinjected another pending interrupt.\n\nIn that case, kvm_ioapic_set_irq() proceeds to ioapic_service() which\nsets remote_irr even if it failed to inject (since the IRR was high due\nto EOI reinjection).\n\nSince the TMR bit has been cleared by the first EOI, the second one\nfails to clear remote_irr.\n\nEnd result is interrupt line dead.\n\nFix it by setting remote_irr only if a new pending interrupt has been\ngenerated (and the TMR bit for vector in question set).\n\nSigned-off-by: Marcelo Tosatti <mtosatti@redhat.com>\nSigned-off-by: Avi Kivity <avi@qumranet.com>",
  "full_message": "KVM: IOAPIC: only set remote_irr if interrupt was injected\n\nThere's a bug in the IOAPIC code for level-triggered interrupts. Its\nrelatively easy to trigger by sharing (virtio-blk + usbtablet was the\ntestcase, initially reported by Gerd von Egidy).\n\nThe \"remote_irr\" variable is used to indicate accepted but not yet acked\ninterrupts. Its cleared from the EOI handler.\n\nProblem is that the EOI handler clears remote_irr unconditionally, even\nif it reinjected another pending interrupt.\n\nIn that case, kvm_ioapic_set_irq() proceeds to ioapic_service() which\nsets remote_irr even if it failed to inject (since the IRR was high due\nto EOI reinjection).\n\nSince the TMR bit has been cleared by the first EOI, the second one\nfails to clear remote_irr.\n\nEnd result is interrupt line dead.\n\nFix it by setting remote_irr only if a new pending interrupt has been\ngenerated (and the TMR bit for vector in question set).\n\nSigned-off-by: Marcelo Tosatti <mtosatti@redhat.com>\nSigned-off-by: Avi Kivity <avi@qumranet.com>",
  "author_name": "Marcelo Tosatti",
  "author_email": "mtosatti@redhat.com",
  "author_date": "Thu Jun 5 00:08:11 2008 -0300",
  "author_date_iso": "2008-06-05T00:08:11-03:00",
  "committer_name": "Avi Kivity",
  "committer_email": "avi@qumranet.com",
  "committer_date": "Fri Jun 6 21:32:39 2008 +0300",
  "committer_date_iso": "2008-06-06T21:32:39+03:00",
  "files_changed": [
    "virt/kvm/ioapic.c"
  ],
  "files_changed_count": 1,
  "stats": [
    {
      "file": "virt/kvm/ioapic.c",
      "insertions": 11,
      "deletions": 10
    }
  ],
  "total_insertions": 11,
  "total_deletions": 10,
  "total_changes": 21,
  "parents": [
    "8d2d73b9a5c35f2c6abf427afba7888cfc4cc65d"
  ],
  "branches": [
    "* development",
    "master",
    "remotes/origin/HEAD -> origin/master",
    "remotes/origin/master"
  ],
  "tags": [
    "v2.6.26",
    "v2.6.26-rc6",
    "v2.6.26-rc7",
    "v2.6.26-rc8",
    "v2.6.26-rc9",
    "v2.6.27",
    "v2.6.27-rc1",
    "v2.6.27-rc2",
    "v2.6.27-rc3",
    "v2.6.27-rc4"
  ],
  "is_merge": false,
  "security_info": {
    "cve_ids": [],
    "security_keywords": [
      "inject"
    ]
  },
  "fix_type": "security",
  "file_results": [
    {
      "file": "virt/kvm/ioapic.c",
      "pre_version": false,
      "post_version": true,
      "patch": true
    }
  ]
}