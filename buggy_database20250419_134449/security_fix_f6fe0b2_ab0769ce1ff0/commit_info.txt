Commit Hash: f6fe0b2d35457c10ec37acc209d19726bdc16dbd
Subject: nvme-pci: fix sleeping function called from interrupt context


Security Keywords:
- authentication

Full commit message:
nvme-pci: fix sleeping function called from interrupt context

the nvme_handle_cqe() interrupt handler calls nvme_complete_async_event()
but the latter may call nvme_auth_stop() which is a blocking function.
Sleeping functions can't be called in interrupt context

 BUG: sleeping function called from invalid context
 in_atomic(): 1, irqs_disabled(): 1, non_block: 0, pid: 0, name: swapper/15
  Call Trace:
     <IRQ>
      __cancel_work_timer+0x31e/0x460
      ? nvme_change_ctrl_state+0xcf/0x3c0 [nvme_core]
      ? nvme_change_ctrl_state+0xcf/0x3c0 [nvme_core]
      nvme_complete_async_event+0x365/0x480 [nvme_core]
      nvme_poll_cq+0x262/0xe50 [nvme]

Fix the bug by moving nvme_auth_stop() to fw_act_work
(executed by the nvme_wq workqueue)

Fixes: f50fff73d620 ("nvme: implement In-Band authentication")
Signed-off-by: Maurizio Lombardi <mlombard@redhat.com>
Reviewed-by: Jens Axboe <axboe@kernel.dk>
Reviewed-by: Sagi Grimberg <sagi@grimberg.me>
Signed-off-by: Keith Busch <kbusch@kernel.org>

Metadata:
Author: Maurizio Lombardi <mlombard@redhat.com>
Author Date: Tue Dec 19 17:48:23 2023 +0100
Committer: Keith Busch <kbusch@kernel.org>
Commit Date: Tue Dec 19 12:41:05 2023 -0800

Files Changed: 1
Lines Added: 2
Lines Removed: 1
Total Changes: 3
