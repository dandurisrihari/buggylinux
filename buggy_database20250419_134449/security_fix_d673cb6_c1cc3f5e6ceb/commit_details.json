{
  "hash": "d673cb6fe6c03b2be157cc6c5db40481828d282d",
  "hash_short": "d673cb6f",
  "subject": "wifi: ath11k: fix peer addition/deletion error on sta band migration",
  "body": "This patch try to fix the following error.\n\nWed Jun  1 22:19:30 2022 kern.warn kernel: [  119.561227] ath11k c000000.wifi: peer already added vdev id 0 req, vdev id 1 present\nWed Jun  1 22:19:30 2022 kern.warn kernel: [  119.561282] ath11k c000000.wifi: Failed to add peer: 28:c2:1f:xx:xx:xx for VDEV: 0\nWed Jun  1 22:19:30 2022 kern.warn kernel: [  119.568053] ath11k c000000.wifi: Failed to add station: 28:c2:1f:xx:xx:xx for VDEV: 0\nWed Jun  1 22:19:31 2022 daemon.notice hostapd: wlan2: STA 28:c2:1f:xx:xx:xx IEEE 802.11: Could not add STA to kernel driver\nWed Jun  1 22:19:31 2022 daemon.notice hostapd: wlan2: STA 28:c2:1f:xx:xx:xx IEEE 802.11: did not acknowledge authentication response\nWed Jun  1 22:19:31 2022 daemon.notice hostapd: wlan1: AP-STA-DISCONNECTED 28:c2:1f:xx:xx:xx\nWed Jun  1 22:19:31 2022 daemon.info hostapd: wlan1: STA 28:c2:1f:xx:xx:xx IEEE 802.11: disassociated due to inactivity\nWed Jun  1 22:19:32 2022 daemon.info hostapd: wlan1: STA 28:c2:1f:xx:xx:xx IEEE 802.11: deauthenticated due to inactivity (timer DEAUTH/REMOVE)\n\nTo repro this:\n- Have 2 Wifi with the same bssid and pass on different band (2.4 and\n5GHz)\n- Enable 802.11r Fast Transaction with same mobility domain\n- FT Protocol: FT over the Air\nFrom a openwrt system issue the command (with the correct mac)\nubus call hostapd.wlan1 wnm_disassoc_imminent '{\"addr\":\"28:C2:1F:xx:xx:xx\"}'\nNotice the log printing the errors.\n\nThe cause of this error has been investigated and we found that this is\nrelated to the WiFi Fast Transaction feature. We observed that this is\ntriggered when the router tells the device to change band. In this case\nthe device first auth to the other band and then the disconnect path\nfrom the prev band is triggered.\nThis is problematic with the current rhash implementation since the\naddrs is used as key and the logic of \"adding first, delete later\"\nconflicts with the rhash logic.\nIn fact peer addition will fail since the peer is already added and with\nthat fixed a peer deletion will cause unitended effect by removing the\npeer just added.\n\nCurrent solution to this is to add additional logic to the peer delete,\nmake sure we are deleting the correct peer taken from the rhash\ntable (and fallback to the peer list) and for the peer add logic delete\nthe peer entry for the rhash list before adding the new one (counting as\nan error only when a peer with the same vlan_id is asked to be added).\n\nWith this change, a sta can correctly transition from 2.4GHz and 5GHZ\nwith no drop and no error are printed.\n\nTested-on: IPQ8074 hw2.0 AHB WLAN.HK.2.5.0.1-01208-QCAHKSWPL_SILICONZ-1\n\nFixes: 7b0c70d92a43 (\"ath11k: Add peer rhash table support\")\nSigned-off-by: Christian 'Ansuel' Marangi <ansuelsmth@gmail.com>\nSigned-off-by: Kalle Valo <quic_kvalo@quicinc.com>\nLink: https://lore.kernel.org/r/20220603164559.27769-1-ansuelsmth@gmail.com",
  "full_message": "wifi: ath11k: fix peer addition/deletion error on sta band migration\n\nThis patch try to fix the following error.\n\nWed Jun  1 22:19:30 2022 kern.warn kernel: [  119.561227] ath11k c000000.wifi: peer already added vdev id 0 req, vdev id 1 present\nWed Jun  1 22:19:30 2022 kern.warn kernel: [  119.561282] ath11k c000000.wifi: Failed to add peer: 28:c2:1f:xx:xx:xx for VDEV: 0\nWed Jun  1 22:19:30 2022 kern.warn kernel: [  119.568053] ath11k c000000.wifi: Failed to add station: 28:c2:1f:xx:xx:xx for VDEV: 0\nWed Jun  1 22:19:31 2022 daemon.notice hostapd: wlan2: STA 28:c2:1f:xx:xx:xx IEEE 802.11: Could not add STA to kernel driver\nWed Jun  1 22:19:31 2022 daemon.notice hostapd: wlan2: STA 28:c2:1f:xx:xx:xx IEEE 802.11: did not acknowledge authentication response\nWed Jun  1 22:19:31 2022 daemon.notice hostapd: wlan1: AP-STA-DISCONNECTED 28:c2:1f:xx:xx:xx\nWed Jun  1 22:19:31 2022 daemon.info hostapd: wlan1: STA 28:c2:1f:xx:xx:xx IEEE 802.11: disassociated due to inactivity\nWed Jun  1 22:19:32 2022 daemon.info hostapd: wlan1: STA 28:c2:1f:xx:xx:xx IEEE 802.11: deauthenticated due to inactivity (timer DEAUTH/REMOVE)\n\nTo repro this:\n- Have 2 Wifi with the same bssid and pass on different band (2.4 and\n5GHz)\n- Enable 802.11r Fast Transaction with same mobility domain\n- FT Protocol: FT over the Air\nFrom a openwrt system issue the command (with the correct mac)\nubus call hostapd.wlan1 wnm_disassoc_imminent '{\"addr\":\"28:C2:1F:xx:xx:xx\"}'\nNotice the log printing the errors.\n\nThe cause of this error has been investigated and we found that this is\nrelated to the WiFi Fast Transaction feature. We observed that this is\ntriggered when the router tells the device to change band. In this case\nthe device first auth to the other band and then the disconnect path\nfrom the prev band is triggered.\nThis is problematic with the current rhash implementation since the\naddrs is used as key and the logic of \"adding first, delete later\"\nconflicts with the rhash logic.\nIn fact peer addition will fail since the peer is already added and with\nthat fixed a peer deletion will cause unitended effect by removing the\npeer just added.\n\nCurrent solution to this is to add additional logic to the peer delete,\nmake sure we are deleting the correct peer taken from the rhash\ntable (and fallback to the peer list) and for the peer add logic delete\nthe peer entry for the rhash list before adding the new one (counting as\nan error only when a peer with the same vlan_id is asked to be added).\n\nWith this change, a sta can correctly transition from 2.4GHz and 5GHZ\nwith no drop and no error are printed.\n\nTested-on: IPQ8074 hw2.0 AHB WLAN.HK.2.5.0.1-01208-QCAHKSWPL_SILICONZ-1\n\nFixes: 7b0c70d92a43 (\"ath11k: Add peer rhash table support\")\nSigned-off-by: Christian 'Ansuel' Marangi <ansuelsmth@gmail.com>\nSigned-off-by: Kalle Valo <quic_kvalo@quicinc.com>\nLink: https://lore.kernel.org/r/20220603164559.27769-1-ansuelsmth@gmail.com",
  "author_name": "Christian 'Ansuel' Marangi",
  "author_email": "ansuelsmth@gmail.com",
  "author_date": "Thu Sep 22 10:35:14 2022 +0300",
  "author_date_iso": "2022-09-22T10:35:14+03:00",
  "committer_name": "Kalle Valo",
  "committer_email": "quic_kvalo@quicinc.com",
  "committer_date": "Sat Sep 24 16:42:29 2022 +0300",
  "committer_date_iso": "2022-09-24T16:42:29+03:00",
  "files_changed": [
    "drivers/net/wireless/ath/ath11k/peer.c"
  ],
  "files_changed_count": 1,
  "stats": [
    {
      "file": "drivers/net/wireless/ath/ath11k/peer.c",
      "insertions": 26,
      "deletions": 4
    }
  ],
  "total_insertions": 26,
  "total_deletions": 4,
  "total_changes": 30,
  "parents": [
    "55b5ee3357d7bb98ee578cf9b84a652e7a1bc199"
  ],
  "branches": [
    "* development",
    "remotes/origin/HEAD -> origin/master",
    "remotes/origin/master"
  ],
  "tags": [],
  "is_merge": false,
  "security_info": {
    "cve_ids": [],
    "security_keywords": [
      "authentication"
    ]
  },
  "fix_type": "security",
  "file_results": [
    {
      "file": "drivers/net/wireless/ath/ath11k/peer.c",
      "pre_version": false,
      "post_version": true,
      "patch": true
    }
  ]
}