Commit Hash: fa40a8214bb9bcae8d49c234c19d8b4a6c1f37ff
Subject: KVM: switch irq injection/acking data structures to irq_lock


Security Keywords:
- injection

Full commit message:
KVM: switch irq injection/acking data structures to irq_lock

Protect irq injection/acking data structures with a separate irq_lock
mutex. This fixes the following deadlock:

CPU A                               CPU B
kvm_vm_ioctl_deassign_dev_irq()
  mutex_lock(&kvm->lock);            worker_thread()
  -> kvm_deassign_irq()                -> kvm_assigned_dev_interrupt_work_handler()
    -> deassign_host_irq()               mutex_lock(&kvm->lock);
      -> cancel_work_sync() [blocked]

[gleb: fix ia64 path]

Reported-by: Alex Williamson <alex.williamson@hp.com>
Signed-off-by: Marcelo Tosatti <mtosatti@redhat.com>
Signed-off-by: Gleb Natapov <gleb@redhat.com>
Signed-off-by: Avi Kivity <avi@redhat.com>

Metadata:
Author: Marcelo Tosatti <mtosatti@redhat.com>
Author Date: Thu Jun 4 15:08:24 2009 -0300
Committer: Avi Kivity <avi@redhat.com>
Commit Date: Thu Sep 10 08:32:49 2009 +0300

Files Changed: 8
Lines Added: 58
Lines Removed: 30
Total Changes: 88
