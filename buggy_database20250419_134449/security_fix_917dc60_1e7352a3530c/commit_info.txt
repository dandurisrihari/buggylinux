Commit Hash: 917dc6068bc12a2dafffcf0e9d405ddb1b8780cb
Subject: KVM: nVMX: Fix vmx_check_nested_events() return value in case an event was reinjected to L2


Security Keywords:
- injection

Full commit message:
KVM: nVMX: Fix vmx_check_nested_events() return value in case an event was reinjected to L2

vmx_check_nested_events() should return -EBUSY only in case there is a
pending L1 event which requires a VMExit from L2 to L1 but such a
VMExit is currently blocked. Such VMExits are blocked either
because nested_run_pending=1 or an event was reinjected to L2.
vmx_check_nested_events() should return 0 in case there are no
pending L1 events which requires a VMExit from L2 to L1 or if
a VMExit from L2 to L1 was done internally.

However, upstream commit which introduced blocking in case an event was
reinjected to L2 (commit acc9ab601327 ("KVM: nVMX: Fix pending events
injection")) contains a bug: It returns -EBUSY even if there are no
pending L1 events which requires VMExit from L2 to L1.

This commit fix this issue.

Fixes: acc9ab601327 ("KVM: nVMX: Fix pending events injection")

Signed-off-by: Liran Alon <liran.alon@oracle.com>
Reviewed-by: Nikita Leshenko <nikita.leshchenko@oracle.com>
Signed-off-by: Konrad Rzeszutek Wilk <konrad.wilk@oracle.com>
Signed-off-by: Radim Krčmář <rkrcmar@redhat.com>

Metadata:
Author: Liran Alon <liran.alon@oracle.com>
Author Date: Sun Nov 5 16:07:43 2017 +0200
Committer: Paolo Bonzini <pbonzini@redhat.com>
Commit Date: Fri Nov 17 13:20:21 2017 +0100

Files Changed: 1
Lines Added: 6
Lines Removed: 7
Total Changes: 13
