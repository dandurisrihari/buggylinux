Commit Hash: a048a07d7f4535baa4cbad6bc024f175317ab938
Subject: powerpc/64s: Add support for a store forwarding barrier at kernel entry/exit


Security Keywords:
- vulnerability

Full commit message:
powerpc/64s: Add support for a store forwarding barrier at kernel entry/exit

On some CPUs we can prevent a vulnerability related to store-to-load
forwarding by preventing store forwarding between privilege domains,
by inserting a barrier in kernel entry and exit paths.

This is known to be the case on at least Power7, Power8 and Power9
powerpc CPUs.

Barriers must be inserted generally before the first load after moving
to a higher privilege, and after the last store before moving to a
lower privilege, HV and PR privilege transitions must be protected.

Barriers are added as patch sections, with all kernel/hypervisor entry
points patched, and the exit points to lower privilge levels patched
similarly to the RFI flush patching.

Firmware advertisement is not implemented yet, so CPU flush types
are hard coded.

Thanks to Michal Suchánek for bug fixes and review.

Signed-off-by: Nicholas Piggin <npiggin@gmail.com>
Signed-off-by: Mauricio Faria de Oliveira <mauricfo@linux.vnet.ibm.com>
Signed-off-by: Michael Neuling <mikey@neuling.org>
Signed-off-by: Michal Suchánek <msuchanek@suse.de>
Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>

Metadata:
Author: Nicholas Piggin <npiggin@gmail.com>
Author Date: Tue May 22 09:00:00 2018 +1000
Committer: Linus Torvalds <torvalds@linux-foundation.org>
Commit Date: Mon May 21 20:45:31 2018 -0700

Files Changed: 9
Lines Added: 356
Lines Removed: 2
Total Changes: 358
