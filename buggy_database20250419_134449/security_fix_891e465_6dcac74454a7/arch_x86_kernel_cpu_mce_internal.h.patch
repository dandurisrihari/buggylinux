commit 891e465a1bd8798d5f97c3afb99393f123817fef
Author: Smita Koralahalli <Smita.KoralahalliChannabasappa@amd.com>
Date:   Mon Jun 27 20:56:46 2022 +0000

    x86/mce: Check whether writes to MCA_STATUS are getting ignored
    
    The platform can sometimes - depending on its settings - cause writes
    to MCA_STATUS MSRs to get ignored, regardless of HWCR[McStatusWrEn]'s
    value.
    
    For further info see
    
      PPR for AMD Family 19h, Model 01h, Revision B1 Processors, doc ID 55898
    
    at https://bugzilla.kernel.org/show_bug.cgi?id=206537.
    
    Therefore, probe for ignored writes to MCA_STATUS to determine if hardware
    error injection is at all possible.
    
      [ bp: Heavily massage commit message and patch. ]
    
    Signed-off-by: Smita Koralahalli <Smita.KoralahalliChannabasappa@amd.com>
    Signed-off-by: Borislav Petkov <bp@suse.de>
    Link: https://lore.kernel.org/r/20220214233640.70510-2-Smita.KoralahalliChannabasappa@amd.com

diff --git a/arch/x86/kernel/cpu/mce/internal.h b/arch/x86/kernel/cpu/mce/internal.h
index 4ae0e603f7fa..7e03f5b7f6bd 100644
--- a/arch/x86/kernel/cpu/mce/internal.h
+++ b/arch/x86/kernel/cpu/mce/internal.h
@@ -211,7 +211,7 @@ noinstr u64 mce_rdmsrl(u32 msr);
 
 static __always_inline u32 mca_msr_reg(int bank, enum mca_msr reg)
 {
-	if (mce_flags.smca) {
+	if (cpu_feature_enabled(X86_FEATURE_SMCA)) {
 		switch (reg) {
 		case MCA_CTL:	 return MSR_AMD64_SMCA_MCx_CTL(bank);
 		case MCA_ADDR:	 return MSR_AMD64_SMCA_MCx_ADDR(bank);