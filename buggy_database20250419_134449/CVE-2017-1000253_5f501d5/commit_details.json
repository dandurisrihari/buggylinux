{
  "hash": "5f501d555653f8968011a1e65ebb121c8b43c144",
  "hash_short": "5f501d55",
  "subject": "binfmt_elf: reintroduce using MAP_FIXED_NOREPLACE",
  "body": "Commit b212921b13bd (\"elf: don't use MAP_FIXED_NOREPLACE for elf\nexecutable mappings\") reverted back to using MAP_FIXED to map ELF LOAD\nsegments because it was found that the segments in some binaries overlap\nand can cause MAP_FIXED_NOREPLACE to fail.\n\nThe original intent of MAP_FIXED_NOREPLACE in the ELF loader was to\nprevent the silent clobbering of an existing mapping (e.g.  stack) by\nthe ELF image, which could lead to exploitable conditions.  Quoting\ncommit 4ed28639519c (\"fs, elf: drop MAP_FIXED usage from elf_map\"),\nwhich originally introduced the use of MAP_FIXED_NOREPLACE in the\nloader:\n\n    Both load_elf_interp and load_elf_binary rely on elf_map to map\n    segments [to a specific] address and they use MAP_FIXED to enforce\n    that. This is however [a] dangerous thing prone to silent data\n    corruption which can be even exploitable.\n    ...\n    Let's take CVE-2017-1000253 as an example ... we could end up mapping\n    [the executable] over the existing stack ... The [stack layout] issue\n    has been fixed since then ... So we should be safe and any [similar]\n    attack should be impractical. On the other hand this is just too\n    subtle [an] assumption ... it can break quite easily and [be] hard to\n    spot.\n    ...\n    Address this [weakness] by changing MAP_FIXED to the newly added\n    MAP_FIXED_NOREPLACE. This will mean that mmap will fail if there is\n    an existing mapping clashing with the requested one [instead of\n    silently] clobbering it.\n\nThen processing ET_DYN binaries the loader already calculates a total\nsize for the image when the first segment is mapped, maps the entire\nimage, and then unmaps the remainder before the remaining segments are\nthen individually mapped.\n\nTo avoid the earlier problems (legitimate overlapping LOAD segments\nspecified in the ELF), apply the same logic to ET_EXEC binaries as well.\n\nFor both ET_EXEC and ET_DYN+INTERP use MAP_FIXED_NOREPLACE for the\ninitial total size mapping and then use MAP_FIXED to build the final\n(possibly legitimately overlapping) mappings.  For ET_DYN w/out INTERP,\ncontinue to map at a system-selected address in the mmap region.\n\nLink: https://lkml.kernel.org/r/20210916215947.3993776-1-keescook@chromium.org\nLink: https://lore.kernel.org/lkml/1595869887-23307-2-git-send-email-anthony.yznaga@oracle.com\nCo-developed-by: Anthony Yznaga <anthony.yznaga@oracle.com>\nSigned-off-by: Anthony Yznaga <anthony.yznaga@oracle.com>\nSigned-off-by: Kees Cook <keescook@chromium.org>\nCc: Russell King <linux@armlinux.org.uk>\nCc: Michal Hocko <mhocko@suse.com>\nCc: Eric Biederman <ebiederm@xmission.com>\nCc: Chen Jingwen <chenjingwen6@huawei.com>\nCc: Alexander Viro <viro@zeniv.linux.org.uk>\nCc: Andrei Vagin <avagin@openvz.org>\nCc: Khalid Aziz <khalid.aziz@oracle.com>\nCc: Michael Ellerman <mpe@ellerman.id.au>\nSigned-off-by: Andrew Morton <akpm@linux-foundation.org>\nSigned-off-by: Linus Torvalds <torvalds@linux-foundation.org>",
  "full_message": "binfmt_elf: reintroduce using MAP_FIXED_NOREPLACE\n\nCommit b212921b13bd (\"elf: don't use MAP_FIXED_NOREPLACE for elf\nexecutable mappings\") reverted back to using MAP_FIXED to map ELF LOAD\nsegments because it was found that the segments in some binaries overlap\nand can cause MAP_FIXED_NOREPLACE to fail.\n\nThe original intent of MAP_FIXED_NOREPLACE in the ELF loader was to\nprevent the silent clobbering of an existing mapping (e.g.  stack) by\nthe ELF image, which could lead to exploitable conditions.  Quoting\ncommit 4ed28639519c (\"fs, elf: drop MAP_FIXED usage from elf_map\"),\nwhich originally introduced the use of MAP_FIXED_NOREPLACE in the\nloader:\n\n    Both load_elf_interp and load_elf_binary rely on elf_map to map\n    segments [to a specific] address and they use MAP_FIXED to enforce\n    that. This is however [a] dangerous thing prone to silent data\n    corruption which can be even exploitable.\n    ...\n    Let's take CVE-2017-1000253 as an example ... we could end up mapping\n    [the executable] over the existing stack ... The [stack layout] issue\n    has been fixed since then ... So we should be safe and any [similar]\n    attack should be impractical. On the other hand this is just too\n    subtle [an] assumption ... it can break quite easily and [be] hard to\n    spot.\n    ...\n    Address this [weakness] by changing MAP_FIXED to the newly added\n    MAP_FIXED_NOREPLACE. This will mean that mmap will fail if there is\n    an existing mapping clashing with the requested one [instead of\n    silently] clobbering it.\n\nThen processing ET_DYN binaries the loader already calculates a total\nsize for the image when the first segment is mapped, maps the entire\nimage, and then unmaps the remainder before the remaining segments are\nthen individually mapped.\n\nTo avoid the earlier problems (legitimate overlapping LOAD segments\nspecified in the ELF), apply the same logic to ET_EXEC binaries as well.\n\nFor both ET_EXEC and ET_DYN+INTERP use MAP_FIXED_NOREPLACE for the\ninitial total size mapping and then use MAP_FIXED to build the final\n(possibly legitimately overlapping) mappings.  For ET_DYN w/out INTERP,\ncontinue to map at a system-selected address in the mmap region.\n\nLink: https://lkml.kernel.org/r/20210916215947.3993776-1-keescook@chromium.org\nLink: https://lore.kernel.org/lkml/1595869887-23307-2-git-send-email-anthony.yznaga@oracle.com\nCo-developed-by: Anthony Yznaga <anthony.yznaga@oracle.com>\nSigned-off-by: Anthony Yznaga <anthony.yznaga@oracle.com>\nSigned-off-by: Kees Cook <keescook@chromium.org>\nCc: Russell King <linux@armlinux.org.uk>\nCc: Michal Hocko <mhocko@suse.com>\nCc: Eric Biederman <ebiederm@xmission.com>\nCc: Chen Jingwen <chenjingwen6@huawei.com>\nCc: Alexander Viro <viro@zeniv.linux.org.uk>\nCc: Andrei Vagin <avagin@openvz.org>\nCc: Khalid Aziz <khalid.aziz@oracle.com>\nCc: Michael Ellerman <mpe@ellerman.id.au>\nSigned-off-by: Andrew Morton <akpm@linux-foundation.org>\nSigned-off-by: Linus Torvalds <torvalds@linux-foundation.org>",
  "author_name": "Kees Cook",
  "author_email": "keescook@chromium.org",
  "author_date": "Mon Nov 8 18:33:37 2021 -0800",
  "author_date_iso": "2021-11-08T18:33:37-08:00",
  "committer_name": "Linus Torvalds",
  "committer_email": "torvalds@linux-foundation.org",
  "committer_date": "Tue Nov 9 10:02:50 2021 -0800",
  "committer_date_iso": "2021-11-09T10:02:50-08:00",
  "files_changed": [
    "fs/binfmt_elf.c"
  ],
  "files_changed_count": 1,
  "stats": [
    {
      "file": "fs/binfmt_elf.c",
      "insertions": 22,
      "deletions": 9
    }
  ],
  "total_insertions": 22,
  "total_deletions": 9,
  "total_changes": 31,
  "parents": [
    "0ee3e7b8893eca232cb118cb4874324ebfe9f767"
  ],
  "branches": [
    "* development",
    "remotes/origin/HEAD -> origin/master",
    "remotes/origin/master"
  ],
  "tags": [],
  "is_merge": false,
  "security_info": {
    "cve_ids": [
      "CVE-2017-1000253"
    ],
    "security_keywords": []
  },
  "fix_type": "cve",
  "file_results": [
    {
      "file": "fs/binfmt_elf.c",
      "pre_version": false,
      "post_version": true,
      "patch": true
    }
  ]
}