{
  "hash": "9df3f5082ff94c55e84523a28c040445220b2f64",
  "hash_short": "9df3f508",
  "subject": "arm64: avoid redundant PAC stripping in __builtin_return_address()",
  "body": "In old versions of GCC and Clang, __builtin_return_address() did not\nstrip the PAC. This was not the behaviour we desired, and so we wrapped\nthis with code to strip the PAC in commit:\n\n  689eae42afd7a916 (\"arm64: mask PAC bits of __builtin_return_address\")\n\nSince then, both GCC and Clang decided that __builtin_return_address()\n*should* strip the PAC, and the existing behaviour was a bug.\n\nGCC was fixed in 11.1.0, with those fixes backported to 10.2.0, 9.4.0,\n8.5.0, but not earlier:\n\n  https://gcc.gnu.org/bugzilla/show_bug.cgi?id=94891\n\nClang was fixed in 12.0.0, though this was not backported:\n\n  https://reviews.llvm.org/D75044\n\nWhen using a compiler whose __builtin_return_address() strips the PAC,\nour wrapper to strip the PAC is redundant. Similarly, when pointer\nauthentication is not in use within the kernel pointers will not have a\nPAC, and so there's no point stripping those pointers.\n\nTo avoid this redundant work, this patch updates the\n__builtin_return_address() wrapper to only be used when in-kernel\npointer authentication is configured and the compiler's\n__builtin_return_address() does not strip the PAC.\n\nThis is a cleanup/optimization, and not a fix that requires backporting.\nStripping a PAC should be an idempotent operation, and so redundantly\nstripping the PAC is not harmful.\n\nThere should be no functional change as a result of this patch.\n\nSigned-off-by: Mark Rutland <mark.rutland@arm.com>\nCc: Amit Daniel Kachhap <amit.kachhap@arm.com>\nCc: Catalin Marinas <catalin.marinas@arm.com>\nCc: James Morse <james.morse@arm.com>\nCc: Kristina Martsenko <kristina.martsenko@arm.com>\nCc: Will Deacon <will@kernel.org>\nLink: https://lore.kernel.org/r/20230412160134.306148-2-mark.rutland@arm.com\nSigned-off-by: Will Deacon <will@kernel.org>",
  "full_message": "arm64: avoid redundant PAC stripping in __builtin_return_address()\n\nIn old versions of GCC and Clang, __builtin_return_address() did not\nstrip the PAC. This was not the behaviour we desired, and so we wrapped\nthis with code to strip the PAC in commit:\n\n  689eae42afd7a916 (\"arm64: mask PAC bits of __builtin_return_address\")\n\nSince then, both GCC and Clang decided that __builtin_return_address()\n*should* strip the PAC, and the existing behaviour was a bug.\n\nGCC was fixed in 11.1.0, with those fixes backported to 10.2.0, 9.4.0,\n8.5.0, but not earlier:\n\n  https://gcc.gnu.org/bugzilla/show_bug.cgi?id=94891\n\nClang was fixed in 12.0.0, though this was not backported:\n\n  https://reviews.llvm.org/D75044\n\nWhen using a compiler whose __builtin_return_address() strips the PAC,\nour wrapper to strip the PAC is redundant. Similarly, when pointer\nauthentication is not in use within the kernel pointers will not have a\nPAC, and so there's no point stripping those pointers.\n\nTo avoid this redundant work, this patch updates the\n__builtin_return_address() wrapper to only be used when in-kernel\npointer authentication is configured and the compiler's\n__builtin_return_address() does not strip the PAC.\n\nThis is a cleanup/optimization, and not a fix that requires backporting.\nStripping a PAC should be an idempotent operation, and so redundantly\nstripping the PAC is not harmful.\n\nThere should be no functional change as a result of this patch.\n\nSigned-off-by: Mark Rutland <mark.rutland@arm.com>\nCc: Amit Daniel Kachhap <amit.kachhap@arm.com>\nCc: Catalin Marinas <catalin.marinas@arm.com>\nCc: James Morse <james.morse@arm.com>\nCc: Kristina Martsenko <kristina.martsenko@arm.com>\nCc: Will Deacon <will@kernel.org>\nLink: https://lore.kernel.org/r/20230412160134.306148-2-mark.rutland@arm.com\nSigned-off-by: Will Deacon <will@kernel.org>",
  "author_name": "Mark Rutland",
  "author_email": "mark.rutland@arm.com",
  "author_date": "Wed Apr 12 17:01:32 2023 +0100",
  "author_date_iso": "2023-04-12T17:01:32+01:00",
  "committer_name": "Will Deacon",
  "committer_email": "will@kernel.org",
  "committer_date": "Thu Apr 13 12:27:11 2023 +0100",
  "committer_date_iso": "2023-04-13T12:27:11+01:00",
  "files_changed": [
    "arch/arm64/Kconfig",
    "arch/arm64/include/asm/compiler.h"
  ],
  "files_changed_count": 2,
  "stats": [
    {
      "file": "arch/arm64/Kconfig",
      "insertions": 14,
      "deletions": 0
    },
    {
      "file": "arch/arm64/include/asm/compiler.h",
      "insertions": 3,
      "deletions": 0
    }
  ],
  "total_insertions": 17,
  "total_deletions": 0,
  "total_changes": 17,
  "parents": [
    "b5ecc19e684eee1df32a035b7d981932f344fc67"
  ],
  "branches": [
    "* development",
    "remotes/origin/HEAD -> origin/master",
    "remotes/origin/master"
  ],
  "tags": [],
  "is_merge": false,
  "security_info": {
    "cve_ids": [],
    "security_keywords": [
      "authentication"
    ]
  },
  "fix_type": "security",
  "file_results": [
    {
      "file": "arch/arm64/Kconfig",
      "pre_version": false,
      "post_version": true,
      "patch": true
    },
    {
      "file": "arch/arm64/include/asm/compiler.h",
      "pre_version": false,
      "post_version": true,
      "patch": true
    }
  ]
}