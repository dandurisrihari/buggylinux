commit 46738b1317e169b281ad74690276916e24d1be6d
Author: David Lebrun <david.lebrun@uclouvain.be>
Date:   Tue Nov 15 16:14:04 2016 +0100

    ipv6: sr: add option to control lwtunnel support
    
    This patch adds a new option CONFIG_IPV6_SEG6_LWTUNNEL to enable/disable
    support of encapsulation with the lightweight tunnels. When this option
    is enabled, CONFIG_LWTUNNEL is automatically selected.
    
    Fix commit 6c8702c60b88 ("ipv6: sr: add support for SRH encapsulation and injection with lwtunnels")
    
    Without a proper option to control lwtunnel support for SR-IPv6, if
    CONFIG_LWTUNNEL=n then the IPv6 initialization fails as a consequence
    of seg6_iptunnel_init() failure with EOPNOTSUPP:
    
    NET: Registered protocol family 10
    IPv6: Attempt to unregister permanent protocol 6
    IPv6: Attempt to unregister permanent protocol 136
    IPv6: Attempt to unregister permanent protocol 17
    NET: Unregistered protocol family 10
    
    Tested (compiling, booting, and loading ipv6 module when relevant)
    with possible combinations of CONFIG_IPV6={y,m,n},
    CONFIG_IPV6_SEG6_LWTUNNEL={y,n} and CONFIG_LWTUNNEL={y,n}.
    
    Reported-by: Lorenzo Colitti <lorenzo@google.com>
    Suggested-by: Roopa Prabhu <roopa@cumulusnetworks.com>
    Signed-off-by: David Lebrun <david.lebrun@uclouvain.be>
    Signed-off-by: David S. Miller <davem@davemloft.net>

diff --git a/net/ipv6/Kconfig b/net/ipv6/Kconfig
index 0f00811a785f..ec1267e2bd1f 100644
--- a/net/ipv6/Kconfig
+++ b/net/ipv6/Kconfig
@@ -289,9 +289,20 @@ config IPV6_PIMSM_V2
 	  Support for IPv6 PIM multicast routing protocol PIM-SMv2.
 	  If unsure, say N.
 
+config IPV6_SEG6_LWTUNNEL
+	bool "IPv6: Segment Routing Header encapsulation support"
+	depends on IPV6
+	select LWTUNNEL
+	---help---
+	  Support for encapsulation of packets within an outer IPv6
+	  header and a Segment Routing Header using the lightweight
+	  tunnels mechanism.
+
+	  If unsure, say N.
+
 config IPV6_SEG6_INLINE
 	bool "IPv6: direct Segment Routing Header insertion "
-	depends on IPV6
+	depends on IPV6_SEG6_LWTUNNEL
 	---help---
 	  Support for direct insertion of the Segment Routing Header,
 	  also known as inline mode. Be aware that direct insertion of