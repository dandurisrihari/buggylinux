{
  "hash": "603ead96582d85903baec2d55f021b8dac5c25d2",
  "hash_short": "603ead96",
  "subject": "net: sparx5: Add spinlock for frame transmission from CPU",
  "body": "Both registers used when doing manual injection or fdma injection are\nshared between all the net devices of the switch. It was noticed that\nwhen having two process which each of them trying to inject frames on\ndifferent ethernet ports, that the HW started to behave strange, by\nsending out more frames then expected. When doing fdma injection it is\nrequired to set the frame in the DCB and then make sure that the next\npointer of the last DCB is invalid. But because there is no locks for\nthis, then easily this pointer between the DCB can be broken and then it\nwould create a loop of DCBs. And that means that the HW will\ncontinuously transmit these frames in a loop. Until the SW will break\nthis loop.\nTherefore to fix this issue, add a spin lock for when accessing the\nregisters for manual or fdma injection.\n\nSigned-off-by: Horatiu Vultur <horatiu.vultur@microchip.com>\nReviewed-by: Daniel Machon <daniel.machon@microchip.com>\nFixes: f3cad2611a77 (\"net: sparx5: add hostmode with phylink support\")\nLink: https://lore.kernel.org/r/20240219080043.1561014-1-horatiu.vultur@microchip.com\nSigned-off-by: Jakub Kicinski <kuba@kernel.org>",
  "full_message": "net: sparx5: Add spinlock for frame transmission from CPU\n\nBoth registers used when doing manual injection or fdma injection are\nshared between all the net devices of the switch. It was noticed that\nwhen having two process which each of them trying to inject frames on\ndifferent ethernet ports, that the HW started to behave strange, by\nsending out more frames then expected. When doing fdma injection it is\nrequired to set the frame in the DCB and then make sure that the next\npointer of the last DCB is invalid. But because there is no locks for\nthis, then easily this pointer between the DCB can be broken and then it\nwould create a loop of DCBs. And that means that the HW will\ncontinuously transmit these frames in a loop. Until the SW will break\nthis loop.\nTherefore to fix this issue, add a spin lock for when accessing the\nregisters for manual or fdma injection.\n\nSigned-off-by: Horatiu Vultur <horatiu.vultur@microchip.com>\nReviewed-by: Daniel Machon <daniel.machon@microchip.com>\nFixes: f3cad2611a77 (\"net: sparx5: add hostmode with phylink support\")\nLink: https://lore.kernel.org/r/20240219080043.1561014-1-horatiu.vultur@microchip.com\nSigned-off-by: Jakub Kicinski <kuba@kernel.org>",
  "author_name": "Horatiu Vultur",
  "author_email": "horatiu.vultur@microchip.com",
  "author_date": "Mon Feb 19 09:00:43 2024 +0100",
  "author_date_iso": "2024-02-19T09:00:43+01:00",
  "committer_name": "Jakub Kicinski",
  "committer_email": "kuba@kernel.org",
  "committer_date": "Wed Feb 21 17:12:43 2024 -0800",
  "committer_date_iso": "2024-02-21T17:12:43-08:00",
  "files_changed": [
    "drivers/net/ethernet/microchip/sparx5/sparx5_main.c",
    "drivers/net/ethernet/microchip/sparx5/sparx5_main.h",
    "drivers/net/ethernet/microchip/sparx5/sparx5_packet.c"
  ],
  "files_changed_count": 3,
  "stats": [
    {
      "file": "drivers/net/ethernet/microchip/sparx5/sparx5_main.c",
      "insertions": 1,
      "deletions": 0
    },
    {
      "file": "drivers/net/ethernet/microchip/sparx5/sparx5_main.h",
      "insertions": 1,
      "deletions": 0
    },
    {
      "file": "drivers/net/ethernet/microchip/sparx5/sparx5_packet.c",
      "insertions": 2,
      "deletions": 0
    }
  ],
  "total_insertions": 4,
  "total_deletions": 0,
  "total_changes": 4,
  "parents": [
    "1fde0ca3a0de7e9f917668941156959dd5e9108b"
  ],
  "branches": [
    "* development",
    "remotes/origin/HEAD -> origin/master",
    "remotes/origin/master"
  ],
  "tags": [],
  "is_merge": false,
  "security_info": {
    "cve_ids": [],
    "security_keywords": [
      "injection"
    ]
  },
  "fix_type": "security",
  "file_results": [
    {
      "file": "drivers/net/ethernet/microchip/sparx5/sparx5_main.c",
      "pre_version": false,
      "post_version": true,
      "patch": true
    },
    {
      "file": "drivers/net/ethernet/microchip/sparx5/sparx5_main.h",
      "pre_version": false,
      "post_version": true,
      "patch": true
    },
    {
      "file": "drivers/net/ethernet/microchip/sparx5/sparx5_packet.c",
      "pre_version": false,
      "post_version": true,
      "patch": true
    }
  ]
}