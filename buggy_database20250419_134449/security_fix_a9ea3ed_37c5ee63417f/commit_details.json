{
  "hash": "a9ea3ed9b71cc3271dd59e76f65748adcaa76422",
  "hash_short": "a9ea3ed9",
  "subject": "Bluetooth: Fix legacy pairing with some devices",
  "body": "Some devices e.g. some Android based phones don't do SDP search before\npairing and cancel legacy pairing when ACL is disconnected.\n\nPIN Code Request event which changes ACL timeout to HCI_PAIRING_TIMEOUT\nis only received after remote user entered PIN.\n\nIn that case no L2CAP is connected so default HCI_DISCONN_TIMEOUT\n(2 seconds) is being used to timeout ACL connection. This results in\nproblems with legacy pairing as remote user has only few seconds to\nenter PIN before ACL is disconnected.\n\nIncrease disconnect timeout for incomming connection to\nHCI_PAIRING_TIMEOUT if SSP is disabled and no linkey exists.\n\nTo avoid keeping ACL alive for too long after SDP search set ACL\ntimeout back to HCI_DISCONN_TIMEOUT when L2CAP is connected.\n\n2012-07-19 13:24:43.413521 < HCI Command: Create Connection (0x01|0x0005) plen 13\n    bdaddr 00:02:72:D6:6A:3F ptype 0xcc18 rswitch 0x01 clkoffset 0x0000\n    Packet type: DM1 DM3 DM5 DH1 DH3 DH5\n2012-07-19 13:24:43.425224 > HCI Event: Command Status (0x0f) plen 4\n    Create Connection (0x01|0x0005) status 0x00 ncmd 1\n2012-07-19 13:24:43.885222 > HCI Event: Role Change (0x12) plen 8\n    status 0x00 bdaddr 00:02:72:D6:6A:3F role 0x01\n    Role: Slave\n2012-07-19 13:24:44.054221 > HCI Event: Connect Complete (0x03) plen 11\n    status 0x00 handle 42 bdaddr 00:02:72:D6:6A:3F type ACL encrypt 0x00\n2012-07-19 13:24:44.054313 < HCI Command: Read Remote Supported Features (0x01|0x001b) plen 2\n    handle 42\n2012-07-19 13:24:44.055176 > HCI Event: Page Scan Repetition Mode Change (0x20) plen 7\n    bdaddr 00:02:72:D6:6A:3F mode 0\n2012-07-19 13:24:44.056217 > HCI Event: Max Slots Change (0x1b) plen 3\n    handle 42 slots 5\n2012-07-19 13:24:44.059218 > HCI Event: Command Status (0x0f) plen 4\n    Read Remote Supported Features (0x01|0x001b) status 0x00 ncmd 0\n2012-07-19 13:24:44.062192 > HCI Event: Command Status (0x0f) plen 4\n    Unknown (0x00|0x0000) status 0x00 ncmd 1\n2012-07-19 13:24:44.067219 > HCI Event: Read Remote Supported Features (0x0b) plen 11\n    status 0x00 handle 42\n    Features: 0xbf 0xfe 0xcf 0xfe 0xdb 0xff 0x7b 0x87\n2012-07-19 13:24:44.067248 < HCI Command: Read Remote Extended Features (0x01|0x001c) plen 3\n    handle 42 page 1\n2012-07-19 13:24:44.071217 > HCI Event: Command Status (0x0f) plen 4\n    Read Remote Extended Features (0x01|0x001c) status 0x00 ncmd 1\n2012-07-19 13:24:44.076218 > HCI Event: Read Remote Extended Features (0x23) plen 13\n    status 0x00 handle 42 page 1 max 1\n    Features: 0x01 0x00 0x00 0x00 0x00 0x00 0x00 0x00\n2012-07-19 13:24:44.076249 < HCI Command: Remote Name Request (0x01|0x0019) plen 10\n    bdaddr 00:02:72:D6:6A:3F mode 2 clkoffset 0x0000\n2012-07-19 13:24:44.081218 > HCI Event: Command Status (0x0f) plen 4\n    Remote Name Request (0x01|0x0019) status 0x00 ncmd 1\n2012-07-19 13:24:44.105214 > HCI Event: Remote Name Req Complete (0x07) plen 255\n    status 0x00 bdaddr 00:02:72:D6:6A:3F name 'uw000951-0'\n2012-07-19 13:24:44.105284 < HCI Command: Authentication Requested (0x01|0x0011) plen 2\n    handle 42\n2012-07-19 13:24:44.111207 > HCI Event: Command Status (0x0f) plen 4\n    Authentication Requested (0x01|0x0011) status 0x00 ncmd 1\n2012-07-19 13:24:44.112220 > HCI Event: Link Key Request (0x17) plen 6\n    bdaddr 00:02:72:D6:6A:3F\n2012-07-19 13:24:44.112249 < HCI Command: Link Key Request Negative Reply (0x01|0x000c) plen 6\n    bdaddr 00:02:72:D6:6A:3F\n2012-07-19 13:24:44.115215 > HCI Event: Command Complete (0x0e) plen 10\n    Link Key Request Negative Reply (0x01|0x000c) ncmd 1\n    status 0x00 bdaddr 00:02:72:D6:6A:3F\n2012-07-19 13:24:44.116215 > HCI Event: PIN Code Request (0x16) plen 6\n    bdaddr 00:02:72:D6:6A:3F\n2012-07-19 13:24:48.099184 > HCI Event: Auth Complete (0x06) plen 3\n    status 0x13 handle 42\n    Error: Remote User Terminated Connection\n2012-07-19 13:24:48.179182 > HCI Event: Disconn Complete (0x05) plen 4\n    status 0x00 handle 42 reason 0x13\n    Reason: Remote User Terminated Connection\n\nCc: stable@vger.kernel.org\nSigned-off-by: Szymon Janc <szymon.janc@tieto.com>\nAcked-by: Johan Hedberg <johan.hedberg@intel.com>\nSigned-off-by: Gustavo Padovan <gustavo.padovan@collabora.co.uk>",
  "full_message": "Bluetooth: Fix legacy pairing with some devices\n\nSome devices e.g. some Android based phones don't do SDP search before\npairing and cancel legacy pairing when ACL is disconnected.\n\nPIN Code Request event which changes ACL timeout to HCI_PAIRING_TIMEOUT\nis only received after remote user entered PIN.\n\nIn that case no L2CAP is connected so default HCI_DISCONN_TIMEOUT\n(2 seconds) is being used to timeout ACL connection. This results in\nproblems with legacy pairing as remote user has only few seconds to\nenter PIN before ACL is disconnected.\n\nIncrease disconnect timeout for incomming connection to\nHCI_PAIRING_TIMEOUT if SSP is disabled and no linkey exists.\n\nTo avoid keeping ACL alive for too long after SDP search set ACL\ntimeout back to HCI_DISCONN_TIMEOUT when L2CAP is connected.\n\n2012-07-19 13:24:43.413521 < HCI Command: Create Connection (0x01|0x0005) plen 13\n    bdaddr 00:02:72:D6:6A:3F ptype 0xcc18 rswitch 0x01 clkoffset 0x0000\n    Packet type: DM1 DM3 DM5 DH1 DH3 DH5\n2012-07-19 13:24:43.425224 > HCI Event: Command Status (0x0f) plen 4\n    Create Connection (0x01|0x0005) status 0x00 ncmd 1\n2012-07-19 13:24:43.885222 > HCI Event: Role Change (0x12) plen 8\n    status 0x00 bdaddr 00:02:72:D6:6A:3F role 0x01\n    Role: Slave\n2012-07-19 13:24:44.054221 > HCI Event: Connect Complete (0x03) plen 11\n    status 0x00 handle 42 bdaddr 00:02:72:D6:6A:3F type ACL encrypt 0x00\n2012-07-19 13:24:44.054313 < HCI Command: Read Remote Supported Features (0x01|0x001b) plen 2\n    handle 42\n2012-07-19 13:24:44.055176 > HCI Event: Page Scan Repetition Mode Change (0x20) plen 7\n    bdaddr 00:02:72:D6:6A:3F mode 0\n2012-07-19 13:24:44.056217 > HCI Event: Max Slots Change (0x1b) plen 3\n    handle 42 slots 5\n2012-07-19 13:24:44.059218 > HCI Event: Command Status (0x0f) plen 4\n    Read Remote Supported Features (0x01|0x001b) status 0x00 ncmd 0\n2012-07-19 13:24:44.062192 > HCI Event: Command Status (0x0f) plen 4\n    Unknown (0x00|0x0000) status 0x00 ncmd 1\n2012-07-19 13:24:44.067219 > HCI Event: Read Remote Supported Features (0x0b) plen 11\n    status 0x00 handle 42\n    Features: 0xbf 0xfe 0xcf 0xfe 0xdb 0xff 0x7b 0x87\n2012-07-19 13:24:44.067248 < HCI Command: Read Remote Extended Features (0x01|0x001c) plen 3\n    handle 42 page 1\n2012-07-19 13:24:44.071217 > HCI Event: Command Status (0x0f) plen 4\n    Read Remote Extended Features (0x01|0x001c) status 0x00 ncmd 1\n2012-07-19 13:24:44.076218 > HCI Event: Read Remote Extended Features (0x23) plen 13\n    status 0x00 handle 42 page 1 max 1\n    Features: 0x01 0x00 0x00 0x00 0x00 0x00 0x00 0x00\n2012-07-19 13:24:44.076249 < HCI Command: Remote Name Request (0x01|0x0019) plen 10\n    bdaddr 00:02:72:D6:6A:3F mode 2 clkoffset 0x0000\n2012-07-19 13:24:44.081218 > HCI Event: Command Status (0x0f) plen 4\n    Remote Name Request (0x01|0x0019) status 0x00 ncmd 1\n2012-07-19 13:24:44.105214 > HCI Event: Remote Name Req Complete (0x07) plen 255\n    status 0x00 bdaddr 00:02:72:D6:6A:3F name 'uw000951-0'\n2012-07-19 13:24:44.105284 < HCI Command: Authentication Requested (0x01|0x0011) plen 2\n    handle 42\n2012-07-19 13:24:44.111207 > HCI Event: Command Status (0x0f) plen 4\n    Authentication Requested (0x01|0x0011) status 0x00 ncmd 1\n2012-07-19 13:24:44.112220 > HCI Event: Link Key Request (0x17) plen 6\n    bdaddr 00:02:72:D6:6A:3F\n2012-07-19 13:24:44.112249 < HCI Command: Link Key Request Negative Reply (0x01|0x000c) plen 6\n    bdaddr 00:02:72:D6:6A:3F\n2012-07-19 13:24:44.115215 > HCI Event: Command Complete (0x0e) plen 10\n    Link Key Request Negative Reply (0x01|0x000c) ncmd 1\n    status 0x00 bdaddr 00:02:72:D6:6A:3F\n2012-07-19 13:24:44.116215 > HCI Event: PIN Code Request (0x16) plen 6\n    bdaddr 00:02:72:D6:6A:3F\n2012-07-19 13:24:48.099184 > HCI Event: Auth Complete (0x06) plen 3\n    status 0x13 handle 42\n    Error: Remote User Terminated Connection\n2012-07-19 13:24:48.179182 > HCI Event: Disconn Complete (0x05) plen 4\n    status 0x00 handle 42 reason 0x13\n    Reason: Remote User Terminated Connection\n\nCc: stable@vger.kernel.org\nSigned-off-by: Szymon Janc <szymon.janc@tieto.com>\nAcked-by: Johan Hedberg <johan.hedberg@intel.com>\nSigned-off-by: Gustavo Padovan <gustavo.padovan@collabora.co.uk>",
  "author_name": "Szymon Janc",
  "author_email": "szymon.janc@tieto.com",
  "author_date": "Thu Jul 19 14:46:08 2012 +0200",
  "author_date_iso": "2012-07-19T14:46:08+02:00",
  "committer_name": "Gustavo Padovan",
  "committer_email": "gustavo.padovan@collabora.co.uk",
  "committer_date": "Mon Aug 6 15:19:36 2012 -0300",
  "committer_date_iso": "2012-08-06T15:19:36-03:00",
  "files_changed": [
    "net/bluetooth/hci_event.c",
    "net/bluetooth/l2cap_core.c"
  ],
  "files_changed_count": 2,
  "stats": [
    {
      "file": "net/bluetooth/hci_event.c",
      "insertions": 6,
      "deletions": 1
    },
    {
      "file": "net/bluetooth/l2cap_core.c",
      "insertions": 1,
      "deletions": 0
    }
  ],
  "total_insertions": 7,
  "total_deletions": 1,
  "total_changes": 8,
  "parents": [
    "269c4845d5b3627b95b1934107251bacbe99bb68"
  ],
  "branches": [
    "* development",
    "master",
    "remotes/origin/HEAD -> origin/master",
    "remotes/origin/master"
  ],
  "tags": [
    "v3.10",
    "v3.10-rc1",
    "v3.10-rc2",
    "v3.10-rc3",
    "v3.10-rc4",
    "v3.10-rc5",
    "v3.10-rc6",
    "v3.10-rc7",
    "v3.11",
    "v3.11-rc1"
  ],
  "is_merge": false,
  "security_info": {
    "cve_ids": [],
    "security_keywords": [
      "Authentication"
    ]
  },
  "fix_type": "security",
  "file_results": [
    {
      "file": "net/bluetooth/hci_event.c",
      "pre_version": false,
      "post_version": true,
      "patch": true
    },
    {
      "file": "net/bluetooth/l2cap_core.c",
      "pre_version": false,
      "post_version": true,
      "patch": true
    }
  ]
}