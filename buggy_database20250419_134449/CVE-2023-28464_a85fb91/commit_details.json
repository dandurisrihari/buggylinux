{
  "hash": "a85fb91e3d728bdfc80833167e8162cce8bc7004",
  "hash_short": "a85fb91e",
  "subject": "Bluetooth: Fix double free in hci_conn_cleanup",
  "body": "syzbot reports a slab use-after-free in hci_conn_hash_flush [1].\nAfter releasing an object using hci_conn_del_sysfs in the\nhci_conn_cleanup function, releasing the same object again\nusing the hci_dev_put and hci_conn_put functions causes a double free.\nHere's a simplified flow:\n\nhci_conn_del_sysfs:\n  hci_dev_put\n    put_device\n      kobject_put\n        kref_put\n          kobject_release\n            kobject_cleanup\n              kfree_const\n                kfree(name)\n\nhci_dev_put:\n  ...\n    kfree(name)\n\nhci_conn_put:\n  put_device\n    ...\n      kfree(name)\n\nThis patch drop the hci_dev_put and hci_conn_put function\ncall in hci_conn_cleanup function, because the object is\nfreed in hci_conn_del_sysfs function.\n\nThis patch also fixes the refcounting in hci_conn_add_sysfs() and\nhci_conn_del_sysfs() to take into account device_add() failures.\n\nThis fixes CVE-2023-28464.\n\nLink: https://syzkaller.appspot.com/bug?id=1bb51491ca5df96a5f724899d1dbb87afda61419 [1]\n\nSigned-off-by: ZhengHan Wang <wzhmmmmm@gmail.com>\nCo-developed-by: Luiz Augusto von Dentz <luiz.von.dentz@intel.com>\nSigned-off-by: Luiz Augusto von Dentz <luiz.von.dentz@intel.com>",
  "full_message": "Bluetooth: Fix double free in hci_conn_cleanup\n\nsyzbot reports a slab use-after-free in hci_conn_hash_flush [1].\nAfter releasing an object using hci_conn_del_sysfs in the\nhci_conn_cleanup function, releasing the same object again\nusing the hci_dev_put and hci_conn_put functions causes a double free.\nHere's a simplified flow:\n\nhci_conn_del_sysfs:\n  hci_dev_put\n    put_device\n      kobject_put\n        kref_put\n          kobject_release\n            kobject_cleanup\n              kfree_const\n                kfree(name)\n\nhci_dev_put:\n  ...\n    kfree(name)\n\nhci_conn_put:\n  put_device\n    ...\n      kfree(name)\n\nThis patch drop the hci_dev_put and hci_conn_put function\ncall in hci_conn_cleanup function, because the object is\nfreed in hci_conn_del_sysfs function.\n\nThis patch also fixes the refcounting in hci_conn_add_sysfs() and\nhci_conn_del_sysfs() to take into account device_add() failures.\n\nThis fixes CVE-2023-28464.\n\nLink: https://syzkaller.appspot.com/bug?id=1bb51491ca5df96a5f724899d1dbb87afda61419 [1]\n\nSigned-off-by: ZhengHan Wang <wzhmmmmm@gmail.com>\nCo-developed-by: Luiz Augusto von Dentz <luiz.von.dentz@intel.com>\nSigned-off-by: Luiz Augusto von Dentz <luiz.von.dentz@intel.com>",
  "author_name": "ZhengHan Wang",
  "author_email": "wzhmmmmm@gmail.com",
  "author_date": "Wed Oct 18 12:30:55 2023 +0200",
  "author_date_iso": "2023-10-18T12:30:55+02:00",
  "committer_name": "Luiz Augusto von Dentz",
  "committer_email": "luiz.von.dentz@intel.com",
  "committer_date": "Mon Oct 23 11:05:11 2023 -0700",
  "committer_date_iso": "2023-10-23T11:05:11-07:00",
  "files_changed": [
    "net/bluetooth/hci_conn.c",
    "net/bluetooth/hci_sysfs.c"
  ],
  "files_changed_count": 2,
  "stats": [
    {
      "file": "net/bluetooth/hci_conn.c",
      "insertions": 2,
      "deletions": 4
    },
    {
      "file": "net/bluetooth/hci_sysfs.c",
      "insertions": 12,
      "deletions": 11
    }
  ],
  "total_insertions": 14,
  "total_deletions": 15,
  "total_changes": 29,
  "parents": [
    "4ed924fc122f759e383df7eccd89a2e57d9c4c5d"
  ],
  "branches": [
    "* development",
    "remotes/origin/HEAD -> origin/master",
    "remotes/origin/master"
  ],
  "tags": [],
  "is_merge": false,
  "security_info": {
    "cve_ids": [
      "CVE-2023-28464"
    ],
    "security_keywords": []
  },
  "fix_type": "cve",
  "file_results": [
    {
      "file": "net/bluetooth/hci_conn.c",
      "pre_version": false,
      "post_version": true,
      "patch": true
    },
    {
      "file": "net/bluetooth/hci_sysfs.c",
      "pre_version": false,
      "post_version": true,
      "patch": true
    }
  ]
}