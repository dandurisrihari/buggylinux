{
  "hash": "cfa39381173d5f969daf43582c95ad679189cbc9",
  "hash_short": "cfa39381",
  "subject": "kvm: fix kvm_ioctl_create_device() reference counting (CVE-2019-6974)",
  "body": "kvm_ioctl_create_device() does the following:\n\n1. creates a device that holds a reference to the VM object (with a borrowed\n   reference, the VM's refcount has not been bumped yet)\n2. initializes the device\n3. transfers the reference to the device to the caller's file descriptor table\n4. calls kvm_get_kvm() to turn the borrowed reference to the VM into a real\n   reference\n\nThe ownership transfer in step 3 must not happen before the reference to the VM\nbecomes a proper, non-borrowed reference, which only happens in step 4.\nAfter step 3, an attacker can close the file descriptor and drop the borrowed\nreference, which can cause the refcount of the kvm object to drop to zero.\n\nThis means that we need to grab a reference for the device before\nanon_inode_getfd(), otherwise the VM can disappear from under us.\n\nFixes: 852b6d57dc7f (\"kvm: add device control API\")\nCc: stable@kernel.org\nSigned-off-by: Jann Horn <jannh@google.com>\nSigned-off-by: Paolo Bonzini <pbonzini@redhat.com>",
  "full_message": "kvm: fix kvm_ioctl_create_device() reference counting (CVE-2019-6974)\n\nkvm_ioctl_create_device() does the following:\n\n1. creates a device that holds a reference to the VM object (with a borrowed\n   reference, the VM's refcount has not been bumped yet)\n2. initializes the device\n3. transfers the reference to the device to the caller's file descriptor table\n4. calls kvm_get_kvm() to turn the borrowed reference to the VM into a real\n   reference\n\nThe ownership transfer in step 3 must not happen before the reference to the VM\nbecomes a proper, non-borrowed reference, which only happens in step 4.\nAfter step 3, an attacker can close the file descriptor and drop the borrowed\nreference, which can cause the refcount of the kvm object to drop to zero.\n\nThis means that we need to grab a reference for the device before\nanon_inode_getfd(), otherwise the VM can disappear from under us.\n\nFixes: 852b6d57dc7f (\"kvm: add device control API\")\nCc: stable@kernel.org\nSigned-off-by: Jann Horn <jannh@google.com>\nSigned-off-by: Paolo Bonzini <pbonzini@redhat.com>",
  "author_name": "Jann Horn",
  "author_email": "jannh@google.com",
  "author_date": "Sat Jan 26 01:54:33 2019 +0100",
  "author_date_iso": "2019-01-26T01:54:33+01:00",
  "committer_name": "Paolo Bonzini",
  "committer_email": "pbonzini@redhat.com",
  "committer_date": "Thu Feb 7 19:02:38 2019 +0100",
  "committer_date_iso": "2019-02-07T19:02:38+01:00",
  "files_changed": [
    "virt/kvm/kvm_main.c"
  ],
  "files_changed_count": 1,
  "stats": [
    {
      "file": "virt/kvm/kvm_main.c",
      "insertions": 2,
      "deletions": 1
    }
  ],
  "total_insertions": 2,
  "total_deletions": 1,
  "total_changes": 3,
  "parents": [
    "8834f5600cf3c8db365e18a3d5cac2c2780c81e5"
  ],
  "branches": [
    "* development",
    "master",
    "remotes/origin/HEAD -> origin/master",
    "remotes/origin/master"
  ],
  "tags": [
    "v5.0",
    "v5.0-rc6",
    "v5.0-rc7",
    "v5.0-rc8",
    "v5.1",
    "v5.1-rc1",
    "v5.1-rc2",
    "v5.1-rc3",
    "v5.1-rc4",
    "v5.1-rc5"
  ],
  "is_merge": false,
  "security_info": {
    "cve_ids": [
      "CVE-2019-6974",
      "CVE-2019-6974"
    ],
    "security_keywords": []
  },
  "fix_type": "cve",
  "file_results": [
    {
      "file": "virt/kvm/kvm_main.c",
      "pre_version": false,
      "post_version": true,
      "patch": true
    }
  ]
}