Commit Hash: 0977cfac6e76fa976618129a4585bcf53784cc87
Subject: KVM: nSVM: Implement support for nested VNMI


Security Keywords:
- injection

Full commit message:
KVM: nSVM: Implement support for nested VNMI

Allow L1 to use vNMI to accelerate its injection of NMI to L2 by
propagating vNMI int_ctl bits from/to vmcb12 to/from vmcb02.

To handle both the case where vNMI is enabled for L1 and L2, and where
vNMI is enabled for L1 but _not_ L2, move pending L1 vNMIs to nmi_pending
on nested VM-Entry and raise KVM_REQ_EVENT, i.e. rely on existing code to
route the NMI to the correct domain.

On nested VM-Exit, reverse the process and set/clear V_NMI_PENDING for L1
based one whether nmi_pending is zero or non-zero.  There is no need to
consider vmcb02 in this case, as V_NMI_PENDING can be set in vmcb02 if
vNMI is disabled for L2, and if vNMI is enabled for L2, then L1 and L2
have different NMI contexts.

Co-developed-by: Maxim Levitsky <mlevitsk@redhat.com>
Signed-off-by: Maxim Levitsky <mlevitsk@redhat.com>
Signed-off-by: Santosh Shukla <santosh.shukla@amd.com>
Link: https://lore.kernel.org/r/20230227084016.3368-12-santosh.shukla@amd.com
[sean: massage changelog to match the code]
Signed-off-by: Sean Christopherson <seanjc@google.com>

Metadata:
Author: Santosh Shukla <santosh.shukla@amd.com>
Author Date: Mon Feb 27 14:10:16 2023 +0530
Committer: Sean Christopherson <seanjc@google.com>
Commit Date: Wed Mar 22 17:43:45 2023 -0700

Files Changed: 3
Lines Added: 45
Lines Removed: 0
Total Changes: 45
