{
  "hash": "acc9ab60132739e0c5ab40644444cd7b22d12886",
  "hash_short": "acc9ab60",
  "subject": "KVM: nVMX: Fix pending events injection",
  "body": "L2 fails to boot on a non-APICv box dues to 'commit 0ad3bed6c5ec\n(\"kvm: nVMX: move nested events check to kvm_vcpu_running\")'\n\nKVM internal error. Suberror: 3\nextra data[0]: 800000ef\nextra data[1]: 1\nRAX=0000000000000000 RBX=ffffffff81f36140 RCX=0000000000000000 RDX=0000000000000000\nRSI=0000000000000000 RDI=0000000000000000 RBP=ffff88007c92fe90 RSP=ffff88007c92fe90\nR8 =ffff88007fccdca0 R9 =0000000000000000 R10=00000000fffedb3d R11=0000000000000000\nR12=0000000000000003 R13=0000000000000000 R14=0000000000000000 R15=ffff88007c92c000\nRIP=ffffffff810645e6 RFL=00000246 [---Z-P-] CPL=0 II=0 A20=1 SMM=0 HLT=0\nES =0000 0000000000000000 ffffffff 00c00000\nCS =0010 0000000000000000 ffffffff 00a09b00 DPL=0 CS64 [-RA]\nSS =0000 0000000000000000 ffffffff 00c00000\nDS =0000 0000000000000000 ffffffff 00c00000\nFS =0000 0000000000000000 ffffffff 00c00000\nGS =0000 ffff88007fcc0000 ffffffff 00c00000\nLDT=0000 0000000000000000 ffffffff 00c00000\nTR =0040 ffff88007fcd4200 00002087 00008b00 DPL=0 TSS64-busy\nGDT=     ffff88007fcc9000 0000007f\nIDT=     ffffffffff578000 00000fff\nCR0=80050033 CR2=00000000ffffffff CR3=0000000001e0a000 CR4=003406e0\nDR0=0000000000000000 DR1=0000000000000000 DR2=0000000000000000 DR3=0000000000000000\nDR6=00000000fffe0ff0 DR7=0000000000000400\nEFER=0000000000000d01\n\nWe should try to reinject previous events if any before trying to inject\nnew event if pending. If vmexit is triggered by L2 guest and L0 interested\nin, we should reinject IDT-vectoring info to L2 through vmcs02 if any,\notherwise, we can consider new IRQs/NMIs which can be injected and call\nnested events callback to switch from L2 to L1 if needed and inject the\nproper vmexit events. However, 'commit 0ad3bed6c5ec (\"kvm: nVMX: move\nnested events check to kvm_vcpu_running\")' results in the handle events\norder reversely on non-APICv box. This patch fixes it by bailing out for\npending events and not consider new events in this scenario.\n\nCc: Paolo Bonzini <pbonzini@redhat.com>\nCc: Radim Kr\u010dm\u00e1\u0159 <rkrcmar@redhat.com>\nCc: Jan Kiszka <jan.kiszka@siemens.com>\nSigned-off-by: Wanpeng Li <wanpeng.li@hotmail.com>\nFixes: 0ad3bed6c5ec (\"kvm: nVMX: move nested events check to kvm_vcpu_running\")\nSigned-off-by: Radim Kr\u010dm\u00e1\u0159 <rkrcmar@redhat.com>",
  "full_message": "KVM: nVMX: Fix pending events injection\n\nL2 fails to boot on a non-APICv box dues to 'commit 0ad3bed6c5ec\n(\"kvm: nVMX: move nested events check to kvm_vcpu_running\")'\n\nKVM internal error. Suberror: 3\nextra data[0]: 800000ef\nextra data[1]: 1\nRAX=0000000000000000 RBX=ffffffff81f36140 RCX=0000000000000000 RDX=0000000000000000\nRSI=0000000000000000 RDI=0000000000000000 RBP=ffff88007c92fe90 RSP=ffff88007c92fe90\nR8 =ffff88007fccdca0 R9 =0000000000000000 R10=00000000fffedb3d R11=0000000000000000\nR12=0000000000000003 R13=0000000000000000 R14=0000000000000000 R15=ffff88007c92c000\nRIP=ffffffff810645e6 RFL=00000246 [---Z-P-] CPL=0 II=0 A20=1 SMM=0 HLT=0\nES =0000 0000000000000000 ffffffff 00c00000\nCS =0010 0000000000000000 ffffffff 00a09b00 DPL=0 CS64 [-RA]\nSS =0000 0000000000000000 ffffffff 00c00000\nDS =0000 0000000000000000 ffffffff 00c00000\nFS =0000 0000000000000000 ffffffff 00c00000\nGS =0000 ffff88007fcc0000 ffffffff 00c00000\nLDT=0000 0000000000000000 ffffffff 00c00000\nTR =0040 ffff88007fcd4200 00002087 00008b00 DPL=0 TSS64-busy\nGDT=     ffff88007fcc9000 0000007f\nIDT=     ffffffffff578000 00000fff\nCR0=80050033 CR2=00000000ffffffff CR3=0000000001e0a000 CR4=003406e0\nDR0=0000000000000000 DR1=0000000000000000 DR2=0000000000000000 DR3=0000000000000000\nDR6=00000000fffe0ff0 DR7=0000000000000400\nEFER=0000000000000d01\n\nWe should try to reinject previous events if any before trying to inject\nnew event if pending. If vmexit is triggered by L2 guest and L0 interested\nin, we should reinject IDT-vectoring info to L2 through vmcs02 if any,\notherwise, we can consider new IRQs/NMIs which can be injected and call\nnested events callback to switch from L2 to L1 if needed and inject the\nproper vmexit events. However, 'commit 0ad3bed6c5ec (\"kvm: nVMX: move\nnested events check to kvm_vcpu_running\")' results in the handle events\norder reversely on non-APICv box. This patch fixes it by bailing out for\npending events and not consider new events in this scenario.\n\nCc: Paolo Bonzini <pbonzini@redhat.com>\nCc: Radim Kr\u010dm\u00e1\u0159 <rkrcmar@redhat.com>\nCc: Jan Kiszka <jan.kiszka@siemens.com>\nSigned-off-by: Wanpeng Li <wanpeng.li@hotmail.com>\nFixes: 0ad3bed6c5ec (\"kvm: nVMX: move nested events check to kvm_vcpu_running\")\nSigned-off-by: Radim Kr\u010dm\u00e1\u0159 <rkrcmar@redhat.com>",
  "author_name": "Wanpeng Li",
  "author_email": "wanpeng.li@hotmail.com",
  "author_date": "Mon Feb 27 04:24:39 2017 -0800",
  "author_date_iso": "2017-02-27T04:24:39-08:00",
  "committer_name": "Radim Kr\u010dm\u00e1\u0159",
  "committer_email": "rkrcmar@redhat.com",
  "committer_date": "Wed Mar 1 17:03:24 2017 +0100",
  "committer_date_iso": "2017-03-01T17:03:24+01:00",
  "files_changed": [
    "arch/x86/kvm/vmx.c"
  ],
  "files_changed_count": 1,
  "stats": [
    {
      "file": "arch/x86/kvm/vmx.c",
      "insertions": 6,
      "deletions": 2
    }
  ],
  "total_insertions": 6,
  "total_deletions": 2,
  "total_changes": 8,
  "parents": [
    "0fce546f9f07b94ccc9de09cf48d35e18946d2fa"
  ],
  "branches": [
    "* development",
    "master",
    "remotes/origin/HEAD -> origin/master",
    "remotes/origin/master"
  ],
  "tags": [
    "v4.11",
    "v4.11-rc1",
    "v4.11-rc2",
    "v4.11-rc3",
    "v4.11-rc4",
    "v4.11-rc5",
    "v4.11-rc6",
    "v4.11-rc7",
    "v4.11-rc8",
    "v4.12"
  ],
  "is_merge": false,
  "security_info": {
    "cve_ids": [],
    "security_keywords": [
      "injection"
    ]
  },
  "fix_type": "security",
  "file_results": [
    {
      "file": "arch/x86/kvm/vmx.c",
      "pre_version": true,
      "post_version": true,
      "patch": true
    }
  ]
}