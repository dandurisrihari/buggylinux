{
  "hash": "2652f6b472ffa175868dc98306d01c03f52da4c1",
  "hash_short": "2652f6b4",
  "subject": "wifi: ath12k: avoid stopping mac80211 queues in ath12k_core_restart()",
  "body": "Currently when resume ath12k_core_restart() calls\nath12k_core_pre_reconfigure_recovery() where mac80211 queues are\nstopped by calling ieee80211_stop_queues(). Then in\nath12k_mac_op_reconfig_complete() those queues are not started\nbecause ieee80211_wake_queues() is skipped due to the check on\nreconfig_type. The result is that mac80211\ncould not deliver any frame to ath12k to send out, finally making\nconnection fail.\n\n[84473.104249] PM: suspend exit\n[84479.372397] wlan0: no VHT 160 MHz capability on 5 GHz, limiting to 80 MHz\n[84479.372401] wlan0: determined local STA to be EHT, BW limited to 80 MHz\n[84479.372416] wlan0: determined AP 00:03:7f:12:b7:b7 to be HE\n[84479.372420] wlan0: connecting with HE mode, max bandwidth 80 MHz\n[84479.580348] wlan0: authenticate with 00:03:7f:12:b7:b7 (local address=00:03:7f:37:11:53)\n[84479.580351] wlan0: send auth to 00:03:7f:12:b7:b7 (try 1/3)\n[84480.698993] wlan0: send auth to 00:03:7f:12:b7:b7 (try 2/3)\n[84481.816505] wlan0: send auth to 00:03:7f:12:b7:b7 (try 3/3)\n[84482.810966] wlan0: authentication with 00:03:7f:12:b7:b7 timed out\n\nActually we don't need to stop/start queues during suspend/resume,\nso remove ath12k_core_pre_reconfigure_recovery() from ath12k_core_restart().\nThis won't cause any regression because currently the only chance\nath12k_core_restart() gets called is in reset case, where ab->is_reset\nis set so that function will never be executed.\n\nAlso remove ath12k_core_post_reconfigure_recovery() because it is\nnot needed in suspend/resume case. This is also valid due to above\nanalysis.\n\nTested-on: WCN7850 hw2.0 PCI WLAN.HMT.1.0-03427-QCAHMTSWPL_V1.0_V2.0_SILICONZ-1.15378.4\nTested-on: QCN9274 hw2.0 PCI WLAN.WBE.1.0.1-00029-QCAHKSWPL_SILICONZ-1\n\nSigned-off-by: Baochen Qiang <quic_bqiang@quicinc.com>\nSigned-off-by: Kalle Valo <quic_kvalo@quicinc.com>\nLink: https://msgid.link/20240412060620.27519-9-quic_bqiang@quicinc.com",
  "full_message": "wifi: ath12k: avoid stopping mac80211 queues in ath12k_core_restart()\n\nCurrently when resume ath12k_core_restart() calls\nath12k_core_pre_reconfigure_recovery() where mac80211 queues are\nstopped by calling ieee80211_stop_queues(). Then in\nath12k_mac_op_reconfig_complete() those queues are not started\nbecause ieee80211_wake_queues() is skipped due to the check on\nreconfig_type. The result is that mac80211\ncould not deliver any frame to ath12k to send out, finally making\nconnection fail.\n\n[84473.104249] PM: suspend exit\n[84479.372397] wlan0: no VHT 160 MHz capability on 5 GHz, limiting to 80 MHz\n[84479.372401] wlan0: determined local STA to be EHT, BW limited to 80 MHz\n[84479.372416] wlan0: determined AP 00:03:7f:12:b7:b7 to be HE\n[84479.372420] wlan0: connecting with HE mode, max bandwidth 80 MHz\n[84479.580348] wlan0: authenticate with 00:03:7f:12:b7:b7 (local address=00:03:7f:37:11:53)\n[84479.580351] wlan0: send auth to 00:03:7f:12:b7:b7 (try 1/3)\n[84480.698993] wlan0: send auth to 00:03:7f:12:b7:b7 (try 2/3)\n[84481.816505] wlan0: send auth to 00:03:7f:12:b7:b7 (try 3/3)\n[84482.810966] wlan0: authentication with 00:03:7f:12:b7:b7 timed out\n\nActually we don't need to stop/start queues during suspend/resume,\nso remove ath12k_core_pre_reconfigure_recovery() from ath12k_core_restart().\nThis won't cause any regression because currently the only chance\nath12k_core_restart() gets called is in reset case, where ab->is_reset\nis set so that function will never be executed.\n\nAlso remove ath12k_core_post_reconfigure_recovery() because it is\nnot needed in suspend/resume case. This is also valid due to above\nanalysis.\n\nTested-on: WCN7850 hw2.0 PCI WLAN.HMT.1.0-03427-QCAHMTSWPL_V1.0_V2.0_SILICONZ-1.15378.4\nTested-on: QCN9274 hw2.0 PCI WLAN.WBE.1.0.1-00029-QCAHKSWPL_SILICONZ-1\n\nSigned-off-by: Baochen Qiang <quic_bqiang@quicinc.com>\nSigned-off-by: Kalle Valo <quic_kvalo@quicinc.com>\nLink: https://msgid.link/20240412060620.27519-9-quic_bqiang@quicinc.com",
  "author_name": "Baochen Qiang",
  "author_email": "quic_bqiang@quicinc.com",
  "author_date": "Mon Apr 22 15:11:45 2024 +0300",
  "author_date_iso": "2024-04-22T15:11:45+03:00",
  "committer_name": "Kalle Valo",
  "committer_email": "quic_kvalo@quicinc.com",
  "committer_date": "Tue Apr 23 12:27:15 2024 +0300",
  "committer_date_iso": "2024-04-23T12:27:15+03:00",
  "files_changed": [
    "drivers/net/wireless/ath/ath12k/core.c"
  ],
  "files_changed_count": 1,
  "stats": [
    {
      "file": "drivers/net/wireless/ath/ath12k/core.c",
      "insertions": 0,
      "deletions": 6
    }
  ],
  "total_insertions": 0,
  "total_deletions": 6,
  "total_changes": 6,
  "parents": [
    "b1c9992c675be99d8fa14f99fa7dedfaca726dd9"
  ],
  "branches": [
    "* development",
    "remotes/origin/HEAD -> origin/master",
    "remotes/origin/master"
  ],
  "tags": [],
  "is_merge": false,
  "security_info": {
    "cve_ids": [],
    "security_keywords": [
      "auth"
    ]
  },
  "fix_type": "security",
  "file_results": [
    {
      "file": "drivers/net/wireless/ath/ath12k/core.c",
      "pre_version": true,
      "post_version": true,
      "patch": true
    }
  ]
}