{
  "hash": "c7c5ae2902bf8fe9acc75f798c0de75ac9295ccf",
  "hash_short": "c7c5ae29",
  "subject": "Bluetooth: btqca: release_firmware after qca_inject_cmd_complete_event",
  "body": "commit 32646db8cc28 (\"Bluetooth: btqca: inject command complete event\nduring fw download\") added qca_inject_cmd_complete_event() for certain\nqualcomm chips. However, qca_download_firmware() will return without\ncalling release_firmware() in this case.\n\nThis leads to a memory leak like the following found by kmemleak:\n\nunreferenced object 0xfffffff3868a5880 (size 128):\n  comm \"kworker/u17:5\", pid 347, jiffies 4294676481 (age 312.157s)\n  hex dump (first 32 bytes):\n    ac fd 00 00 00 00 00 00 00 d0 7e 17 80 ff ff ff  ..........~.....\n    00 00 00 00 00 00 00 00 00 59 8a 86 f3 ff ff ff  .........Y......\n  backtrace:\n    [<00000000978ce31d>] kmem_cache_alloc_trace+0x194/0x298\n    [<000000006ea0398c>] _request_firmware+0x74/0x4e4\n    [<000000004da31ca0>] request_firmware+0x44/0x64\n    [<0000000094572996>] qca_download_firmware+0x74/0x6e4 [btqca]\n    [<00000000b24d615a>] qca_uart_setup+0xc0/0x2b0 [btqca]\n    [<00000000364a6d5a>] qca_setup+0x204/0x570 [hci_uart]\n    [<000000006be1a544>] hci_uart_setup+0xa8/0x148 [hci_uart]\n    [<00000000d64c0f4f>] hci_dev_do_open+0x144/0x530 [bluetooth]\n    [<00000000f69f5110>] hci_power_on+0x84/0x288 [bluetooth]\n    [<00000000d4151583>] process_one_work+0x210/0x420\n    [<000000003cf3dcfb>] worker_thread+0x2c4/0x3e4\n    [<000000007ccaf055>] kthread+0x124/0x134\n    [<00000000bef1f723>] ret_from_fork+0x10/0x18\n    [<00000000c36ee3dd>] 0xffffffffffffffff\nunreferenced object 0xfffffff37b16de00 (size 128):\n  comm \"kworker/u17:5\", pid 347, jiffies 4294676873 (age 311.766s)\n  hex dump (first 32 bytes):\n    da 07 00 00 00 00 00 00 00 50 ff 0b 80 ff ff ff  .........P......\n    00 00 00 00 00 00 00 00 00 dd 16 7b f3 ff ff ff  ...........{....\n  backtrace:\n    [<00000000978ce31d>] kmem_cache_alloc_trace+0x194/0x298\n    [<000000006ea0398c>] _request_firmware+0x74/0x4e4\n    [<000000004da31ca0>] request_firmware+0x44/0x64\n    [<0000000094572996>] qca_download_firmware+0x74/0x6e4 [btqca]\n    [<000000000cde20a9>] qca_uart_setup+0x144/0x2b0 [btqca]\n    [<00000000364a6d5a>] qca_setup+0x204/0x570 [hci_uart]\n    [<000000006be1a544>] hci_uart_setup+0xa8/0x148 [hci_uart]\n    [<00000000d64c0f4f>] hci_dev_do_open+0x144/0x530 [bluetooth]\n    [<00000000f69f5110>] hci_power_on+0x84/0x288 [bluetooth]\n    [<00000000d4151583>] process_one_work+0x210/0x420\n    [<000000003cf3dcfb>] worker_thread+0x2c4/0x3e4\n    [<000000007ccaf055>] kthread+0x124/0x134\n    [<00000000bef1f723>] ret_from_fork+0x10/0x18\n    [<00000000c36ee3dd>] 0xffffffffffffffff\n\nMake sure release_firmware() is called aftre\nqca_inject_cmd_complete_event() to avoid the memory leak.\n\nFixes: 32646db8cc28 (\"Bluetooth: btqca: inject command complete event during fw download\")\nSigned-off-by: Claire Chang <tientzu@chromium.org>\nReviewed-by: Balakrishna Godavarthi <bgodavar@codeaurora.org>\nSigned-off-by: Marcel Holtmann <marcel@holtmann.org>",
  "full_message": "Bluetooth: btqca: release_firmware after qca_inject_cmd_complete_event\n\ncommit 32646db8cc28 (\"Bluetooth: btqca: inject command complete event\nduring fw download\") added qca_inject_cmd_complete_event() for certain\nqualcomm chips. However, qca_download_firmware() will return without\ncalling release_firmware() in this case.\n\nThis leads to a memory leak like the following found by kmemleak:\n\nunreferenced object 0xfffffff3868a5880 (size 128):\n  comm \"kworker/u17:5\", pid 347, jiffies 4294676481 (age 312.157s)\n  hex dump (first 32 bytes):\n    ac fd 00 00 00 00 00 00 00 d0 7e 17 80 ff ff ff  ..........~.....\n    00 00 00 00 00 00 00 00 00 59 8a 86 f3 ff ff ff  .........Y......\n  backtrace:\n    [<00000000978ce31d>] kmem_cache_alloc_trace+0x194/0x298\n    [<000000006ea0398c>] _request_firmware+0x74/0x4e4\n    [<000000004da31ca0>] request_firmware+0x44/0x64\n    [<0000000094572996>] qca_download_firmware+0x74/0x6e4 [btqca]\n    [<00000000b24d615a>] qca_uart_setup+0xc0/0x2b0 [btqca]\n    [<00000000364a6d5a>] qca_setup+0x204/0x570 [hci_uart]\n    [<000000006be1a544>] hci_uart_setup+0xa8/0x148 [hci_uart]\n    [<00000000d64c0f4f>] hci_dev_do_open+0x144/0x530 [bluetooth]\n    [<00000000f69f5110>] hci_power_on+0x84/0x288 [bluetooth]\n    [<00000000d4151583>] process_one_work+0x210/0x420\n    [<000000003cf3dcfb>] worker_thread+0x2c4/0x3e4\n    [<000000007ccaf055>] kthread+0x124/0x134\n    [<00000000bef1f723>] ret_from_fork+0x10/0x18\n    [<00000000c36ee3dd>] 0xffffffffffffffff\nunreferenced object 0xfffffff37b16de00 (size 128):\n  comm \"kworker/u17:5\", pid 347, jiffies 4294676873 (age 311.766s)\n  hex dump (first 32 bytes):\n    da 07 00 00 00 00 00 00 00 50 ff 0b 80 ff ff ff  .........P......\n    00 00 00 00 00 00 00 00 00 dd 16 7b f3 ff ff ff  ...........{....\n  backtrace:\n    [<00000000978ce31d>] kmem_cache_alloc_trace+0x194/0x298\n    [<000000006ea0398c>] _request_firmware+0x74/0x4e4\n    [<000000004da31ca0>] request_firmware+0x44/0x64\n    [<0000000094572996>] qca_download_firmware+0x74/0x6e4 [btqca]\n    [<000000000cde20a9>] qca_uart_setup+0x144/0x2b0 [btqca]\n    [<00000000364a6d5a>] qca_setup+0x204/0x570 [hci_uart]\n    [<000000006be1a544>] hci_uart_setup+0xa8/0x148 [hci_uart]\n    [<00000000d64c0f4f>] hci_dev_do_open+0x144/0x530 [bluetooth]\n    [<00000000f69f5110>] hci_power_on+0x84/0x288 [bluetooth]\n    [<00000000d4151583>] process_one_work+0x210/0x420\n    [<000000003cf3dcfb>] worker_thread+0x2c4/0x3e4\n    [<000000007ccaf055>] kthread+0x124/0x134\n    [<00000000bef1f723>] ret_from_fork+0x10/0x18\n    [<00000000c36ee3dd>] 0xffffffffffffffff\n\nMake sure release_firmware() is called aftre\nqca_inject_cmd_complete_event() to avoid the memory leak.\n\nFixes: 32646db8cc28 (\"Bluetooth: btqca: inject command complete event during fw download\")\nSigned-off-by: Claire Chang <tientzu@chromium.org>\nReviewed-by: Balakrishna Godavarthi <bgodavar@codeaurora.org>\nSigned-off-by: Marcel Holtmann <marcel@holtmann.org>",
  "author_name": "Claire Chang",
  "author_email": "tientzu@chromium.org",
  "author_date": "Tue Aug 6 17:56:29 2019 +0800",
  "author_date_iso": "2019-08-06T17:56:29+08:00",
  "committer_name": "Marcel Holtmann",
  "committer_email": "marcel@holtmann.org",
  "committer_date": "Mon Aug 12 18:36:09 2019 +0200",
  "committer_date_iso": "2019-08-12T18:36:09+02:00",
  "files_changed": [
    "drivers/bluetooth/btqca.c"
  ],
  "files_changed_count": 1,
  "stats": [
    {
      "file": "drivers/bluetooth/btqca.c",
      "insertions": 1,
      "deletions": 1
    }
  ],
  "total_insertions": 1,
  "total_deletions": 1,
  "total_changes": 2,
  "parents": [
    "48d9cc9d85dde37c87abb7ac9bbec6598ba44b56"
  ],
  "branches": [
    "* development",
    "master",
    "remotes/origin/HEAD -> origin/master",
    "remotes/origin/master"
  ],
  "tags": [
    "v5.3",
    "v5.3-rc6",
    "v5.3-rc7",
    "v5.3-rc8",
    "v5.4",
    "v5.4-rc1",
    "v5.4-rc2",
    "v5.4-rc3",
    "v5.4-rc4",
    "v5.4-rc5"
  ],
  "is_merge": false,
  "security_info": {
    "cve_ids": [],
    "security_keywords": [
      "inject"
    ]
  },
  "fix_type": "security",
  "file_results": [
    {
      "file": "drivers/bluetooth/btqca.c",
      "pre_version": false,
      "post_version": true,
      "patch": true
    }
  ]
}