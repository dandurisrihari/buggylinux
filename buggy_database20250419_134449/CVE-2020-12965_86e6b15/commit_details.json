{
  "hash": "86e6b1547b3d013bc392adf775b89318441403c2",
  "hash_short": "86e6b154",
  "subject": "x86: fix user address masking non-canonical speculation issue",
  "body": "It turns out that AMD has a \"Meltdown Lite(tm)\" issue with non-canonical\naccesses in kernel space.  And so using just the high bit to decide\nwhether an access is in user space or kernel space ends up with the good\nold \"leak speculative data\" if you have the right gadget using the\nresult:\n\n  CVE-2020-12965 \u201cTransient Execution of Non-Canonical Accesses\u201c\n\nNow, the kernel surrounds the access with a STAC/CLAC pair, and those\ninstructions end up serializing execution on older Zen architectures,\nwhich closes the speculation window.\n\nBut that was true only up until Zen 5, which renames the AC bit [1].\nThat improves performance of STAC/CLAC a lot, but also means that the\nspeculation window is now open.\n\nNote that this affects not just the new address masking, but also the\nregular valid_user_address() check used by access_ok(), and the asm\nversion of the sign bit check in the get_user() helpers.\n\nIt does not affect put_user() or clear_user() variants, since there's no\nspeculative result to be used in a gadget for those operations.\n\nReported-by: Andrew Cooper <andrew.cooper3@citrix.com>\nLink: https://lore.kernel.org/all/80d94591-1297-4afb-b510-c665efd37f10@citrix.com/\nLink: https://lore.kernel.org/all/20241023094448.GAZxjFkEOOF_DM83TQ@fat_crate.local/ [1]\nLink: https://www.amd.com/en/resources/product-security/bulletin/amd-sb-1010.html\nLink: https://arxiv.org/pdf/2108.10771\nCc: Josh Poimboeuf <jpoimboe@kernel.org>\nCc: Borislav Petkov <bp@alien8.de>\nTested-by: Maciej Wieczor-Retman <maciej.wieczor-retman@intel.com> # LAM case\nFixes: 2865baf54077 (\"x86: support user address masking instead of non-speculative conditional\")\nFixes: 6014bc27561f (\"x86-64: make access_ok() independent of LAM\")\nFixes: b19b74bc99b1 (\"x86/mm: Rework address range check in get_user() and put_user()\")\nSigned-off-by: Linus Torvalds <torvalds@linux-foundation.org>",
  "full_message": "x86: fix user address masking non-canonical speculation issue\n\nIt turns out that AMD has a \"Meltdown Lite(tm)\" issue with non-canonical\naccesses in kernel space.  And so using just the high bit to decide\nwhether an access is in user space or kernel space ends up with the good\nold \"leak speculative data\" if you have the right gadget using the\nresult:\n\n  CVE-2020-12965 \u201cTransient Execution of Non-Canonical Accesses\u201c\n\nNow, the kernel surrounds the access with a STAC/CLAC pair, and those\ninstructions end up serializing execution on older Zen architectures,\nwhich closes the speculation window.\n\nBut that was true only up until Zen 5, which renames the AC bit [1].\nThat improves performance of STAC/CLAC a lot, but also means that the\nspeculation window is now open.\n\nNote that this affects not just the new address masking, but also the\nregular valid_user_address() check used by access_ok(), and the asm\nversion of the sign bit check in the get_user() helpers.\n\nIt does not affect put_user() or clear_user() variants, since there's no\nspeculative result to be used in a gadget for those operations.\n\nReported-by: Andrew Cooper <andrew.cooper3@citrix.com>\nLink: https://lore.kernel.org/all/80d94591-1297-4afb-b510-c665efd37f10@citrix.com/\nLink: https://lore.kernel.org/all/20241023094448.GAZxjFkEOOF_DM83TQ@fat_crate.local/ [1]\nLink: https://www.amd.com/en/resources/product-security/bulletin/amd-sb-1010.html\nLink: https://arxiv.org/pdf/2108.10771\nCc: Josh Poimboeuf <jpoimboe@kernel.org>\nCc: Borislav Petkov <bp@alien8.de>\nTested-by: Maciej Wieczor-Retman <maciej.wieczor-retman@intel.com> # LAM case\nFixes: 2865baf54077 (\"x86: support user address masking instead of non-speculative conditional\")\nFixes: 6014bc27561f (\"x86-64: make access_ok() independent of LAM\")\nFixes: b19b74bc99b1 (\"x86/mm: Rework address range check in get_user() and put_user()\")\nSigned-off-by: Linus Torvalds <torvalds@linux-foundation.org>",
  "author_name": "Linus Torvalds",
  "author_email": "torvalds@linux-foundation.org",
  "author_date": "Wed Oct 23 18:17:46 2024 -0700",
  "author_date_iso": "2024-10-23T18:17:46-07:00",
  "committer_name": "Linus Torvalds",
  "committer_email": "torvalds@linux-foundation.org",
  "committer_date": "Fri Oct 25 09:53:03 2024 -0700",
  "committer_date_iso": "2024-10-25T09:53:03-07:00",
  "files_changed": [
    "arch/x86/include/asm/uaccess_64.h",
    "arch/x86/kernel/cpu/common.c",
    "arch/x86/kernel/vmlinux.lds.S",
    "arch/x86/lib/getuser.S"
  ],
  "files_changed_count": 4,
  "stats": [
    {
      "file": "arch/x86/include/asm/uaccess_64.h",
      "insertions": 24,
      "deletions": 19
    },
    {
      "file": "arch/x86/kernel/cpu/common.c",
      "insertions": 10,
      "deletions": 0
    },
    {
      "file": "arch/x86/kernel/vmlinux.lds.S",
      "insertions": 1,
      "deletions": 0
    },
    {
      "file": "arch/x86/lib/getuser.S",
      "insertions": 7,
      "deletions": 2
    }
  ],
  "total_insertions": 42,
  "total_deletions": 21,
  "total_changes": 63,
  "parents": [
    "ae90f6a6170d7a7a1aa4fddf664fbd093e3023bc"
  ],
  "branches": [
    "* development",
    "remotes/origin/HEAD -> origin/master",
    "remotes/origin/master"
  ],
  "tags": [],
  "is_merge": false,
  "security_info": {
    "cve_ids": [
      "CVE-2020-12965"
    ],
    "security_keywords": []
  },
  "fix_type": "cve",
  "file_results": [
    {
      "file": "arch/x86/include/asm/uaccess_64.h",
      "pre_version": false,
      "post_version": true,
      "patch": true
    },
    {
      "file": "arch/x86/kernel/cpu/common.c",
      "pre_version": false,
      "post_version": true,
      "patch": true
    },
    {
      "file": "arch/x86/kernel/vmlinux.lds.S",
      "pre_version": false,
      "post_version": true,
      "patch": true
    },
    {
      "file": "arch/x86/lib/getuser.S",
      "pre_version": false,
      "post_version": true,
      "patch": true
    }
  ]
}