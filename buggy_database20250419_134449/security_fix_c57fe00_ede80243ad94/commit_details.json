{
  "hash": "c57fe0037a4e3863d9b740f8c14df9c51ac31aa1",
  "hash_short": "c57fe003",
  "subject": "net: mscc: ocelot: make use of all 63 PTP timestamp identifiers",
  "body": "At present, there is a problem when user space bombards a port with PTP\nevent frames which have TX timestamping requests (or when a tc-taprio\noffload is installed on a port, which delays the TX timestamps by a\nsignificant amount of time). The driver will happily roll over the 2-bit\ntimestamp ID and this will cause incorrect matches between an skb and\nthe TX timestamp collected from the FIFO.\n\nThe Ocelot switches have a 6-bit PTP timestamp identifier, and the value\n63 is reserved, so that leaves identifiers 0-62 to be used.\n\nThe timestamp identifiers are selected by the REW_OP packet field, and\nare actually shared between CPU-injected frames and frames which match a\nVCAP IS2 rule that modifies the REW_OP. The hardware supports\npartitioning between the two uses of the REW_OP field through the\nPTP_ID_LOW and PTP_ID_HIGH registers, and by default reserves the PTP\nIDs 0-3 for CPU-injected traffic and the rest for VCAP IS2.\n\nThe driver does not use VCAP IS2 to set REW_OP for 2-step timestamping,\nand it also writes 0xffffffff to both PTP_ID_HIGH and PTP_ID_LOW in\nocelot_init_timestamp() which makes all timestamp identifiers available\nto CPU injection.\n\nTherefore, we can make use of all 63 timestamp identifiers, which should\nallow more timestampable packets to be in flight on each port. This is\nonly part of the solution, more issues will be addressed in future changes.\n\nFixes: 4e3b0468e6d7 (\"net: mscc: PTP Hardware Clock (PHC) support\")\nSigned-off-by: Vladimir Oltean <vladimir.oltean@nxp.com>\nSigned-off-by: Jakub Kicinski <kuba@kernel.org>",
  "full_message": "net: mscc: ocelot: make use of all 63 PTP timestamp identifiers\n\nAt present, there is a problem when user space bombards a port with PTP\nevent frames which have TX timestamping requests (or when a tc-taprio\noffload is installed on a port, which delays the TX timestamps by a\nsignificant amount of time). The driver will happily roll over the 2-bit\ntimestamp ID and this will cause incorrect matches between an skb and\nthe TX timestamp collected from the FIFO.\n\nThe Ocelot switches have a 6-bit PTP timestamp identifier, and the value\n63 is reserved, so that leaves identifiers 0-62 to be used.\n\nThe timestamp identifiers are selected by the REW_OP packet field, and\nare actually shared between CPU-injected frames and frames which match a\nVCAP IS2 rule that modifies the REW_OP. The hardware supports\npartitioning between the two uses of the REW_OP field through the\nPTP_ID_LOW and PTP_ID_HIGH registers, and by default reserves the PTP\nIDs 0-3 for CPU-injected traffic and the rest for VCAP IS2.\n\nThe driver does not use VCAP IS2 to set REW_OP for 2-step timestamping,\nand it also writes 0xffffffff to both PTP_ID_HIGH and PTP_ID_LOW in\nocelot_init_timestamp() which makes all timestamp identifiers available\nto CPU injection.\n\nTherefore, we can make use of all 63 timestamp identifiers, which should\nallow more timestampable packets to be in flight on each port. This is\nonly part of the solution, more issues will be addressed in future changes.\n\nFixes: 4e3b0468e6d7 (\"net: mscc: PTP Hardware Clock (PHC) support\")\nSigned-off-by: Vladimir Oltean <vladimir.oltean@nxp.com>\nSigned-off-by: Jakub Kicinski <kuba@kernel.org>",
  "author_name": "Vladimir Oltean",
  "author_email": "vladimir.oltean@nxp.com",
  "author_date": "Tue Oct 12 14:40:35 2021 +0300",
  "author_date_iso": "2021-10-12T14:40:35+03:00",
  "committer_name": "Jakub Kicinski",
  "committer_email": "kuba@kernel.org",
  "committer_date": "Tue Oct 12 17:35:17 2021 -0700",
  "committer_date_iso": "2021-10-12T17:35:17-07:00",
  "files_changed": [
    "drivers/net/ethernet/mscc/ocelot.c",
    "include/soc/mscc/ocelot_ptp.h"
  ],
  "files_changed_count": 2,
  "stats": [
    {
      "file": "drivers/net/ethernet/mscc/ocelot.c",
      "insertions": 3,
      "deletions": 1
    },
    {
      "file": "include/soc/mscc/ocelot_ptp.h",
      "insertions": 2,
      "deletions": 0
    }
  ],
  "total_insertions": 5,
  "total_deletions": 1,
  "total_changes": 6,
  "parents": [
    "3af760e4d3b0a32448decb8ea068a221cbd24fe3"
  ],
  "branches": [
    "* development",
    "remotes/origin/HEAD -> origin/master",
    "remotes/origin/master"
  ],
  "tags": [],
  "is_merge": false,
  "security_info": {
    "cve_ids": [],
    "security_keywords": [
      "injection"
    ]
  },
  "fix_type": "security",
  "file_results": [
    {
      "file": "drivers/net/ethernet/mscc/ocelot.c",
      "pre_version": false,
      "post_version": true,
      "patch": true
    },
    {
      "file": "include/soc/mscc/ocelot_ptp.h",
      "pre_version": false,
      "post_version": true,
      "patch": true
    }
  ]
}