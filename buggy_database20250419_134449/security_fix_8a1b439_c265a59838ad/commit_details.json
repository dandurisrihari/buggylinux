{
  "hash": "8a1b43922d0d1279e7936ba85c4c2a870403c95f",
  "hash_short": "8a1b4392",
  "subject": "kvm: vmx: Reinstate support for CPUs without virtual NMI",
  "body": "This is more or less a revert of commit 2c82878b0cb3 (\"KVM: VMX: require\nvirtual NMI support\", 2017-03-27); it turns out that Core 2 Duo machines\nonly had virtual NMIs in some SKUs.\n\nThe revert is not trivial because in the meanwhile there have been several\nfixes to nested NMI injection.  Therefore, the entire vNMI state is moved\nto struct loaded_vmcs.\n\nAnother change compared to before the patch is a simplification here:\n\n       if (unlikely(!cpu_has_virtual_nmis() && vmx->soft_vnmi_blocked &&\n           !(is_guest_mode(vcpu) && nested_cpu_has_virtual_nmis(\n                                       get_vmcs12(vcpu))))) {\n\nThe final condition here is always true (because nested_cpu_has_virtual_nmis\nis always false) and is removed.\n\nFixes: 2c82878b0cb38fd516fd612c67852a6bbf282003\nFixes: https://bugzilla.redhat.com/show_bug.cgi?id=1490803\nCc: stable@vger.kernel.org\nSigned-off-by: Paolo Bonzini <pbonzini@redhat.com>\nSigned-off-by: Radim Kr\u010dm\u00e1\u0159 <rkrcmar@redhat.com>",
  "full_message": "kvm: vmx: Reinstate support for CPUs without virtual NMI\n\nThis is more or less a revert of commit 2c82878b0cb3 (\"KVM: VMX: require\nvirtual NMI support\", 2017-03-27); it turns out that Core 2 Duo machines\nonly had virtual NMIs in some SKUs.\n\nThe revert is not trivial because in the meanwhile there have been several\nfixes to nested NMI injection.  Therefore, the entire vNMI state is moved\nto struct loaded_vmcs.\n\nAnother change compared to before the patch is a simplification here:\n\n       if (unlikely(!cpu_has_virtual_nmis() && vmx->soft_vnmi_blocked &&\n           !(is_guest_mode(vcpu) && nested_cpu_has_virtual_nmis(\n                                       get_vmcs12(vcpu))))) {\n\nThe final condition here is always true (because nested_cpu_has_virtual_nmis\nis always false) and is removed.\n\nFixes: 2c82878b0cb38fd516fd612c67852a6bbf282003\nFixes: https://bugzilla.redhat.com/show_bug.cgi?id=1490803\nCc: stable@vger.kernel.org\nSigned-off-by: Paolo Bonzini <pbonzini@redhat.com>\nSigned-off-by: Radim Kr\u010dm\u00e1\u0159 <rkrcmar@redhat.com>",
  "author_name": "Paolo Bonzini",
  "author_email": "pbonzini@redhat.com",
  "author_date": "Mon Nov 6 13:31:12 2017 +0100",
  "author_date_iso": "2017-11-06T13:31:12+01:00",
  "committer_name": "Paolo Bonzini",
  "committer_email": "pbonzini@redhat.com",
  "committer_date": "Fri Nov 17 13:20:07 2017 +0100",
  "committer_date_iso": "2017-11-17T13:20:07+01:00",
  "files_changed": [
    "arch/x86/kvm/vmx.c"
  ],
  "files_changed_count": 1,
  "stats": [
    {
      "file": "arch/x86/kvm/vmx.c",
      "insertions": 106,
      "deletions": 44
    }
  ],
  "total_insertions": 106,
  "total_deletions": 44,
  "total_changes": 150,
  "parents": [
    "15038e14724799b8c205beb5f20f9e54896013c3"
  ],
  "branches": [
    "* development",
    "master",
    "remotes/origin/HEAD -> origin/master",
    "remotes/origin/master"
  ],
  "tags": [
    "v4.15",
    "v4.15-rc1",
    "v4.15-rc2",
    "v4.15-rc3",
    "v4.15-rc4",
    "v4.15-rc5",
    "v4.15-rc6",
    "v4.15-rc7",
    "v4.15-rc8",
    "v4.15-rc9"
  ],
  "is_merge": false,
  "security_info": {
    "cve_ids": [],
    "security_keywords": [
      "injection"
    ]
  },
  "fix_type": "security",
  "file_results": [
    {
      "file": "arch/x86/kvm/vmx.c",
      "pre_version": false,
      "post_version": true,
      "patch": true
    }
  ]
}