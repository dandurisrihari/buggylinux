{
  "hash": "1c970450a7fd8be0298758c4e2c631e4a739292d",
  "hash_short": "1c970450",
  "subject": "block, bfq: initialize bfqq->decrease_time_jif correctly",
  "body": "Inject limit is updated or reset when time_is_before_eq_jiffies(\ndecrease_time_jif + several msecs) or think-time state changes.\ndecrease_time_jif is initialized to 0 and will be set to current jiffies\nwhen inject limit is updated or reset. If the jiffies is slightly greater\nthan LONG_MAX, time_is_after_eq_jiffies(0) will keep for a long time, so as\ntime_is_after_eq_jiffies(decrease_time_jif + several msecs). If the\nthink-time state never chages, then the injection will not work as expected\nfor long time.\n\nTo be more specific:\nFunction bfq_update_inject_limit maybe triggered when jiffies pasts\ndecrease_time_jif + msecs_to_jiffies(10) in bfq_add_request by setting\nbfqd->wait_dispatch to true.\nFunction bfq_reset_inject_limit are called in two conditions:\n1. jiffies pasts bfqq->decrease_time_jif + msecs_to_jiffies(1000) in\nfunction bfq_add_request.\n2. jiffies pasts bfqq->decrease_time_jif + msecs_to_jiffies(100) or\nbfq think-time state change from short to long.\n\nFix this by initializing bfqq->decrease_time_jif to current jiffies\nto trigger service injection soon when service injection conditions\nare met.\n\nSigned-off-by: Kemeng Shi <shikemeng@huaweicloud.com>\nReviewed-by: Jan Kara <jack@suse.cz>\nLink: https://lore.kernel.org/r/20230116095153.3810101-4-shikemeng@huaweicloud.com\nSigned-off-by: Jens Axboe <axboe@kernel.dk>",
  "full_message": "block, bfq: initialize bfqq->decrease_time_jif correctly\n\nInject limit is updated or reset when time_is_before_eq_jiffies(\ndecrease_time_jif + several msecs) or think-time state changes.\ndecrease_time_jif is initialized to 0 and will be set to current jiffies\nwhen inject limit is updated or reset. If the jiffies is slightly greater\nthan LONG_MAX, time_is_after_eq_jiffies(0) will keep for a long time, so as\ntime_is_after_eq_jiffies(decrease_time_jif + several msecs). If the\nthink-time state never chages, then the injection will not work as expected\nfor long time.\n\nTo be more specific:\nFunction bfq_update_inject_limit maybe triggered when jiffies pasts\ndecrease_time_jif + msecs_to_jiffies(10) in bfq_add_request by setting\nbfqd->wait_dispatch to true.\nFunction bfq_reset_inject_limit are called in two conditions:\n1. jiffies pasts bfqq->decrease_time_jif + msecs_to_jiffies(1000) in\nfunction bfq_add_request.\n2. jiffies pasts bfqq->decrease_time_jif + msecs_to_jiffies(100) or\nbfq think-time state change from short to long.\n\nFix this by initializing bfqq->decrease_time_jif to current jiffies\nto trigger service injection soon when service injection conditions\nare met.\n\nSigned-off-by: Kemeng Shi <shikemeng@huaweicloud.com>\nReviewed-by: Jan Kara <jack@suse.cz>\nLink: https://lore.kernel.org/r/20230116095153.3810101-4-shikemeng@huaweicloud.com\nSigned-off-by: Jens Axboe <axboe@kernel.dk>",
  "author_name": "Kemeng Shi",
  "author_email": "shikemeng@huaweicloud.com",
  "author_date": "Mon Jan 16 17:51:48 2023 +0800",
  "author_date_iso": "2023-01-16T17:51:48+08:00",
  "committer_name": "Jens Axboe",
  "committer_email": "axboe@kernel.dk",
  "committer_date": "Sun Jan 29 20:03:49 2023 -0700",
  "committer_date_iso": "2023-01-29T20:03:49-07:00",
  "files_changed": [
    "block/bfq-iosched.c"
  ],
  "files_changed_count": 1,
  "stats": [
    {
      "file": "block/bfq-iosched.c",
      "insertions": 2,
      "deletions": 0
    }
  ],
  "total_insertions": 2,
  "total_deletions": 0,
  "total_changes": 2,
  "parents": [
    "bebeb9e582e8040944b12942ccc56f4ebacaa9f8"
  ],
  "branches": [
    "* development",
    "remotes/origin/HEAD -> origin/master",
    "remotes/origin/master"
  ],
  "tags": [],
  "is_merge": false,
  "security_info": {
    "cve_ids": [],
    "security_keywords": [
      "Inject"
    ]
  },
  "fix_type": "security",
  "file_results": [
    {
      "file": "block/bfq-iosched.c",
      "pre_version": true,
      "post_version": true,
      "patch": true
    }
  ]
}