{
  "hash": "1f7becf1b7e21794fc9d460765fe09679bc9b9e0",
  "hash_short": "1f7becf1",
  "subject": "KVM: x86: get smi pending status correctly",
  "body": "The injection process of smi has two steps:\n\n    Qemu                        KVM\nStep1:\n    cpu->interrupt_request &= \\\n        ~CPU_INTERRUPT_SMI;\n    kvm_vcpu_ioctl(cpu, KVM_SMI)\n\n                                call kvm_vcpu_ioctl_smi() and\n                                kvm_make_request(KVM_REQ_SMI, vcpu);\n\nStep2:\n    kvm_vcpu_ioctl(cpu, KVM_RUN, 0)\n\n                                call process_smi() if\n                                kvm_check_request(KVM_REQ_SMI, vcpu) is\n                                true, mark vcpu->arch.smi_pending = true;\n\nThe vcpu->arch.smi_pending will be set true in step2, unfortunately if\nvcpu paused between step1 and step2, the kvm_run->immediate_exit will be\nset and vcpu has to exit to Qemu immediately during step2 before mark\nvcpu->arch.smi_pending true.\nDuring VM migration, Qemu will get the smi pending status from KVM using\nKVM_GET_VCPU_EVENTS ioctl at the downtime, then the smi pending status\nwill be lost.\n\nSigned-off-by: Jay Zhou <jianjay.zhou@huawei.com>\nSigned-off-by: Shengen Zhuang <zhuangshengen@huawei.com>\nMessage-Id: <20210118084720.1585-1-jianjay.zhou@huawei.com>\nCc: stable@vger.kernel.org\nSigned-off-by: Paolo Bonzini <pbonzini@redhat.com>",
  "full_message": "KVM: x86: get smi pending status correctly\n\nThe injection process of smi has two steps:\n\n    Qemu                        KVM\nStep1:\n    cpu->interrupt_request &= \\\n        ~CPU_INTERRUPT_SMI;\n    kvm_vcpu_ioctl(cpu, KVM_SMI)\n\n                                call kvm_vcpu_ioctl_smi() and\n                                kvm_make_request(KVM_REQ_SMI, vcpu);\n\nStep2:\n    kvm_vcpu_ioctl(cpu, KVM_RUN, 0)\n\n                                call process_smi() if\n                                kvm_check_request(KVM_REQ_SMI, vcpu) is\n                                true, mark vcpu->arch.smi_pending = true;\n\nThe vcpu->arch.smi_pending will be set true in step2, unfortunately if\nvcpu paused between step1 and step2, the kvm_run->immediate_exit will be\nset and vcpu has to exit to Qemu immediately during step2 before mark\nvcpu->arch.smi_pending true.\nDuring VM migration, Qemu will get the smi pending status from KVM using\nKVM_GET_VCPU_EVENTS ioctl at the downtime, then the smi pending status\nwill be lost.\n\nSigned-off-by: Jay Zhou <jianjay.zhou@huawei.com>\nSigned-off-by: Shengen Zhuang <zhuangshengen@huawei.com>\nMessage-Id: <20210118084720.1585-1-jianjay.zhou@huawei.com>\nCc: stable@vger.kernel.org\nSigned-off-by: Paolo Bonzini <pbonzini@redhat.com>",
  "author_name": "Jay Zhou",
  "author_email": "jianjay.zhou@huawei.com",
  "author_date": "Mon Jan 18 16:47:20 2021 +0800",
  "author_date_iso": "2021-01-18T16:47:20+08:00",
  "committer_name": "Paolo Bonzini",
  "committer_email": "pbonzini@redhat.com",
  "committer_date": "Mon Jan 25 18:52:07 2021 -0500",
  "committer_date_iso": "2021-01-25T18:52:07-05:00",
  "files_changed": [
    "arch/x86/kvm/x86.c"
  ],
  "files_changed_count": 1,
  "stats": [
    {
      "file": "arch/x86/kvm/x86.c",
      "insertions": 4,
      "deletions": 0
    }
  ],
  "total_insertions": 4,
  "total_deletions": 0,
  "total_changes": 4,
  "parents": [
    "98dd2f108e448988d91e296173e773b06fb978b8"
  ],
  "branches": [
    "* development",
    "remotes/origin/HEAD -> origin/master",
    "remotes/origin/master"
  ],
  "tags": [],
  "is_merge": false,
  "security_info": {
    "cve_ids": [],
    "security_keywords": [
      "injection"
    ]
  },
  "fix_type": "security",
  "file_results": [
    {
      "file": "arch/x86/kvm/x86.c",
      "pre_version": false,
      "post_version": true,
      "patch": true
    }
  ]
}