commit eaa4f41642f096f1e10c15a2b172d79199e893ff
Author: David Hildenbrand <dahi@linux.vnet.ibm.com>
Date:   Wed Nov 4 16:46:55 2015 +0100

    KVM: s390: irq delivery should not rely on icptcode
    
    Program irq injection during program irq intercepts is the last candidates
    that injects nullifying irqs and relies on delivery to do the right thing.
    
    As we should not rely on the icptcode during any delivery (because that
    value will not be migrated), let's add a flag, telling prog IRQ delivery
    to not rewind the PSW in case of nullifying prog IRQs.
    
    Signed-off-by: David Hildenbrand <dahi@linux.vnet.ibm.com>
    Signed-off-by: Christian Borntraeger <borntraeger@de.ibm.com>

diff --git a/arch/s390/kvm/intercept.c b/arch/s390/kvm/intercept.c
index 6b4e5b5ff06c..2e6b54e4d3f9 100644
--- a/arch/s390/kvm/intercept.c
+++ b/arch/s390/kvm/intercept.c
@@ -140,6 +140,8 @@ static int inject_prog_on_prog_intercept(struct kvm_vcpu *vcpu)
 {
 	struct kvm_s390_pgm_info pgm_info = {
 		.code = vcpu->arch.sie_block->iprcc,
+		/* the PSW has already been rewound */
+		.flags = KVM_S390_PGM_FLAGS_NO_REWIND,
 	};
 
 	switch (vcpu->arch.sie_block->iprcc & ~PGM_PER) {