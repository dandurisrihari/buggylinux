Commit Hash: c0b98ac1cc104f48763cdb27b1e9ac25fd81fc90
Subject: ipv6: sr: block BH in seg6_output_core() and seg6_input_core()


Security Keywords:
- injection

Full commit message:
ipv6: sr: block BH in seg6_output_core() and seg6_input_core()

As explained in commit 1378817486d6 ("tipc: block BH
before using dst_cache"), net/core/dst_cache.c
helpers need to be called with BH disabled.

Disabling preemption in seg6_output_core() is not good enough,
because seg6_output_core() is called from process context,
lwtunnel_output() only uses rcu_read_lock().

We might be interrupted by a softirq, re-enter seg6_output_core()
and corrupt dst_cache data structures.

Fix the race by using local_bh_disable() instead of
preempt_disable().

Apply a similar change in seg6_input_core().

Fixes: fa79581ea66c ("ipv6: sr: fix several BUGs when preemption is enabled")
Fixes: 6c8702c60b88 ("ipv6: sr: add support for SRH encapsulation and injection with lwtunnels")
Signed-off-by: Eric Dumazet <edumazet@google.com>
Cc: David Lebrun <dlebrun@google.com>
Acked-by: Paolo Abeni <pabeni@redhat.com>
Link: https://lore.kernel.org/r/20240531132636.2637995-4-edumazet@google.com
Signed-off-by: Jakub Kicinski <kuba@kernel.org>

Metadata:
Author: Eric Dumazet <edumazet@google.com>
Author Date: Fri May 31 13:26:34 2024 +0000
Committer: Jakub Kicinski <kuba@kernel.org>
Commit Date: Mon Jun 3 18:50:08 2024 -0700

Files Changed: 1
Lines Added: 6
Lines Removed: 8
Total Changes: 14
