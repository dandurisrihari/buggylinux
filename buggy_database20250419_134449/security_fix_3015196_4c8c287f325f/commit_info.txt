Commit Hash: 301519674699aa9b80a15b2b2165e08532b176e6
Subject: xfs: Introduce error injection to allocate only minlen size extents for files


Security Keywords:
- injection

Full commit message:
xfs: Introduce error injection to allocate only minlen size extents for files

This commit adds XFS_ERRTAG_BMAP_ALLOC_MINLEN_EXTENT error tag which
helps userspace test programs to get xfs_bmap_btalloc() to always
allocate minlen sized extents.

This is required for test programs which need a guarantee that minlen
extents allocated for a file do not get merged with their existing
neighbours in the inode's BMBT. "Inode fork extent overflow check" for
Directories, Xattrs and extension of realtime inodes need this since the
file offset at which the extents are being allocated cannot be
explicitly controlled from userspace.

One way to use this error tag is to,
1. Consume all of the free space by sequentially writing to a file.
2. Punch alternate blocks of the file. This causes CNTBT to contain
   sufficient number of one block sized extent records.
3. Inject XFS_ERRTAG_BMAP_ALLOC_MINLEN_EXTENT error tag.
After step 3, xfs_bmap_btalloc() will issue space allocation
requests for minlen sized extents only.

ENOSPC error code is returned to userspace when there aren't any "one
block sized" extents left in any of the AGs.

Reviewed-by: Darrick J. Wong <darrick.wong@oracle.com>
Signed-off-by: Chandan Babu R <chandanrlinux@gmail.com>
Signed-off-by: Darrick J. Wong <darrick.wong@oracle.com>

Metadata:
Author: Chandan Babu R <chandanrlinux@gmail.com>
Author Date: Fri Jan 22 16:48:17 2021 -0800
Committer: Darrick J. Wong <djwong@kernel.org>
Commit Date: Fri Jan 22 16:54:49 2021 -0800

Files Changed: 5
Lines Added: 159
Lines Removed: 25
Total Changes: 184
