{
  "hash": "f16d80b75a096c52354c6e0a574993f3b0dfbdfe",
  "hash_short": "f16d80b7",
  "subject": "powerpc/tm: Fix oops on sigreturn on systems without TM",
  "body": "On systems like P9 powernv where we have no TM (or P8 booted with\nppc_tm=off), userspace can construct a signal context which still has\nthe MSR TS bits set. The kernel tries to restore this context which\nresults in the following crash:\n\n  Unexpected TM Bad Thing exception at c0000000000022fc (msr 0x8000000102a03031) tm_scratch=800000020280f033\n  Oops: Unrecoverable exception, sig: 6 [#1]\n  LE PAGE_SIZE=64K MMU=Hash SMP NR_CPUS=2048 NUMA pSeries\n  Modules linked in:\n  CPU: 0 PID: 1636 Comm: sigfuz Not tainted 5.2.0-11043-g0a8ad0ffa4 #69\n  NIP:  c0000000000022fc LR: 00007fffb2d67e48 CTR: 0000000000000000\n  REGS: c00000003fffbd70 TRAP: 0700   Not tainted  (5.2.0-11045-g7142b497d8)\n  MSR:  8000000102a03031 <SF,VEC,VSX,FP,ME,IR,DR,LE,TM[E]>  CR: 42004242  XER: 00000000\n  CFAR: c0000000000022e0 IRQMASK: 0\n  GPR00: 0000000000000072 00007fffb2b6e560 00007fffb2d87f00 0000000000000669\n  GPR04: 00007fffb2b6e728 0000000000000000 0000000000000000 00007fffb2b6f2a8\n  GPR08: 0000000000000000 0000000000000000 0000000000000000 0000000000000000\n  GPR12: 0000000000000000 00007fffb2b76900 0000000000000000 0000000000000000\n  GPR16: 00007fffb2370000 00007fffb2d84390 00007fffea3a15ac 000001000a250420\n  GPR20: 00007fffb2b6f260 0000000010001770 0000000000000000 0000000000000000\n  GPR24: 00007fffb2d843a0 00007fffea3a14a0 0000000000010000 0000000000800000\n  GPR28: 00007fffea3a14d8 00000000003d0f00 0000000000000000 00007fffb2b6e728\n  NIP [c0000000000022fc] rfi_flush_fallback+0x7c/0x80\n  LR [00007fffb2d67e48] 0x7fffb2d67e48\n  Call Trace:\n  Instruction dump:\n  e96a0220 e96a02a8 e96a0330 e96a03b8 394a0400 4200ffdc 7d2903a6 e92d0c00\n  e94d0c08 e96d0c10 e82d0c18 7db242a6 <4c000024> 7db243a6 7db142a6 f82d0c18\n\nThe problem is the signal code assumes TM is enabled when\nCONFIG_PPC_TRANSACTIONAL_MEM is enabled. This may not be the case as\nwith P9 powernv or if `ppc_tm=off` is used on P8.\n\nThis means any local user can crash the system.\n\nFix the problem by returning a bad stack frame to the user if they try\nto set the MSR TS bits with sigreturn() on systems where TM is not\nsupported.\n\nFound with sigfuz kernel selftest on P9.\n\nThis fixes CVE-2019-13648.\n\nFixes: 2b0a576d15e0 (\"powerpc: Add new transactional memory state to the signal context\")\nCc: stable@vger.kernel.org # v3.9\nReported-by: Praveen Pandey <Praveen.Pandey@in.ibm.com>\nSigned-off-by: Michael Neuling <mikey@neuling.org>\nSigned-off-by: Michael Ellerman <mpe@ellerman.id.au>\nLink: https://lore.kernel.org/r/20190719050502.405-1-mikey@neuling.org",
  "full_message": "powerpc/tm: Fix oops on sigreturn on systems without TM\n\nOn systems like P9 powernv where we have no TM (or P8 booted with\nppc_tm=off), userspace can construct a signal context which still has\nthe MSR TS bits set. The kernel tries to restore this context which\nresults in the following crash:\n\n  Unexpected TM Bad Thing exception at c0000000000022fc (msr 0x8000000102a03031) tm_scratch=800000020280f033\n  Oops: Unrecoverable exception, sig: 6 [#1]\n  LE PAGE_SIZE=64K MMU=Hash SMP NR_CPUS=2048 NUMA pSeries\n  Modules linked in:\n  CPU: 0 PID: 1636 Comm: sigfuz Not tainted 5.2.0-11043-g0a8ad0ffa4 #69\n  NIP:  c0000000000022fc LR: 00007fffb2d67e48 CTR: 0000000000000000\n  REGS: c00000003fffbd70 TRAP: 0700   Not tainted  (5.2.0-11045-g7142b497d8)\n  MSR:  8000000102a03031 <SF,VEC,VSX,FP,ME,IR,DR,LE,TM[E]>  CR: 42004242  XER: 00000000\n  CFAR: c0000000000022e0 IRQMASK: 0\n  GPR00: 0000000000000072 00007fffb2b6e560 00007fffb2d87f00 0000000000000669\n  GPR04: 00007fffb2b6e728 0000000000000000 0000000000000000 00007fffb2b6f2a8\n  GPR08: 0000000000000000 0000000000000000 0000000000000000 0000000000000000\n  GPR12: 0000000000000000 00007fffb2b76900 0000000000000000 0000000000000000\n  GPR16: 00007fffb2370000 00007fffb2d84390 00007fffea3a15ac 000001000a250420\n  GPR20: 00007fffb2b6f260 0000000010001770 0000000000000000 0000000000000000\n  GPR24: 00007fffb2d843a0 00007fffea3a14a0 0000000000010000 0000000000800000\n  GPR28: 00007fffea3a14d8 00000000003d0f00 0000000000000000 00007fffb2b6e728\n  NIP [c0000000000022fc] rfi_flush_fallback+0x7c/0x80\n  LR [00007fffb2d67e48] 0x7fffb2d67e48\n  Call Trace:\n  Instruction dump:\n  e96a0220 e96a02a8 e96a0330 e96a03b8 394a0400 4200ffdc 7d2903a6 e92d0c00\n  e94d0c08 e96d0c10 e82d0c18 7db242a6 <4c000024> 7db243a6 7db142a6 f82d0c18\n\nThe problem is the signal code assumes TM is enabled when\nCONFIG_PPC_TRANSACTIONAL_MEM is enabled. This may not be the case as\nwith P9 powernv or if `ppc_tm=off` is used on P8.\n\nThis means any local user can crash the system.\n\nFix the problem by returning a bad stack frame to the user if they try\nto set the MSR TS bits with sigreturn() on systems where TM is not\nsupported.\n\nFound with sigfuz kernel selftest on P9.\n\nThis fixes CVE-2019-13648.\n\nFixes: 2b0a576d15e0 (\"powerpc: Add new transactional memory state to the signal context\")\nCc: stable@vger.kernel.org # v3.9\nReported-by: Praveen Pandey <Praveen.Pandey@in.ibm.com>\nSigned-off-by: Michael Neuling <mikey@neuling.org>\nSigned-off-by: Michael Ellerman <mpe@ellerman.id.au>\nLink: https://lore.kernel.org/r/20190719050502.405-1-mikey@neuling.org",
  "author_name": "Michael Neuling",
  "author_email": "mikey@neuling.org",
  "author_date": "Fri Jul 19 15:05:02 2019 +1000",
  "author_date_iso": "2019-07-19T15:05:02+10:00",
  "committer_name": "Michael Ellerman",
  "committer_email": "mpe@ellerman.id.au",
  "committer_date": "Mon Jul 22 13:05:23 2019 +1000",
  "committer_date_iso": "2019-07-22T13:05:23+10:00",
  "files_changed": [
    "arch/powerpc/kernel/signal_32.c",
    "arch/powerpc/kernel/signal_64.c"
  ],
  "files_changed_count": 2,
  "stats": [
    {
      "file": "arch/powerpc/kernel/signal_32.c",
      "insertions": 3,
      "deletions": 0
    },
    {
      "file": "arch/powerpc/kernel/signal_64.c",
      "insertions": 5,
      "deletions": 0
    }
  ],
  "total_insertions": 8,
  "total_deletions": 0,
  "total_changes": 8,
  "parents": [
    "b4fc36e60f25cf22bf8b7b015a701015740c3743"
  ],
  "branches": [
    "* development",
    "master",
    "remotes/origin/HEAD -> origin/master",
    "remotes/origin/master"
  ],
  "tags": [
    "v5.3",
    "v5.3-rc2",
    "v5.3-rc3",
    "v5.3-rc4",
    "v5.3-rc5",
    "v5.3-rc6",
    "v5.3-rc7",
    "v5.3-rc8",
    "v5.4",
    "v5.4-rc1"
  ],
  "is_merge": false,
  "security_info": {
    "cve_ids": [
      "CVE-2019-13648"
    ],
    "security_keywords": []
  },
  "fix_type": "cve",
  "file_results": [
    {
      "file": "arch/powerpc/kernel/signal_32.c",
      "pre_version": false,
      "post_version": true,
      "patch": true
    },
    {
      "file": "arch/powerpc/kernel/signal_64.c",
      "pre_version": false,
      "post_version": true,
      "patch": true
    }
  ]
}