Commit Hash: 861377730aa9db4cbaa0f3bd3f4d295c152732c4
Subject: KVM: SVM: Provide support for SEV-ES vCPU loading


Security Keywords:
- XSS

Full commit message:
KVM: SVM: Provide support for SEV-ES vCPU loading

An SEV-ES vCPU requires additional VMCB vCPU load/put requirements. SEV-ES
hardware will restore certain registers on VMEXIT, but not save them on
VMRUN (see Table B-3 and Table B-4 of the AMD64 APM Volume 2), so make the
following changes:

General vCPU load changes:
  - During vCPU loading, perform a VMSAVE to the per-CPU SVM save area and
    save the current values of XCR0, XSS and PKRU to the per-CPU SVM save
    area as these registers will be restored on VMEXIT.

General vCPU put changes:
  - Do not attempt to restore registers that SEV-ES hardware has already
    restored on VMEXIT.

Signed-off-by: Tom Lendacky <thomas.lendacky@amd.com>
Message-Id: <019390e9cb5e93cd73014fa5a040c17d42588733.1607620209.git.thomas.lendacky@amd.com>
Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>

Metadata:
Author: Tom Lendacky <thomas.lendacky@amd.com>
Author Date: Thu Dec 10 11:10:07 2020 -0600
Committer: Paolo Bonzini <pbonzini@redhat.com>
Commit Date: Tue Dec 15 05:20:59 2020 -0500

Files Changed: 6
Lines Added: 103
Lines Removed: 23
Total Changes: 126
