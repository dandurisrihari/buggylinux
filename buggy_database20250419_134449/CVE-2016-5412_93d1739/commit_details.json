{
  "hash": "93d17397e4e2182fdaad503e2f9da46202c0f1c3",
  "hash_short": "93d17397",
  "subject": "KVM: PPC: Book3S HV: Save/restore TM state in H_CEDE",
  "body": "It turns out that if the guest does a H_CEDE while the CPU is in\na transactional state, and the H_CEDE does a nap, and the nap\nloses the architected state of the CPU (which is is allowed to do),\nthen we lose the checkpointed state of the virtual CPU.  In addition,\nthe transactional-memory state recorded in the MSR gets reset back\nto non-transactional, and when we try to return to the guest, we take\na TM bad thing type of program interrupt because we are trying to\ntransition from non-transactional to transactional with a hrfid\ninstruction, which is not permitted.\n\nThe result of the program interrupt occurring at that point is that\nthe host CPU will hang in an infinite loop with interrupts disabled.\nThus this is a denial of service vulnerability in the host which can\nbe triggered by any guest (and depending on the guest kernel, it can\npotentially triggered by unprivileged userspace in the guest).\n\nThis vulnerability has been assigned the ID CVE-2016-5412.\n\nTo fix this, we save the TM state before napping and restore it\non exit from the nap, when handling a H_CEDE in real mode.  The\ncase where H_CEDE exits to host virtual mode is already OK (as are\nother hcalls which exit to host virtual mode) because the exit\npath saves the TM state.\n\nCc: stable@vger.kernel.org # v3.15+\nSigned-off-by: Paul Mackerras <paulus@ozlabs.org>",
  "full_message": "KVM: PPC: Book3S HV: Save/restore TM state in H_CEDE\n\nIt turns out that if the guest does a H_CEDE while the CPU is in\na transactional state, and the H_CEDE does a nap, and the nap\nloses the architected state of the CPU (which is is allowed to do),\nthen we lose the checkpointed state of the virtual CPU.  In addition,\nthe transactional-memory state recorded in the MSR gets reset back\nto non-transactional, and when we try to return to the guest, we take\na TM bad thing type of program interrupt because we are trying to\ntransition from non-transactional to transactional with a hrfid\ninstruction, which is not permitted.\n\nThe result of the program interrupt occurring at that point is that\nthe host CPU will hang in an infinite loop with interrupts disabled.\nThus this is a denial of service vulnerability in the host which can\nbe triggered by any guest (and depending on the guest kernel, it can\npotentially triggered by unprivileged userspace in the guest).\n\nThis vulnerability has been assigned the ID CVE-2016-5412.\n\nTo fix this, we save the TM state before napping and restore it\non exit from the nap, when handling a H_CEDE in real mode.  The\ncase where H_CEDE exits to host virtual mode is already OK (as are\nother hcalls which exit to host virtual mode) because the exit\npath saves the TM state.\n\nCc: stable@vger.kernel.org # v3.15+\nSigned-off-by: Paul Mackerras <paulus@ozlabs.org>",
  "author_name": "Paul Mackerras",
  "author_email": "paulus@ozlabs.org",
  "author_date": "Wed Jun 22 15:52:55 2016 +1000",
  "author_date_iso": "2016-06-22T15:52:55+10:00",
  "committer_name": "Paul Mackerras",
  "committer_email": "paulus@ozlabs.org",
  "committer_date": "Thu Jul 28 16:10:07 2016 +1000",
  "committer_date_iso": "2016-07-28T16:10:07+10:00",
  "files_changed": [
    "arch/powerpc/kvm/book3s_hv_rmhandlers.S"
  ],
  "files_changed_count": 1,
  "stats": [
    {
      "file": "arch/powerpc/kvm/book3s_hv_rmhandlers.S",
      "insertions": 13,
      "deletions": 0
    }
  ],
  "total_insertions": 13,
  "total_deletions": 0,
  "total_changes": 13,
  "parents": [
    "f024ee098476a3e620232e4a78cfac505f121245"
  ],
  "branches": [
    "* development",
    "master",
    "remotes/origin/HEAD -> origin/master",
    "remotes/origin/master"
  ],
  "tags": [
    "v4.10",
    "v4.10-rc1",
    "v4.10-rc2",
    "v4.10-rc3",
    "v4.10-rc4",
    "v4.10-rc5",
    "v4.10-rc6",
    "v4.10-rc7",
    "v4.10-rc8",
    "v4.11"
  ],
  "is_merge": false,
  "security_info": {
    "cve_ids": [
      "CVE-2016-5412"
    ],
    "security_keywords": [
      "vulnerability"
    ]
  },
  "fix_type": "cve",
  "file_results": [
    {
      "file": "arch/powerpc/kvm/book3s_hv_rmhandlers.S",
      "pre_version": true,
      "post_version": true,
      "patch": true
    }
  ]
}