{
  "hash": "ba48202932de455566868a065874279688c9241f",
  "hash_short": "ba482029",
  "subject": "cifs: fix bad error handling in crypto code",
  "body": "Jarod reported an Oops like when testing with fips=1:\n\nCIFS VFS: could not allocate crypto hmacmd5\nCIFS VFS: could not crypto alloc hmacmd5 rc -2\nCIFS VFS: Error -2 during NTLMSSP authentication\nCIFS VFS: Send error in SessSetup = -2\nBUG: unable to handle kernel NULL pointer dereference at 000000000000004e\nIP: [<ffffffff812b5c7a>] crypto_destroy_tfm+0x1a/0x90\nPGD 0\nOops: 0000 [#1] SMP\nModules linked in: md4 nls_utf8 cifs dns_resolver fscache kvm serio_raw virtio_balloon virtio_net mperf i2c_piix4 cirrus drm_kms_helper ttm drm i2c_core virtio_blk ata_generic pata_acpi\nCPU: 1 PID: 639 Comm: mount.cifs Not tainted 3.11.0-0.rc3.git0.1.fc20.x86_64 #1\nHardware name: Bochs Bochs, BIOS Bochs 01/01/2011\ntask: ffff88007bf496e0 ti: ffff88007b080000 task.ti: ffff88007b080000\nRIP: 0010:[<ffffffff812b5c7a>]  [<ffffffff812b5c7a>] crypto_destroy_tfm+0x1a/0x90\nRSP: 0018:ffff88007b081d10  EFLAGS: 00010282\nRAX: 0000000000001f1f RBX: ffff880037422000 RCX: ffff88007b081fd8\nRDX: 000000000000001f RSI: 0000000000000006 RDI: fffffffffffffffe\nRBP: ffff88007b081d30 R08: ffff880037422000 R09: ffff88007c090100\nR10: 0000000000000000 R11: 00000000fffffffe R12: fffffffffffffffe\nR13: ffff880037422000 R14: ffff880037422000 R15: 00000000fffffffe\nFS:  00007fc322f4f780(0000) GS:ffff88007fc80000(0000) knlGS:0000000000000000\nCS:  0010 DS: 0000 ES: 0000 CR0: 000000008005003b\nCR2: 000000000000004e CR3: 000000007bdaa000 CR4: 00000000000006e0\nStack:\n ffffffff81085845 ffff880037422000 ffff8800375e7400 ffff880037422000\n ffff88007b081d48 ffffffffa0176022 ffff880037422000 ffff88007b081d60\n ffffffffa015c07b ffff880037600600 ffff88007b081dc8 ffffffffa01610e1\nCall Trace:\n [<ffffffff81085845>] ? __cancel_work_timer+0x75/0xf0\n [<ffffffffa0176022>] cifs_crypto_shash_release+0x82/0xf0 [cifs]\n [<ffffffffa015c07b>] cifs_put_tcp_session+0x8b/0xe0 [cifs]\n [<ffffffffa01610e1>] cifs_mount+0x9d1/0xad0 [cifs]\n [<ffffffffa014ff50>] cifs_do_mount+0xa0/0x4d0 [cifs]\n [<ffffffff811ab6e9>] mount_fs+0x39/0x1b0\n [<ffffffff811c466f>] vfs_kern_mount+0x5f/0xf0\n [<ffffffff811c6a9e>] do_mount+0x23e/0xa20\n [<ffffffff811c66e6>] ? copy_mount_options+0x36/0x170\n [<ffffffff811c7303>] SyS_mount+0x83/0xc0\n [<ffffffff8165c8d9>] system_call_fastpath+0x16/0x1b\nCode: eb 9e 66 66 66 66 66 66 2e 0f 1f 84 00 00 00 00 00 66 66 66 66 90 55 48 89 e5 41 55 41 54 49 89 fc 53 48 83 ec 08 48 85 ff 74 46 <48> 83 7e 48 00 48 8b 5e 50 74 4b 48 89 f7 e8 83 fc ff ff 4c 8b\nRIP  [<ffffffff812b5c7a>] crypto_destroy_tfm+0x1a/0x90\n RSP <ffff88007b081d10>\nCR2: 000000000000004e\n\nThe cifs code allocates some crypto structures. If that fails, it\nreturns an error, but it leaves the pointers set to their PTR_ERR\nvalues. Then later when it tries to clean up, it sees that those values\nare non-NULL and then passes them to the routine that frees them.\n\nFix this by setting the pointers to NULL after collecting the error code\nin this situation.\n\nCc: Sachin Prabhu <sprabhu@redhat.com>\nReported-by: Jarod Wilson <jarod@redhat.com>\nSigned-off-by: Jeff Layton <jlayton@redhat.com>\nSigned-off-by: Steve French <smfrench@gmail.com>",
  "full_message": "cifs: fix bad error handling in crypto code\n\nJarod reported an Oops like when testing with fips=1:\n\nCIFS VFS: could not allocate crypto hmacmd5\nCIFS VFS: could not crypto alloc hmacmd5 rc -2\nCIFS VFS: Error -2 during NTLMSSP authentication\nCIFS VFS: Send error in SessSetup = -2\nBUG: unable to handle kernel NULL pointer dereference at 000000000000004e\nIP: [<ffffffff812b5c7a>] crypto_destroy_tfm+0x1a/0x90\nPGD 0\nOops: 0000 [#1] SMP\nModules linked in: md4 nls_utf8 cifs dns_resolver fscache kvm serio_raw virtio_balloon virtio_net mperf i2c_piix4 cirrus drm_kms_helper ttm drm i2c_core virtio_blk ata_generic pata_acpi\nCPU: 1 PID: 639 Comm: mount.cifs Not tainted 3.11.0-0.rc3.git0.1.fc20.x86_64 #1\nHardware name: Bochs Bochs, BIOS Bochs 01/01/2011\ntask: ffff88007bf496e0 ti: ffff88007b080000 task.ti: ffff88007b080000\nRIP: 0010:[<ffffffff812b5c7a>]  [<ffffffff812b5c7a>] crypto_destroy_tfm+0x1a/0x90\nRSP: 0018:ffff88007b081d10  EFLAGS: 00010282\nRAX: 0000000000001f1f RBX: ffff880037422000 RCX: ffff88007b081fd8\nRDX: 000000000000001f RSI: 0000000000000006 RDI: fffffffffffffffe\nRBP: ffff88007b081d30 R08: ffff880037422000 R09: ffff88007c090100\nR10: 0000000000000000 R11: 00000000fffffffe R12: fffffffffffffffe\nR13: ffff880037422000 R14: ffff880037422000 R15: 00000000fffffffe\nFS:  00007fc322f4f780(0000) GS:ffff88007fc80000(0000) knlGS:0000000000000000\nCS:  0010 DS: 0000 ES: 0000 CR0: 000000008005003b\nCR2: 000000000000004e CR3: 000000007bdaa000 CR4: 00000000000006e0\nStack:\n ffffffff81085845 ffff880037422000 ffff8800375e7400 ffff880037422000\n ffff88007b081d48 ffffffffa0176022 ffff880037422000 ffff88007b081d60\n ffffffffa015c07b ffff880037600600 ffff88007b081dc8 ffffffffa01610e1\nCall Trace:\n [<ffffffff81085845>] ? __cancel_work_timer+0x75/0xf0\n [<ffffffffa0176022>] cifs_crypto_shash_release+0x82/0xf0 [cifs]\n [<ffffffffa015c07b>] cifs_put_tcp_session+0x8b/0xe0 [cifs]\n [<ffffffffa01610e1>] cifs_mount+0x9d1/0xad0 [cifs]\n [<ffffffffa014ff50>] cifs_do_mount+0xa0/0x4d0 [cifs]\n [<ffffffff811ab6e9>] mount_fs+0x39/0x1b0\n [<ffffffff811c466f>] vfs_kern_mount+0x5f/0xf0\n [<ffffffff811c6a9e>] do_mount+0x23e/0xa20\n [<ffffffff811c66e6>] ? copy_mount_options+0x36/0x170\n [<ffffffff811c7303>] SyS_mount+0x83/0xc0\n [<ffffffff8165c8d9>] system_call_fastpath+0x16/0x1b\nCode: eb 9e 66 66 66 66 66 66 2e 0f 1f 84 00 00 00 00 00 66 66 66 66 90 55 48 89 e5 41 55 41 54 49 89 fc 53 48 83 ec 08 48 85 ff 74 46 <48> 83 7e 48 00 48 8b 5e 50 74 4b 48 89 f7 e8 83 fc ff ff 4c 8b\nRIP  [<ffffffff812b5c7a>] crypto_destroy_tfm+0x1a/0x90\n RSP <ffff88007b081d10>\nCR2: 000000000000004e\n\nThe cifs code allocates some crypto structures. If that fails, it\nreturns an error, but it leaves the pointers set to their PTR_ERR\nvalues. Then later when it tries to clean up, it sees that those values\nare non-NULL and then passes them to the routine that frees them.\n\nFix this by setting the pointers to NULL after collecting the error code\nin this situation.\n\nCc: Sachin Prabhu <sprabhu@redhat.com>\nReported-by: Jarod Wilson <jarod@redhat.com>\nSigned-off-by: Jeff Layton <jlayton@redhat.com>\nSigned-off-by: Steve French <smfrench@gmail.com>",
  "author_name": "Jeff Layton",
  "author_email": "jlayton@redhat.com",
  "author_date": "Wed Jul 31 13:48:00 2013 -0400",
  "author_date_iso": "2013-07-31T13:48:00-04:00",
  "committer_name": "Steve French",
  "committer_email": "smfrench@gmail.com",
  "committer_date": "Wed Jul 31 13:44:59 2013 -0500",
  "committer_date_iso": "2013-07-31T13:44:59-05:00",
  "files_changed": [
    "fs/cifs/cifsencrypt.c",
    "fs/cifs/smb2transport.c"
  ],
  "files_changed_count": 2,
  "stats": [
    {
      "file": "fs/cifs/cifsencrypt.c",
      "insertions": 8,
      "deletions": 4
    },
    {
      "file": "fs/cifs/smb2transport.c",
      "insertions": 7,
      "deletions": 2
    }
  ],
  "total_insertions": 15,
  "total_deletions": 6,
  "total_changes": 21,
  "parents": [
    "fe090e4e44bac1d7d8c0ebd1dfa4e6007e1b2762"
  ],
  "branches": [
    "* development",
    "master",
    "remotes/origin/HEAD -> origin/master",
    "remotes/origin/master"
  ],
  "tags": [
    "v3.11",
    "v3.11-rc6",
    "v3.11-rc7",
    "v3.12",
    "v3.12-rc1",
    "v3.12-rc2",
    "v3.12-rc3",
    "v3.12-rc4",
    "v3.12-rc5",
    "v3.12-rc6"
  ],
  "is_merge": false,
  "security_info": {
    "cve_ids": [],
    "security_keywords": [
      "authentication"
    ]
  },
  "fix_type": "security",
  "file_results": [
    {
      "file": "fs/cifs/cifsencrypt.c",
      "pre_version": false,
      "post_version": true,
      "patch": true
    },
    {
      "file": "fs/cifs/smb2transport.c",
      "pre_version": false,
      "post_version": true,
      "patch": true
    }
  ]
}