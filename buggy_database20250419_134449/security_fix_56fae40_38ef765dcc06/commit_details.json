{
  "hash": "56fae404fb2c306db0a35dad0d16fa24c65678f3",
  "hash_short": "56fae404",
  "subject": "bridge: Fix incorrect re-injection of STP packets",
  "body": "Commit 8626c56c8279 (\"bridge: fix potential use-after-free when hook\nreturns QUEUE or STOLEN verdict\") fixed incorrect usage of NF_HOOK's\nreturn value by consuming packets in okfn via br_pass_frame_up().\n\nHowever, this function re-injects packets to the Rx path with skb->dev\nset to the bridge device, which breaks kernel's STP, as all STP packets\nappear to originate from the bridge device itself.\n\nInstead, if STP is enabled and bridge isn't a 802.1ad bridge, then learn\npacket's SMAC and inject it back to the Rx path for further processing\nby the packet handlers.\n\nThe patch also makes netfilter's behavior consistent with regards to\npackets destined to the Bridge Group Address, as no hook registered at\nLOCAL_IN will ever be called, regardless if STP is enabled or not.\n\nCc: Florian Westphal <fw@strlen.de>\nCc: Shmulik Ladkani <shmulik.ladkani@gmail.com>\nCc: Toshiaki Makita <makita.toshiaki@lab.ntt.co.jp>\nFixes: 8626c56c8279 (\"bridge: fix potential use-after-free when hook returns QUEUE or STOLEN verdict\")\nSigned-off-by: Jiri Pirko <jiri@mellanox.com>\nSigned-off-by: Ido Schimmel <idosch@mellanox.com>\nSigned-off-by: David S. Miller <davem@davemloft.net>",
  "full_message": "bridge: Fix incorrect re-injection of STP packets\n\nCommit 8626c56c8279 (\"bridge: fix potential use-after-free when hook\nreturns QUEUE or STOLEN verdict\") fixed incorrect usage of NF_HOOK's\nreturn value by consuming packets in okfn via br_pass_frame_up().\n\nHowever, this function re-injects packets to the Rx path with skb->dev\nset to the bridge device, which breaks kernel's STP, as all STP packets\nappear to originate from the bridge device itself.\n\nInstead, if STP is enabled and bridge isn't a 802.1ad bridge, then learn\npacket's SMAC and inject it back to the Rx path for further processing\nby the packet handlers.\n\nThe patch also makes netfilter's behavior consistent with regards to\npackets destined to the Bridge Group Address, as no hook registered at\nLOCAL_IN will ever be called, regardless if STP is enabled or not.\n\nCc: Florian Westphal <fw@strlen.de>\nCc: Shmulik Ladkani <shmulik.ladkani@gmail.com>\nCc: Toshiaki Makita <makita.toshiaki@lab.ntt.co.jp>\nFixes: 8626c56c8279 (\"bridge: fix potential use-after-free when hook returns QUEUE or STOLEN verdict\")\nSigned-off-by: Jiri Pirko <jiri@mellanox.com>\nSigned-off-by: Ido Schimmel <idosch@mellanox.com>\nSigned-off-by: David S. Miller <davem@davemloft.net>",
  "author_name": "Ido Schimmel",
  "author_email": "idosch@mellanox.com",
  "author_date": "Tue Jun 7 12:06:58 2016 +0300",
  "author_date_iso": "2016-06-07T12:06:58+03:00",
  "committer_name": "David S. Miller",
  "committer_email": "davem@davemloft.net",
  "committer_date": "Fri Jun 10 22:41:58 2016 -0700",
  "committer_date_iso": "2016-06-10T22:41:58-07:00",
  "files_changed": [
    "net/bridge/br_input.c"
  ],
  "files_changed_count": 1,
  "stats": [
    {
      "file": "net/bridge/br_input.c",
      "insertions": 12,
      "deletions": 3
    }
  ],
  "total_insertions": 12,
  "total_deletions": 3,
  "total_changes": 15,
  "parents": [
    "fc0f7e3317c5f406e6d5520209b4689a4ffecfdf"
  ],
  "branches": [
    "* development",
    "master",
    "remotes/origin/HEAD -> origin/master",
    "remotes/origin/master"
  ],
  "tags": [
    "v4.10",
    "v4.10-rc1",
    "v4.10-rc2",
    "v4.10-rc3",
    "v4.10-rc4",
    "v4.10-rc5",
    "v4.10-rc6",
    "v4.10-rc7",
    "v4.10-rc8",
    "v4.11"
  ],
  "is_merge": false,
  "security_info": {
    "cve_ids": [],
    "security_keywords": [
      "injection"
    ]
  },
  "fix_type": "security",
  "file_results": [
    {
      "file": "net/bridge/br_input.c",
      "pre_version": false,
      "post_version": true,
      "patch": true
    }
  ]
}