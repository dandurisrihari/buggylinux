{
  "hash": "5981a8821b774ada0be512fd9bad7c241e17657e",
  "hash_short": "5981a882",
  "subject": "Bluetooth: Fix removing Long Term Key",
  "body": "This patch fixes authentication failure on LE link re-connection when\nBlueZ acts as slave (peripheral). LTK is removed from the internal list\nafter its first use causing PIN or Key missing reply when re-connecting\nthe link. The LE Long Term Key Request event indicates that the master\nis attempting to encrypt or re-encrypt the link.\n\nPre-condition: BlueZ host paired and running as slave.\nHow to reproduce(master):\n\n  1) Establish an ACL LE encrypted link\n  2) Disconnect the link\n  3) Try to re-establish the ACL LE encrypted link (fails)\n\n> HCI Event: LE Meta Event (0x3e) plen 19\n      LE Connection Complete (0x01)\n        Status: Success (0x00)\n        Handle: 64\n        Role: Slave (0x01)\n...\n@ Device Connected: 00:02:72:DC:29:C9 (1) flags 0x0000\n> HCI Event: LE Meta Event (0x3e) plen 13\n      LE Long Term Key Request (0x05)\n        Handle: 64\n        Random number: 875be18439d9aa37\n        Encryption diversifier: 0x76ed\n< HCI Command: LE Long Term Key Request Reply (0x08|0x001a) plen 18\n        Handle: 64\n        Long term key: 2aa531db2fce9f00a0569c7d23d17409\n> HCI Event: Command Complete (0x0e) plen 6\n      LE Long Term Key Request Reply (0x08|0x001a) ncmd 1\n        Status: Success (0x00)\n        Handle: 64\n> HCI Event: Encryption Change (0x08) plen 4\n        Status: Success (0x00)\n        Handle: 64\n        Encryption: Enabled with AES-CCM (0x01)\n...\n@ Device Disconnected: 00:02:72:DC:29:C9 (1) reason 3\n< HCI Command: LE Set Advertise Enable (0x08|0x000a) plen 1\n        Advertising: Enabled (0x01)\n> HCI Event: Command Complete (0x0e) plen 4\n      LE Set Advertise Enable (0x08|0x000a) ncmd 1\n        Status: Success (0x00)\n> HCI Event: LE Meta Event (0x3e) plen 19\n      LE Connection Complete (0x01)\n        Status: Success (0x00)\n        Handle: 64\n        Role: Slave (0x01)\n...\n@ Device Connected: 00:02:72:DC:29:C9 (1) flags 0x0000\n> HCI Event: LE Meta Event (0x3e) plen 13\n      LE Long Term Key Request (0x05)\n        Handle: 64\n        Random number: 875be18439d9aa37\n        Encryption diversifier: 0x76ed\n< HCI Command: LE Long Term Key Request Neg Reply (0x08|0x001b) plen 2\n        Handle: 64\n> HCI Event: Command Complete (0x0e) plen 6\n      LE Long Term Key Request Neg Reply (0x08|0x001b) ncmd 1\n        Status: Success (0x00)\n        Handle: 64\n> HCI Event: Disconnect Complete (0x05) plen 4\n        Status: Success (0x00)\n        Handle: 64\n        Reason: Authentication Failure (0x05)\n@ Device Disconnected: 00:02:72:DC:29:C9 (1) reason 0\n\nSigned-off-by: Claudio Takahasi <claudio.takahasi@openbossa.org>\nCc: stable@vger.kernel.org\nSigned-off-by: Johan Hedberg <johan.hedberg@intel.com>",
  "full_message": "Bluetooth: Fix removing Long Term Key\n\nThis patch fixes authentication failure on LE link re-connection when\nBlueZ acts as slave (peripheral). LTK is removed from the internal list\nafter its first use causing PIN or Key missing reply when re-connecting\nthe link. The LE Long Term Key Request event indicates that the master\nis attempting to encrypt or re-encrypt the link.\n\nPre-condition: BlueZ host paired and running as slave.\nHow to reproduce(master):\n\n  1) Establish an ACL LE encrypted link\n  2) Disconnect the link\n  3) Try to re-establish the ACL LE encrypted link (fails)\n\n> HCI Event: LE Meta Event (0x3e) plen 19\n      LE Connection Complete (0x01)\n        Status: Success (0x00)\n        Handle: 64\n        Role: Slave (0x01)\n...\n@ Device Connected: 00:02:72:DC:29:C9 (1) flags 0x0000\n> HCI Event: LE Meta Event (0x3e) plen 13\n      LE Long Term Key Request (0x05)\n        Handle: 64\n        Random number: 875be18439d9aa37\n        Encryption diversifier: 0x76ed\n< HCI Command: LE Long Term Key Request Reply (0x08|0x001a) plen 18\n        Handle: 64\n        Long term key: 2aa531db2fce9f00a0569c7d23d17409\n> HCI Event: Command Complete (0x0e) plen 6\n      LE Long Term Key Request Reply (0x08|0x001a) ncmd 1\n        Status: Success (0x00)\n        Handle: 64\n> HCI Event: Encryption Change (0x08) plen 4\n        Status: Success (0x00)\n        Handle: 64\n        Encryption: Enabled with AES-CCM (0x01)\n...\n@ Device Disconnected: 00:02:72:DC:29:C9 (1) reason 3\n< HCI Command: LE Set Advertise Enable (0x08|0x000a) plen 1\n        Advertising: Enabled (0x01)\n> HCI Event: Command Complete (0x0e) plen 4\n      LE Set Advertise Enable (0x08|0x000a) ncmd 1\n        Status: Success (0x00)\n> HCI Event: LE Meta Event (0x3e) plen 19\n      LE Connection Complete (0x01)\n        Status: Success (0x00)\n        Handle: 64\n        Role: Slave (0x01)\n...\n@ Device Connected: 00:02:72:DC:29:C9 (1) flags 0x0000\n> HCI Event: LE Meta Event (0x3e) plen 13\n      LE Long Term Key Request (0x05)\n        Handle: 64\n        Random number: 875be18439d9aa37\n        Encryption diversifier: 0x76ed\n< HCI Command: LE Long Term Key Request Neg Reply (0x08|0x001b) plen 2\n        Handle: 64\n> HCI Event: Command Complete (0x0e) plen 6\n      LE Long Term Key Request Neg Reply (0x08|0x001b) ncmd 1\n        Status: Success (0x00)\n        Handle: 64\n> HCI Event: Disconnect Complete (0x05) plen 4\n        Status: Success (0x00)\n        Handle: 64\n        Reason: Authentication Failure (0x05)\n@ Device Disconnected: 00:02:72:DC:29:C9 (1) reason 0\n\nSigned-off-by: Claudio Takahasi <claudio.takahasi@openbossa.org>\nCc: stable@vger.kernel.org\nSigned-off-by: Johan Hedberg <johan.hedberg@intel.com>",
  "author_name": "Claudio Takahasi",
  "author_email": "claudio.takahasi@openbossa.org",
  "author_date": "Thu Jul 25 16:34:24 2013 -0300",
  "author_date_iso": "2013-07-25T16:34:24-03:00",
  "committer_name": "Johan Hedberg",
  "committer_email": "johan.hedberg@intel.com",
  "committer_date": "Wed Mar 5 19:41:20 2014 +0200",
  "committer_date_iso": "2014-03-05T19:41:20+02:00",
  "files_changed": [
    "net/bluetooth/hci_event.c"
  ],
  "files_changed_count": 1,
  "stats": [
    {
      "file": "net/bluetooth/hci_event.c",
      "insertions": 7,
      "deletions": 1
    }
  ],
  "total_insertions": 7,
  "total_deletions": 1,
  "total_changes": 8,
  "parents": [
    "c327cddd184059d018b12d7ef818ba0961200079"
  ],
  "branches": [
    "* development",
    "master",
    "remotes/origin/HEAD -> origin/master",
    "remotes/origin/master"
  ],
  "tags": [
    "v3.15",
    "v3.15-rc1",
    "v3.15-rc2",
    "v3.15-rc3",
    "v3.15-rc4",
    "v3.15-rc5",
    "v3.15-rc6",
    "v3.15-rc7",
    "v3.15-rc8",
    "v3.16"
  ],
  "is_merge": false,
  "security_info": {
    "cve_ids": [],
    "security_keywords": [
      "authentication"
    ]
  },
  "fix_type": "security",
  "file_results": [
    {
      "file": "net/bluetooth/hci_event.c",
      "pre_version": false,
      "post_version": true,
      "patch": true
    }
  ]
}