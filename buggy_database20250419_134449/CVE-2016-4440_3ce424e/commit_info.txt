Commit Hash: 3ce424e45411cf5a13105e0386b6ecf6eeb4f66f
Subject: kvm:vmx: more complete state update on APICv on/off

CVE Identifiers:
- CVE-2016-4440

Full commit message:
kvm:vmx: more complete state update on APICv on/off

The function to update APICv on/off state (in particular, to deactivate
it when enabling Hyper-V SynIC) is incomplete: it doesn't adjust
APICv-related fields among secondary processor-based VM-execution
controls.  As a result, Windows 2012 guests get stuck when SynIC-based
auto-EOI interrupt intersected with e.g. an IPI in the guest.

In addition, the MSR intercept bitmap isn't updated every time "virtualize
x2APIC mode" is toggled.  This path can only be triggered by a malicious
guest, because Windows didn't use x2APIC but rather their own synthetic
APIC access MSRs; however a guest running in a SynIC-enabled VM could
switch to x2APIC and thus obtain direct access to host APIC MSRs
(CVE-2016-4440).

The patch fixes those omissions.

Signed-off-by: Roman Kagan <rkagan@virtuozzo.com>
Reported-by: Steve Rutherford <srutherford@google.com>
Reported-by: Yang Zhang <yang.zhang.wz@gmail.com>
Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>

Metadata:
Author: Roman Kagan <rkagan@virtuozzo.com>
Author Date: Wed May 18 17:48:20 2016 +0300
Committer: Paolo Bonzini <pbonzini@redhat.com>
Commit Date: Wed May 25 16:11:37 2016 +0200

Files Changed: 1
Lines Added: 30
Lines Removed: 18
Total Changes: 48
