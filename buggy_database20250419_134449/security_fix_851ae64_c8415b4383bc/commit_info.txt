Commit Hash: 851ae6424697d1c4f085cb878c88168923ebcad1
Subject: migrate_pages_batch: fix statistics for longterm pin retry


Security Keywords:
- injection

Full commit message:
migrate_pages_batch: fix statistics for longterm pin retry

In commit fd4a7ac32918 ("mm: migrate: try again if THP split is failed due
to page refcnt"), if the THP splitting fails due to page reference count,
we will retry to improve migration successful rate.  But the failed
splitting is counted as migration failure and migration retry, which will
cause duplicated failure counting.  So, in this patch, this is fixed via
undoing the failure counting if we decide to retry.  The patch is tested
via failure injection.

Link: https://lkml.kernel.org/r/20230416235929.1040194-1-ying.huang@intel.com
Fixes: fd4a7ac32918 ("mm: migrate: try again if THP split is failed due to page refcnt")
Signed-off-by: "Huang, Ying" <ying.huang@intel.com>
Reviewed-by: Baolin Wang <baolin.wang@linux.alibaba.com>
Cc: Alistair Popple <apopple@nvidia.com>
Cc: David Hildenbrand <david@redhat.com>
Cc: Yang Shi <shy828301@gmail.com>
Cc: Zi Yan <ziy@nvidia.com>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>

Metadata:
Author: Huang Ying <ying.huang@intel.com>
Author Date: Mon Apr 17 07:59:29 2023 +0800
Committer: Andrew Morton <akpm@linux-foundation.org>
Commit Date: Fri Apr 21 14:52:02 2023 -0700

Files Changed: 1
Lines Added: 3
Lines Removed: 0
Total Changes: 3
