commit 661b19473bf3ac0924560f0cbf84c15458b3c8de
Author: Mika Westerberg <mika.westerberg@linux.intel.com>
Date:   Tue Nov 10 11:34:07 2020 +0300

    thunderbolt: Perform USB4 router NVM upgrade in two phases
    
    The currect code expects that the router returns back the status of the
    NVM authentication immediately. When tested against a real USB4 device
    what happens is that the router is reset and only after that the result
    is updated in the ROUTER_CS_26 register status field. This also seems to
    align better what the spec suggests.
    
    For this reason do the same what we already do with the Thunderbolt 3
    devices and perform the NVM upgrade in two phases. First start the
    NVM_AUTH router operation and once the router is added back after the
    reset read the status in ROUTER_CS_26 and expose it to the userspace
    accordingly.
    
    Signed-off-by: Mika Westerberg <mika.westerberg@linux.intel.com>

diff --git a/drivers/thunderbolt/tb_regs.h b/drivers/thunderbolt/tb_regs.h
index e7d9529822fa..67cb173a2f8e 100644
--- a/drivers/thunderbolt/tb_regs.h
+++ b/drivers/thunderbolt/tb_regs.h
@@ -211,6 +211,7 @@ struct tb_regs_switch_header {
 #define ROUTER_CS_9				0x09
 #define ROUTER_CS_25				0x19
 #define ROUTER_CS_26				0x1a
+#define ROUTER_CS_26_OPCODE_MASK		GENMASK(15, 0)
 #define ROUTER_CS_26_STATUS_MASK		GENMASK(29, 24)
 #define ROUTER_CS_26_STATUS_SHIFT		24
 #define ROUTER_CS_26_ONS			BIT(30)