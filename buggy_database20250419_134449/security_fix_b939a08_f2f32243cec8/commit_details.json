{
  "hash": "b939a08bc378a7c716ad7a9486b48794b95d22f5",
  "hash_short": "b939a08b",
  "subject": "drm/i915/guc: Flush ct receive tasklet during reset preparation",
  "body": "GuC to host communication is interrupt driven, the handling has 3\nparts: interrupt context, tasklet and request queue worker.\nDuring GuC reset prepare, interrupt is disabled before destroy\ncontexts steps start. The IRQ and worker are flushed to finish\nany outstanding in-progress message handling. But, the tasklet\nflush is missing, it might causes 2 race conditions:\n1. Tasklet runs after IRQ flushed, add request to queue after worker\nflush started, causes unexpected G2H message request processing,\nmeanwhile, reset prepare code already get the context destroyed.\nThis will causes error reported about bad context state.\n(https://gitlab.freedesktop.org/drm/i915/kernel/-/issues/11349 and\nhttps://gitlab.freedesktop.org/drm/i915/kernel/-/issues/12303)\n2. Tasklet runs after intel_guc_submission_reset_prepare,\nct_try_receive_message start to run, while intel_uc_reset_prepare\nalready finished guc sanitize and set ct->enable to false. This will\ncauses warning on incorrect ct->enable state.\n(https://gitlab.freedesktop.org/drm/i915/kernel/-/issues/12439)\n\nAdd the missing tasklet flush to flush all 3 parts.\n\nSigned-off-by: Zhanjun Dong <zhanjun.dong@intel.com>\nReviewed-by: Alan Previn <alan.previn.teres.alexis@intel.com>\nSigned-off-by: John Harrison <John.C.Harrison@Intel.com>\nLink: https://patchwork.freedesktop.org/patch/msgid/20241104214103.214702-1-zhanjun.dong@intel.com",
  "full_message": "drm/i915/guc: Flush ct receive tasklet during reset preparation\n\nGuC to host communication is interrupt driven, the handling has 3\nparts: interrupt context, tasklet and request queue worker.\nDuring GuC reset prepare, interrupt is disabled before destroy\ncontexts steps start. The IRQ and worker are flushed to finish\nany outstanding in-progress message handling. But, the tasklet\nflush is missing, it might causes 2 race conditions:\n1. Tasklet runs after IRQ flushed, add request to queue after worker\nflush started, causes unexpected G2H message request processing,\nmeanwhile, reset prepare code already get the context destroyed.\nThis will causes error reported about bad context state.\n(https://gitlab.freedesktop.org/drm/i915/kernel/-/issues/11349 and\nhttps://gitlab.freedesktop.org/drm/i915/kernel/-/issues/12303)\n2. Tasklet runs after intel_guc_submission_reset_prepare,\nct_try_receive_message start to run, while intel_uc_reset_prepare\nalready finished guc sanitize and set ct->enable to false. This will\ncauses warning on incorrect ct->enable state.\n(https://gitlab.freedesktop.org/drm/i915/kernel/-/issues/12439)\n\nAdd the missing tasklet flush to flush all 3 parts.\n\nSigned-off-by: Zhanjun Dong <zhanjun.dong@intel.com>\nReviewed-by: Alan Previn <alan.previn.teres.alexis@intel.com>\nSigned-off-by: John Harrison <John.C.Harrison@Intel.com>\nLink: https://patchwork.freedesktop.org/patch/msgid/20241104214103.214702-1-zhanjun.dong@intel.com",
  "author_name": "Zhanjun Dong",
  "author_email": "zhanjun.dong@intel.com",
  "author_date": "Mon Nov 4 13:41:03 2024 -0800",
  "author_date_iso": "2024-11-04T13:41:03-08:00",
  "committer_name": "John Harrison",
  "committer_email": "John.C.Harrison@Intel.com",
  "committer_date": "Wed Nov 6 12:29:30 2024 -0800",
  "committer_date_iso": "2024-11-06T12:29:30-08:00",
  "files_changed": [
    "drivers/gpu/drm/i915/gt/uc/intel_guc_submission.c"
  ],
  "files_changed_count": 1,
  "stats": [
    {
      "file": "drivers/gpu/drm/i915/gt/uc/intel_guc_submission.c",
      "insertions": 4,
      "deletions": 0
    }
  ],
  "total_insertions": 4,
  "total_deletions": 0,
  "total_changes": 4,
  "parents": [
    "79367b7a58c82d0b1c0a7b0ef748f7aafa91d048"
  ],
  "branches": [
    "* development",
    "remotes/origin/HEAD -> origin/master",
    "remotes/origin/master"
  ],
  "tags": [],
  "is_merge": false,
  "security_info": {
    "cve_ids": [],
    "security_keywords": [
      "sanitize"
    ]
  },
  "fix_type": "security",
  "file_results": [
    {
      "file": "drivers/gpu/drm/i915/gt/uc/intel_guc_submission.c",
      "pre_version": false,
      "post_version": true,
      "patch": true
    }
  ]
}