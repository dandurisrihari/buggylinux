{
  "hash": "00d6a284fcf3fad1b7e1b5bc3cd87cbfb60ce03f",
  "hash_short": "00d6a284",
  "subject": "fbcon: always restore the old font data in fbcon_do_set_font()",
  "body": "Commit a5a923038d70 (fbdev: fbcon: Properly revert changes when\nvc_resize() failed) started restoring old font data upon failure (of\nvc_resize()). But it performs so only for user fonts. It means that the\n\"system\"/internal fonts are not restored at all. So in result, the very\nfirst call to fbcon_do_set_font() performs no restore at all upon\nfailing vc_resize().\n\nThis can be reproduced by Syzkaller to crash the system on the next\ninvocation of font_get(). It's rather hard to hit the allocation failure\nin vc_resize() on the first font_set(), but not impossible. Esp. if\nfault injection is used to aid the execution/failure. It was\ndemonstrated by Sirius:\n  BUG: unable to handle page fault for address: fffffffffffffff8\n  #PF: supervisor read access in kernel mode\n  #PF: error_code(0x0000) - not-present page\n  PGD cb7b067 P4D cb7b067 PUD cb7d067 PMD 0\n  Oops: 0000 [#1] PREEMPT SMP KASAN\n  CPU: 1 PID: 8007 Comm: poc Not tainted 6.7.0-g9d1694dc91ce #20\n  Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.15.0-1 04/01/2014\n  RIP: 0010:fbcon_get_font+0x229/0x800 drivers/video/fbdev/core/fbcon.c:2286\n  Call Trace:\n   <TASK>\n   con_font_get drivers/tty/vt/vt.c:4558 [inline]\n   con_font_op+0x1fc/0xf20 drivers/tty/vt/vt.c:4673\n   vt_k_ioctl drivers/tty/vt/vt_ioctl.c:474 [inline]\n   vt_ioctl+0x632/0x2ec0 drivers/tty/vt/vt_ioctl.c:752\n   tty_ioctl+0x6f8/0x1570 drivers/tty/tty_io.c:2803\n   vfs_ioctl fs/ioctl.c:51 [inline]\n  ...\n\nSo restore the font data in any case, not only for user fonts. Note the\nlater 'if' is now protected by 'old_userfont' and not 'old_data' as the\nlatter is always set now. (And it is supposed to be non-NULL. Otherwise\nwe would see the bug above again.)\n\nSigned-off-by: Jiri Slaby (SUSE) <jirislaby@kernel.org>\nFixes: a5a923038d70 (\"fbdev: fbcon: Properly revert changes when vc_resize() failed\")\nReported-and-tested-by: Ubisectech Sirius <bugreport@ubisectech.com>\nCc: Ubisectech Sirius <bugreport@ubisectech.com>\nCc: Daniel Vetter <daniel@ffwll.ch>\nCc: Helge Deller <deller@gmx.de>\nCc: linux-fbdev@vger.kernel.org\nCc: dri-devel@lists.freedesktop.org\nSigned-off-by: Daniel Vetter <daniel.vetter@ffwll.ch>\nLink: https://patchwork.freedesktop.org/patch/msgid/20240208114411.14604-1-jirislaby@kernel.org",
  "full_message": "fbcon: always restore the old font data in fbcon_do_set_font()\n\nCommit a5a923038d70 (fbdev: fbcon: Properly revert changes when\nvc_resize() failed) started restoring old font data upon failure (of\nvc_resize()). But it performs so only for user fonts. It means that the\n\"system\"/internal fonts are not restored at all. So in result, the very\nfirst call to fbcon_do_set_font() performs no restore at all upon\nfailing vc_resize().\n\nThis can be reproduced by Syzkaller to crash the system on the next\ninvocation of font_get(). It's rather hard to hit the allocation failure\nin vc_resize() on the first font_set(), but not impossible. Esp. if\nfault injection is used to aid the execution/failure. It was\ndemonstrated by Sirius:\n  BUG: unable to handle page fault for address: fffffffffffffff8\n  #PF: supervisor read access in kernel mode\n  #PF: error_code(0x0000) - not-present page\n  PGD cb7b067 P4D cb7b067 PUD cb7d067 PMD 0\n  Oops: 0000 [#1] PREEMPT SMP KASAN\n  CPU: 1 PID: 8007 Comm: poc Not tainted 6.7.0-g9d1694dc91ce #20\n  Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.15.0-1 04/01/2014\n  RIP: 0010:fbcon_get_font+0x229/0x800 drivers/video/fbdev/core/fbcon.c:2286\n  Call Trace:\n   <TASK>\n   con_font_get drivers/tty/vt/vt.c:4558 [inline]\n   con_font_op+0x1fc/0xf20 drivers/tty/vt/vt.c:4673\n   vt_k_ioctl drivers/tty/vt/vt_ioctl.c:474 [inline]\n   vt_ioctl+0x632/0x2ec0 drivers/tty/vt/vt_ioctl.c:752\n   tty_ioctl+0x6f8/0x1570 drivers/tty/tty_io.c:2803\n   vfs_ioctl fs/ioctl.c:51 [inline]\n  ...\n\nSo restore the font data in any case, not only for user fonts. Note the\nlater 'if' is now protected by 'old_userfont' and not 'old_data' as the\nlatter is always set now. (And it is supposed to be non-NULL. Otherwise\nwe would see the bug above again.)\n\nSigned-off-by: Jiri Slaby (SUSE) <jirislaby@kernel.org>\nFixes: a5a923038d70 (\"fbdev: fbcon: Properly revert changes when vc_resize() failed\")\nReported-and-tested-by: Ubisectech Sirius <bugreport@ubisectech.com>\nCc: Ubisectech Sirius <bugreport@ubisectech.com>\nCc: Daniel Vetter <daniel@ffwll.ch>\nCc: Helge Deller <deller@gmx.de>\nCc: linux-fbdev@vger.kernel.org\nCc: dri-devel@lists.freedesktop.org\nSigned-off-by: Daniel Vetter <daniel.vetter@ffwll.ch>\nLink: https://patchwork.freedesktop.org/patch/msgid/20240208114411.14604-1-jirislaby@kernel.org",
  "author_name": "Jiri Slaby (SUSE)",
  "author_email": "jirislaby@kernel.org",
  "author_date": "Thu Feb 8 12:44:11 2024 +0100",
  "author_date_iso": "2024-02-08T12:44:11+01:00",
  "committer_name": "Daniel Vetter",
  "committer_email": "daniel.vetter@ffwll.ch",
  "committer_date": "Mon Feb 26 16:47:02 2024 +0100",
  "committer_date_iso": "2024-02-26T16:47:02+01:00",
  "files_changed": [
    "drivers/video/fbdev/core/fbcon.c"
  ],
  "files_changed_count": 1,
  "stats": [
    {
      "file": "drivers/video/fbdev/core/fbcon.c",
      "insertions": 3,
      "deletions": 5
    }
  ],
  "total_insertions": 3,
  "total_deletions": 5,
  "total_changes": 8,
  "parents": [
    "9d3f8a723c7950e56e0b95ab84b572caee29e065"
  ],
  "branches": [
    "* development",
    "remotes/origin/HEAD -> origin/master",
    "remotes/origin/master"
  ],
  "tags": [],
  "is_merge": false,
  "security_info": {
    "cve_ids": [],
    "security_keywords": [
      "injection"
    ]
  },
  "fix_type": "security",
  "file_results": [
    {
      "file": "drivers/video/fbdev/core/fbcon.c",
      "pre_version": false,
      "post_version": true,
      "patch": true
    }
  ]
}