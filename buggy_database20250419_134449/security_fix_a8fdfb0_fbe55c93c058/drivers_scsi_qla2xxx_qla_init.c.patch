commit a8fdfb0b39c2b31722c70bdf2272b949d5af4b7b
Author: Quinn Tran <qutran@marvell.com>
Date:   Wed Jun 8 04:58:45 2022 -0700

    scsi: qla2xxx: edif: Fix session thrash
    
    Current code prematurely sends out PRLI before authentication application
    has given the OK to do so. This causes PRLI failure and session teardown.
    
    Prevents PRLI from going out before authentication app gives the OK.
    
    Link: https://lore.kernel.org/r/20220608115849.16693-7-njavali@marvell.com
    Fixes: 91f6f5fbe87b ("scsi: qla2xxx: edif: Reduce connection thrash")
    Reviewed-by: Himanshu Madhani <himanshu.madhani@oracle.com>
    Signed-off-by: Quinn Tran <qutran@marvell.com>
    Signed-off-by: Nilesh Javali <njavali@marvell.com>
    Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>

diff --git a/drivers/scsi/qla2xxx/qla_init.c b/drivers/scsi/qla2xxx/qla_init.c
index d915c1f85fa2..6070834104f6 100644
--- a/drivers/scsi/qla2xxx/qla_init.c
+++ b/drivers/scsi/qla2xxx/qla_init.c
@@ -1762,8 +1762,16 @@ int qla24xx_fcport_handle_login(struct scsi_qla_host *vha, fc_port_t *fcport)
 		break;
 
 	case DSC_LOGIN_PEND:
-		if (fcport->fw_login_state == DSC_LS_PLOGI_COMP)
+		if (vha->hw->flags.edif_enabled)
+			break;
+
+		if (fcport->fw_login_state == DSC_LS_PLOGI_COMP) {
+			ql_dbg(ql_dbg_disc, vha, 0x2118,
+			       "%s %d %8phC post %s PRLI\n",
+			       __func__, __LINE__, fcport->port_name,
+			       NVME_TARGET(vha->hw, fcport) ? "NVME" : "FC");
 			qla24xx_post_prli_work(vha, fcport);
+		}
 		break;
 
 	case DSC_UPD_FCPORT: