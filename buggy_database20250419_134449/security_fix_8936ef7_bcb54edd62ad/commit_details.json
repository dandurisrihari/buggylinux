{
  "hash": "8936ef7604c11b5d701580d779e0f5684abc7b68",
  "hash_short": "8936ef76",
  "subject": "ipv6: sr: fix NULL pointer dereference when setting encap source address",
  "body": "When using seg6 in encap mode, we call ipv6_dev_get_saddr() to set the\nsource address of the outer IPv6 header, in case none was specified.\nUsing skb->dev can lead to BUG() when it is in an inconsistent state.\nThis patch uses the net_device attached to the skb's dst instead.\n\n[940807.667429] BUG: unable to handle kernel NULL pointer dereference at 000000000000047c\n[940807.762427] IP: ipv6_dev_get_saddr+0x8b/0x1d0\n[940807.815725] PGD 0 P4D 0\n[940807.847173] Oops: 0000 [#1] SMP PTI\n[940807.890073] Modules linked in:\n[940807.927765] CPU: 6 PID: 0 Comm: swapper/6 Tainted: G        W        4.16.0-rc1-seg6bpf+ #2\n[940808.028988] Hardware name: HP ProLiant DL120 G6/ProLiant DL120 G6, BIOS O26    09/06/2010\n[940808.128128] RIP: 0010:ipv6_dev_get_saddr+0x8b/0x1d0\n[940808.187667] RSP: 0018:ffff88043fd836b0 EFLAGS: 00010206\n[940808.251366] RAX: 0000000000000005 RBX: ffff88042cb1c860 RCX: 00000000000000fe\n[940808.338025] RDX: 00000000000002c0 RSI: ffff88042cb1c860 RDI: 0000000000004500\n[940808.424683] RBP: ffff88043fd83740 R08: 0000000000000000 R09: ffffffffffffffff\n[940808.511342] R10: 0000000000000040 R11: 0000000000000000 R12: ffff88042cb1c850\n[940808.598012] R13: ffffffff8208e380 R14: ffff88042ac8da00 R15: 0000000000000002\n[940808.684675] FS:  0000000000000000(0000) GS:ffff88043fd80000(0000) knlGS:0000000000000000\n[940808.783036] CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033\n[940808.852975] CR2: 000000000000047c CR3: 00000004255fe000 CR4: 00000000000006e0\n[940808.939634] Call Trace:\n[940808.970041]  <IRQ>\n[940808.995250]  ? ip6t_do_table+0x265/0x640\n[940809.043341]  seg6_do_srh_encap+0x28f/0x300\n[940809.093516]  ? seg6_do_srh+0x1a0/0x210\n[940809.139528]  seg6_do_srh+0x1a0/0x210\n[940809.183462]  seg6_output+0x28/0x1e0\n[940809.226358]  lwtunnel_output+0x3f/0x70\n[940809.272370]  ip6_xmit+0x2b8/0x530\n[940809.313185]  ? ac6_proc_exit+0x20/0x20\n[940809.359197]  inet6_csk_xmit+0x7d/0xc0\n[940809.404173]  tcp_transmit_skb+0x548/0x9a0\n[940809.453304]  __tcp_retransmit_skb+0x1a8/0x7a0\n[940809.506603]  ? ip6_default_advmss+0x40/0x40\n[940809.557824]  ? tcp_current_mss+0x24/0x90\n[940809.605925]  tcp_retransmit_skb+0xd/0x80\n[940809.654016]  tcp_xmit_retransmit_queue.part.17+0xf9/0x210\n[940809.719797]  tcp_ack+0xa47/0x1110\n[940809.760612]  tcp_rcv_established+0x13c/0x570\n[940809.812865]  tcp_v6_do_rcv+0x151/0x3d0\n[940809.858879]  tcp_v6_rcv+0xa5c/0xb10\n[940809.901770]  ? seg6_output+0xdd/0x1e0\n[940809.946745]  ip6_input_finish+0xbb/0x460\n[940809.994837]  ip6_input+0x74/0x80\n[940810.034612]  ? ip6_rcv_finish+0xb0/0xb0\n[940810.081663]  ipv6_rcv+0x31c/0x4c0\n...\n\nFixes: 6c8702c60b886 (\"ipv6: sr: add support for SRH encapsulation and injection with lwtunnels\")\nReported-by: Tom Herbert <tom@quantonium.net>\nSigned-off-by: David Lebrun <dlebrun@google.com>\nSigned-off-by: David S. Miller <davem@davemloft.net>",
  "full_message": "ipv6: sr: fix NULL pointer dereference when setting encap source address\n\nWhen using seg6 in encap mode, we call ipv6_dev_get_saddr() to set the\nsource address of the outer IPv6 header, in case none was specified.\nUsing skb->dev can lead to BUG() when it is in an inconsistent state.\nThis patch uses the net_device attached to the skb's dst instead.\n\n[940807.667429] BUG: unable to handle kernel NULL pointer dereference at 000000000000047c\n[940807.762427] IP: ipv6_dev_get_saddr+0x8b/0x1d0\n[940807.815725] PGD 0 P4D 0\n[940807.847173] Oops: 0000 [#1] SMP PTI\n[940807.890073] Modules linked in:\n[940807.927765] CPU: 6 PID: 0 Comm: swapper/6 Tainted: G        W        4.16.0-rc1-seg6bpf+ #2\n[940808.028988] Hardware name: HP ProLiant DL120 G6/ProLiant DL120 G6, BIOS O26    09/06/2010\n[940808.128128] RIP: 0010:ipv6_dev_get_saddr+0x8b/0x1d0\n[940808.187667] RSP: 0018:ffff88043fd836b0 EFLAGS: 00010206\n[940808.251366] RAX: 0000000000000005 RBX: ffff88042cb1c860 RCX: 00000000000000fe\n[940808.338025] RDX: 00000000000002c0 RSI: ffff88042cb1c860 RDI: 0000000000004500\n[940808.424683] RBP: ffff88043fd83740 R08: 0000000000000000 R09: ffffffffffffffff\n[940808.511342] R10: 0000000000000040 R11: 0000000000000000 R12: ffff88042cb1c850\n[940808.598012] R13: ffffffff8208e380 R14: ffff88042ac8da00 R15: 0000000000000002\n[940808.684675] FS:  0000000000000000(0000) GS:ffff88043fd80000(0000) knlGS:0000000000000000\n[940808.783036] CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033\n[940808.852975] CR2: 000000000000047c CR3: 00000004255fe000 CR4: 00000000000006e0\n[940808.939634] Call Trace:\n[940808.970041]  <IRQ>\n[940808.995250]  ? ip6t_do_table+0x265/0x640\n[940809.043341]  seg6_do_srh_encap+0x28f/0x300\n[940809.093516]  ? seg6_do_srh+0x1a0/0x210\n[940809.139528]  seg6_do_srh+0x1a0/0x210\n[940809.183462]  seg6_output+0x28/0x1e0\n[940809.226358]  lwtunnel_output+0x3f/0x70\n[940809.272370]  ip6_xmit+0x2b8/0x530\n[940809.313185]  ? ac6_proc_exit+0x20/0x20\n[940809.359197]  inet6_csk_xmit+0x7d/0xc0\n[940809.404173]  tcp_transmit_skb+0x548/0x9a0\n[940809.453304]  __tcp_retransmit_skb+0x1a8/0x7a0\n[940809.506603]  ? ip6_default_advmss+0x40/0x40\n[940809.557824]  ? tcp_current_mss+0x24/0x90\n[940809.605925]  tcp_retransmit_skb+0xd/0x80\n[940809.654016]  tcp_xmit_retransmit_queue.part.17+0xf9/0x210\n[940809.719797]  tcp_ack+0xa47/0x1110\n[940809.760612]  tcp_rcv_established+0x13c/0x570\n[940809.812865]  tcp_v6_do_rcv+0x151/0x3d0\n[940809.858879]  tcp_v6_rcv+0xa5c/0xb10\n[940809.901770]  ? seg6_output+0xdd/0x1e0\n[940809.946745]  ip6_input_finish+0xbb/0x460\n[940809.994837]  ip6_input+0x74/0x80\n[940810.034612]  ? ip6_rcv_finish+0xb0/0xb0\n[940810.081663]  ipv6_rcv+0x31c/0x4c0\n...\n\nFixes: 6c8702c60b886 (\"ipv6: sr: add support for SRH encapsulation and injection with lwtunnels\")\nReported-by: Tom Herbert <tom@quantonium.net>\nSigned-off-by: David Lebrun <dlebrun@google.com>\nSigned-off-by: David S. Miller <davem@davemloft.net>",
  "author_name": "David Lebrun",
  "author_email": "dlebrun@google.com",
  "author_date": "Tue Mar 20 14:44:56 2018 +0000",
  "author_date_iso": "2018-03-20T14:44:56+00:00",
  "committer_name": "David S. Miller",
  "committer_email": "davem@davemloft.net",
  "committer_date": "Thu Mar 22 12:22:45 2018 -0400",
  "committer_date_iso": "2018-03-22T12:22:45-04:00",
  "files_changed": [
    "net/ipv6/seg6_iptunnel.c"
  ],
  "files_changed_count": 1,
  "stats": [
    {
      "file": "net/ipv6/seg6_iptunnel.c",
      "insertions": 3,
      "deletions": 2
    }
  ],
  "total_insertions": 3,
  "total_deletions": 2,
  "total_changes": 5,
  "parents": [
    "191f86ca8ef27f7a492fd1c03620498c6e94f0ac"
  ],
  "branches": [
    "* development",
    "master",
    "remotes/origin/HEAD -> origin/master",
    "remotes/origin/master"
  ],
  "tags": [
    "v4.16",
    "v4.16-rc7",
    "v4.17",
    "v4.17-rc1",
    "v4.17-rc2",
    "v4.17-rc3",
    "v4.17-rc4",
    "v4.17-rc5",
    "v4.17-rc6",
    "v4.17-rc7"
  ],
  "is_merge": false,
  "security_info": {
    "cve_ids": [],
    "security_keywords": [
      "injection"
    ]
  },
  "fix_type": "security",
  "file_results": [
    {
      "file": "net/ipv6/seg6_iptunnel.c",
      "pre_version": true,
      "post_version": true,
      "patch": true
    }
  ]
}