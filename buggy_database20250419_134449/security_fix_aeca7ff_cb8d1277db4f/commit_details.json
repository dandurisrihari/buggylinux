{
  "hash": "aeca7ff254843d49a8739f07f7dab1341450111d",
  "hash_short": "aeca7ff2",
  "subject": "vdpa_sim: fix possible memory leak in vdpasim_net_init() and vdpasim_blk_init()",
  "body": "Inject fault while probing module, if device_register() fails in\nvdpasim_net_init() or vdpasim_blk_init(), but the refcount of kobject is\nnot decreased to 0, the name allocated in dev_set_name() is leaked.\nFix this by calling put_device(), so that name can be freed in\ncallback function kobject_cleanup().\n\n(vdpa_sim_net)\nunreferenced object 0xffff88807eebc370 (size 16):\n  comm \"modprobe\", pid 3848, jiffies 4362982860 (age 18.153s)\n  hex dump (first 16 bytes):\n    76 64 70 61 73 69 6d 5f 6e 65 74 00 6b 6b 6b a5  vdpasim_net.kkk.\n  backtrace:\n    [<ffffffff8174f19e>] __kmalloc_node_track_caller+0x4e/0x150\n    [<ffffffff81731d53>] kstrdup+0x33/0x60\n    [<ffffffff83a5d421>] kobject_set_name_vargs+0x41/0x110\n    [<ffffffff82d87aab>] dev_set_name+0xab/0xe0\n    [<ffffffff82d91a23>] device_add+0xe3/0x1a80\n    [<ffffffffa0270013>] 0xffffffffa0270013\n    [<ffffffff81001c27>] do_one_initcall+0x87/0x2e0\n    [<ffffffff813739cb>] do_init_module+0x1ab/0x640\n    [<ffffffff81379d20>] load_module+0x5d00/0x77f0\n    [<ffffffff8137bc40>] __do_sys_finit_module+0x110/0x1b0\n    [<ffffffff83c4d505>] do_syscall_64+0x35/0x80\n    [<ffffffff83e0006a>] entry_SYSCALL_64_after_hwframe+0x46/0xb0\n\n(vdpa_sim_blk)\nunreferenced object 0xffff8881070c1250 (size 16):\n  comm \"modprobe\", pid 6844, jiffies 4364069319 (age 17.572s)\n  hex dump (first 16 bytes):\n    76 64 70 61 73 69 6d 5f 62 6c 6b 00 6b 6b 6b a5  vdpasim_blk.kkk.\n  backtrace:\n    [<ffffffff8174f19e>] __kmalloc_node_track_caller+0x4e/0x150\n    [<ffffffff81731d53>] kstrdup+0x33/0x60\n    [<ffffffff83a5d421>] kobject_set_name_vargs+0x41/0x110\n    [<ffffffff82d87aab>] dev_set_name+0xab/0xe0\n    [<ffffffff82d91a23>] device_add+0xe3/0x1a80\n    [<ffffffffa0220013>] 0xffffffffa0220013\n    [<ffffffff81001c27>] do_one_initcall+0x87/0x2e0\n    [<ffffffff813739cb>] do_init_module+0x1ab/0x640\n    [<ffffffff81379d20>] load_module+0x5d00/0x77f0\n    [<ffffffff8137bc40>] __do_sys_finit_module+0x110/0x1b0\n    [<ffffffff83c4d505>] do_syscall_64+0x35/0x80\n    [<ffffffff83e0006a>] entry_SYSCALL_64_after_hwframe+0x46/0xb0\n\nFixes: 899c4d187f6a (\"vdpa_sim_blk: add support for vdpa management tool\")\nFixes: a3c06ae158dd (\"vdpa_sim_net: Add support for user supported devices\")\n\nSigned-off-by: ruanjinjie <ruanjinjie@huawei.com>\nReviewed-by: Stefano Garzarella <sgarzare@redhat.com>\nMessage-Id: <20221110082348.4105476-1-ruanjinjie@huawei.com>\nSigned-off-by: Michael S. Tsirkin <mst@redhat.com>\nAcked-by: Jason Wang <jasowang@redhat.com>",
  "full_message": "vdpa_sim: fix possible memory leak in vdpasim_net_init() and vdpasim_blk_init()\n\nInject fault while probing module, if device_register() fails in\nvdpasim_net_init() or vdpasim_blk_init(), but the refcount of kobject is\nnot decreased to 0, the name allocated in dev_set_name() is leaked.\nFix this by calling put_device(), so that name can be freed in\ncallback function kobject_cleanup().\n\n(vdpa_sim_net)\nunreferenced object 0xffff88807eebc370 (size 16):\n  comm \"modprobe\", pid 3848, jiffies 4362982860 (age 18.153s)\n  hex dump (first 16 bytes):\n    76 64 70 61 73 69 6d 5f 6e 65 74 00 6b 6b 6b a5  vdpasim_net.kkk.\n  backtrace:\n    [<ffffffff8174f19e>] __kmalloc_node_track_caller+0x4e/0x150\n    [<ffffffff81731d53>] kstrdup+0x33/0x60\n    [<ffffffff83a5d421>] kobject_set_name_vargs+0x41/0x110\n    [<ffffffff82d87aab>] dev_set_name+0xab/0xe0\n    [<ffffffff82d91a23>] device_add+0xe3/0x1a80\n    [<ffffffffa0270013>] 0xffffffffa0270013\n    [<ffffffff81001c27>] do_one_initcall+0x87/0x2e0\n    [<ffffffff813739cb>] do_init_module+0x1ab/0x640\n    [<ffffffff81379d20>] load_module+0x5d00/0x77f0\n    [<ffffffff8137bc40>] __do_sys_finit_module+0x110/0x1b0\n    [<ffffffff83c4d505>] do_syscall_64+0x35/0x80\n    [<ffffffff83e0006a>] entry_SYSCALL_64_after_hwframe+0x46/0xb0\n\n(vdpa_sim_blk)\nunreferenced object 0xffff8881070c1250 (size 16):\n  comm \"modprobe\", pid 6844, jiffies 4364069319 (age 17.572s)\n  hex dump (first 16 bytes):\n    76 64 70 61 73 69 6d 5f 62 6c 6b 00 6b 6b 6b a5  vdpasim_blk.kkk.\n  backtrace:\n    [<ffffffff8174f19e>] __kmalloc_node_track_caller+0x4e/0x150\n    [<ffffffff81731d53>] kstrdup+0x33/0x60\n    [<ffffffff83a5d421>] kobject_set_name_vargs+0x41/0x110\n    [<ffffffff82d87aab>] dev_set_name+0xab/0xe0\n    [<ffffffff82d91a23>] device_add+0xe3/0x1a80\n    [<ffffffffa0220013>] 0xffffffffa0220013\n    [<ffffffff81001c27>] do_one_initcall+0x87/0x2e0\n    [<ffffffff813739cb>] do_init_module+0x1ab/0x640\n    [<ffffffff81379d20>] load_module+0x5d00/0x77f0\n    [<ffffffff8137bc40>] __do_sys_finit_module+0x110/0x1b0\n    [<ffffffff83c4d505>] do_syscall_64+0x35/0x80\n    [<ffffffff83e0006a>] entry_SYSCALL_64_after_hwframe+0x46/0xb0\n\nFixes: 899c4d187f6a (\"vdpa_sim_blk: add support for vdpa management tool\")\nFixes: a3c06ae158dd (\"vdpa_sim_net: Add support for user supported devices\")\n\nSigned-off-by: ruanjinjie <ruanjinjie@huawei.com>\nReviewed-by: Stefano Garzarella <sgarzare@redhat.com>\nMessage-Id: <20221110082348.4105476-1-ruanjinjie@huawei.com>\nSigned-off-by: Michael S. Tsirkin <mst@redhat.com>\nAcked-by: Jason Wang <jasowang@redhat.com>",
  "author_name": "ruanjinjie",
  "author_email": "ruanjinjie@huawei.com",
  "author_date": "Thu Nov 10 16:23:48 2022 +0800",
  "author_date_iso": "2022-11-10T16:23:48+08:00",
  "committer_name": "Michael S. Tsirkin",
  "committer_email": "mst@redhat.com",
  "committer_date": "Wed Dec 28 05:28:10 2022 -0500",
  "committer_date_iso": "2022-12-28T05:28:10-05:00",
  "files_changed": [
    "drivers/vdpa/vdpa_sim/vdpa_sim_blk.c",
    "drivers/vdpa/vdpa_sim/vdpa_sim_net.c"
  ],
  "files_changed_count": 2,
  "stats": [
    {
      "file": "drivers/vdpa/vdpa_sim/vdpa_sim_blk.c",
      "insertions": 3,
      "deletions": 1
    },
    {
      "file": "drivers/vdpa/vdpa_sim/vdpa_sim_net.c",
      "insertions": 3,
      "deletions": 1
    }
  ],
  "total_insertions": 6,
  "total_deletions": 2,
  "total_changes": 8,
  "parents": [
    "75e4ab9735a5a70612dd06461ca372b897bf371c"
  ],
  "branches": [
    "* development",
    "remotes/origin/HEAD -> origin/master",
    "remotes/origin/master"
  ],
  "tags": [],
  "is_merge": false,
  "security_info": {
    "cve_ids": [],
    "security_keywords": [
      "Inject"
    ]
  },
  "fix_type": "security",
  "file_results": [
    {
      "file": "drivers/vdpa/vdpa_sim/vdpa_sim_blk.c",
      "pre_version": false,
      "post_version": true,
      "patch": true
    },
    {
      "file": "drivers/vdpa/vdpa_sim/vdpa_sim_net.c",
      "pre_version": false,
      "post_version": true,
      "patch": true
    }
  ]
}