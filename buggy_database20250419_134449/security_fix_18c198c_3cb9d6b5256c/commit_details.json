{
  "hash": "18c198c96a815c962adc2b9b77909eec0be7df4d",
  "hash_short": "18c198c9",
  "subject": "vfio/pci: Create persistent INTx handler",
  "body": "A vulnerability exists where the eventfd for INTx signaling can be\ndeconfigured, which unregisters the IRQ handler but still allows\neventfds to be signaled with a NULL context through the SET_IRQS ioctl\nor through unmask irqfd if the device interrupt is pending.\n\nIdeally this could be solved with some additional locking; the igate\nmutex serializes the ioctl and config space accesses, and the interrupt\nhandler is unregistered relative to the trigger, but the irqfd path\nruns asynchronous to those.  The igate mutex cannot be acquired from the\natomic context of the eventfd wake function.  Disabling the irqfd\nrelative to the eventfd registration is potentially incompatible with\nexisting userspace.\n\nAs a result, the solution implemented here moves configuration of the\nINTx interrupt handler to track the lifetime of the INTx context object\nand irq_type configuration, rather than registration of a particular\ntrigger eventfd.  Synchronization is added between the ioctl path and\neventfd_signal() wrapper such that the eventfd trigger can be\ndynamically updated relative to in-flight interrupts or irqfd callbacks.\n\nCc:  <stable@vger.kernel.org>\nFixes: 89e1f7d4c66d (\"vfio: Add PCI device driver\")\nReported-by: Reinette Chatre <reinette.chatre@intel.com>\nReviewed-by: Kevin Tian <kevin.tian@intel.com>\nReviewed-by: Reinette Chatre <reinette.chatre@intel.com>\nReviewed-by: Eric Auger <eric.auger@redhat.com>\nLink: https://lore.kernel.org/r/20240308230557.805580-5-alex.williamson@redhat.com\nSigned-off-by: Alex Williamson <alex.williamson@redhat.com>",
  "full_message": "vfio/pci: Create persistent INTx handler\n\nA vulnerability exists where the eventfd for INTx signaling can be\ndeconfigured, which unregisters the IRQ handler but still allows\neventfds to be signaled with a NULL context through the SET_IRQS ioctl\nor through unmask irqfd if the device interrupt is pending.\n\nIdeally this could be solved with some additional locking; the igate\nmutex serializes the ioctl and config space accesses, and the interrupt\nhandler is unregistered relative to the trigger, but the irqfd path\nruns asynchronous to those.  The igate mutex cannot be acquired from the\natomic context of the eventfd wake function.  Disabling the irqfd\nrelative to the eventfd registration is potentially incompatible with\nexisting userspace.\n\nAs a result, the solution implemented here moves configuration of the\nINTx interrupt handler to track the lifetime of the INTx context object\nand irq_type configuration, rather than registration of a particular\ntrigger eventfd.  Synchronization is added between the ioctl path and\neventfd_signal() wrapper such that the eventfd trigger can be\ndynamically updated relative to in-flight interrupts or irqfd callbacks.\n\nCc:  <stable@vger.kernel.org>\nFixes: 89e1f7d4c66d (\"vfio: Add PCI device driver\")\nReported-by: Reinette Chatre <reinette.chatre@intel.com>\nReviewed-by: Kevin Tian <kevin.tian@intel.com>\nReviewed-by: Reinette Chatre <reinette.chatre@intel.com>\nReviewed-by: Eric Auger <eric.auger@redhat.com>\nLink: https://lore.kernel.org/r/20240308230557.805580-5-alex.williamson@redhat.com\nSigned-off-by: Alex Williamson <alex.williamson@redhat.com>",
  "author_name": "Alex Williamson",
  "author_email": "alex.williamson@redhat.com",
  "author_date": "Fri Mar 8 16:05:25 2024 -0700",
  "author_date_iso": "2024-03-08T16:05:25-07:00",
  "committer_name": "Alex Williamson",
  "committer_email": "alex.williamson@redhat.com",
  "committer_date": "Mon Mar 11 13:08:52 2024 -0600",
  "committer_date_iso": "2024-03-11T13:08:52-06:00",
  "files_changed": [
    "drivers/vfio/pci/vfio_pci_intrs.c"
  ],
  "files_changed_count": 1,
  "stats": [
    {
      "file": "drivers/vfio/pci/vfio_pci_intrs.c",
      "insertions": 78,
      "deletions": 67
    }
  ],
  "total_insertions": 78,
  "total_deletions": 67,
  "total_changes": 145,
  "parents": [
    "b620ecbd17a03cacd06f014a5d3f3a11285ce053"
  ],
  "branches": [
    "* development",
    "remotes/origin/HEAD -> origin/master",
    "remotes/origin/master"
  ],
  "tags": [],
  "is_merge": false,
  "security_info": {
    "cve_ids": [],
    "security_keywords": [
      "vulnerability"
    ]
  },
  "fix_type": "security",
  "file_results": [
    {
      "file": "drivers/vfio/pci/vfio_pci_intrs.c",
      "pre_version": false,
      "post_version": true,
      "patch": true
    }
  ]
}