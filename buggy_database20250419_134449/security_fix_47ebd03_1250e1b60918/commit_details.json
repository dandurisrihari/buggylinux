{
  "hash": "47ebd0310e89c087f56e58c103c44b72a2f6b216",
  "hash_short": "47ebd031",
  "subject": "mm: kmsan: handle alloc failures in kmsan_vmap_pages_range_noflush()",
  "body": "As reported by Dipanjan Das, when KMSAN is used together with kernel fault\ninjection (or, generally, even without the latter), calls to kcalloc() or\n__vmap_pages_range_noflush() may fail, leaving the metadata mappings for\nthe virtual mapping in an inconsistent state.  When these metadata\nmappings are accessed later, the kernel crashes.\n\nTo address the problem, we return a non-zero error code from\nkmsan_vmap_pages_range_noflush() in the case of any allocation/mapping\nfailure inside it, and make vmap_pages_range_noflush() return an error if\nKMSAN fails to allocate the metadata.\n\nThis patch also removes KMSAN_WARN_ON() from vmap_pages_range_noflush(),\nas these allocation failures are not fatal anymore.\n\nLink: https://lkml.kernel.org/r/20230413131223.4135168-1-glider@google.com\nFixes: b073d7f8aee4 (\"mm: kmsan: maintain KMSAN metadata for page operations\")\nSigned-off-by: Alexander Potapenko <glider@google.com>\nReported-by: Dipanjan Das <mail.dipanjan.das@gmail.com>\n  Link: https://lore.kernel.org/linux-mm/CANX2M5ZRrRA64k0hOif02TjmY9kbbO2aCBPyq79es34RXZ=cAw@mail.gmail.com/\nReviewed-by: Marco Elver <elver@google.com>\nCc: Christoph Hellwig <hch@infradead.org>\nCc: Dmitry Vyukov <dvyukov@google.com>\nCc: Uladzislau Rezki (Sony) <urezki@gmail.com>\nCc: <stable@vger.kernel.org>\nSigned-off-by: Andrew Morton <akpm@linux-foundation.org>",
  "full_message": "mm: kmsan: handle alloc failures in kmsan_vmap_pages_range_noflush()\n\nAs reported by Dipanjan Das, when KMSAN is used together with kernel fault\ninjection (or, generally, even without the latter), calls to kcalloc() or\n__vmap_pages_range_noflush() may fail, leaving the metadata mappings for\nthe virtual mapping in an inconsistent state.  When these metadata\nmappings are accessed later, the kernel crashes.\n\nTo address the problem, we return a non-zero error code from\nkmsan_vmap_pages_range_noflush() in the case of any allocation/mapping\nfailure inside it, and make vmap_pages_range_noflush() return an error if\nKMSAN fails to allocate the metadata.\n\nThis patch also removes KMSAN_WARN_ON() from vmap_pages_range_noflush(),\nas these allocation failures are not fatal anymore.\n\nLink: https://lkml.kernel.org/r/20230413131223.4135168-1-glider@google.com\nFixes: b073d7f8aee4 (\"mm: kmsan: maintain KMSAN metadata for page operations\")\nSigned-off-by: Alexander Potapenko <glider@google.com>\nReported-by: Dipanjan Das <mail.dipanjan.das@gmail.com>\n  Link: https://lore.kernel.org/linux-mm/CANX2M5ZRrRA64k0hOif02TjmY9kbbO2aCBPyq79es34RXZ=cAw@mail.gmail.com/\nReviewed-by: Marco Elver <elver@google.com>\nCc: Christoph Hellwig <hch@infradead.org>\nCc: Dmitry Vyukov <dvyukov@google.com>\nCc: Uladzislau Rezki (Sony) <urezki@gmail.com>\nCc: <stable@vger.kernel.org>\nSigned-off-by: Andrew Morton <akpm@linux-foundation.org>",
  "author_name": "Alexander Potapenko",
  "author_email": "glider@google.com",
  "author_date": "Thu Apr 13 15:12:20 2023 +0200",
  "author_date_iso": "2023-04-13T15:12:20+02:00",
  "committer_name": "Andrew Morton",
  "committer_email": "akpm@linux-foundation.org",
  "committer_date": "Tue Apr 18 14:22:13 2023 -0700",
  "committer_date_iso": "2023-04-18T14:22:13-07:00",
  "files_changed": [
    "include/linux/kmsan.h",
    "mm/kmsan/shadow.c",
    "mm/vmalloc.c"
  ],
  "files_changed_count": 3,
  "stats": [
    {
      "file": "include/linux/kmsan.h",
      "insertions": 11,
      "deletions": 9
    },
    {
      "file": "mm/kmsan/shadow.c",
      "insertions": 18,
      "deletions": 9
    },
    {
      "file": "mm/vmalloc.c",
      "insertions": 5,
      "deletions": 1
    }
  ],
  "total_insertions": 34,
  "total_deletions": 19,
  "total_changes": 53,
  "parents": [
    "a101482421a318369eef2d0e03f2fcb40a47abad"
  ],
  "branches": [
    "* development",
    "remotes/origin/HEAD -> origin/master",
    "remotes/origin/master"
  ],
  "tags": [],
  "is_merge": false,
  "security_info": {
    "cve_ids": [],
    "security_keywords": [
      "injection"
    ]
  },
  "fix_type": "security",
  "file_results": [
    {
      "file": "include/linux/kmsan.h",
      "pre_version": false,
      "post_version": true,
      "patch": true
    },
    {
      "file": "mm/kmsan/shadow.c",
      "pre_version": false,
      "post_version": true,
      "patch": true
    },
    {
      "file": "mm/vmalloc.c",
      "pre_version": false,
      "post_version": true,
      "patch": true
    }
  ]
}