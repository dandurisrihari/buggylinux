Commit Hash: 0ad6bded175e829c2ca261529c9dce39a32a042d
Subject: nfc/nci: fix race with opening and closing


Security Keywords:
- bypass

Full commit message:
nfc/nci: fix race with opening and closing

Previously we leverage NCI_UNREG and the lock inside nci_close_device to
prevent the race condition between opening a device and closing a
device. However, it still has problem because a failed opening command
will erase the NCI_UNREG flag and allow another opening command to
bypass the status checking.

This fix corrects that by making sure the NCI_UNREG is held.

Reported-by: syzbot+43475bf3cfbd6e41f5b7@syzkaller.appspotmail.com
Fixes: 48b71a9e66c2 ("NFC: add NCI_UNREG flag to eliminate the race")
Signed-off-by: Lin Ma <linma@zju.edu.cn>
Signed-off-by: David S. Miller <davem@davemloft.net>

Metadata:
Author: Lin Ma <linma@zju.edu.cn>
Author Date: Wed Nov 16 21:02:49 2022 +0800
Committer: David S. Miller <davem@davemloft.net>
Commit Date: Fri Nov 18 12:37:11 2022 +0000

Files Changed: 1
Lines Added: 1
Lines Removed: 1
Total Changes: 2
