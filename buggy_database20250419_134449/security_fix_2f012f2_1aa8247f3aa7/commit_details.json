{
  "hash": "2f012f2baca140c488e43d27a374029c1e59098d",
  "hash_short": "2f012f2b",
  "subject": "nilfs2: fix incomplete buffer cleanup in nilfs_btnode_abort_change_key()",
  "body": "A syzbot fault injection test reported that nilfs_btnode_create_block, a\nhelper function that allocates a new node block for b-trees, causes a\nkernel BUG for disk images where the file system block size is smaller\nthan the page size.\n\nThis was due to unexpected flags on the newly allocated buffer head, and\nit turned out to be because the buffer flags were not cleared by\nnilfs_btnode_abort_change_key() after an error occurred during a b-tree\nupdate operation and the buffer was later reused in that state.\n\nFix this issue by using nilfs_btnode_delete() to abandon the unused\npreallocated buffer in nilfs_btnode_abort_change_key().\n\nLink: https://lkml.kernel.org/r/20230513102428.10223-1-konishi.ryusuke@gmail.com\nSigned-off-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>\nReported-by: syzbot+b0a35a5c1f7e846d3b09@syzkaller.appspotmail.com\nCloses: https://lkml.kernel.org/r/000000000000d1d6c205ebc4d512@google.com\nTested-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>\nCc: <stable@vger.kernel.org>\nSigned-off-by: Andrew Morton <akpm@linux-foundation.org>",
  "full_message": "nilfs2: fix incomplete buffer cleanup in nilfs_btnode_abort_change_key()\n\nA syzbot fault injection test reported that nilfs_btnode_create_block, a\nhelper function that allocates a new node block for b-trees, causes a\nkernel BUG for disk images where the file system block size is smaller\nthan the page size.\n\nThis was due to unexpected flags on the newly allocated buffer head, and\nit turned out to be because the buffer flags were not cleared by\nnilfs_btnode_abort_change_key() after an error occurred during a b-tree\nupdate operation and the buffer was later reused in that state.\n\nFix this issue by using nilfs_btnode_delete() to abandon the unused\npreallocated buffer in nilfs_btnode_abort_change_key().\n\nLink: https://lkml.kernel.org/r/20230513102428.10223-1-konishi.ryusuke@gmail.com\nSigned-off-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>\nReported-by: syzbot+b0a35a5c1f7e846d3b09@syzkaller.appspotmail.com\nCloses: https://lkml.kernel.org/r/000000000000d1d6c205ebc4d512@google.com\nTested-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>\nCc: <stable@vger.kernel.org>\nSigned-off-by: Andrew Morton <akpm@linux-foundation.org>",
  "author_name": "Ryusuke Konishi",
  "author_email": "konishi.ryusuke@gmail.com",
  "author_date": "Sat May 13 19:24:28 2023 +0900",
  "author_date_iso": "2023-05-13T19:24:28+09:00",
  "committer_name": "Andrew Morton",
  "committer_email": "akpm@linux-foundation.org",
  "committer_date": "Mon Jun 12 11:31:49 2023 -0700",
  "committer_date_iso": "2023-06-12T11:31:49-07:00",
  "files_changed": [
    "fs/nilfs2/btnode.c"
  ],
  "files_changed_count": 1,
  "stats": [
    {
      "file": "fs/nilfs2/btnode.c",
      "insertions": 10,
      "deletions": 2
    }
  ],
  "total_insertions": 10,
  "total_deletions": 2,
  "total_changes": 12,
  "parents": [
    "8b817fded42d8fe3a0eb47b1149d907851a3c942"
  ],
  "branches": [
    "* development",
    "remotes/origin/HEAD -> origin/master",
    "remotes/origin/master"
  ],
  "tags": [],
  "is_merge": false,
  "security_info": {
    "cve_ids": [],
    "security_keywords": [
      "injection"
    ]
  },
  "fix_type": "security",
  "file_results": [
    {
      "file": "fs/nilfs2/btnode.c",
      "pre_version": false,
      "post_version": true,
      "patch": true
    }
  ]
}