{
  "hash": "553a8f2f42dffc5414a82fffe55d9b8c0fbd383f",
  "hash_short": "553a8f2f",
  "subject": "Merge branch 'bpf-override-return'",
  "body": "Josef Bacik says:\n\n====================\nThis is the same as v8, just rebased onto the bpf tree.\n\nv8->v9:\n- rebased onto the bpf tree.\n\nv7->v8:\n- removed the _ASM_KPROBE_ERROR_INJECT since it was not needed.\n\nv6->v7:\n- moved the opt-in macro to bpf.h out of kprobes.h.\n\nv5->v6:\n- add BPF_ALLOW_ERROR_INJECTION() tagging for functions that will support this\n  feature.  This way only functions that opt-in will be allowed to be\n  overridden.\n- added a btrfs patch to allow error injection for open_ctree() so that the bpf\n  sample actually works.\n\nv4->v5:\n- disallow kprobe_override programs from being put in the prog map array so we\n  don't tail call into something we didn't check.  This allows us to make the\n  normal path still fast without a bunch of percpu operations.\n\nv3->v4:\n- fix a build error found by kbuild test bot (I didn't wait long enough\n  apparently.)\n- Added a warning message as per Daniels suggestion.\n\nv2->v3:\n- added a ->kprobe_override flag to bpf_prog.\n- added some sanity checks to disallow attaching bpf progs that have\n  ->kprobe_override set that aren't for ftrace kprobes.\n- added the trace_kprobe_ftrace helper to check if the trace_event_call is a\n  ftrace kprobe.\n- renamed bpf_kprobe_state to bpf_kprobe_override, fixed it so we only read this\n  value in the kprobe path, and thus only write to it if we're overriding or\n  clearing the override.\n\nv1->v2:\n- moved things around to make sure that bpf_override_return could really only be\n  used for an ftrace kprobe.\n- killed the special return values from trace_call_bpf.\n- renamed pc_modified to bpf_kprobe_state so bpf_override_return could tell if\n  it was being called from an ftrace kprobe context.\n- reworked the logic in kprobe_perf_func to take advantage of bpf_kprobe_state.\n- updated the test as per Alexei's review.\n\n- Original message -\n\nA lot of our error paths are not well tested because we have no good way of\ninjecting errors generically.  Some subystems (block, memory) have ways to\ninject errors, but they are random so it's hard to get reproduceable results.\n\nWith BPF we can add determinism to our error injection.  We can use kprobes and\nother things to verify we are injecting errors at the exact case we are trying\nto test.  This patch gives us the tool to actual do the error injection part.\nIt is very simple, we just set the return value of the pt_regs we're given to\nwhatever we provide, and then override the PC with a dummy function that simply\nreturns.\n\nRight now this only works on x86, but it would be simple enough to expand to\nother architectures.  Thanks,\n\nJosef\n====================\n\nIn patch \"bpf: add a bpf_override_function helper\" Alexei moved\n\"ifdef CONFIG_BPF_KPROBE_OVERRIDE\" few lines to fail program loading\nwhen kprobe_override is not available instead of failing at run-time.\n\nSigned-off-by: Alexei Starovoitov <ast@kernel.org>",
  "full_message": "Merge branch 'bpf-override-return'\n\nJosef Bacik says:\n\n====================\nThis is the same as v8, just rebased onto the bpf tree.\n\nv8->v9:\n- rebased onto the bpf tree.\n\nv7->v8:\n- removed the _ASM_KPROBE_ERROR_INJECT since it was not needed.\n\nv6->v7:\n- moved the opt-in macro to bpf.h out of kprobes.h.\n\nv5->v6:\n- add BPF_ALLOW_ERROR_INJECTION() tagging for functions that will support this\n  feature.  This way only functions that opt-in will be allowed to be\n  overridden.\n- added a btrfs patch to allow error injection for open_ctree() so that the bpf\n  sample actually works.\n\nv4->v5:\n- disallow kprobe_override programs from being put in the prog map array so we\n  don't tail call into something we didn't check.  This allows us to make the\n  normal path still fast without a bunch of percpu operations.\n\nv3->v4:\n- fix a build error found by kbuild test bot (I didn't wait long enough\n  apparently.)\n- Added a warning message as per Daniels suggestion.\n\nv2->v3:\n- added a ->kprobe_override flag to bpf_prog.\n- added some sanity checks to disallow attaching bpf progs that have\n  ->kprobe_override set that aren't for ftrace kprobes.\n- added the trace_kprobe_ftrace helper to check if the trace_event_call is a\n  ftrace kprobe.\n- renamed bpf_kprobe_state to bpf_kprobe_override, fixed it so we only read this\n  value in the kprobe path, and thus only write to it if we're overriding or\n  clearing the override.\n\nv1->v2:\n- moved things around to make sure that bpf_override_return could really only be\n  used for an ftrace kprobe.\n- killed the special return values from trace_call_bpf.\n- renamed pc_modified to bpf_kprobe_state so bpf_override_return could tell if\n  it was being called from an ftrace kprobe context.\n- reworked the logic in kprobe_perf_func to take advantage of bpf_kprobe_state.\n- updated the test as per Alexei's review.\n\n- Original message -\n\nA lot of our error paths are not well tested because we have no good way of\ninjecting errors generically.  Some subystems (block, memory) have ways to\ninject errors, but they are random so it's hard to get reproduceable results.\n\nWith BPF we can add determinism to our error injection.  We can use kprobes and\nother things to verify we are injecting errors at the exact case we are trying\nto test.  This patch gives us the tool to actual do the error injection part.\nIt is very simple, we just set the return value of the pt_regs we're given to\nwhatever we provide, and then override the PC with a dummy function that simply\nreturns.\n\nRight now this only works on x86, but it would be simple enough to expand to\nother architectures.  Thanks,\n\nJosef\n====================\n\nIn patch \"bpf: add a bpf_override_function helper\" Alexei moved\n\"ifdef CONFIG_BPF_KPROBE_OVERRIDE\" few lines to fail program loading\nwhen kprobe_override is not available instead of failing at run-time.\n\nSigned-off-by: Alexei Starovoitov <ast@kernel.org>",
  "author_name": "Alexei Starovoitov",
  "author_email": "ast@kernel.org",
  "author_date": "Tue Dec 12 09:16:22 2017 -0800",
  "author_date_iso": "2017-12-12T09:16:22-08:00",
  "committer_name": "Alexei Starovoitov",
  "committer_email": "ast@kernel.org",
  "committer_date": "Tue Dec 12 09:16:56 2017 -0800",
  "committer_date_iso": "2017-12-12T09:16:56-08:00",
  "files_changed": [],
  "files_changed_count": 0,
  "stats": [
    {
      "file": "arch/Kconfig",
      "insertions": 3,
      "deletions": 0
    },
    {
      "file": "arch/x86/Kconfig",
      "insertions": 1,
      "deletions": 0
    },
    {
      "file": "arch/x86/include/asm/kprobes.h",
      "insertions": 4,
      "deletions": 0
    },
    {
      "file": "arch/x86/include/asm/ptrace.h",
      "insertions": 5,
      "deletions": 0
    },
    {
      "file": "arch/x86/kernel/kprobes/ftrace.c",
      "insertions": 14,
      "deletions": 0
    },
    {
      "file": "fs/btrfs/disk-io.c",
      "insertions": 2,
      "deletions": 0
    },
    {
      "file": "fs/btrfs/free-space-cache.c",
      "insertions": 2,
      "deletions": 0
    },
    {
      "file": "include/asm-generic/vmlinux.lds.h",
      "insertions": 10,
      "deletions": 0
    },
    {
      "file": "include/linux/bpf.h",
      "insertions": 11,
      "deletions": 0
    },
    {
      "file": "include/linux/filter.h",
      "insertions": 2,
      "deletions": 1
    },
    {
      "file": "include/linux/kprobes.h",
      "insertions": 1,
      "deletions": 0
    },
    {
      "file": "include/linux/module.h",
      "insertions": 5,
      "deletions": 0
    },
    {
      "file": "include/linux/trace_events.h",
      "insertions": 1,
      "deletions": 0
    },
    {
      "file": "include/uapi/linux/bpf.h",
      "insertions": 6,
      "deletions": 1
    },
    {
      "file": "kernel/bpf/core.c",
      "insertions": 3,
      "deletions": 0
    },
    {
      "file": "kernel/bpf/verifier.c",
      "insertions": 2,
      "deletions": 0
    },
    {
      "file": "kernel/events/core.c",
      "insertions": 7,
      "deletions": 0
    },
    {
      "file": "kernel/kprobes.c",
      "insertions": 163,
      "deletions": 0
    },
    {
      "file": "kernel/module.c",
      "insertions": 5,
      "deletions": 1
    },
    {
      "file": "kernel/trace/Kconfig",
      "insertions": 11,
      "deletions": 0
    },
    {
      "file": "kernel/trace/bpf_trace.c",
      "insertions": 35,
      "deletions": 0
    },
    {
      "file": "kernel/trace/trace_kprobe.c",
      "insertions": 48,
      "deletions": 7
    },
    {
      "file": "kernel/trace/trace_probe.h",
      "insertions": 12,
      "deletions": 0
    },
    {
      "file": "samples/bpf/Makefile",
      "insertions": 4,
      "deletions": 0
    },
    {
      "file": "samples/bpf/test_override_return.sh",
      "insertions": 15,
      "deletions": 0
    },
    {
      "file": "samples/bpf/tracex7_kern.c",
      "insertions": 16,
      "deletions": 0
    },
    {
      "file": "samples/bpf/tracex7_user.c",
      "insertions": 28,
      "deletions": 0
    },
    {
      "file": "tools/include/uapi/linux/bpf.h",
      "insertions": 6,
      "deletions": 1
    },
    {
      "file": "tools/testing/selftests/bpf/bpf_helpers.h",
      "insertions": 2,
      "deletions": 1
    }
  ],
  "total_insertions": 424,
  "total_deletions": 12,
  "total_changes": 436,
  "parents": [
    "a23967c181cae80becb451b38ff2a1e01c05c37b",
    "023f46c5b807ae5fff83b57d918727a5b9dbee55"
  ],
  "branches": [
    "* development",
    "master",
    "remotes/origin/HEAD -> origin/master",
    "remotes/origin/master"
  ],
  "tags": [
    "v4.16",
    "v4.16-rc1",
    "v4.16-rc2",
    "v4.16-rc3",
    "v4.16-rc4",
    "v4.16-rc5",
    "v4.16-rc6",
    "v4.16-rc7",
    "v4.17",
    "v4.17-rc1"
  ],
  "is_merge": true,
  "security_info": {
    "cve_ids": [],
    "security_keywords": [
      "injection"
    ]
  },
  "fix_type": "security",
  "file_results": []
}