{
  "hash": "d47c4c454ab023feae8c5be56bb14927d064bac0",
  "hash_short": "d47c4c45",
  "subject": "KVM: s390: Fix PV check in deliverable_irqs()",
  "body": "The diag 0x44 handler, which handles a directed yield, goes into a\na codepath that does a kvm_for_each_vcpu() and ultimately\ndeliverable_irqs().  The new check for kvm_s390_pv_cpu_is_protected()\ncontains an assertion that the vcpu->mutex is held, which isn't going\nto be the case in this scenario.\n\nThe result is a plethora of these messages if the lock debugging\nis enabled, and thus an implication that we have a problem.\n\n  WARNING: CPU: 9 PID: 16167 at arch/s390/kvm/kvm-s390.h:239 deliverable_irqs+0x1c6/0x1d0 [kvm]\n  ...snip...\n  Call Trace:\n   [<000003ff80429bf2>] deliverable_irqs+0x1ca/0x1d0 [kvm]\n  ([<000003ff80429b34>] deliverable_irqs+0x10c/0x1d0 [kvm])\n   [<000003ff8042ba82>] kvm_s390_vcpu_has_irq+0x2a/0xa8 [kvm]\n   [<000003ff804101e2>] kvm_arch_dy_runnable+0x22/0x38 [kvm]\n   [<000003ff80410284>] kvm_vcpu_on_spin+0x8c/0x1d0 [kvm]\n   [<000003ff80436888>] kvm_s390_handle_diag+0x3b0/0x768 [kvm]\n   [<000003ff80425af4>] kvm_handle_sie_intercept+0x1cc/0xcd0 [kvm]\n   [<000003ff80422bb0>] __vcpu_run+0x7b8/0xfd0 [kvm]\n   [<000003ff80423de6>] kvm_arch_vcpu_ioctl_run+0xee/0x3e0 [kvm]\n   [<000003ff8040ccd8>] kvm_vcpu_ioctl+0x2c8/0x8d0 [kvm]\n   [<00000001504ced06>] ksys_ioctl+0xae/0xe8\n   [<00000001504cedaa>] __s390x_sys_ioctl+0x2a/0x38\n   [<0000000150cb9034>] system_call+0xd8/0x2d8\n  2 locks held by CPU 2/KVM/16167:\n   #0: 00000001951980c0 (&vcpu->mutex){+.+.}, at: kvm_vcpu_ioctl+0x90/0x8d0 [kvm]\n   #1: 000000019599c0f0 (&kvm->srcu){....}, at: __vcpu_run+0x4bc/0xfd0 [kvm]\n  Last Breaking-Event-Address:\n   [<000003ff80429b34>] deliverable_irqs+0x10c/0x1d0 [kvm]\n  irq event stamp: 11967\n  hardirqs last  enabled at (11975): [<00000001502992f2>] console_unlock+0x4ca/0x650\n  hardirqs last disabled at (11982): [<0000000150298ee8>] console_unlock+0xc0/0x650\n  softirqs last  enabled at (7940): [<0000000150cba6ca>] __do_softirq+0x422/0x4d8\n  softirqs last disabled at (7929): [<00000001501cd688>] do_softirq_own_stack+0x70/0x80\n\nConsidering what's being done here, let's fix this by removing the\nmutex assertion rather than acquiring the mutex for every other vcpu.\n\nFixes: 201ae986ead7 (\"KVM: s390: protvirt: Implement interrupt injection\")\nSigned-off-by: Eric Farman <farman@linux.ibm.com>\nSigned-off-by: Christian Borntraeger <borntraeger@de.ibm.com>\nReviewed-by: Christian Borntraeger <borntraeger@de.ibm.com>\nReviewed-by: Cornelia Huck <cohuck@redhat.com>\nLink: https://lore.kernel.org/r/20200415190353.63625-1-farman@linux.ibm.com\nSigned-off-by: Christian Borntraeger <borntraeger@de.ibm.com>",
  "full_message": "KVM: s390: Fix PV check in deliverable_irqs()\n\nThe diag 0x44 handler, which handles a directed yield, goes into a\na codepath that does a kvm_for_each_vcpu() and ultimately\ndeliverable_irqs().  The new check for kvm_s390_pv_cpu_is_protected()\ncontains an assertion that the vcpu->mutex is held, which isn't going\nto be the case in this scenario.\n\nThe result is a plethora of these messages if the lock debugging\nis enabled, and thus an implication that we have a problem.\n\n  WARNING: CPU: 9 PID: 16167 at arch/s390/kvm/kvm-s390.h:239 deliverable_irqs+0x1c6/0x1d0 [kvm]\n  ...snip...\n  Call Trace:\n   [<000003ff80429bf2>] deliverable_irqs+0x1ca/0x1d0 [kvm]\n  ([<000003ff80429b34>] deliverable_irqs+0x10c/0x1d0 [kvm])\n   [<000003ff8042ba82>] kvm_s390_vcpu_has_irq+0x2a/0xa8 [kvm]\n   [<000003ff804101e2>] kvm_arch_dy_runnable+0x22/0x38 [kvm]\n   [<000003ff80410284>] kvm_vcpu_on_spin+0x8c/0x1d0 [kvm]\n   [<000003ff80436888>] kvm_s390_handle_diag+0x3b0/0x768 [kvm]\n   [<000003ff80425af4>] kvm_handle_sie_intercept+0x1cc/0xcd0 [kvm]\n   [<000003ff80422bb0>] __vcpu_run+0x7b8/0xfd0 [kvm]\n   [<000003ff80423de6>] kvm_arch_vcpu_ioctl_run+0xee/0x3e0 [kvm]\n   [<000003ff8040ccd8>] kvm_vcpu_ioctl+0x2c8/0x8d0 [kvm]\n   [<00000001504ced06>] ksys_ioctl+0xae/0xe8\n   [<00000001504cedaa>] __s390x_sys_ioctl+0x2a/0x38\n   [<0000000150cb9034>] system_call+0xd8/0x2d8\n  2 locks held by CPU 2/KVM/16167:\n   #0: 00000001951980c0 (&vcpu->mutex){+.+.}, at: kvm_vcpu_ioctl+0x90/0x8d0 [kvm]\n   #1: 000000019599c0f0 (&kvm->srcu){....}, at: __vcpu_run+0x4bc/0xfd0 [kvm]\n  Last Breaking-Event-Address:\n   [<000003ff80429b34>] deliverable_irqs+0x10c/0x1d0 [kvm]\n  irq event stamp: 11967\n  hardirqs last  enabled at (11975): [<00000001502992f2>] console_unlock+0x4ca/0x650\n  hardirqs last disabled at (11982): [<0000000150298ee8>] console_unlock+0xc0/0x650\n  softirqs last  enabled at (7940): [<0000000150cba6ca>] __do_softirq+0x422/0x4d8\n  softirqs last disabled at (7929): [<00000001501cd688>] do_softirq_own_stack+0x70/0x80\n\nConsidering what's being done here, let's fix this by removing the\nmutex assertion rather than acquiring the mutex for every other vcpu.\n\nFixes: 201ae986ead7 (\"KVM: s390: protvirt: Implement interrupt injection\")\nSigned-off-by: Eric Farman <farman@linux.ibm.com>\nSigned-off-by: Christian Borntraeger <borntraeger@de.ibm.com>\nReviewed-by: Christian Borntraeger <borntraeger@de.ibm.com>\nReviewed-by: Cornelia Huck <cohuck@redhat.com>\nLink: https://lore.kernel.org/r/20200415190353.63625-1-farman@linux.ibm.com\nSigned-off-by: Christian Borntraeger <borntraeger@de.ibm.com>",
  "author_name": "Eric Farman",
  "author_email": "farman@linux.ibm.com",
  "author_date": "Wed Apr 15 21:03:53 2020 +0200",
  "author_date_iso": "2020-04-15T21:03:53+02:00",
  "committer_name": "Christian Borntraeger",
  "committer_email": "borntraeger@de.ibm.com",
  "committer_date": "Mon Apr 20 11:23:45 2020 +0200",
  "committer_date_iso": "2020-04-20T11:23:45+02:00",
  "files_changed": [
    "arch/s390/kvm/interrupt.c"
  ],
  "files_changed_count": 1,
  "stats": [
    {
      "file": "arch/s390/kvm/interrupt.c",
      "insertions": 1,
      "deletions": 1
    }
  ],
  "total_insertions": 1,
  "total_deletions": 1,
  "total_changes": 2,
  "parents": [
    "ae83d0b416db002fe95601e7f97f64b59514d936"
  ],
  "branches": [
    "* development",
    "remotes/origin/HEAD -> origin/master",
    "remotes/origin/master"
  ],
  "tags": [],
  "is_merge": false,
  "security_info": {
    "cve_ids": [],
    "security_keywords": [
      "injection"
    ]
  },
  "fix_type": "security",
  "file_results": [
    {
      "file": "arch/s390/kvm/interrupt.c",
      "pre_version": false,
      "post_version": true,
      "patch": true
    }
  ]
}