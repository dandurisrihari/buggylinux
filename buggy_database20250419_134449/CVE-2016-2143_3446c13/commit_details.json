{
  "hash": "3446c13b268af86391d06611327006b059b8bab1",
  "hash_short": "3446c13b",
  "subject": "s390/mm: four page table levels vs. fork",
  "body": "The fork of a process with four page table levels is broken since\ngit commit 6252d702c5311ce9 \"[S390] dynamic page tables.\"\n\nAll new mm contexts are created with three page table levels and\nan asce limit of 4TB. If the parent has four levels dup_mmap will\nadd vmas to the new context which are outside of the asce limit.\nThe subsequent call to copy_page_range will walk the three level\npage table structure of the new process with non-zero pgd and pud\nindexes. This leads to memory clobbers as the pgd_index *and* the\npud_index is added to the mm->pgd pointer without a pgd_deref\nin between.\n\nThe init_new_context() function is selecting the number of page\ntable levels for a new context. The function is used by mm_init()\nwhich in turn is called by dup_mm() and mm_alloc(). These two are\nused by fork() and exec(). The init_new_context() function can\ndistinguish the two cases by looking at mm->context.asce_limit,\nfor fork() the mm struct has been copied and the number of page\ntable levels may not change. For exec() the mm_alloc() function\nset the new mm structure to zero, in this case a three-level page\ntable is created as the temporary stack space is located at\nSTACK_TOP_MAX = 4TB.\n\nThis fixes CVE-2016-2143.\n\nReported-by: Marcin Ko\u015bcielnicki <koriakin@0x04.net>\nReviewed-by: Heiko Carstens <heiko.carstens@de.ibm.com>\nCc: stable@vger.kernel.org\nSigned-off-by: Martin Schwidefsky <schwidefsky@de.ibm.com>",
  "full_message": "s390/mm: four page table levels vs. fork\n\nThe fork of a process with four page table levels is broken since\ngit commit 6252d702c5311ce9 \"[S390] dynamic page tables.\"\n\nAll new mm contexts are created with three page table levels and\nan asce limit of 4TB. If the parent has four levels dup_mmap will\nadd vmas to the new context which are outside of the asce limit.\nThe subsequent call to copy_page_range will walk the three level\npage table structure of the new process with non-zero pgd and pud\nindexes. This leads to memory clobbers as the pgd_index *and* the\npud_index is added to the mm->pgd pointer without a pgd_deref\nin between.\n\nThe init_new_context() function is selecting the number of page\ntable levels for a new context. The function is used by mm_init()\nwhich in turn is called by dup_mm() and mm_alloc(). These two are\nused by fork() and exec(). The init_new_context() function can\ndistinguish the two cases by looking at mm->context.asce_limit,\nfor fork() the mm struct has been copied and the number of page\ntable levels may not change. For exec() the mm_alloc() function\nset the new mm structure to zero, in this case a three-level page\ntable is created as the temporary stack space is located at\nSTACK_TOP_MAX = 4TB.\n\nThis fixes CVE-2016-2143.\n\nReported-by: Marcin Ko\u015bcielnicki <koriakin@0x04.net>\nReviewed-by: Heiko Carstens <heiko.carstens@de.ibm.com>\nCc: stable@vger.kernel.org\nSigned-off-by: Martin Schwidefsky <schwidefsky@de.ibm.com>",
  "author_name": "Martin Schwidefsky",
  "author_email": "schwidefsky@de.ibm.com",
  "author_date": "Mon Feb 15 14:46:49 2016 +0100",
  "author_date_iso": "2016-02-15T14:46:49+01:00",
  "committer_name": "Martin Schwidefsky",
  "committer_email": "schwidefsky@de.ibm.com",
  "committer_date": "Thu Mar 10 09:21:24 2016 +0100",
  "committer_date_iso": "2016-03-10T09:21:24+01:00",
  "files_changed": [
    "arch/s390/include/asm/mmu_context.h",
    "arch/s390/include/asm/pgalloc.h"
  ],
  "files_changed_count": 2,
  "stats": [
    {
      "file": "arch/s390/include/asm/mmu_context.h",
      "insertions": 11,
      "deletions": 5
    },
    {
      "file": "arch/s390/include/asm/pgalloc.h",
      "insertions": 19,
      "deletions": 5
    }
  ],
  "total_insertions": 30,
  "total_deletions": 10,
  "total_changes": 40,
  "parents": [
    "7a76aa95f6f6682db5629449d763251d1c9f8c4e"
  ],
  "branches": [
    "* development",
    "master",
    "remotes/origin/HEAD -> origin/master",
    "remotes/origin/master"
  ],
  "tags": [
    "v4.10",
    "v4.10-rc1",
    "v4.10-rc2",
    "v4.10-rc3",
    "v4.10-rc4",
    "v4.10-rc5",
    "v4.10-rc6",
    "v4.10-rc7",
    "v4.10-rc8",
    "v4.11"
  ],
  "is_merge": false,
  "security_info": {
    "cve_ids": [
      "CVE-2016-2143"
    ],
    "security_keywords": []
  },
  "fix_type": "cve",
  "file_results": [
    {
      "file": "arch/s390/include/asm/mmu_context.h",
      "pre_version": false,
      "post_version": true,
      "patch": true
    },
    {
      "file": "arch/s390/include/asm/pgalloc.h",
      "pre_version": false,
      "post_version": true,
      "patch": true
    }
  ]
}