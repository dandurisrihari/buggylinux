{
  "hash": "45fc8757d1d2128e342b4e7ef39adedf7752faac",
  "hash_short": "45fc8757",
  "subject": "x86: Make the GDT remapping read-only on 64-bit",
  "body": "This patch makes the GDT remapped pages read-only, to prevent accidental\n(or intentional) corruption of this key data structure.\n\nThis change is done only on 64-bit, because 32-bit needs it to be writable\nfor TSS switches.\n\nThe native_load_tr_desc function was adapted to correctly handle a\nread-only GDT. The LTR instruction always writes to the GDT TSS entry.\nThis generates a page fault if the GDT is read-only. This change checks\nif the current GDT is a remap and swap GDTs as needed. This function was\ntested by booting multiple machines and checking hibernation works\nproperly.\n\nKVM SVM and VMX were adapted to use the writeable GDT. On VMX, the\nper-cpu variable was removed for functions to fetch the original GDT.\nInstead of reloading the previous GDT, VMX will reload the fixmap GDT as\nexpected. For testing, VMs were started and restored on multiple\nconfigurations.\n\nSigned-off-by: Thomas Garnier <thgarnie@google.com>\nCc: Alexander Potapenko <glider@google.com>\nCc: Andrew Morton <akpm@linux-foundation.org>\nCc: Andrey Ryabinin <aryabinin@virtuozzo.com>\nCc: Andy Lutomirski <luto@kernel.org>\nCc: Ard Biesheuvel <ard.biesheuvel@linaro.org>\nCc: Boris Ostrovsky <boris.ostrovsky@oracle.com>\nCc: Borislav Petkov <bp@suse.de>\nCc: Chris Wilson <chris@chris-wilson.co.uk>\nCc: Christian Borntraeger <borntraeger@de.ibm.com>\nCc: Dmitry Vyukov <dvyukov@google.com>\nCc: Frederic Weisbecker <fweisbec@gmail.com>\nCc: Jiri Kosina <jikos@kernel.org>\nCc: Joerg Roedel <joro@8bytes.org>\nCc: Jonathan Corbet <corbet@lwn.net>\nCc: Josh Poimboeuf <jpoimboe@redhat.com>\nCc: Juergen Gross <jgross@suse.com>\nCc: Kees Cook <keescook@chromium.org>\nCc: Len Brown <len.brown@intel.com>\nCc: Linus Torvalds <torvalds@linux-foundation.org>\nCc: Lorenzo Stoakes <lstoakes@gmail.com>\nCc: Luis R . Rodriguez <mcgrof@kernel.org>\nCc: Matt Fleming <matt@codeblueprint.co.uk>\nCc: Michal Hocko <mhocko@suse.com>\nCc: Paolo Bonzini <pbonzini@redhat.com>\nCc: Paul Gortmaker <paul.gortmaker@windriver.com>\nCc: Pavel Machek <pavel@ucw.cz>\nCc: Peter Zijlstra <peterz@infradead.org>\nCc: Radim Kr\u010dm\u00e1\u0159 <rkrcmar@redhat.com>\nCc: Rafael J . Wysocki <rjw@rjwysocki.net>\nCc: Rusty Russell <rusty@rustcorp.com.au>\nCc: Stanislaw Gruszka <sgruszka@redhat.com>\nCc: Thomas Gleixner <tglx@linutronix.de>\nCc: Tim Chen <tim.c.chen@linux.intel.com>\nCc: Vitaly Kuznetsov <vkuznets@redhat.com>\nCc: kasan-dev@googlegroups.com\nCc: kernel-hardening@lists.openwall.com\nCc: kvm@vger.kernel.org\nCc: lguest@lists.ozlabs.org\nCc: linux-doc@vger.kernel.org\nCc: linux-efi@vger.kernel.org\nCc: linux-mm@kvack.org\nCc: linux-pm@vger.kernel.org\nCc: xen-devel@lists.xenproject.org\nCc: zijun_hu <zijun_hu@htc.com>\nLink: http://lkml.kernel.org/r/20170314170508.100882-3-thgarnie@google.com\nSigned-off-by: Ingo Molnar <mingo@kernel.org>",
  "full_message": "x86: Make the GDT remapping read-only on 64-bit\n\nThis patch makes the GDT remapped pages read-only, to prevent accidental\n(or intentional) corruption of this key data structure.\n\nThis change is done only on 64-bit, because 32-bit needs it to be writable\nfor TSS switches.\n\nThe native_load_tr_desc function was adapted to correctly handle a\nread-only GDT. The LTR instruction always writes to the GDT TSS entry.\nThis generates a page fault if the GDT is read-only. This change checks\nif the current GDT is a remap and swap GDTs as needed. This function was\ntested by booting multiple machines and checking hibernation works\nproperly.\n\nKVM SVM and VMX were adapted to use the writeable GDT. On VMX, the\nper-cpu variable was removed for functions to fetch the original GDT.\nInstead of reloading the previous GDT, VMX will reload the fixmap GDT as\nexpected. For testing, VMs were started and restored on multiple\nconfigurations.\n\nSigned-off-by: Thomas Garnier <thgarnie@google.com>\nCc: Alexander Potapenko <glider@google.com>\nCc: Andrew Morton <akpm@linux-foundation.org>\nCc: Andrey Ryabinin <aryabinin@virtuozzo.com>\nCc: Andy Lutomirski <luto@kernel.org>\nCc: Ard Biesheuvel <ard.biesheuvel@linaro.org>\nCc: Boris Ostrovsky <boris.ostrovsky@oracle.com>\nCc: Borislav Petkov <bp@suse.de>\nCc: Chris Wilson <chris@chris-wilson.co.uk>\nCc: Christian Borntraeger <borntraeger@de.ibm.com>\nCc: Dmitry Vyukov <dvyukov@google.com>\nCc: Frederic Weisbecker <fweisbec@gmail.com>\nCc: Jiri Kosina <jikos@kernel.org>\nCc: Joerg Roedel <joro@8bytes.org>\nCc: Jonathan Corbet <corbet@lwn.net>\nCc: Josh Poimboeuf <jpoimboe@redhat.com>\nCc: Juergen Gross <jgross@suse.com>\nCc: Kees Cook <keescook@chromium.org>\nCc: Len Brown <len.brown@intel.com>\nCc: Linus Torvalds <torvalds@linux-foundation.org>\nCc: Lorenzo Stoakes <lstoakes@gmail.com>\nCc: Luis R . Rodriguez <mcgrof@kernel.org>\nCc: Matt Fleming <matt@codeblueprint.co.uk>\nCc: Michal Hocko <mhocko@suse.com>\nCc: Paolo Bonzini <pbonzini@redhat.com>\nCc: Paul Gortmaker <paul.gortmaker@windriver.com>\nCc: Pavel Machek <pavel@ucw.cz>\nCc: Peter Zijlstra <peterz@infradead.org>\nCc: Radim Kr\u010dm\u00e1\u0159 <rkrcmar@redhat.com>\nCc: Rafael J . Wysocki <rjw@rjwysocki.net>\nCc: Rusty Russell <rusty@rustcorp.com.au>\nCc: Stanislaw Gruszka <sgruszka@redhat.com>\nCc: Thomas Gleixner <tglx@linutronix.de>\nCc: Tim Chen <tim.c.chen@linux.intel.com>\nCc: Vitaly Kuznetsov <vkuznets@redhat.com>\nCc: kasan-dev@googlegroups.com\nCc: kernel-hardening@lists.openwall.com\nCc: kvm@vger.kernel.org\nCc: lguest@lists.ozlabs.org\nCc: linux-doc@vger.kernel.org\nCc: linux-efi@vger.kernel.org\nCc: linux-mm@kvack.org\nCc: linux-pm@vger.kernel.org\nCc: xen-devel@lists.xenproject.org\nCc: zijun_hu <zijun_hu@htc.com>\nLink: http://lkml.kernel.org/r/20170314170508.100882-3-thgarnie@google.com\nSigned-off-by: Ingo Molnar <mingo@kernel.org>",
  "author_name": "Thomas Garnier",
  "author_email": "thgarnie@google.com",
  "author_date": "Tue Mar 14 10:05:08 2017 -0700",
  "author_date_iso": "2017-03-14T10:05:08-07:00",
  "committer_name": "Ingo Molnar",
  "committer_email": "mingo@kernel.org",
  "committer_date": "Thu Mar 16 09:06:35 2017 +0100",
  "committer_date_iso": "2017-03-16T09:06:35+01:00",
  "files_changed": [
    "arch/x86/include/asm/desc.h",
    "arch/x86/include/asm/processor.h",
    "arch/x86/kernel/cpu/common.c",
    "arch/x86/kvm/svm.c",
    "arch/x86/kvm/vmx.c"
  ],
  "files_changed_count": 5,
  "stats": [
    {
      "file": "arch/x86/include/asm/desc.h",
      "insertions": 68,
      "deletions": 38
    },
    {
      "file": "arch/x86/include/asm/processor.h",
      "insertions": 1,
      "deletions": 0
    },
    {
      "file": "arch/x86/kernel/cpu/common.c",
      "insertions": 22,
      "deletions": 6
    },
    {
      "file": "arch/x86/kvm/svm.c",
      "insertions": 1,
      "deletions": 3
    },
    {
      "file": "arch/x86/kvm/vmx.c",
      "insertions": 4,
      "deletions": 8
    }
  ],
  "total_insertions": 96,
  "total_deletions": 55,
  "total_changes": 151,
  "parents": [
    "69218e47994da614e7af600bf06887750ab6657a"
  ],
  "branches": [
    "* development",
    "master",
    "remotes/origin/HEAD -> origin/master",
    "remotes/origin/master"
  ],
  "tags": [
    "v4.12",
    "v4.12-rc1",
    "v4.12-rc2",
    "v4.12-rc3",
    "v4.12-rc4",
    "v4.12-rc5",
    "v4.12-rc6",
    "v4.12-rc7",
    "v4.13",
    "v4.13-rc1"
  ],
  "is_merge": false,
  "security_info": {
    "cve_ids": [],
    "security_keywords": [
      "hardening"
    ]
  },
  "fix_type": "security",
  "file_results": [
    {
      "file": "arch/x86/include/asm/desc.h",
      "pre_version": true,
      "post_version": true,
      "patch": true
    },
    {
      "file": "arch/x86/include/asm/processor.h",
      "pre_version": true,
      "post_version": true,
      "patch": true
    },
    {
      "file": "arch/x86/kernel/cpu/common.c",
      "pre_version": true,
      "post_version": true,
      "patch": true
    },
    {
      "file": "arch/x86/kvm/svm.c",
      "pre_version": false,
      "post_version": true,
      "patch": true
    },
    {
      "file": "arch/x86/kvm/vmx.c",
      "pre_version": false,
      "post_version": true,
      "patch": true
    }
  ]
}