{
  "hash": "acff78477b9b4f26ecdf65733a4ed77fe837e9dc",
  "hash_short": "acff7847",
  "subject": "KVM: x86: nVMX: close leak of L0's x2APIC MSRs (CVE-2019-3887)",
  "body": "The nested_vmx_prepare_msr_bitmap() function doesn't directly guard the\nx2APIC MSR intercepts with the \"virtualize x2APIC mode\" MSR. As a\nresult, we discovered the potential for a buggy or malicious L1 to get\naccess to L0's x2APIC MSRs, via an L2, as follows.\n\n1. L1 executes WRMSR(IA32_SPEC_CTRL, 1). This causes the spec_ctrl\nvariable, in nested_vmx_prepare_msr_bitmap() to become true.\n2. L1 disables \"virtualize x2APIC mode\" in VMCS12.\n3. L1 enables \"APIC-register virtualization\" in VMCS12.\n\nNow, KVM will set VMCS02's x2APIC MSR intercepts from VMCS12, and then\nset \"virtualize x2APIC mode\" to 0 in VMCS02. Oops.\n\nThis patch closes the leak by explicitly guarding VMCS02's x2APIC MSR\nintercepts with VMCS12's \"virtualize x2APIC mode\" control.\n\nThe scenario outlined above and fix prescribed here, were verified with\na related patch in kvm-unit-tests titled \"Add leak scenario to\nvirt_x2apic_mode_test\".\n\nNote, it looks like this issue may have been introduced inadvertently\nduring a merge---see 15303ba5d1cd.\n\nSigned-off-by: Marc Orr <marcorr@google.com>\nReviewed-by: Jim Mattson <jmattson@google.com>\nSigned-off-by: Paolo Bonzini <pbonzini@redhat.com>",
  "full_message": "KVM: x86: nVMX: close leak of L0's x2APIC MSRs (CVE-2019-3887)\n\nThe nested_vmx_prepare_msr_bitmap() function doesn't directly guard the\nx2APIC MSR intercepts with the \"virtualize x2APIC mode\" MSR. As a\nresult, we discovered the potential for a buggy or malicious L1 to get\naccess to L0's x2APIC MSRs, via an L2, as follows.\n\n1. L1 executes WRMSR(IA32_SPEC_CTRL, 1). This causes the spec_ctrl\nvariable, in nested_vmx_prepare_msr_bitmap() to become true.\n2. L1 disables \"virtualize x2APIC mode\" in VMCS12.\n3. L1 enables \"APIC-register virtualization\" in VMCS12.\n\nNow, KVM will set VMCS02's x2APIC MSR intercepts from VMCS12, and then\nset \"virtualize x2APIC mode\" to 0 in VMCS02. Oops.\n\nThis patch closes the leak by explicitly guarding VMCS02's x2APIC MSR\nintercepts with VMCS12's \"virtualize x2APIC mode\" control.\n\nThe scenario outlined above and fix prescribed here, were verified with\na related patch in kvm-unit-tests titled \"Add leak scenario to\nvirt_x2apic_mode_test\".\n\nNote, it looks like this issue may have been introduced inadvertently\nduring a merge---see 15303ba5d1cd.\n\nSigned-off-by: Marc Orr <marcorr@google.com>\nReviewed-by: Jim Mattson <jmattson@google.com>\nSigned-off-by: Paolo Bonzini <pbonzini@redhat.com>",
  "author_name": "Marc Orr",
  "author_email": "marcorr@google.com",
  "author_date": "Mon Apr 1 23:55:59 2019 -0700",
  "author_date_iso": "2019-04-01T23:55:59-07:00",
  "committer_name": "Paolo Bonzini",
  "committer_email": "pbonzini@redhat.com",
  "committer_date": "Fri Apr 5 21:08:22 2019 +0200",
  "committer_date_iso": "2019-04-05T21:08:22+02:00",
  "files_changed": [
    "arch/x86/kvm/vmx/nested.c"
  ],
  "files_changed_count": 1,
  "stats": [
    {
      "file": "arch/x86/kvm/vmx/nested.c",
      "insertions": 44,
      "deletions": 28
    }
  ],
  "total_insertions": 44,
  "total_deletions": 28,
  "total_changes": 72,
  "parents": [
    "b86bc2858b389255cd44555ce4b1e427b2b770c0"
  ],
  "branches": [
    "* development",
    "master",
    "remotes/origin/HEAD -> origin/master",
    "remotes/origin/master"
  ],
  "tags": [
    "v5.1",
    "v5.1-rc4",
    "v5.1-rc5",
    "v5.1-rc6",
    "v5.1-rc7",
    "v5.2",
    "v5.2-rc1",
    "v5.2-rc2",
    "v5.2-rc3",
    "v5.2-rc4"
  ],
  "is_merge": false,
  "security_info": {
    "cve_ids": [
      "CVE-2019-3887",
      "CVE-2019-3887"
    ],
    "security_keywords": []
  },
  "fix_type": "cve",
  "file_results": [
    {
      "file": "arch/x86/kvm/vmx/nested.c",
      "pre_version": false,
      "post_version": true,
      "patch": true
    }
  ]
}