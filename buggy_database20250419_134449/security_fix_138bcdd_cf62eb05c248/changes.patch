diff --cc arch/x86/kernel/cpu/amd.c
index 26ad7ca423e7,41e10c26efb5..1e1e253038ce
--- a/arch/x86/kernel/cpu/amd.c
+++ b/arch/x86/kernel/cpu/amd.c
@@@ -1279,14 -1236,21 +1279,33 @@@ u32 amd_get_highest_perf(void
  }
  EXPORT_SYMBOL_GPL(amd_get_highest_perf);
  
 +static void zenbleed_check_cpu(void *unused)
 +{
 +	struct cpuinfo_x86 *c = &cpu_data(smp_processor_id());
 +
 +	zenbleed_check(c);
 +}
 +
 +void amd_check_microcode(void)
 +{
 +	on_each_cpu(zenbleed_check_cpu, NULL, 1);
 +}
++
+ bool cpu_has_ibpb_brtype_microcode(void)
+ {
+ 	switch (boot_cpu_data.x86) {
+ 	/* Zen1/2 IBPB flushes branch type predictions too. */
+ 	case 0x17:
+ 		return boot_cpu_has(X86_FEATURE_AMD_IBPB);
+ 	case 0x19:
+ 		/* Poke the MSR bit on Zen3/4 to check its presence. */
+ 		if (!wrmsrl_safe(MSR_IA32_PRED_CMD, PRED_CMD_SBPB)) {
+ 			setup_force_cpu_cap(X86_FEATURE_SBPB);
+ 			return true;
+ 		} else {
+ 			return false;
+ 		}
+ 	default:
+ 		return false;
+ 	}
+ }