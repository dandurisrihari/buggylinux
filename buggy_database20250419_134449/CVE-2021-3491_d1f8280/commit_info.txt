Commit Hash: d1f82808877bb10d3deee7cf3374a4eb3fb582db
Subject: io_uring: truncate lengths larger than MAX_RW_COUNT on provide buffers

CVE Identifiers:
- CVE-2021-3491

Full commit message:
io_uring: truncate lengths larger than MAX_RW_COUNT on provide buffers

Read and write operations are capped to MAX_RW_COUNT. Some read ops rely on
that limit, and that is not guaranteed by the IORING_OP_PROVIDE_BUFFERS.

Truncate those lengths when doing io_add_buffers, so buffer addresses still
use the uncapped length.

Also, take the chance and change struct io_buffer len member to __u32, so
it matches struct io_provide_buffer len member.

This fixes CVE-2021-3491, also reported as ZDI-CAN-13546.

Fixes: ddf0322db79c ("io_uring: add IORING_OP_PROVIDE_BUFFERS")
Reported-by: Billy Jheng Bing-Jhong (@st424204)
Signed-off-by: Thadeu Lima de Souza Cascardo <cascardo@canonical.com>
Signed-off-by: Jens Axboe <axboe@kernel.dk>

Metadata:
Author: Thadeu Lima de Souza Cascardo <cascardo@canonical.com>
Author Date: Wed May 5 09:47:06 2021 -0300
Committer: Jens Axboe <axboe@kernel.dk>
Commit Date: Wed May 5 15:17:35 2021 -0600

Files Changed: 1
Lines Added: 2
Lines Removed: 2
Total Changes: 4
