{
  "hash": "8e2e1faf28b3e66430f55f0b0ee83370ecc150af",
  "hash_short": "8e2e1faf",
  "subject": "io_uring: only post events in io_poll_remove_all() if we completed some",
  "body": "syzbot reports this crash:\n\nBUG: unable to handle page fault for address: ffffffffffffffe8\nPGD f96e17067 P4D f96e17067 PUD f96e19067 PMD 0\nOops: 0000 [#1] SMP DEBUG_PAGEALLOC KASAN PTI\nCPU: 55 PID: 211750 Comm: trinity-c127 Tainted: G    B        L    5.7.0-rc1-next-20200413 #4\nHardware name: HP ProLiant DL380 Gen9/ProLiant DL380 Gen9, BIOS P89 04/12/2017\nRIP: 0010:__wake_up_common+0x98/0x290\nel/sched/wait.c:87\nCode: 40 4d 8d 78 e8 49 8d 7f 18 49 39 fd 0f 84 80 00 00 00 e8 6b bd 2b 00 49 8b 5f 18 45 31 e4 48 83 eb 18 4c 89 ff e8 08 bc 2b 00 <45> 8b 37 41 f6 c6 04 75 71 49 8d 7f 10 e8 46 bd 2b 00 49 8b 47 10\nRSP: 0018:ffffc9000adbfaf0 EFLAGS: 00010046\nRAX: 0000000000000000 RBX: ffffffffffffffe8 RCX: ffffffffaa9636b8\nRDX: 0000000000000003 RSI: dffffc0000000000 RDI: ffffffffffffffe8\nRBP: ffffc9000adbfb40 R08: fffffbfff582c5fd R09: fffffbfff582c5fd\nR10: ffffffffac162fe3 R11: fffffbfff582c5fc R12: 0000000000000000\nR13: ffff888ef82b0960 R14: ffffc9000adbfb80 R15: ffffffffffffffe8\nFS:  00007fdcba4c4740(0000) GS:ffff889033780000(0000) knlGS:0000000000000000\nCS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033\nCR2: ffffffffffffffe8 CR3: 0000000f776a0004 CR4: 00000000001606e0\nCall Trace:\n __wake_up_common_lock+0xea/0x150\nommon_lock at kernel/sched/wait.c:124\n ? __wake_up_common+0x290/0x290\n ? lockdep_hardirqs_on+0x16/0x2c0\n __wake_up+0x13/0x20\n io_cqring_ev_posted+0x75/0xe0\nv_posted at fs/io_uring.c:1160\n io_ring_ctx_wait_and_kill+0x1c0/0x2f0\nl at fs/io_uring.c:7305\n io_uring_create+0xa8d/0x13b0\n ? io_req_defer_prep+0x990/0x990\n ? __kasan_check_write+0x14/0x20\n io_uring_setup+0xb8/0x130\n ? io_uring_create+0x13b0/0x13b0\n ? check_flags.part.28+0x220/0x220\n ? lockdep_hardirqs_on+0x16/0x2c0\n __x64_sys_io_uring_setup+0x31/0x40\n do_syscall_64+0xcc/0xaf0\n ? syscall_return_slowpath+0x580/0x580\n ? lockdep_hardirqs_off+0x1f/0x140\n ? entry_SYSCALL_64_after_hwframe+0x3e/0xb3\n ? trace_hardirqs_off_caller+0x3a/0x150\n ? trace_hardirqs_off_thunk+0x1a/0x1c\n entry_SYSCALL_64_after_hwframe+0x49/0xb3\nRIP: 0033:0x7fdcb9dd76ed\nCode: 00 c3 66 2e 0f 1f 84 00 00 00 00 00 90 f3 0f 1e fa 48 89 f8 48 89 f7 48 89 d6 48 89 ca 4d 89 c2 4d 89 c8 4c 8b 4c 24 08 0f 05 <48> 3d 01 f0 ff ff 73 01 c3 48 8b 0d 6b 57 2c 00 f7 d8 64 89 01 48\nRSP: 002b:00007ffe7fd4e4f8 EFLAGS: 00000246 ORIG_RAX: 00000000000001a9\nRAX: ffffffffffffffda RBX: 00000000000001a9 RCX: 00007fdcb9dd76ed\nRDX: fffffffffffffffc RSI: 0000000000000000 RDI: 0000000000005d54\nRBP: 00000000000001a9 R08: 0000000e31d3caa7 R09: 0082400004004000\nR10: ffffffffffffffff R11: 0000000000000246 R12: 0000000000000002\nR13: 00007fdcb842e058 R14: 00007fdcba4c46c0 R15: 00007fdcb842e000\nModules linked in: bridge stp llc nfnetlink cn brd vfat fat ext4 crc16 mbcache jbd2 loop kvm_intel kvm irqbypass intel_cstate intel_uncore dax_pmem intel_rapl_perf dax_pmem_core ip_tables x_tables xfs sd_mod tg3 firmware_class libphy hpsa scsi_transport_sas dm_mirror dm_region_hash dm_log dm_mod [last unloaded: binfmt_misc]\nCR2: ffffffffffffffe8\n---[ end trace f9502383d57e0e22 ]---\nRIP: 0010:__wake_up_common+0x98/0x290\nCode: 40 4d 8d 78 e8 49 8d 7f 18 49 39 fd 0f 84 80 00 00 00 e8 6b bd 2b 00 49 8b 5f 18 45 31 e4 48 83 eb 18 4c 89 ff e8 08 bc 2b 00 <45> 8b 37 41 f6 c6 04 75 71 49 8d 7f 10 e8 46 bd 2b 00 49 8b 47 10\nRSP: 0018:ffffc9000adbfaf0 EFLAGS: 00010046\nRAX: 0000000000000000 RBX: ffffffffffffffe8 RCX: ffffffffaa9636b8\nRDX: 0000000000000003 RSI: dffffc0000000000 RDI: ffffffffffffffe8\nRBP: ffffc9000adbfb40 R08: fffffbfff582c5fd R09: fffffbfff582c5fd\nR10: ffffffffac162fe3 R11: fffffbfff582c5fc R12: 0000000000000000\nR13: ffff888ef82b0960 R14: ffffc9000adbfb80 R15: ffffffffffffffe8\nFS:  00007fdcba4c4740(0000) GS:ffff889033780000(0000) knlGS:0000000000000000\nCS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033\nCR2: ffffffffffffffe8 CR3: 0000000f776a0004 CR4: 00000000001606e0\nKernel panic - not syncing: Fatal exception\nKernel Offset: 0x29800000 from 0xffffffff81000000 (relocation range: 0xffffffff80000000-0xffffffffbfffffff)\n---[ end Kernel panic - not syncing: Fatal exception ]\u2014\n\nwhich is due to error injection (or allocation failure) preventing the\nrings from being setup. On shutdown, we attempt to remove any pending\nrequests, and for poll request, we call io_cqring_ev_posted() when we've\nkilled poll requests. However, since the rings aren't setup, we won't\nfind any poll requests. Make the calling of io_cqring_ev_posted()\ndependent on actually having completed requests. This fixes this setup\ncorner case, and removes spurious calls if we remove poll requests and\ndon't find any.\n\nReported-by: Qian Cai <cai@lca.pw>\nSigned-off-by: Jens Axboe <axboe@kernel.dk>",
  "full_message": "io_uring: only post events in io_poll_remove_all() if we completed some\n\nsyzbot reports this crash:\n\nBUG: unable to handle page fault for address: ffffffffffffffe8\nPGD f96e17067 P4D f96e17067 PUD f96e19067 PMD 0\nOops: 0000 [#1] SMP DEBUG_PAGEALLOC KASAN PTI\nCPU: 55 PID: 211750 Comm: trinity-c127 Tainted: G    B        L    5.7.0-rc1-next-20200413 #4\nHardware name: HP ProLiant DL380 Gen9/ProLiant DL380 Gen9, BIOS P89 04/12/2017\nRIP: 0010:__wake_up_common+0x98/0x290\nel/sched/wait.c:87\nCode: 40 4d 8d 78 e8 49 8d 7f 18 49 39 fd 0f 84 80 00 00 00 e8 6b bd 2b 00 49 8b 5f 18 45 31 e4 48 83 eb 18 4c 89 ff e8 08 bc 2b 00 <45> 8b 37 41 f6 c6 04 75 71 49 8d 7f 10 e8 46 bd 2b 00 49 8b 47 10\nRSP: 0018:ffffc9000adbfaf0 EFLAGS: 00010046\nRAX: 0000000000000000 RBX: ffffffffffffffe8 RCX: ffffffffaa9636b8\nRDX: 0000000000000003 RSI: dffffc0000000000 RDI: ffffffffffffffe8\nRBP: ffffc9000adbfb40 R08: fffffbfff582c5fd R09: fffffbfff582c5fd\nR10: ffffffffac162fe3 R11: fffffbfff582c5fc R12: 0000000000000000\nR13: ffff888ef82b0960 R14: ffffc9000adbfb80 R15: ffffffffffffffe8\nFS:  00007fdcba4c4740(0000) GS:ffff889033780000(0000) knlGS:0000000000000000\nCS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033\nCR2: ffffffffffffffe8 CR3: 0000000f776a0004 CR4: 00000000001606e0\nCall Trace:\n __wake_up_common_lock+0xea/0x150\nommon_lock at kernel/sched/wait.c:124\n ? __wake_up_common+0x290/0x290\n ? lockdep_hardirqs_on+0x16/0x2c0\n __wake_up+0x13/0x20\n io_cqring_ev_posted+0x75/0xe0\nv_posted at fs/io_uring.c:1160\n io_ring_ctx_wait_and_kill+0x1c0/0x2f0\nl at fs/io_uring.c:7305\n io_uring_create+0xa8d/0x13b0\n ? io_req_defer_prep+0x990/0x990\n ? __kasan_check_write+0x14/0x20\n io_uring_setup+0xb8/0x130\n ? io_uring_create+0x13b0/0x13b0\n ? check_flags.part.28+0x220/0x220\n ? lockdep_hardirqs_on+0x16/0x2c0\n __x64_sys_io_uring_setup+0x31/0x40\n do_syscall_64+0xcc/0xaf0\n ? syscall_return_slowpath+0x580/0x580\n ? lockdep_hardirqs_off+0x1f/0x140\n ? entry_SYSCALL_64_after_hwframe+0x3e/0xb3\n ? trace_hardirqs_off_caller+0x3a/0x150\n ? trace_hardirqs_off_thunk+0x1a/0x1c\n entry_SYSCALL_64_after_hwframe+0x49/0xb3\nRIP: 0033:0x7fdcb9dd76ed\nCode: 00 c3 66 2e 0f 1f 84 00 00 00 00 00 90 f3 0f 1e fa 48 89 f8 48 89 f7 48 89 d6 48 89 ca 4d 89 c2 4d 89 c8 4c 8b 4c 24 08 0f 05 <48> 3d 01 f0 ff ff 73 01 c3 48 8b 0d 6b 57 2c 00 f7 d8 64 89 01 48\nRSP: 002b:00007ffe7fd4e4f8 EFLAGS: 00000246 ORIG_RAX: 00000000000001a9\nRAX: ffffffffffffffda RBX: 00000000000001a9 RCX: 00007fdcb9dd76ed\nRDX: fffffffffffffffc RSI: 0000000000000000 RDI: 0000000000005d54\nRBP: 00000000000001a9 R08: 0000000e31d3caa7 R09: 0082400004004000\nR10: ffffffffffffffff R11: 0000000000000246 R12: 0000000000000002\nR13: 00007fdcb842e058 R14: 00007fdcba4c46c0 R15: 00007fdcb842e000\nModules linked in: bridge stp llc nfnetlink cn brd vfat fat ext4 crc16 mbcache jbd2 loop kvm_intel kvm irqbypass intel_cstate intel_uncore dax_pmem intel_rapl_perf dax_pmem_core ip_tables x_tables xfs sd_mod tg3 firmware_class libphy hpsa scsi_transport_sas dm_mirror dm_region_hash dm_log dm_mod [last unloaded: binfmt_misc]\nCR2: ffffffffffffffe8\n---[ end trace f9502383d57e0e22 ]---\nRIP: 0010:__wake_up_common+0x98/0x290\nCode: 40 4d 8d 78 e8 49 8d 7f 18 49 39 fd 0f 84 80 00 00 00 e8 6b bd 2b 00 49 8b 5f 18 45 31 e4 48 83 eb 18 4c 89 ff e8 08 bc 2b 00 <45> 8b 37 41 f6 c6 04 75 71 49 8d 7f 10 e8 46 bd 2b 00 49 8b 47 10\nRSP: 0018:ffffc9000adbfaf0 EFLAGS: 00010046\nRAX: 0000000000000000 RBX: ffffffffffffffe8 RCX: ffffffffaa9636b8\nRDX: 0000000000000003 RSI: dffffc0000000000 RDI: ffffffffffffffe8\nRBP: ffffc9000adbfb40 R08: fffffbfff582c5fd R09: fffffbfff582c5fd\nR10: ffffffffac162fe3 R11: fffffbfff582c5fc R12: 0000000000000000\nR13: ffff888ef82b0960 R14: ffffc9000adbfb80 R15: ffffffffffffffe8\nFS:  00007fdcba4c4740(0000) GS:ffff889033780000(0000) knlGS:0000000000000000\nCS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033\nCR2: ffffffffffffffe8 CR3: 0000000f776a0004 CR4: 00000000001606e0\nKernel panic - not syncing: Fatal exception\nKernel Offset: 0x29800000 from 0xffffffff81000000 (relocation range: 0xffffffff80000000-0xffffffffbfffffff)\n---[ end Kernel panic - not syncing: Fatal exception ]\u2014\n\nwhich is due to error injection (or allocation failure) preventing the\nrings from being setup. On shutdown, we attempt to remove any pending\nrequests, and for poll request, we call io_cqring_ev_posted() when we've\nkilled poll requests. However, since the rings aren't setup, we won't\nfind any poll requests. Make the calling of io_cqring_ev_posted()\ndependent on actually having completed requests. This fixes this setup\ncorner case, and removes spurious calls if we remove poll requests and\ndon't find any.\n\nReported-by: Qian Cai <cai@lca.pw>\nSigned-off-by: Jens Axboe <axboe@kernel.dk>",
  "author_name": "Jens Axboe",
  "author_email": "axboe@kernel.dk",
  "author_date": "Mon Apr 13 17:05:14 2020 -0600",
  "author_date_iso": "2020-04-13T17:05:14-06:00",
  "committer_name": "Jens Axboe",
  "committer_email": "axboe@kernel.dk",
  "committer_date": "Mon Apr 13 17:05:14 2020 -0600",
  "committer_date_iso": "2020-04-13T17:05:14-06:00",
  "files_changed": [
    "fs/io_uring.c"
  ],
  "files_changed_count": 1,
  "stats": [
    {
      "file": "fs/io_uring.c",
      "insertions": 4,
      "deletions": 3
    }
  ],
  "total_insertions": 4,
  "total_deletions": 3,
  "total_changes": 7,
  "parents": [
    "2bae047ec9576da72d5003487de0bb93e747fff7"
  ],
  "branches": [
    "* development",
    "master",
    "remotes/origin/HEAD -> origin/master",
    "remotes/origin/master"
  ],
  "tags": [],
  "is_merge": false,
  "security_info": {
    "cve_ids": [],
    "security_keywords": [
      "injection"
    ]
  },
  "fix_type": "security",
  "file_results": [
    {
      "file": "fs/io_uring.c",
      "pre_version": true,
      "post_version": true,
      "patch": true
    }
  ]
}