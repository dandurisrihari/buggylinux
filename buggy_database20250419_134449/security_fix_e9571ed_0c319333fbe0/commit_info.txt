Commit Hash: e9571ed54b2a290d61b98ad6f369f963159fe6da
Subject: KVM: fix kvm_vcpu_kick vs __vcpu_run race


Security Keywords:
- Injection

Full commit message:
KVM: fix kvm_vcpu_kick vs __vcpu_run race

There is a window open between testing of pending IRQ's
and assignment of guest_mode in __vcpu_run.

Injection of IRQ's can race with __vcpu_run as follows:

CPU0                                CPU1
kvm_x86_ops->run()
vcpu->guest_mode = 0                SET_IRQ_LINE ioctl
..
kvm_x86_ops->inject_pending_irq
kvm_cpu_has_interrupt()

                                    apic_test_and_set_irr()
                                    kvm_vcpu_kick
                                    if (vcpu->guest_mode)
                                        send_ipi()

vcpu->guest_mode = 1

So move guest_mode=1 assignment before ->inject_pending_irq, and make
sure that it won't reorder after it.

Signed-off-by: Marcelo Tosatti <mtosatti@redhat.com>
Signed-off-by: Avi Kivity <avi@qumranet.com>

Metadata:
Author: Marcelo Tosatti <mtosatti@redhat.com>
Author Date: Fri Apr 11 15:01:22 2008 -0300
Committer: Avi Kivity <avi@qumranet.com>
Commit Date: Sun Apr 27 18:21:32 2008 +0300

Files Changed: 1
Lines Added: 14
Lines Removed: 2
Total Changes: 16
