{
  "hash": "cccf748b810832cfab4dbb3ed4c7cf1a1ee35ad2",
  "hash_short": "cccf748b",
  "subject": "[PATCH] KVM: fix race between mmio reads and injected interrupts",
  "body": "The kvm mmio read path looks like:\n\n 1. guest read faults\n 2. kvm emulates read, calls emulator_read_emulated()\n 3. fails as a read requires userspace help\n 4. exit to userspace\n 5. userspace emulates read, kvm sets vcpu->mmio_read_completed\n 6. re-enter guest, fault again\n 7. kvm emulates read, calls emulator_read_emulated()\n 8. succeeds as vcpu->mmio_read_emulated is set\n 9. instruction completes and guest is resumed\n\nA problem surfaces if the userspace exit (step 5) also requests an interrupt\ninjection.  In that case, the guest does not re-execute the original\ninstruction, but the interrupt handler.  The next time an mmio read is\nexectued (likely for a different address), step 3 will find\nvcpu->mmio_read_completed set and return the value read for the original\ninstruction.\n\nThe problem manifested itself in a few annoying ways:\n- little squares appear randomly on console when switching virtual terminals\n- ne2000 fails under nfs read load\n- rtl8139 complains about \"pci errors\" even though the device model is\n  incapable of issuing them.\n\nFix by skipping interrupt injection if an mmio read is pending.\n\nA better fix is to avoid re-entry into the guest, and re-emulating immediately\ninstead.  However that's a bit more complex.\n\nSigned-off-by: Avi Kivity <avi@qumranet.com>\nCc: Ingo Molnar <mingo@elte.hu>\nSigned-off-by: Andrew Morton <akpm@osdl.org>\nSigned-off-by: Linus Torvalds <torvalds@linux-foundation.org>",
  "full_message": "[PATCH] KVM: fix race between mmio reads and injected interrupts\n\nThe kvm mmio read path looks like:\n\n 1. guest read faults\n 2. kvm emulates read, calls emulator_read_emulated()\n 3. fails as a read requires userspace help\n 4. exit to userspace\n 5. userspace emulates read, kvm sets vcpu->mmio_read_completed\n 6. re-enter guest, fault again\n 7. kvm emulates read, calls emulator_read_emulated()\n 8. succeeds as vcpu->mmio_read_emulated is set\n 9. instruction completes and guest is resumed\n\nA problem surfaces if the userspace exit (step 5) also requests an interrupt\ninjection.  In that case, the guest does not re-execute the original\ninstruction, but the interrupt handler.  The next time an mmio read is\nexectued (likely for a different address), step 3 will find\nvcpu->mmio_read_completed set and return the value read for the original\ninstruction.\n\nThe problem manifested itself in a few annoying ways:\n- little squares appear randomly on console when switching virtual terminals\n- ne2000 fails under nfs read load\n- rtl8139 complains about \"pci errors\" even though the device model is\n  incapable of issuing them.\n\nFix by skipping interrupt injection if an mmio read is pending.\n\nA better fix is to avoid re-entry into the guest, and re-emulating immediately\ninstead.  However that's a bit more complex.\n\nSigned-off-by: Avi Kivity <avi@qumranet.com>\nCc: Ingo Molnar <mingo@elte.hu>\nSigned-off-by: Andrew Morton <akpm@osdl.org>\nSigned-off-by: Linus Torvalds <torvalds@linux-foundation.org>",
  "author_name": "Avi Kivity",
  "author_email": "avi@qumranet.com",
  "author_date": "Mon Jan 22 20:40:39 2007 -0800",
  "author_date_iso": "2007-01-22T20:40:39-08:00",
  "committer_name": "Linus Torvalds",
  "committer_email": "torvalds@woody.linux-foundation.org",
  "committer_date": "Tue Jan 23 07:52:06 2007 -0800",
  "committer_date_iso": "2007-01-23T07:52:06-08:00",
  "files_changed": [
    "drivers/kvm/svm.c",
    "drivers/kvm/vmx.c"
  ],
  "files_changed_count": 2,
  "stats": [
    {
      "file": "drivers/kvm/svm.c",
      "insertions": 2,
      "deletions": 1
    },
    {
      "file": "drivers/kvm/vmx.c",
      "insertions": 2,
      "deletions": 1
    }
  ],
  "total_insertions": 4,
  "total_deletions": 2,
  "total_changes": 6,
  "parents": [
    "084384754ebe6636f9e5554ad30b3143b4a26c84"
  ],
  "branches": [
    "* development",
    "master",
    "remotes/origin/HEAD -> origin/master",
    "remotes/origin/master"
  ],
  "tags": [
    "v2.6.20",
    "v2.6.20-rc6",
    "v2.6.20-rc7",
    "v2.6.21",
    "v2.6.21-rc1",
    "v2.6.21-rc2",
    "v2.6.21-rc3",
    "v2.6.21-rc4",
    "v2.6.21-rc5",
    "v2.6.21-rc6"
  ],
  "is_merge": false,
  "security_info": {
    "cve_ids": [],
    "security_keywords": [
      "injection"
    ]
  },
  "fix_type": "security",
  "file_results": [
    {
      "file": "drivers/kvm/svm.c",
      "pre_version": false,
      "post_version": true,
      "patch": true
    },
    {
      "file": "drivers/kvm/vmx.c",
      "pre_version": false,
      "post_version": true,
      "patch": true
    }
  ]
}