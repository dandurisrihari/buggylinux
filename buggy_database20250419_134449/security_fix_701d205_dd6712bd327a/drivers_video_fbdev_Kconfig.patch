commit 701d2054fa317188cd4039c84e72c73254013b23
Author: Thomas Zimmermann <tzimmermann@suse.de>
Date:   Tue Jun 13 13:07:13 2023 +0200

    fbdev: Make support for userspace interfaces configurable
    
    Add Kconfig option CONFIG_FB_DEVICE and make the virtual fbdev
    device optional. If the new option has not been selected, fbdev
    does not create files in devfs, sysfs or procfs.
    
    Most modern Linux systems run a DRM-based graphics stack that uses
    the kernel's framebuffer console, but has otherwise deprecated fbdev
    support. Yet fbdev userspace interfaces are still present.
    
    The option makes it possible to use the fbdev subsystem as console
    implementation without support for userspace. This closes potential
    entry points to manipulate kernel or I/O memory via framebuffers. It
    also prevents the execution of driver code via ioctl or sysfs, both
    of which might allow malicious software to exploit bugs in the fbdev
    code.
    
    A small number of fbdev drivers require struct fbinfo.dev to be
    initialized, usually for the support of sysfs interface. Make these
    drivers depend on FB_DEVICE. They can later be fixed if necessary.
    
    v3:
            * effect -> affect in Kconfig help (Daniel)
    v2:
            * set FB_DEVICE default to y (Geert)
            * comment on {get,put}_device() (Sam)
            * Kconfig fixes (Sam)
            * add TODO item about FB_DEVICE dependencies (Sam)
    
    Signed-off-by: Thomas Zimmermann <tzimmermann@suse.de>
    Acked-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
    Reviewed-by: Sam Ravnborg <sam@ravnborg.org>
    Link: https://patchwork.freedesktop.org/patch/msgid/20230613110953.24176-39-tzimmermann@suse.de

diff --git a/drivers/video/fbdev/Kconfig b/drivers/video/fbdev/Kconfig
index 6df9bd09454a..cecf15418632 100644
--- a/drivers/video/fbdev/Kconfig
+++ b/drivers/video/fbdev/Kconfig
@@ -57,6 +57,16 @@ config FIRMWARE_EDID
 	  combination with certain motherboards and monitors are known to
 	  suffer from this problem.
 
+config FB_DEVICE
+	bool "Provide legacy /dev/fb* device"
+	depends on FB
+	default y
+	help
+	  Say Y here if you want the legacy /dev/fb* device file and
+	  interfaces within sysfs anc procfs. It is only required if you
+	  have userspace programs that depend on fbdev for graphics output.
+	  This does not affect the framebuffer console. If unsure, say N.
+
 config FB_DDC
 	tristate
 	depends on FB
@@ -1545,6 +1555,7 @@ config FB_3DFX_I2C
 config FB_VOODOO1
 	tristate "3Dfx Voodoo Graphics (sst1) support"
 	depends on FB && PCI
+	depends on FB_DEVICE
 	select FB_CFB_FILLRECT
 	select FB_CFB_COPYAREA
 	select FB_CFB_IMAGEBLIT
@@ -1862,6 +1873,7 @@ config FB_SH_MOBILE_LCDC
 	tristate "SuperH Mobile LCDC framebuffer support"
 	depends on FB && HAVE_CLK && HAS_IOMEM
 	depends on SUPERH || ARCH_RENESAS || COMPILE_TEST
+	depends on FB_DEVICE
 	select FB_SYS_FILLRECT
 	select FB_SYS_COPYAREA
 	select FB_SYS_IMAGEBLIT
@@ -1930,6 +1942,7 @@ config FB_SMSCUFX
 config FB_UDL
 	tristate "Displaylink USB Framebuffer support"
 	depends on FB && USB
+	depends on FB_DEVICE
 	select FB_MODE_HELPERS
 	select FB_SYS_FILLRECT
 	select FB_SYS_COPYAREA