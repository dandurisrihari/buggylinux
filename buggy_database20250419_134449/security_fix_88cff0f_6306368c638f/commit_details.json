{
  "hash": "88cff0f0fbcf64cb6c2fbad6cf57e2725475d0ee",
  "hash_short": "88cff0f0",
  "subject": "UBIFS: return -EINVAL if log head is empty",
  "body": "CS node is recognized as a sign in UBIFS log replay mechanism.\nLog relaying during mount should find the CS node in log head\nat beginning and then replay the following uncommitted buds.\n\nHere is a bug in log replay path: If the log head, which is\nindicated by @log_lnum in mst_node, is empty, current UBIFS\nreplay nothing and directly mount the partition without any\nwarning. This action will put filesystem in an abnormal state,\ne.g. space management in LPT area is incorrect to the real\nspace usage in main area.\n\nWe reproduced this bug by fault injection: turn log head leb\ninto all 0xFF. UBIFS driver mount the polluted partition\nnormally. But errors occur while running fs_stress on this\nmount:\n\n[89068.055183] UBI error: ubi_io_read: error -74 (ECC error) while reading 59 bytes from PEB 711:33088, read 59 bytes\n[89068.179877] UBIFS error (pid 10517): ubifs_check_node: bad magic 0x101031, expected 0x6101831\n[89068.179882] UBIFS error (pid 10517): ubifs_check_node: bad node at LEB 591:28992\n[89068.179891] Not a node, first 24 bytes:\n[89068.179892] 00000000: 31 10 10 00 37 84 64 04 10 04 00 00 00 00 00 00 20 00 00 00 02 01 00 00                          1...7.d......... .......\n[89068.180282] UBIFS error (pid 10517): ubifs_read_node: expected node type 2\n\nThis patch fix the problem by checking *lnum* to guarantee\nthe empty leb is not log head leb and return an error if the\nlog head leb is incorrectly empty. After this, we could catch\n*log head empty* error in place.\n\nSigned-off-by: hujianyang <hujianyang@huawei.com>\nSigned-off-by: Artem Bityutskiy <artem.bityutskiy@linux.intel.com>",
  "full_message": "UBIFS: return -EINVAL if log head is empty\n\nCS node is recognized as a sign in UBIFS log replay mechanism.\nLog relaying during mount should find the CS node in log head\nat beginning and then replay the following uncommitted buds.\n\nHere is a bug in log replay path: If the log head, which is\nindicated by @log_lnum in mst_node, is empty, current UBIFS\nreplay nothing and directly mount the partition without any\nwarning. This action will put filesystem in an abnormal state,\ne.g. space management in LPT area is incorrect to the real\nspace usage in main area.\n\nWe reproduced this bug by fault injection: turn log head leb\ninto all 0xFF. UBIFS driver mount the polluted partition\nnormally. But errors occur while running fs_stress on this\nmount:\n\n[89068.055183] UBI error: ubi_io_read: error -74 (ECC error) while reading 59 bytes from PEB 711:33088, read 59 bytes\n[89068.179877] UBIFS error (pid 10517): ubifs_check_node: bad magic 0x101031, expected 0x6101831\n[89068.179882] UBIFS error (pid 10517): ubifs_check_node: bad node at LEB 591:28992\n[89068.179891] Not a node, first 24 bytes:\n[89068.179892] 00000000: 31 10 10 00 37 84 64 04 10 04 00 00 00 00 00 00 20 00 00 00 02 01 00 00                          1...7.d......... .......\n[89068.180282] UBIFS error (pid 10517): ubifs_read_node: expected node type 2\n\nThis patch fix the problem by checking *lnum* to guarantee\nthe empty leb is not log head leb and return an error if the\nlog head leb is incorrectly empty. After this, we could catch\n*log head empty* error in place.\n\nSigned-off-by: hujianyang <hujianyang@huawei.com>\nSigned-off-by: Artem Bityutskiy <artem.bityutskiy@linux.intel.com>",
  "author_name": "hujianyang",
  "author_email": "hujianyang@huawei.com",
  "author_date": "Tue Feb 10 11:28:57 2015 +0800",
  "author_date_iso": "2015-02-10T11:28:57+08:00",
  "committer_name": "Artem Bityutskiy",
  "committer_email": "artem.bityutskiy@linux.intel.com",
  "committer_date": "Tue Feb 10 10:06:24 2015 +0200",
  "committer_date_iso": "2015-02-10T10:06:24+02:00",
  "files_changed": [
    "fs/ubifs/replay.c"
  ],
  "files_changed_count": 1,
  "stats": [
    {
      "file": "fs/ubifs/replay.c",
      "insertions": 16,
      "deletions": 3
    }
  ],
  "total_insertions": 16,
  "total_deletions": 3,
  "total_changes": 19,
  "parents": [
    "832b52a15085d04039b01cec56845d3972c2f301"
  ],
  "branches": [
    "* development",
    "master",
    "remotes/origin/HEAD -> origin/master",
    "remotes/origin/master"
  ],
  "tags": [
    "v4.0",
    "v4.0-rc1",
    "v4.0-rc2",
    "v4.0-rc3",
    "v4.0-rc4",
    "v4.0-rc5",
    "v4.0-rc6",
    "v4.0-rc7",
    "v4.1",
    "v4.1-rc1"
  ],
  "is_merge": false,
  "security_info": {
    "cve_ids": [],
    "security_keywords": [
      "injection"
    ]
  },
  "fix_type": "security",
  "file_results": [
    {
      "file": "fs/ubifs/replay.c",
      "pre_version": false,
      "post_version": true,
      "patch": true
    }
  ]
}