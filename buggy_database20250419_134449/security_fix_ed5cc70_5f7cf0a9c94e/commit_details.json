{
  "hash": "ed5cc702d311c14b653323d76062b0294effa66e",
  "hash_short": "ed5cc702",
  "subject": "block: Add config option to not allow writing to mounted devices",
  "body": "Writing to mounted devices is dangerous and can lead to filesystem\ncorruption as well as crashes. Furthermore syzbot comes with more and\nmore involved examples how to corrupt block device under a mounted\nfilesystem leading to kernel crashes and reports we can do nothing\nabout. Add tracking of writers to each block device and a kernel cmdline\nargument which controls whether other writeable opens to block devices\nopen with BLK_OPEN_RESTRICT_WRITES flag are allowed. We will make\nfilesystems use this flag for used devices.\n\nNote that this effectively only prevents modification of the particular\nblock device's page cache by other writers. The actual device content\ncan still be modified by other means - e.g. by issuing direct scsi\ncommands, by doing writes through devices lower in the storage stack\n(e.g. in case loop devices, DM, or MD are involved) etc. But blocking\ndirect modifications of the block device page cache is enough to give\nfilesystems a chance to perform data validation when loading data from\nthe underlying storage and thus prevent kernel crashes.\n\nSyzbot can use this cmdline argument option to avoid uninteresting\ncrashes. Also users whose userspace setup does not need writing to\nmounted block devices can set this option for hardening.\n\nLink: https://lore.kernel.org/all/60788e5d-5c7c-1142-e554-c21d709acfd9@linaro.org\nSigned-off-by: Jan Kara <jack@suse.cz>\nLink: https://lore.kernel.org/r/20231101174325.10596-3-jack@suse.cz\nReviewed-by: Jens Axboe <axboe@kernel.dk>\nSigned-off-by: Christian Brauner <brauner@kernel.org>",
  "full_message": "block: Add config option to not allow writing to mounted devices\n\nWriting to mounted devices is dangerous and can lead to filesystem\ncorruption as well as crashes. Furthermore syzbot comes with more and\nmore involved examples how to corrupt block device under a mounted\nfilesystem leading to kernel crashes and reports we can do nothing\nabout. Add tracking of writers to each block device and a kernel cmdline\nargument which controls whether other writeable opens to block devices\nopen with BLK_OPEN_RESTRICT_WRITES flag are allowed. We will make\nfilesystems use this flag for used devices.\n\nNote that this effectively only prevents modification of the particular\nblock device's page cache by other writers. The actual device content\ncan still be modified by other means - e.g. by issuing direct scsi\ncommands, by doing writes through devices lower in the storage stack\n(e.g. in case loop devices, DM, or MD are involved) etc. But blocking\ndirect modifications of the block device page cache is enough to give\nfilesystems a chance to perform data validation when loading data from\nthe underlying storage and thus prevent kernel crashes.\n\nSyzbot can use this cmdline argument option to avoid uninteresting\ncrashes. Also users whose userspace setup does not need writing to\nmounted block devices can set this option for hardening.\n\nLink: https://lore.kernel.org/all/60788e5d-5c7c-1142-e554-c21d709acfd9@linaro.org\nSigned-off-by: Jan Kara <jack@suse.cz>\nLink: https://lore.kernel.org/r/20231101174325.10596-3-jack@suse.cz\nReviewed-by: Jens Axboe <axboe@kernel.dk>\nSigned-off-by: Christian Brauner <brauner@kernel.org>",
  "author_name": "Jan Kara",
  "author_email": "jack@suse.cz",
  "author_date": "Wed Nov 1 18:43:08 2023 +0100",
  "author_date_iso": "2023-11-01T18:43:08+01:00",
  "committer_name": "Christian Brauner",
  "committer_email": "brauner@kernel.org",
  "committer_date": "Sat Nov 18 14:59:25 2023 +0100",
  "committer_date_iso": "2023-11-18T14:59:25+01:00",
  "files_changed": [
    "block/Kconfig",
    "block/bdev.c",
    "include/linux/blk_types.h",
    "include/linux/blkdev.h"
  ],
  "files_changed_count": 4,
  "stats": [
    {
      "file": "block/Kconfig",
      "insertions": 20,
      "deletions": 0
    },
    {
      "file": "block/bdev.c",
      "insertions": 74,
      "deletions": 1
    },
    {
      "file": "include/linux/blk_types.h",
      "insertions": 1,
      "deletions": 0
    },
    {
      "file": "include/linux/blkdev.h",
      "insertions": 2,
      "deletions": 0
    }
  ],
  "total_insertions": 97,
  "total_deletions": 1,
  "total_changes": 98,
  "parents": [
    "cd34758c5238ae6976b10fe15bba7031b409c969"
  ],
  "branches": [
    "* development",
    "remotes/origin/HEAD -> origin/master",
    "remotes/origin/master"
  ],
  "tags": [],
  "is_merge": false,
  "security_info": {
    "cve_ids": [],
    "security_keywords": [
      "hardening"
    ]
  },
  "fix_type": "security",
  "file_results": [
    {
      "file": "block/Kconfig",
      "pre_version": false,
      "post_version": true,
      "patch": true
    },
    {
      "file": "block/bdev.c",
      "pre_version": true,
      "post_version": true,
      "patch": true
    },
    {
      "file": "include/linux/blk_types.h",
      "pre_version": false,
      "post_version": true,
      "patch": true
    },
    {
      "file": "include/linux/blkdev.h",
      "pre_version": true,
      "post_version": true,
      "patch": true
    }
  ]
}