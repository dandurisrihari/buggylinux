Commit Hash: a282a2f10539dce2aa619e71e1817570d557fc97
Subject: libceph: harden msgr2.1 frame segment length checks


Security Keywords:
- AUTH

Full commit message:
libceph: harden msgr2.1 frame segment length checks

ceph_frame_desc::fd_lens is an int array.  decode_preamble() thus
effectively casts u32 -> int but the checks for segment lengths are
written as if on unsigned values.  While reading in HELLO or one of the
AUTH frames (before authentication is completed), arithmetic in
head_onwire_len() can get duped by negative ctrl_len and produce
head_len which is less than CEPH_PREAMBLE_LEN but still positive.
This would lead to a buffer overrun in prepare_read_control() as the
preamble gets copied to the newly allocated buffer of size head_len.

Cc: stable@vger.kernel.org
Fixes: cd1a677cad99 ("libceph, ceph: implement msgr2.1 protocol (crc and secure modes)")
Reported-by: Thelford Williams <thelford@google.com>
Signed-off-by: Ilya Dryomov <idryomov@gmail.com>
Reviewed-by: Xiubo Li <xiubli@redhat.com>

Metadata:
Author: Ilya Dryomov <idryomov@gmail.com>
Author Date: Mon Jul 10 20:39:29 2023 +0200
Committer: Ilya Dryomov <idryomov@gmail.com>
Commit Date: Thu Jul 13 13:18:57 2023 +0200

Files Changed: 1
Lines Added: 26
Lines Removed: 15
Total Changes: 41
