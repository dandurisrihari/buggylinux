{
  "hash": "d9f89b4e9290e46cd9b273e9ad0bff0f93e86fae",
  "hash_short": "d9f89b4e",
  "subject": "KVM: arm/arm64: PMU: Fix overflow interrupt injection",
  "body": "kvm_pmu_overflow_set() is called from perf's interrupt handler,\nmaking the call of kvm_vgic_inject_irq() from it introduced with\n\"KVM: arm/arm64: PMU: remove request-less vcpu kick\" a really bad\nidea, as it's quite easy to try and retake a lock that the\ninterrupted context is already holding. The fix is to use a vcpu\nkick, leaving the interrupt injection to kvm_pmu_sync_hwstate(),\nlike it was doing before the refactoring. We don't just revert,\nthough, because before the kick was request-less, leaving the vcpu\nexposed to the request-less vcpu kick race, and also because the\nkick was used unnecessarily from register access handlers.\n\nReviewed-by: Christoffer Dall <cdall@linaro.org>\nSigned-off-by: Andrew Jones <drjones@redhat.com>\nSigned-off-by: Marc Zyngier <marc.zyngier@arm.com>",
  "full_message": "KVM: arm/arm64: PMU: Fix overflow interrupt injection\n\nkvm_pmu_overflow_set() is called from perf's interrupt handler,\nmaking the call of kvm_vgic_inject_irq() from it introduced with\n\"KVM: arm/arm64: PMU: remove request-less vcpu kick\" a really bad\nidea, as it's quite easy to try and retake a lock that the\ninterrupted context is already holding. The fix is to use a vcpu\nkick, leaving the interrupt injection to kvm_pmu_sync_hwstate(),\nlike it was doing before the refactoring. We don't just revert,\nthough, because before the kick was request-less, leaving the vcpu\nexposed to the request-less vcpu kick race, and also because the\nkick was used unnecessarily from register access handlers.\n\nReviewed-by: Christoffer Dall <cdall@linaro.org>\nSigned-off-by: Andrew Jones <drjones@redhat.com>\nSigned-off-by: Marc Zyngier <marc.zyngier@arm.com>",
  "author_name": "Andrew Jones",
  "author_email": "drjones@redhat.com",
  "author_date": "Sat Jul 1 18:26:54 2017 +0200",
  "author_date_iso": "2017-07-01T18:26:54+02:00",
  "committer_name": "Marc Zyngier",
  "committer_email": "marc.zyngier@arm.com",
  "committer_date": "Tue Jul 25 14:18:01 2017 +0100",
  "committer_date_iso": "2017-07-25T14:18:01+01:00",
  "files_changed": [
    "arch/arm64/kvm/sys_regs.c",
    "include/kvm/arm_pmu.h",
    "virt/kvm/arm/pmu.c"
  ],
  "files_changed_count": 3,
  "stats": [
    {
      "file": "arch/arm64/kvm/sys_regs.c",
      "insertions": 1,
      "deletions": 1
    },
    {
      "file": "include/kvm/arm_pmu.h",
      "insertions": 0,
      "deletions": 2
    },
    {
      "file": "virt/kvm/arm/pmu.c",
      "insertions": 15,
      "deletions": 28
    }
  ],
  "total_insertions": 16,
  "total_deletions": 31,
  "total_changes": 47,
  "parents": [
    "79962a5c8ba5b33f49d88a058e2124bf2ff3c034"
  ],
  "branches": [
    "* development",
    "master",
    "remotes/origin/HEAD -> origin/master",
    "remotes/origin/master"
  ],
  "tags": [
    "v4.13",
    "v4.13-rc4",
    "v4.13-rc5",
    "v4.13-rc6",
    "v4.13-rc7",
    "v4.14",
    "v4.14-rc1",
    "v4.14-rc2",
    "v4.14-rc3",
    "v4.14-rc4"
  ],
  "is_merge": false,
  "security_info": {
    "cve_ids": [],
    "security_keywords": [
      "injection"
    ]
  },
  "fix_type": "security",
  "file_results": [
    {
      "file": "arch/arm64/kvm/sys_regs.c",
      "pre_version": false,
      "post_version": true,
      "patch": true
    },
    {
      "file": "include/kvm/arm_pmu.h",
      "pre_version": false,
      "post_version": true,
      "patch": true
    },
    {
      "file": "virt/kvm/arm/pmu.c",
      "pre_version": false,
      "post_version": true,
      "patch": true
    }
  ]
}