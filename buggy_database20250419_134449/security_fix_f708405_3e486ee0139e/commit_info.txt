Commit Hash: f7084059a9cb9e56a186e1677b1dcffd76c2cd24
Subject: bnx2x: Improve reliability in case of nested PCI errors


Security Keywords:
- injection

Full commit message:
bnx2x: Improve reliability in case of nested PCI errors

While in recovery process of PCI error (called EEH on PowerPC arch),
another PCI transaction could be corrupted causing a situation of
nested PCI errors. Also, this scenario could be reproduced with
error injection mechanisms (for debug purposes).

We observe that in case of nested PCI errors, bnx2x might attempt to
initialize its shmem and cause a kernel crash due to bad addresses
read from MCP. Multiple different stack traces were observed depending
on the point the second PCI error happens.

This patch avoids the crashes by:

 * failing PCI recovery in case of nested errors (since multiple
 PCI errors in a row are not expected to lead to a functional
 adapter anyway), and by,

 * preventing access to adapter FW when MCP is failed (we mark it as
 failed when shmem cannot get initialized properly).

Reported-by: Abdul Haleem <abdhalee@linux.vnet.ibm.com>
Signed-off-by: Guilherme G. Piccoli <gpiccoli@linux.vnet.ibm.com>
Acked-by: Shahed Shaikh <Shahed.Shaikh@cavium.com>
Signed-off-by: David S. Miller <davem@davemloft.net>

Metadata:
Author: Guilherme G. Piccoli <gpiccoli@linux.vnet.ibm.com>
Author Date: Fri Dec 22 13:01:39 2017 -0200
Committer: David S. Miller <davem@davemloft.net>
Commit Date: Wed Dec 27 12:13:32 2017 -0500

Files Changed: 2
Lines Added: 15
Lines Removed: 3
Total Changes: 18
