{
  "hash": "07bf9431b1590d1cd7a8d62075d0b50b073f0495",
  "hash_short": "07bf9431",
  "subject": "powerpc/papr_scm: don't requests stats with '0' sized stats buffer",
  "body": "Sachin reported [1] that on a POWER-10 lpar he is seeing a kernel panic being\nreported with vPMEM when papr_scm probe is being called. The panic is of the\nform below and is observed only with following option disabled(profile) for the\nsaid LPAR 'Enable Performance Information Collection' in the HMC:\n\n Kernel attempted to write user page (1c) - exploit attempt? (uid: 0)\n BUG: Kernel NULL pointer dereference on write at 0x0000001c\n Faulting instruction address: 0xc008000001b90844\n Oops: Kernel access of bad area, sig: 11 [#1]\n<snip>\n NIP [c008000001b90844] drc_pmem_query_stats+0x5c/0x270 [papr_scm]\n LR [c008000001b92794] papr_scm_probe+0x2ac/0x6ec [papr_scm]\n Call Trace:\n       0xc00000000941bca0 (unreliable)\n       papr_scm_probe+0x2ac/0x6ec [papr_scm]\n       platform_probe+0x98/0x150\n       really_probe+0xfc/0x510\n       __driver_probe_device+0x17c/0x230\n<snip>\n ---[ end trace 0000000000000000 ]---\n Kernel panic - not syncing: Fatal exception\n\nOn investigation looks like this panic was caused due to a 'stat_buffer' of\nsize==0 being provided to drc_pmem_query_stats() to fetch all performance\nstats-ids of an NVDIMM. However drc_pmem_query_stats() shouldn't have been called\nsince the vPMEM NVDIMM doesn't support and performance stat-id's. This was caused\ndue to missing check for 'p->stat_buffer_len' at the beginning of\npapr_scm_pmu_check_events() which indicates that the NVDIMM doesn't support\nperformance-stats.\n\nFix this by introducing the check for 'p->stat_buffer_len' at the beginning of\npapr_scm_pmu_check_events().\n\n[1] https://lore.kernel.org/all/6B3A522A-6A5F-4CC9-B268-0C63AA6E07D3@linux.ibm.com\n\nFixes: 0e0946e22f3665d2732 (\"powerpc/papr_scm: Fix leaking nvdimm_events_map elements\")\nReported-by: Sachin Sant <sachinp@linux.ibm.com>\nSigned-off-by: Vaibhav Jain <vaibhav@linux.ibm.com>\nTested-by: Sachin Sant <sachinp@linux.ibm.com>\nSigned-off-by: Michael Ellerman <mpe@ellerman.id.au>\nLink: https://lore.kernel.org/r/20220524112353.1718454-1-vaibhav@linux.ibm.com",
  "full_message": "powerpc/papr_scm: don't requests stats with '0' sized stats buffer\n\nSachin reported [1] that on a POWER-10 lpar he is seeing a kernel panic being\nreported with vPMEM when papr_scm probe is being called. The panic is of the\nform below and is observed only with following option disabled(profile) for the\nsaid LPAR 'Enable Performance Information Collection' in the HMC:\n\n Kernel attempted to write user page (1c) - exploit attempt? (uid: 0)\n BUG: Kernel NULL pointer dereference on write at 0x0000001c\n Faulting instruction address: 0xc008000001b90844\n Oops: Kernel access of bad area, sig: 11 [#1]\n<snip>\n NIP [c008000001b90844] drc_pmem_query_stats+0x5c/0x270 [papr_scm]\n LR [c008000001b92794] papr_scm_probe+0x2ac/0x6ec [papr_scm]\n Call Trace:\n       0xc00000000941bca0 (unreliable)\n       papr_scm_probe+0x2ac/0x6ec [papr_scm]\n       platform_probe+0x98/0x150\n       really_probe+0xfc/0x510\n       __driver_probe_device+0x17c/0x230\n<snip>\n ---[ end trace 0000000000000000 ]---\n Kernel panic - not syncing: Fatal exception\n\nOn investigation looks like this panic was caused due to a 'stat_buffer' of\nsize==0 being provided to drc_pmem_query_stats() to fetch all performance\nstats-ids of an NVDIMM. However drc_pmem_query_stats() shouldn't have been called\nsince the vPMEM NVDIMM doesn't support and performance stat-id's. This was caused\ndue to missing check for 'p->stat_buffer_len' at the beginning of\npapr_scm_pmu_check_events() which indicates that the NVDIMM doesn't support\nperformance-stats.\n\nFix this by introducing the check for 'p->stat_buffer_len' at the beginning of\npapr_scm_pmu_check_events().\n\n[1] https://lore.kernel.org/all/6B3A522A-6A5F-4CC9-B268-0C63AA6E07D3@linux.ibm.com\n\nFixes: 0e0946e22f3665d2732 (\"powerpc/papr_scm: Fix leaking nvdimm_events_map elements\")\nReported-by: Sachin Sant <sachinp@linux.ibm.com>\nSigned-off-by: Vaibhav Jain <vaibhav@linux.ibm.com>\nTested-by: Sachin Sant <sachinp@linux.ibm.com>\nSigned-off-by: Michael Ellerman <mpe@ellerman.id.au>\nLink: https://lore.kernel.org/r/20220524112353.1718454-1-vaibhav@linux.ibm.com",
  "author_name": "Vaibhav Jain",
  "author_email": "vaibhav@linux.ibm.com",
  "author_date": "Tue May 24 16:53:53 2022 +0530",
  "author_date_iso": "2022-05-24T16:53:53+05:30",
  "committer_name": "Michael Ellerman",
  "committer_email": "mpe@ellerman.id.au",
  "committer_date": "Tue May 31 10:18:52 2022 +1000",
  "committer_date_iso": "2022-05-31T10:18:52+10:00",
  "files_changed": [
    "arch/powerpc/platforms/pseries/papr_scm.c"
  ],
  "files_changed_count": 1,
  "stats": [
    {
      "file": "arch/powerpc/platforms/pseries/papr_scm.c",
      "insertions": 3,
      "deletions": 0
    }
  ],
  "total_insertions": 3,
  "total_deletions": 0,
  "total_changes": 3,
  "parents": [
    "1346d00e1bdfd4067f92bc14e8a6131a01de4190"
  ],
  "branches": [
    "* development",
    "remotes/origin/HEAD -> origin/master",
    "remotes/origin/master"
  ],
  "tags": [],
  "is_merge": false,
  "security_info": {
    "cve_ids": [],
    "security_keywords": [
      "exploit"
    ]
  },
  "fix_type": "security",
  "file_results": [
    {
      "file": "arch/powerpc/platforms/pseries/papr_scm.c",
      "pre_version": false,
      "post_version": true,
      "patch": true
    }
  ]
}