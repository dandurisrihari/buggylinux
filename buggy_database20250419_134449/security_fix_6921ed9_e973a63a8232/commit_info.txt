Commit Hash: 6921ed9049bc7457f66c1596c5b78aec0dae4a9d
Subject: x86/speculation: Allow enabling STIBP with legacy IBRS


Security Keywords:
- injection

Full commit message:
x86/speculation: Allow enabling STIBP with legacy IBRS

When plain IBRS is enabled (not enhanced IBRS), the logic in
spectre_v2_user_select_mitigation() determines that STIBP is not needed.

The IBRS bit implicitly protects against cross-thread branch target
injection. However, with legacy IBRS, the IBRS bit is cleared on
returning to userspace for performance reasons which leaves userspace
threads vulnerable to cross-thread branch target injection against which
STIBP protects.

Exclude IBRS from the spectre_v2_in_ibrs_mode() check to allow for
enabling STIBP (through seccomp/prctl() by default or always-on, if
selected by spectre_v2_user kernel cmdline parameter).

  [ bp: Massage. ]

Fixes: 7c693f54c873 ("x86/speculation: Add spectre_v2=ibrs option to support Kernel IBRS")
Reported-by: Jos√© Oliveira <joseloliveira11@gmail.com>
Reported-by: Rodrigo Branco <rodrigo@kernelhacking.com>
Signed-off-by: KP Singh <kpsingh@kernel.org>
Signed-off-by: Borislav Petkov (AMD) <bp@alien8.de>
Cc: stable@vger.kernel.org
Link: https://lore.kernel.org/r/20230220120127.1975241-1-kpsingh@kernel.org
Link: https://lore.kernel.org/r/20230221184908.2349578-1-kpsingh@kernel.org

Metadata:
Author: KP Singh <kpsingh@kernel.org>
Author Date: Mon Feb 27 07:05:40 2023 +0100
Committer: Borislav Petkov (AMD) <bp@alien8.de>
Commit Date: Mon Feb 27 18:57:09 2023 +0100

Files Changed: 1
Lines Added: 18
Lines Removed: 7
Total Changes: 25
