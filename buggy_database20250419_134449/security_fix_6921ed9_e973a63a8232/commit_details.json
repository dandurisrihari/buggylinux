{
  "hash": "6921ed9049bc7457f66c1596c5b78aec0dae4a9d",
  "hash_short": "6921ed90",
  "subject": "x86/speculation: Allow enabling STIBP with legacy IBRS",
  "body": "When plain IBRS is enabled (not enhanced IBRS), the logic in\nspectre_v2_user_select_mitigation() determines that STIBP is not needed.\n\nThe IBRS bit implicitly protects against cross-thread branch target\ninjection. However, with legacy IBRS, the IBRS bit is cleared on\nreturning to userspace for performance reasons which leaves userspace\nthreads vulnerable to cross-thread branch target injection against which\nSTIBP protects.\n\nExclude IBRS from the spectre_v2_in_ibrs_mode() check to allow for\nenabling STIBP (through seccomp/prctl() by default or always-on, if\nselected by spectre_v2_user kernel cmdline parameter).\n\n  [ bp: Massage. ]\n\nFixes: 7c693f54c873 (\"x86/speculation: Add spectre_v2=ibrs option to support Kernel IBRS\")\nReported-by: Jos\u00e9 Oliveira <joseloliveira11@gmail.com>\nReported-by: Rodrigo Branco <rodrigo@kernelhacking.com>\nSigned-off-by: KP Singh <kpsingh@kernel.org>\nSigned-off-by: Borislav Petkov (AMD) <bp@alien8.de>\nCc: stable@vger.kernel.org\nLink: https://lore.kernel.org/r/20230220120127.1975241-1-kpsingh@kernel.org\nLink: https://lore.kernel.org/r/20230221184908.2349578-1-kpsingh@kernel.org",
  "full_message": "x86/speculation: Allow enabling STIBP with legacy IBRS\n\nWhen plain IBRS is enabled (not enhanced IBRS), the logic in\nspectre_v2_user_select_mitigation() determines that STIBP is not needed.\n\nThe IBRS bit implicitly protects against cross-thread branch target\ninjection. However, with legacy IBRS, the IBRS bit is cleared on\nreturning to userspace for performance reasons which leaves userspace\nthreads vulnerable to cross-thread branch target injection against which\nSTIBP protects.\n\nExclude IBRS from the spectre_v2_in_ibrs_mode() check to allow for\nenabling STIBP (through seccomp/prctl() by default or always-on, if\nselected by spectre_v2_user kernel cmdline parameter).\n\n  [ bp: Massage. ]\n\nFixes: 7c693f54c873 (\"x86/speculation: Add spectre_v2=ibrs option to support Kernel IBRS\")\nReported-by: Jos\u00e9 Oliveira <joseloliveira11@gmail.com>\nReported-by: Rodrigo Branco <rodrigo@kernelhacking.com>\nSigned-off-by: KP Singh <kpsingh@kernel.org>\nSigned-off-by: Borislav Petkov (AMD) <bp@alien8.de>\nCc: stable@vger.kernel.org\nLink: https://lore.kernel.org/r/20230220120127.1975241-1-kpsingh@kernel.org\nLink: https://lore.kernel.org/r/20230221184908.2349578-1-kpsingh@kernel.org",
  "author_name": "KP Singh",
  "author_email": "kpsingh@kernel.org",
  "author_date": "Mon Feb 27 07:05:40 2023 +0100",
  "author_date_iso": "2023-02-27T07:05:40+01:00",
  "committer_name": "Borislav Petkov (AMD)",
  "committer_email": "bp@alien8.de",
  "committer_date": "Mon Feb 27 18:57:09 2023 +0100",
  "committer_date_iso": "2023-02-27T18:57:09+01:00",
  "files_changed": [
    "arch/x86/kernel/cpu/bugs.c"
  ],
  "files_changed_count": 1,
  "stats": [
    {
      "file": "arch/x86/kernel/cpu/bugs.c",
      "insertions": 18,
      "deletions": 7
    }
  ],
  "total_insertions": 18,
  "total_deletions": 7,
  "total_changes": 25,
  "parents": [
    "877934769e5b91798d304d4641647900ee614ce8"
  ],
  "branches": [
    "* development",
    "remotes/origin/HEAD -> origin/master",
    "remotes/origin/master"
  ],
  "tags": [],
  "is_merge": false,
  "security_info": {
    "cve_ids": [],
    "security_keywords": [
      "injection"
    ]
  },
  "fix_type": "security",
  "file_results": [
    {
      "file": "arch/x86/kernel/cpu/bugs.c",
      "pre_version": true,
      "post_version": true,
      "patch": true
    }
  ]
}