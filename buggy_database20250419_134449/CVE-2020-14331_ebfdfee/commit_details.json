{
  "hash": "ebfdfeeae8c01fcb2b3b74ffaf03876e20835d2d",
  "hash_short": "ebfdfeea",
  "subject": "vgacon: Fix for missing check in scrollback handling",
  "body": "vgacon_scrollback_update() always leaves enbough room in the scrollback\nbuffer for the next call, but if the console size changed that room\nmight not actually be enough, and so we need to re-check.\n\nThe check should be in the loop since vgacon_scrollback_cur->tail is\nupdated in the loop and count may be more than 1 when triggered by CSI M,\nas Jiri's PoC:\n#include <stdio.h>\n#include <stdlib.h>\n#include <unistd.h>\n#include <sys/types.h>\n#include <sys/stat.h>\n#include <sys/ioctl.h>\n#include <fcntl.h>\n\nint main(int argc, char** argv)\n{\n        int fd = open(\"/dev/tty1\", O_RDWR);\n        unsigned short size[3] = {25, 200, 0};\n        ioctl(fd, 0x5609, size); // VT_RESIZE\n\n        write(fd, \"\\e[1;1H\", 6);\n        for (int i = 0; i < 30; i++)\n                write(fd, \"\\e[10M\", 5);\n}\n\nIt leads to various crashes as vgacon_scrollback_update writes out of\nthe buffer:\n BUG: unable to handle page fault for address: ffffc900001752a0\n #PF: supervisor write access in kernel mode\n #PF: error_code(0x0002) - not-present page\n RIP: 0010:mutex_unlock+0x13/0x30\n...\n Call Trace:\n  n_tty_write+0x1a0/0x4d0\n  tty_write+0x1a0/0x2e0\n\nOr to KASAN reports:\nBUG: KASAN: slab-out-of-bounds in vgacon_scroll+0x57a/0x8ed\n\nThis fixes CVE-2020-14331.\n\nReported-by: \u5f20\u4e91\u6d77 <zhangyunhai@nsfocus.com>\nReported-by: Yang Yingliang <yangyingliang@huawei.com>\nReported-by: Kyungtae Kim <kt0755@gmail.com>\nFixes: 15bdab959c9b ([PATCH] vgacon: Add support for soft scrollback)\nCc: stable@vger.kernel.org\nCc: linux-fbdev@vger.kernel.org\nCc: Linus Torvalds <torvalds@linux-foundation.org>\nCc: Solar Designer <solar@openwall.com>\nCc: \"Srivatsa S. Bhat\" <srivatsa@csail.mit.edu>\nCc: Anthony Liguori <aliguori@amazon.com>\nCc: Yang Yingliang <yangyingliang@huawei.com>\nCc: Bartlomiej Zolnierkiewicz <b.zolnierkie@samsung.com>\nCc: Jiri Slaby <jirislaby@kernel.org>\nSigned-off-by: Yunhai Zhang <zhangyunhai@nsfocus.com>\nLink: https://lore.kernel.org/r/9fb43895-ca91-9b07-ebfd-808cf854ca95@nsfocus.com\nSigned-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>",
  "full_message": "vgacon: Fix for missing check in scrollback handling\n\nvgacon_scrollback_update() always leaves enbough room in the scrollback\nbuffer for the next call, but if the console size changed that room\nmight not actually be enough, and so we need to re-check.\n\nThe check should be in the loop since vgacon_scrollback_cur->tail is\nupdated in the loop and count may be more than 1 when triggered by CSI M,\nas Jiri's PoC:\n#include <stdio.h>\n#include <stdlib.h>\n#include <unistd.h>\n#include <sys/types.h>\n#include <sys/stat.h>\n#include <sys/ioctl.h>\n#include <fcntl.h>\n\nint main(int argc, char** argv)\n{\n        int fd = open(\"/dev/tty1\", O_RDWR);\n        unsigned short size[3] = {25, 200, 0};\n        ioctl(fd, 0x5609, size); // VT_RESIZE\n\n        write(fd, \"\\e[1;1H\", 6);\n        for (int i = 0; i < 30; i++)\n                write(fd, \"\\e[10M\", 5);\n}\n\nIt leads to various crashes as vgacon_scrollback_update writes out of\nthe buffer:\n BUG: unable to handle page fault for address: ffffc900001752a0\n #PF: supervisor write access in kernel mode\n #PF: error_code(0x0002) - not-present page\n RIP: 0010:mutex_unlock+0x13/0x30\n...\n Call Trace:\n  n_tty_write+0x1a0/0x4d0\n  tty_write+0x1a0/0x2e0\n\nOr to KASAN reports:\nBUG: KASAN: slab-out-of-bounds in vgacon_scroll+0x57a/0x8ed\n\nThis fixes CVE-2020-14331.\n\nReported-by: \u5f20\u4e91\u6d77 <zhangyunhai@nsfocus.com>\nReported-by: Yang Yingliang <yangyingliang@huawei.com>\nReported-by: Kyungtae Kim <kt0755@gmail.com>\nFixes: 15bdab959c9b ([PATCH] vgacon: Add support for soft scrollback)\nCc: stable@vger.kernel.org\nCc: linux-fbdev@vger.kernel.org\nCc: Linus Torvalds <torvalds@linux-foundation.org>\nCc: Solar Designer <solar@openwall.com>\nCc: \"Srivatsa S. Bhat\" <srivatsa@csail.mit.edu>\nCc: Anthony Liguori <aliguori@amazon.com>\nCc: Yang Yingliang <yangyingliang@huawei.com>\nCc: Bartlomiej Zolnierkiewicz <b.zolnierkie@samsung.com>\nCc: Jiri Slaby <jirislaby@kernel.org>\nSigned-off-by: Yunhai Zhang <zhangyunhai@nsfocus.com>\nLink: https://lore.kernel.org/r/9fb43895-ca91-9b07-ebfd-808cf854ca95@nsfocus.com\nSigned-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>",
  "author_name": "Yunhai Zhang",
  "author_email": "zhangyunhai@nsfocus.com",
  "author_date": "Tue Jul 28 09:58:03 2020 +0800",
  "author_date_iso": "2020-07-28T09:58:03+08:00",
  "committer_name": "Greg Kroah-Hartman",
  "committer_email": "gregkh@linuxfoundation.org",
  "committer_date": "Tue Aug 4 09:40:35 2020 +0200",
  "committer_date_iso": "2020-08-04T09:40:35+02:00",
  "files_changed": [
    "drivers/video/console/vgacon.c"
  ],
  "files_changed_count": 1,
  "stats": [
    {
      "file": "drivers/video/console/vgacon.c",
      "insertions": 4,
      "deletions": 0
    }
  ],
  "total_insertions": 4,
  "total_deletions": 0,
  "total_changes": 4,
  "parents": [
    "81f0f78965ebfe48c4997801050f64687cebea48"
  ],
  "branches": [
    "* development",
    "remotes/origin/HEAD -> origin/master",
    "remotes/origin/master"
  ],
  "tags": [],
  "is_merge": false,
  "security_info": {
    "cve_ids": [
      "CVE-2020-14331"
    ],
    "security_keywords": []
  },
  "fix_type": "cve",
  "file_results": [
    {
      "file": "drivers/video/console/vgacon.c",
      "pre_version": false,
      "post_version": true,
      "patch": true
    }
  ]
}