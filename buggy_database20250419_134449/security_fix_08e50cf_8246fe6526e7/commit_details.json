{
  "hash": "08e50cf071847323414df0835109b6f3560d44f5",
  "hash_short": "08e50cf0",
  "subject": "tipc: fix a potential deadlock on &tx->lock",
  "body": "It seems that tipc_crypto_key_revoke() could be be invoked by\nwokequeue tipc_crypto_work_rx() under process context and\ntimer/rx callback under softirq context, thus the lock acquisition\non &tx->lock seems better use spin_lock_bh() to prevent possible\ndeadlock.\n\nThis flaw was found by an experimental static analysis tool I am\ndeveloping for irq-related deadlock.\n\ntipc_crypto_work_rx() <workqueue>\n--> tipc_crypto_key_distr()\n--> tipc_bcast_xmit()\n--> tipc_bcbase_xmit()\n--> tipc_bearer_bc_xmit()\n--> tipc_crypto_xmit()\n--> tipc_ehdr_build()\n--> tipc_crypto_key_revoke()\n--> spin_lock(&tx->lock)\n<timer interrupt>\n   --> tipc_disc_timeout()\n   --> tipc_bearer_xmit_skb()\n   --> tipc_crypto_xmit()\n   --> tipc_ehdr_build()\n   --> tipc_crypto_key_revoke()\n   --> spin_lock(&tx->lock) <deadlock here>\n\nSigned-off-by: Chengfeng Ye <dg573847474@gmail.com>\nReviewed-by: Jacob Keller <jacob.e.keller@intel.com>\nAcked-by: Jon Maloy <jmaloy@redhat.com>\nFixes: fc1b6d6de220 (\"tipc: introduce TIPC encryption & authentication\")\nLink: https://lore.kernel.org/r/20230927181414.59928-1-dg573847474@gmail.com\nSigned-off-by: Jakub Kicinski <kuba@kernel.org>",
  "full_message": "tipc: fix a potential deadlock on &tx->lock\n\nIt seems that tipc_crypto_key_revoke() could be be invoked by\nwokequeue tipc_crypto_work_rx() under process context and\ntimer/rx callback under softirq context, thus the lock acquisition\non &tx->lock seems better use spin_lock_bh() to prevent possible\ndeadlock.\n\nThis flaw was found by an experimental static analysis tool I am\ndeveloping for irq-related deadlock.\n\ntipc_crypto_work_rx() <workqueue>\n--> tipc_crypto_key_distr()\n--> tipc_bcast_xmit()\n--> tipc_bcbase_xmit()\n--> tipc_bearer_bc_xmit()\n--> tipc_crypto_xmit()\n--> tipc_ehdr_build()\n--> tipc_crypto_key_revoke()\n--> spin_lock(&tx->lock)\n<timer interrupt>\n   --> tipc_disc_timeout()\n   --> tipc_bearer_xmit_skb()\n   --> tipc_crypto_xmit()\n   --> tipc_ehdr_build()\n   --> tipc_crypto_key_revoke()\n   --> spin_lock(&tx->lock) <deadlock here>\n\nSigned-off-by: Chengfeng Ye <dg573847474@gmail.com>\nReviewed-by: Jacob Keller <jacob.e.keller@intel.com>\nAcked-by: Jon Maloy <jmaloy@redhat.com>\nFixes: fc1b6d6de220 (\"tipc: introduce TIPC encryption & authentication\")\nLink: https://lore.kernel.org/r/20230927181414.59928-1-dg573847474@gmail.com\nSigned-off-by: Jakub Kicinski <kuba@kernel.org>",
  "author_name": "Chengfeng Ye",
  "author_email": "dg573847474@gmail.com",
  "author_date": "Wed Sep 27 18:14:14 2023 +0000",
  "author_date_iso": "2023-09-27T18:14:14+00:00",
  "committer_name": "Jakub Kicinski",
  "committer_email": "kuba@kernel.org",
  "committer_date": "Wed Oct 4 13:24:12 2023 -0700",
  "committer_date_iso": "2023-10-04T13:24:12-07:00",
  "files_changed": [
    "net/tipc/crypto.c"
  ],
  "files_changed_count": 1,
  "stats": [
    {
      "file": "net/tipc/crypto.c",
      "insertions": 2,
      "deletions": 2
    }
  ],
  "total_insertions": 2,
  "total_deletions": 2,
  "total_changes": 4,
  "parents": [
    "6f195d6b0da3b689922ba9e302af2f49592fa9fc"
  ],
  "branches": [
    "* development",
    "remotes/origin/HEAD -> origin/master",
    "remotes/origin/master"
  ],
  "tags": [],
  "is_merge": false,
  "security_info": {
    "cve_ids": [],
    "security_keywords": [
      "authentication"
    ]
  },
  "fix_type": "security",
  "file_results": [
    {
      "file": "net/tipc/crypto.c",
      "pre_version": false,
      "post_version": true,
      "patch": true
    }
  ]
}