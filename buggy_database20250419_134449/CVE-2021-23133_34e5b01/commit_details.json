{
  "hash": "34e5b01186858b36c4d7c87e1a025071e8e2401f",
  "hash_short": "34e5b011",
  "subject": "sctp: delay auto_asconf init until binding the first addr",
  "body": "As Or Cohen described:\n\n  If sctp_destroy_sock is called without sock_net(sk)->sctp.addr_wq_lock\n  held and sp->do_auto_asconf is true, then an element is removed\n  from the auto_asconf_splist without any proper locking.\n\n  This can happen in the following functions:\n  1. In sctp_accept, if sctp_sock_migrate fails.\n  2. In inet_create or inet6_create, if there is a bpf program\n     attached to BPF_CGROUP_INET_SOCK_CREATE which denies\n     creation of the sctp socket.\n\nThis patch is to fix it by moving the auto_asconf init out of\nsctp_init_sock(), by which inet_create()/inet6_create() won't\nneed to operate it in sctp_destroy_sock() when calling\nsk_common_release().\n\nIt also makes more sense to do auto_asconf init while binding the\nfirst addr, as auto_asconf actually requires an ANY addr bind,\nsee it in sctp_addr_wq_timeout_handler().\n\nThis addresses CVE-2021-23133.\n\nFixes: 610236587600 (\"bpf: Add new cgroup attach type to enable sock modifications\")\nReported-by: Or Cohen <orcohen@paloaltonetworks.com>\nSigned-off-by: Xin Long <lucien.xin@gmail.com>\nSigned-off-by: David S. Miller <davem@davemloft.net>",
  "full_message": "sctp: delay auto_asconf init until binding the first addr\n\nAs Or Cohen described:\n\n  If sctp_destroy_sock is called without sock_net(sk)->sctp.addr_wq_lock\n  held and sp->do_auto_asconf is true, then an element is removed\n  from the auto_asconf_splist without any proper locking.\n\n  This can happen in the following functions:\n  1. In sctp_accept, if sctp_sock_migrate fails.\n  2. In inet_create or inet6_create, if there is a bpf program\n     attached to BPF_CGROUP_INET_SOCK_CREATE which denies\n     creation of the sctp socket.\n\nThis patch is to fix it by moving the auto_asconf init out of\nsctp_init_sock(), by which inet_create()/inet6_create() won't\nneed to operate it in sctp_destroy_sock() when calling\nsk_common_release().\n\nIt also makes more sense to do auto_asconf init while binding the\nfirst addr, as auto_asconf actually requires an ANY addr bind,\nsee it in sctp_addr_wq_timeout_handler().\n\nThis addresses CVE-2021-23133.\n\nFixes: 610236587600 (\"bpf: Add new cgroup attach type to enable sock modifications\")\nReported-by: Or Cohen <orcohen@paloaltonetworks.com>\nSigned-off-by: Xin Long <lucien.xin@gmail.com>\nSigned-off-by: David S. Miller <davem@davemloft.net>",
  "author_name": "Xin Long",
  "author_email": "lucien.xin@gmail.com",
  "author_date": "Mon May 3 05:11:42 2021 +0800",
  "author_date_iso": "2021-05-03T05:11:42+08:00",
  "committer_name": "David S. Miller",
  "committer_email": "davem@davemloft.net",
  "committer_date": "Mon May 3 13:36:21 2021 -0700",
  "committer_date_iso": "2021-05-03T13:36:21-07:00",
  "files_changed": [
    "net/sctp/socket.c"
  ],
  "files_changed_count": 1,
  "stats": [
    {
      "file": "net/sctp/socket.c",
      "insertions": 17,
      "deletions": 14
    }
  ],
  "total_insertions": 17,
  "total_deletions": 14,
  "total_changes": 31,
  "parents": [
    "01bfe5e8e428b475982a98a46cca5755726f3f7f"
  ],
  "branches": [
    "* development",
    "remotes/origin/HEAD -> origin/master",
    "remotes/origin/master"
  ],
  "tags": [],
  "is_merge": false,
  "security_info": {
    "cve_ids": [
      "CVE-2021-23133"
    ],
    "security_keywords": []
  },
  "fix_type": "cve",
  "file_results": [
    {
      "file": "net/sctp/socket.c",
      "pre_version": true,
      "post_version": true,
      "patch": true
    }
  ]
}