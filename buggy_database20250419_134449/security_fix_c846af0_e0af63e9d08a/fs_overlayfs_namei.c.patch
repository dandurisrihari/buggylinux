commit c846af050f944d584f28bc0de310383003c8096d
Author: Miklos Szeredi <mszeredi@redhat.com>
Date:   Mon Dec 14 15:26:14 2020 +0100

    ovl: check privs before decoding file handle
    
    CAP_DAC_READ_SEARCH is required by open_by_handle_at(2) so check it in
    ovl_decode_real_fh() as well to prevent privilege escalation for
    unprivileged overlay mounts.
    
    [Amir] If the mounter is not capable in init ns, ovl_check_origin() and
    ovl_verify_index() will not function as expected and this will break index
    and nfs export features.  So check capability in ovl_can_decode_fh(), to
    auto disable those features.
    
    Signed-off-by: Miklos Szeredi <mszeredi@redhat.com>

diff --git a/fs/overlayfs/namei.c b/fs/overlayfs/namei.c
index 509dac77af61..3fe05fb5d145 100644
--- a/fs/overlayfs/namei.c
+++ b/fs/overlayfs/namei.c
@@ -156,6 +156,9 @@ struct dentry *ovl_decode_real_fh(struct ovl_fs *ofs, struct ovl_fh *fh,
 	struct dentry *real;
 	int bytes;
 
+	if (!capable(CAP_DAC_READ_SEARCH))
+		return NULL;
+
 	/*
 	 * Make sure that the stored uuid matches the uuid of the lower
 	 * layer where file handle will be decoded.