{
  "hash": "71ab9c3e2253619136c31c89dbb2c69305cc89b1",
  "hash_short": "71ab9c3e",
  "subject": "net: fix UaF in netns ops registration error path",
  "body": "If net_assign_generic() fails, the current error path in ops_init() tries\nto clear the gen pointer slot. Anyway, in such error path, the gen pointer\nitself has not been modified yet, and the existing and accessed one is\nsmaller than the accessed index, causing an out-of-bounds error:\n\n BUG: KASAN: slab-out-of-bounds in ops_init+0x2de/0x320\n Write of size 8 at addr ffff888109124978 by task modprobe/1018\n\n CPU: 2 PID: 1018 Comm: modprobe Not tainted 6.2.0-rc2.mptcp_ae5ac65fbed5+ #1641\n Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS 1.16.1-2.fc37 04/01/2014\n Call Trace:\n  <TASK>\n  dump_stack_lvl+0x6a/0x9f\n  print_address_description.constprop.0+0x86/0x2b5\n  print_report+0x11b/0x1fb\n  kasan_report+0x87/0xc0\n  ops_init+0x2de/0x320\n  register_pernet_operations+0x2e4/0x750\n  register_pernet_subsys+0x24/0x40\n  tcf_register_action+0x9f/0x560\n  do_one_initcall+0xf9/0x570\n  do_init_module+0x190/0x650\n  load_module+0x1fa5/0x23c0\n  __do_sys_finit_module+0x10d/0x1b0\n  do_syscall_64+0x58/0x80\n  entry_SYSCALL_64_after_hwframe+0x72/0xdc\n RIP: 0033:0x7f42518f778d\n Code: 00 c3 66 2e 0f 1f 84 00 00 00 00 00 90 f3 0f 1e fa 48 89 f8 48 89 f7 48\n       89 d6 48 89 ca 4d 89 c2 4d 89 c8 4c 8b 4c 24 08 0f 05 <48> 3d 01 f0 ff\n       ff 73 01 c3 48 8b 0d cb 56 2c 00 f7 d8 64 89 01 48\n RSP: 002b:00007fff96869688 EFLAGS: 00000246 ORIG_RAX: 0000000000000139\n RAX: ffffffffffffffda RBX: 00005568ef7f7c90 RCX: 00007f42518f778d\n RDX: 0000000000000000 RSI: 00005568ef41d796 RDI: 0000000000000003\n RBP: 00005568ef41d796 R08: 0000000000000000 R09: 0000000000000000\n R10: 0000000000000003 R11: 0000000000000246 R12: 0000000000000000\n R13: 00005568ef7f7d30 R14: 0000000000040000 R15: 0000000000000000\n  </TASK>\n\nThis change addresses the issue by skipping the gen pointer\nde-reference in the mentioned error-path.\n\nFound by code inspection and verified with explicit error injection\non a kasan-enabled kernel.\n\nFixes: d266935ac43d (\"net: fix UAF issue in nfqnl_nf_hook_drop() when ops_init() failed\")\nSigned-off-by: Paolo Abeni <pabeni@redhat.com>\nReviewed-by: Simon Horman <simon.horman@corigine.com>\nLink: https://lore.kernel.org/r/cec4e0f3bb2c77ac03a6154a8508d3930beb5f0f.1674154348.git.pabeni@redhat.com\nSigned-off-by: Jakub Kicinski <kuba@kernel.org>",
  "full_message": "net: fix UaF in netns ops registration error path\n\nIf net_assign_generic() fails, the current error path in ops_init() tries\nto clear the gen pointer slot. Anyway, in such error path, the gen pointer\nitself has not been modified yet, and the existing and accessed one is\nsmaller than the accessed index, causing an out-of-bounds error:\n\n BUG: KASAN: slab-out-of-bounds in ops_init+0x2de/0x320\n Write of size 8 at addr ffff888109124978 by task modprobe/1018\n\n CPU: 2 PID: 1018 Comm: modprobe Not tainted 6.2.0-rc2.mptcp_ae5ac65fbed5+ #1641\n Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS 1.16.1-2.fc37 04/01/2014\n Call Trace:\n  <TASK>\n  dump_stack_lvl+0x6a/0x9f\n  print_address_description.constprop.0+0x86/0x2b5\n  print_report+0x11b/0x1fb\n  kasan_report+0x87/0xc0\n  ops_init+0x2de/0x320\n  register_pernet_operations+0x2e4/0x750\n  register_pernet_subsys+0x24/0x40\n  tcf_register_action+0x9f/0x560\n  do_one_initcall+0xf9/0x570\n  do_init_module+0x190/0x650\n  load_module+0x1fa5/0x23c0\n  __do_sys_finit_module+0x10d/0x1b0\n  do_syscall_64+0x58/0x80\n  entry_SYSCALL_64_after_hwframe+0x72/0xdc\n RIP: 0033:0x7f42518f778d\n Code: 00 c3 66 2e 0f 1f 84 00 00 00 00 00 90 f3 0f 1e fa 48 89 f8 48 89 f7 48\n       89 d6 48 89 ca 4d 89 c2 4d 89 c8 4c 8b 4c 24 08 0f 05 <48> 3d 01 f0 ff\n       ff 73 01 c3 48 8b 0d cb 56 2c 00 f7 d8 64 89 01 48\n RSP: 002b:00007fff96869688 EFLAGS: 00000246 ORIG_RAX: 0000000000000139\n RAX: ffffffffffffffda RBX: 00005568ef7f7c90 RCX: 00007f42518f778d\n RDX: 0000000000000000 RSI: 00005568ef41d796 RDI: 0000000000000003\n RBP: 00005568ef41d796 R08: 0000000000000000 R09: 0000000000000000\n R10: 0000000000000003 R11: 0000000000000246 R12: 0000000000000000\n R13: 00005568ef7f7d30 R14: 0000000000040000 R15: 0000000000000000\n  </TASK>\n\nThis change addresses the issue by skipping the gen pointer\nde-reference in the mentioned error-path.\n\nFound by code inspection and verified with explicit error injection\non a kasan-enabled kernel.\n\nFixes: d266935ac43d (\"net: fix UAF issue in nfqnl_nf_hook_drop() when ops_init() failed\")\nSigned-off-by: Paolo Abeni <pabeni@redhat.com>\nReviewed-by: Simon Horman <simon.horman@corigine.com>\nLink: https://lore.kernel.org/r/cec4e0f3bb2c77ac03a6154a8508d3930beb5f0f.1674154348.git.pabeni@redhat.com\nSigned-off-by: Jakub Kicinski <kuba@kernel.org>",
  "author_name": "Paolo Abeni",
  "author_email": "pabeni@redhat.com",
  "author_date": "Thu Jan 19 19:55:45 2023 +0100",
  "author_date_iso": "2023-01-19T19:55:45+01:00",
  "committer_name": "Jakub Kicinski",
  "committer_email": "kuba@kernel.org",
  "committer_date": "Fri Jan 20 18:51:18 2023 -0800",
  "committer_date_iso": "2023-01-20T18:51:18-08:00",
  "files_changed": [
    "net/core/net_namespace.c"
  ],
  "files_changed_count": 1,
  "stats": [
    {
      "file": "net/core/net_namespace.c",
      "insertions": 1,
      "deletions": 1
    }
  ],
  "total_insertions": 1,
  "total_deletions": 1,
  "total_changes": 2,
  "parents": [
    "fd941bd64f0776e4c51d8934f8e666cfbe14406a"
  ],
  "branches": [
    "* development",
    "remotes/origin/HEAD -> origin/master",
    "remotes/origin/master"
  ],
  "tags": [],
  "is_merge": false,
  "security_info": {
    "cve_ids": [],
    "security_keywords": [
      "injection"
    ]
  },
  "fix_type": "security",
  "file_results": [
    {
      "file": "net/core/net_namespace.c",
      "pre_version": false,
      "post_version": true,
      "patch": true
    }
  ]
}