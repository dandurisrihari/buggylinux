Commit Hash: 1e0ad70cc1957b9050368e433b1061a2cd1ce543
Subject: KVM: x86: fix deadline tsc interrupt injection


Security Keywords:
- injection

Full commit message:
KVM: x86: fix deadline tsc interrupt injection

The check in kvm_set_lapic_tscdeadline_msr() was trying to prevent a
situation where we lose a pending deadline timer in a MSR write.
Losing it is fine, because it effectively occurs before the timer fired,
so we should be able to cancel or postpone it.

Another problem comes from interaction with QEMU, or other userspace
that can set deadline MSR without a good reason, when timer is already
pending:  one guest's deadline request results in more than one
interrupt because one is injected immediately on MSR write from
userspace and one through hrtimer later.

The solution is to remove the injection when replacing a pending timer
and to improve the usual QEMU path, we inject without a hrtimer when the
deadline has already passed.

Signed-off-by: Radim Krčmář <rkrcmar@redhat.com>
Reported-by: Nadav Amit <namit@cs.technion.ac.il>
Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>

Metadata:
Author: Radim Krčmář <rkrcmar@redhat.com>
Author Date: Fri Oct 10 19:15:09 2014 +0200
Committer: Paolo Bonzini <pbonzini@redhat.com>
Commit Date: Mon Nov 3 12:07:28 2014 +0100

Files Changed: 1
Lines Added: 4
Lines Removed: 6
Total Changes: 10
