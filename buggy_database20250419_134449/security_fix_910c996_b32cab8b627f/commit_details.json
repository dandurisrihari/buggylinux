{
  "hash": "910c996335c37552ee30fcb837375b808bb4f33b",
  "hash_short": "910c9963",
  "subject": "USB: serial: keyspan: fix memleak on probe errors",
  "body": "I got memory leak as follows when doing fault injection test:\n\nunreferenced object 0xffff888258228440 (size 64):\n  comm \"kworker/7:2\", pid 2005, jiffies 4294989509 (age 824.540s)\n  hex dump (first 32 bytes):\n    00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................\n    00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................\n  backtrace:\n    [<ffffffff8167939c>] slab_post_alloc_hook+0x9c/0x490\n    [<ffffffff8167f627>] kmem_cache_alloc_trace+0x1f7/0x470\n    [<ffffffffa02ac0e4>] keyspan_port_probe+0xa4/0x5d0 [keyspan]\n    [<ffffffffa0294c07>] usb_serial_device_probe+0x97/0x1d0 [usbserial]\n    [<ffffffff82b50ca7>] really_probe+0x167/0x460\n    [<ffffffff82b51099>] __driver_probe_device+0xf9/0x180\n    [<ffffffff82b51173>] driver_probe_device+0x53/0x130\n    [<ffffffff82b516f5>] __device_attach_driver+0x105/0x130\n    [<ffffffff82b4cfe9>] bus_for_each_drv+0x129/0x190\n    [<ffffffff82b50a69>] __device_attach+0x1c9/0x270\n    [<ffffffff82b518d0>] device_initial_probe+0x20/0x30\n    [<ffffffff82b4f062>] bus_probe_device+0x142/0x160\n    [<ffffffff82b4a4e9>] device_add+0x829/0x1300\n    [<ffffffffa0295fda>] usb_serial_probe.cold+0xc9b/0x14ac [usbserial]\n    [<ffffffffa02266aa>] usb_probe_interface+0x1aa/0x3c0 [usbcore]\n    [<ffffffff82b50ca7>] really_probe+0x167/0x460\n\nIf keyspan_port_probe() fails to allocate memory for an out_buffer[i] or\nin_buffer[i], the previously allocated memory for out_buffer or\nin_buffer needs to be freed on the error handling path, otherwise a\nmemory leak will result.\n\nFixes: bad41a5bf177 (\"USB: keyspan: fix port DMA-buffer allocations\")\nReported-by: Hulk Robot <hulkci@huawei.com>\nSigned-off-by: Wang Hai <wanghai38@huawei.com>\nLink: https://lore.kernel.org/r/20211015085543.1203011-1-wanghai38@huawei.com\nCc: stable@vger.kernel.org      # 3.12\nSigned-off-by: Johan Hovold <johan@kernel.org>",
  "full_message": "USB: serial: keyspan: fix memleak on probe errors\n\nI got memory leak as follows when doing fault injection test:\n\nunreferenced object 0xffff888258228440 (size 64):\n  comm \"kworker/7:2\", pid 2005, jiffies 4294989509 (age 824.540s)\n  hex dump (first 32 bytes):\n    00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................\n    00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................\n  backtrace:\n    [<ffffffff8167939c>] slab_post_alloc_hook+0x9c/0x490\n    [<ffffffff8167f627>] kmem_cache_alloc_trace+0x1f7/0x470\n    [<ffffffffa02ac0e4>] keyspan_port_probe+0xa4/0x5d0 [keyspan]\n    [<ffffffffa0294c07>] usb_serial_device_probe+0x97/0x1d0 [usbserial]\n    [<ffffffff82b50ca7>] really_probe+0x167/0x460\n    [<ffffffff82b51099>] __driver_probe_device+0xf9/0x180\n    [<ffffffff82b51173>] driver_probe_device+0x53/0x130\n    [<ffffffff82b516f5>] __device_attach_driver+0x105/0x130\n    [<ffffffff82b4cfe9>] bus_for_each_drv+0x129/0x190\n    [<ffffffff82b50a69>] __device_attach+0x1c9/0x270\n    [<ffffffff82b518d0>] device_initial_probe+0x20/0x30\n    [<ffffffff82b4f062>] bus_probe_device+0x142/0x160\n    [<ffffffff82b4a4e9>] device_add+0x829/0x1300\n    [<ffffffffa0295fda>] usb_serial_probe.cold+0xc9b/0x14ac [usbserial]\n    [<ffffffffa02266aa>] usb_probe_interface+0x1aa/0x3c0 [usbcore]\n    [<ffffffff82b50ca7>] really_probe+0x167/0x460\n\nIf keyspan_port_probe() fails to allocate memory for an out_buffer[i] or\nin_buffer[i], the previously allocated memory for out_buffer or\nin_buffer needs to be freed on the error handling path, otherwise a\nmemory leak will result.\n\nFixes: bad41a5bf177 (\"USB: keyspan: fix port DMA-buffer allocations\")\nReported-by: Hulk Robot <hulkci@huawei.com>\nSigned-off-by: Wang Hai <wanghai38@huawei.com>\nLink: https://lore.kernel.org/r/20211015085543.1203011-1-wanghai38@huawei.com\nCc: stable@vger.kernel.org      # 3.12\nSigned-off-by: Johan Hovold <johan@kernel.org>",
  "author_name": "Wang Hai",
  "author_email": "wanghai38@huawei.com",
  "author_date": "Fri Oct 15 16:55:43 2021 +0800",
  "author_date_iso": "2021-10-15T16:55:43+08:00",
  "committer_name": "Johan Hovold",
  "committer_email": "johan@kernel.org",
  "committer_date": "Wed Oct 27 15:18:59 2021 +0200",
  "committer_date_iso": "2021-10-27T15:18:59+02:00",
  "files_changed": [
    "drivers/usb/serial/keyspan.c"
  ],
  "files_changed_count": 1,
  "stats": [
    {
      "file": "drivers/usb/serial/keyspan.c",
      "insertions": 7,
      "deletions": 8
    }
  ],
  "total_insertions": 7,
  "total_deletions": 8,
  "total_changes": 15,
  "parents": [
    "f5cfbecb0a162319464c9408420282d22ed69721"
  ],
  "branches": [
    "* development",
    "remotes/origin/HEAD -> origin/master",
    "remotes/origin/master"
  ],
  "tags": [],
  "is_merge": false,
  "security_info": {
    "cve_ids": [],
    "security_keywords": [
      "injection"
    ]
  },
  "fix_type": "security",
  "file_results": [
    {
      "file": "drivers/usb/serial/keyspan.c",
      "pre_version": false,
      "post_version": true,
      "patch": true
    }
  ]
}