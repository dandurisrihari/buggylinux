Commit Hash: 55f669f34184ecb25b8353f29c7f6f1ae5b313d1
Subject: xfs: only remap the written blocks in xfs_reflink_end_cow_extent


Security Keywords:
- injection

Full commit message:
xfs: only remap the written blocks in xfs_reflink_end_cow_extent

xfs_reflink_end_cow_extent looks up the COW extent and the data fork
extent at offset_fsb, and then proceeds to remap the common subset
between the two.

It does however not limit the remapped extent to the passed in
[*offset_fsbm end_fsb] range and thus potentially remaps more blocks than
the one handled by the current I/O completion.  This means that with
sufficiently large data and COW extents we could be remapping COW fork
mappings that have not been written to, leading to a stale data exposure
on a powerfail event.

We use to have a xfs_trim_range to make the remap fit the I/O completion
range, but that got (apparently accidentally) removed in commit
df2fd88f8ac7 ("xfs: rewrite xfs_reflink_end_cow to use intents").

Note that I've only found this by code inspection, and a test case would
probably require very specific delay and error injection.

Fixes: df2fd88f8ac7 ("xfs: rewrite xfs_reflink_end_cow to use intents")
Signed-off-by: Christoph Hellwig <hch@lst.de>
Reviewed-by: "Darrick J. Wong" <djwong@kernel.org>
Signed-off-by: Chandan Babu R <chandanbabu@kernel.org>

Metadata:
Author: Christoph Hellwig <hch@lst.de>
Author Date: Mon Oct 16 17:28:52 2023 +0200
Committer: Chandan Babu R <chandanbabu@kernel.org>
Commit Date: Mon Nov 13 09:09:19 2023 +0530

Files Changed: 1
Lines Added: 1
Lines Removed: 0
Total Changes: 1
