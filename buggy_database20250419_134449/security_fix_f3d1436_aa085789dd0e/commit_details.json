{
  "hash": "f3d1436d4bf8ced1c9a62a045d193a65567e1fcc",
  "hash_short": "f3d1436d",
  "subject": "KVM: x86: Take srcu lock in post_kvm_run_save()",
  "body": "The Xen interrupt injection for event channels relies on accessing the\nguest's vcpu_info structure in __kvm_xen_has_interrupt(), through a\ngfn_to_hva_cache.\n\nThis requires the srcu lock to be held, which is mostly the case except\nfor this code path:\n\n[   11.822877] WARNING: suspicious RCU usage\n[   11.822965] -----------------------------\n[   11.823013] include/linux/kvm_host.h:664 suspicious rcu_dereference_check() usage!\n[   11.823131]\n[   11.823131] other info that might help us debug this:\n[   11.823131]\n[   11.823196]\n[   11.823196] rcu_scheduler_active = 2, debug_locks = 1\n[   11.823253] 1 lock held by dom:0/90:\n[   11.823292]  #0: ffff998956ec8118 (&vcpu->mutex){+.+.}, at: kvm_vcpu_ioctl+0x85/0x680\n[   11.823379]\n[   11.823379] stack backtrace:\n[   11.823428] CPU: 2 PID: 90 Comm: dom:0 Kdump: loaded Not tainted 5.4.34+ #5\n[   11.823496] Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS rel-1.12.1-0-ga5cab58e9a3f-prebuilt.qemu.org 04/01/2014\n[   11.823612] Call Trace:\n[   11.823645]  dump_stack+0x7a/0xa5\n[   11.823681]  lockdep_rcu_suspicious+0xc5/0x100\n[   11.823726]  __kvm_xen_has_interrupt+0x179/0x190\n[   11.823773]  kvm_cpu_has_extint+0x6d/0x90\n[   11.823813]  kvm_cpu_accept_dm_intr+0xd/0x40\n[   11.823853]  kvm_vcpu_ready_for_interrupt_injection+0x20/0x30\n              < post_kvm_run_save() inlined here >\n[   11.823906]  kvm_arch_vcpu_ioctl_run+0x135/0x6a0\n[   11.823947]  kvm_vcpu_ioctl+0x263/0x680\n\nFixes: 40da8ccd724f (\"KVM: x86/xen: Add event channel interrupt vector upcall\")\nSigned-off-by: David Woodhouse <dwmw@amazon.co.uk>\nCc: stable@vger.kernel.org\nMessage-Id: <606aaaf29fca3850a63aa4499826104e77a72346.camel@infradead.org>\nSigned-off-by: Paolo Bonzini <pbonzini@redhat.com>",
  "full_message": "KVM: x86: Take srcu lock in post_kvm_run_save()\n\nThe Xen interrupt injection for event channels relies on accessing the\nguest's vcpu_info structure in __kvm_xen_has_interrupt(), through a\ngfn_to_hva_cache.\n\nThis requires the srcu lock to be held, which is mostly the case except\nfor this code path:\n\n[   11.822877] WARNING: suspicious RCU usage\n[   11.822965] -----------------------------\n[   11.823013] include/linux/kvm_host.h:664 suspicious rcu_dereference_check() usage!\n[   11.823131]\n[   11.823131] other info that might help us debug this:\n[   11.823131]\n[   11.823196]\n[   11.823196] rcu_scheduler_active = 2, debug_locks = 1\n[   11.823253] 1 lock held by dom:0/90:\n[   11.823292]  #0: ffff998956ec8118 (&vcpu->mutex){+.+.}, at: kvm_vcpu_ioctl+0x85/0x680\n[   11.823379]\n[   11.823379] stack backtrace:\n[   11.823428] CPU: 2 PID: 90 Comm: dom:0 Kdump: loaded Not tainted 5.4.34+ #5\n[   11.823496] Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS rel-1.12.1-0-ga5cab58e9a3f-prebuilt.qemu.org 04/01/2014\n[   11.823612] Call Trace:\n[   11.823645]  dump_stack+0x7a/0xa5\n[   11.823681]  lockdep_rcu_suspicious+0xc5/0x100\n[   11.823726]  __kvm_xen_has_interrupt+0x179/0x190\n[   11.823773]  kvm_cpu_has_extint+0x6d/0x90\n[   11.823813]  kvm_cpu_accept_dm_intr+0xd/0x40\n[   11.823853]  kvm_vcpu_ready_for_interrupt_injection+0x20/0x30\n              < post_kvm_run_save() inlined here >\n[   11.823906]  kvm_arch_vcpu_ioctl_run+0x135/0x6a0\n[   11.823947]  kvm_vcpu_ioctl+0x263/0x680\n\nFixes: 40da8ccd724f (\"KVM: x86/xen: Add event channel interrupt vector upcall\")\nSigned-off-by: David Woodhouse <dwmw@amazon.co.uk>\nCc: stable@vger.kernel.org\nMessage-Id: <606aaaf29fca3850a63aa4499826104e77a72346.camel@infradead.org>\nSigned-off-by: Paolo Bonzini <pbonzini@redhat.com>",
  "author_name": "David Woodhouse",
  "author_email": "dwmw@amazon.co.uk",
  "author_date": "Tue Oct 26 04:12:38 2021 +0100",
  "author_date_iso": "2021-10-26T04:12:38+01:00",
  "committer_name": "Paolo Bonzini",
  "committer_email": "pbonzini@redhat.com",
  "committer_date": "Thu Oct 28 10:45:38 2021 -0400",
  "committer_date_iso": "2021-10-28T10:45:38-04:00",
  "files_changed": [
    "arch/x86/kvm/x86.c"
  ],
  "files_changed_count": 1,
  "stats": [
    {
      "file": "arch/x86/kvm/x86.c",
      "insertions": 8,
      "deletions": 0
    }
  ],
  "total_insertions": 8,
  "total_deletions": 0,
  "total_changes": 8,
  "parents": [
    "9b0971ca7fc75daca80c0bb6c02e96059daea90a"
  ],
  "branches": [
    "* development",
    "remotes/origin/HEAD -> origin/master",
    "remotes/origin/master"
  ],
  "tags": [],
  "is_merge": false,
  "security_info": {
    "cve_ids": [],
    "security_keywords": [
      "injection"
    ]
  },
  "fix_type": "security",
  "file_results": [
    {
      "file": "arch/x86/kvm/x86.c",
      "pre_version": false,
      "post_version": true,
      "patch": true
    }
  ]
}