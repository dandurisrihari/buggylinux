{
  "hash": "40920c2bb119fd49ba03e2f97a172171781be442",
  "hash_short": "40920c2b",
  "subject": "CIFS: handle guest access errors to Windows shares",
  "body": "Commit 1a967d6c9b39c226be1b45f13acd4d8a5ab3dc44 (\"correctly to\nanonymous authentication for the NTLM(v2) authentication\") introduces\na regression in handling errors related to attempting a guest\nconnection to a Windows share which requires authentication. This\nshould result in a permission denied error but actually causes the\nkernel module to enter a never-ending loop trying to follow a DFS\nreferal which doesn't exist.\n\nThe base cause of this is the failure now occurs later in the process\nduring tree connect and not at the session setup setup and all errors\nin tree connect are interpreted as needing to follow the DFS paths\nwhich isn't in this case correct. So, check the returned error against\nEACCES and fail if this is returned error.\n\nFeedback from Aurelien:\n\n  PS> net user guest /activate:no\n    PS> mkdir C:\\guestshare\n      PS> icacls C:\\guestshare /grant 'Everyone:(OI)(CI)F'\n        PS> new-smbshare -name guestshare -path C:\\guestshare -fullaccess Everyone\n\n        I've tested v3.10, v4.4, master, master+your patch using default options\n        (empty or no user \"NU\") and user=abc (U).\n\n        NT_LOGON_FAILURE in session setup: LF\n        This is what you seem to have in 3.10.\n\n        NT_ACCESS_DENIED in tree connect to the share: AD\n        This is what you get before your infinite loop.\n\n                     |   NU       U\n                     --------------------------------\n                     3.10         |   LF       LF\n                     4.4          |   LF       LF\n                     master       |   AD       LF\n                     master+patch |   AD       LF\n\n                     No infinite DFS loop :(\n                     All these issues result in mount failing very fast with permission denied.\n\n                     I guess it could be from either the Windows version or the share/folder\n                     ACL. A deeper analysis of the packets might reveal more.\n\n                     In any case I did not notice any issues for on a basic DFS setup with\n                     the patch so I don't think it introduced any regressions, which is\n                     probably all that matters. It still bothers me a little I couldn't hit\n                     the bug.\n\n                     I've included kernel output w/ debugging output and network capture of\n                     my tests if anyone want to have a look at it. (master+patch = ml-guestfix).\n\nSigned-off-by: Mark Syms <mark.syms@citrix.com>\nReviewed-by: Aurelien Aptel <aaptel@suse.com>\nTested-by: Aurelien Aptel <aaptel@suse.com>\nAcked-by: Pavel Shilovsky <pshilov@microsoft.com>\nSigned-off-by: Steve French <smfrench@gmail.com>",
  "full_message": "CIFS: handle guest access errors to Windows shares\n\nCommit 1a967d6c9b39c226be1b45f13acd4d8a5ab3dc44 (\"correctly to\nanonymous authentication for the NTLM(v2) authentication\") introduces\na regression in handling errors related to attempting a guest\nconnection to a Windows share which requires authentication. This\nshould result in a permission denied error but actually causes the\nkernel module to enter a never-ending loop trying to follow a DFS\nreferal which doesn't exist.\n\nThe base cause of this is the failure now occurs later in the process\nduring tree connect and not at the session setup setup and all errors\nin tree connect are interpreted as needing to follow the DFS paths\nwhich isn't in this case correct. So, check the returned error against\nEACCES and fail if this is returned error.\n\nFeedback from Aurelien:\n\n  PS> net user guest /activate:no\n    PS> mkdir C:\\guestshare\n      PS> icacls C:\\guestshare /grant 'Everyone:(OI)(CI)F'\n        PS> new-smbshare -name guestshare -path C:\\guestshare -fullaccess Everyone\n\n        I've tested v3.10, v4.4, master, master+your patch using default options\n        (empty or no user \"NU\") and user=abc (U).\n\n        NT_LOGON_FAILURE in session setup: LF\n        This is what you seem to have in 3.10.\n\n        NT_ACCESS_DENIED in tree connect to the share: AD\n        This is what you get before your infinite loop.\n\n                     |   NU       U\n                     --------------------------------\n                     3.10         |   LF       LF\n                     4.4          |   LF       LF\n                     master       |   AD       LF\n                     master+patch |   AD       LF\n\n                     No infinite DFS loop :(\n                     All these issues result in mount failing very fast with permission denied.\n\n                     I guess it could be from either the Windows version or the share/folder\n                     ACL. A deeper analysis of the packets might reveal more.\n\n                     In any case I did not notice any issues for on a basic DFS setup with\n                     the patch so I don't think it introduced any regressions, which is\n                     probably all that matters. It still bothers me a little I couldn't hit\n                     the bug.\n\n                     I've included kernel output w/ debugging output and network capture of\n                     my tests if anyone want to have a look at it. (master+patch = ml-guestfix).\n\nSigned-off-by: Mark Syms <mark.syms@citrix.com>\nReviewed-by: Aurelien Aptel <aaptel@suse.com>\nTested-by: Aurelien Aptel <aaptel@suse.com>\nAcked-by: Pavel Shilovsky <pshilov@microsoft.com>\nSigned-off-by: Steve French <smfrench@gmail.com>",
  "author_name": "Mark Syms",
  "author_email": "mark.syms@citrix.com",
  "author_date": "Tue Nov 29 11:36:46 2016 +0000",
  "author_date_iso": "2016-11-29T11:36:46+00:00",
  "committer_name": "Steve French",
  "committer_email": "smfrench@gmail.com",
  "committer_date": "Mon Apr 10 23:36:38 2017 -0500",
  "committer_date_iso": "2017-04-10T23:36:38-05:00",
  "files_changed": [
    "fs/cifs/connect.c"
  ],
  "files_changed_count": 1,
  "stats": [
    {
      "file": "fs/cifs/connect.c",
      "insertions": 3,
      "deletions": 0
    }
  ],
  "total_insertions": 3,
  "total_deletions": 0,
  "total_changes": 3,
  "parents": [
    "350be257ea83029daee974c72b1fe2e6f1f8e615"
  ],
  "branches": [
    "* development",
    "master",
    "remotes/origin/HEAD -> origin/master",
    "remotes/origin/master"
  ],
  "tags": [
    "v4.11",
    "v4.11-rc7",
    "v4.11-rc8",
    "v4.12",
    "v4.12-rc1",
    "v4.12-rc2",
    "v4.12-rc3",
    "v4.12-rc4",
    "v4.12-rc5",
    "v4.12-rc6"
  ],
  "is_merge": false,
  "security_info": {
    "cve_ids": [],
    "security_keywords": [
      "authentication"
    ]
  },
  "fix_type": "security",
  "file_results": [
    {
      "file": "fs/cifs/connect.c",
      "pre_version": false,
      "post_version": true,
      "patch": true
    }
  ]
}