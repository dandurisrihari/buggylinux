diff --cc mm/hugetlb.c
index b61d2db9f34e,303fb0c02364..cc5be788a39f
--- a/mm/hugetlb.c
+++ b/mm/hugetlb.c
@@@ -2355,11 -2400,10 +2403,13 @@@ retry_avoidcopy
  		huge_ptep_clear_flush(vma, address, ptep);
  		set_huge_pte_at(mm, address, ptep,
  				make_huge_pte(vma, new_page, 1));
+ 		page_remove_rmap(old_page);
+ 		hugepage_add_anon_rmap(new_page, vma, address);
  		/* Make the old page be freed below */
  		new_page = old_page;
 +		mmu_notifier_invalidate_range_end(mm,
 +			address & huge_page_mask(h),
 +			(address & huge_page_mask(h)) + huge_page_size(h));
  	}
  	page_cache_release(new_page);
  	page_cache_release(old_page);
diff --cc mm/memory-failure.c
index 6b44e52cacaa,d0b420aba726..9c26eeca1342
--- a/mm/memory-failure.c
+++ b/mm/memory-failure.c
@@@ -45,7 -45,7 +45,8 @@@
  #include <linux/page-isolation.h>
  #include <linux/suspend.h>
  #include <linux/slab.h>
 +#include <linux/swapops.h>
+ #include <linux/hugetlb.h>
  #include "internal.h"
  
  int sysctl_memory_failure_early_kill __read_mostly = 0;