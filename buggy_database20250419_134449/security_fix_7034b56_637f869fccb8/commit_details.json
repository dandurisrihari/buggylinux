{
  "hash": "7034b566a4e7d550621c2dfafd380b77b3787cd9",
  "hash_short": "7034b566",
  "subject": "netfilter: fix nf_queue handling",
  "body": "nf_queue handling is broken since e3b37f11e6e4 (\"netfilter: replace\nlist_head with single linked list\") for two reasons:\n\n1) If the bypass flag is set on, there are no userspace listeners and\n   we still have more hook entries to iterate over, then jump to the\n   next hook. Otherwise accept the packet. On nf_reinject() path, the\n   okfn() needs to be invoked.\n\n2) We should not re-enter the same hook on packet reinjection. If the\n   packet is accepted, we have to skip the current hook from where the\n   packet was enqueued, otherwise the packets gets enqueued over and\n   over again.\n\nThis restores the previous list_for_each_entry_continue() behaviour\nhappening from nf_iterate() that was dealing with these two cases.\nThis patch introduces a new nf_queue() wrapper function so this fix\nbecomes simpler.\n\nFixes: e3b37f11e6e4 (\"netfilter: replace list_head with single linked list\")\nSigned-off-by: Pablo Neira Ayuso <pablo@netfilter.org>",
  "full_message": "netfilter: fix nf_queue handling\n\nnf_queue handling is broken since e3b37f11e6e4 (\"netfilter: replace\nlist_head with single linked list\") for two reasons:\n\n1) If the bypass flag is set on, there are no userspace listeners and\n   we still have more hook entries to iterate over, then jump to the\n   next hook. Otherwise accept the packet. On nf_reinject() path, the\n   okfn() needs to be invoked.\n\n2) We should not re-enter the same hook on packet reinjection. If the\n   packet is accepted, we have to skip the current hook from where the\n   packet was enqueued, otherwise the packets gets enqueued over and\n   over again.\n\nThis restores the previous list_for_each_entry_continue() behaviour\nhappening from nf_iterate() that was dealing with these two cases.\nThis patch introduces a new nf_queue() wrapper function so this fix\nbecomes simpler.\n\nFixes: e3b37f11e6e4 (\"netfilter: replace list_head with single linked list\")\nSigned-off-by: Pablo Neira Ayuso <pablo@netfilter.org>",
  "author_name": "Pablo Neira Ayuso",
  "author_email": "pablo@netfilter.org",
  "author_date": "Mon Oct 17 18:05:32 2016 +0100",
  "author_date_iso": "2016-10-17T18:05:32+01:00",
  "committer_name": "Pablo Neira Ayuso",
  "committer_email": "pablo@netfilter.org",
  "committer_date": "Thu Oct 20 19:59:59 2016 +0200",
  "committer_date_iso": "2016-10-20T19:59:59+02:00",
  "files_changed": [
    "net/netfilter/core.c",
    "net/netfilter/nf_internals.h",
    "net/netfilter/nf_queue.c"
  ],
  "files_changed_count": 3,
  "stats": [
    {
      "file": "net/netfilter/core.c",
      "insertions": 3,
      "deletions": 10
    },
    {
      "file": "net/netfilter/nf_internals.h",
      "insertions": 1,
      "deletions": 1
    },
    {
      "file": "net/netfilter/nf_queue.c",
      "insertions": 32,
      "deletions": 16
    }
  ],
  "total_insertions": 36,
  "total_deletions": 27,
  "total_changes": 63,
  "parents": [
    "7bb6615d395a7c130053728f3a64f6df6b2e1f18"
  ],
  "branches": [
    "* development",
    "master",
    "remotes/origin/HEAD -> origin/master",
    "remotes/origin/master"
  ],
  "tags": [
    "v4.10",
    "v4.10-rc1",
    "v4.10-rc2",
    "v4.10-rc3",
    "v4.10-rc4",
    "v4.10-rc5",
    "v4.10-rc6",
    "v4.10-rc7",
    "v4.10-rc8",
    "v4.11"
  ],
  "is_merge": false,
  "security_info": {
    "cve_ids": [],
    "security_keywords": [
      "bypass"
    ]
  },
  "fix_type": "security",
  "file_results": [
    {
      "file": "net/netfilter/core.c",
      "pre_version": false,
      "post_version": true,
      "patch": true
    },
    {
      "file": "net/netfilter/nf_internals.h",
      "pre_version": false,
      "post_version": true,
      "patch": true
    },
    {
      "file": "net/netfilter/nf_queue.c",
      "pre_version": false,
      "post_version": true,
      "patch": true
    }
  ]
}