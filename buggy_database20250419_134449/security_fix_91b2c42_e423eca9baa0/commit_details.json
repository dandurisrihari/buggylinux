{
  "hash": "91b2c42c214f570efaff80a666e30b8f6ce4f12b",
  "hash_short": "91b2c42c",
  "subject": "drm/xe: Use fault injection infrastructure to find issues at probe time",
  "body": "The kernel fault injection infrastructure is used to test proper error\nhandling during probe. The return code of the functions using\nALLOW_ERROR_INJECTION() can be conditionnally modified at runtime by\ntuning some debugfs entries. This requires CONFIG_FUNCTION_ERROR_INJECTION\n(among others).\n\nOne way to use fault injection at probe time by making each of those\nfunctions fail one at a time is:\n\n    FAILTYPE=fail_function\n    DEVICE=\"0000:00:08.0\" # depends on the system\n    ERRNO=-12 # -ENOMEM, can depend on the function\n\n    echo N > /sys/kernel/debug/$FAILTYPE/task-filter\n    echo 100 > /sys/kernel/debug/$FAILTYPE/probability\n    echo 0 > /sys/kernel/debug/$FAILTYPE/interval\n    echo -1 > /sys/kernel/debug/$FAILTYPE/times\n    echo 0 > /sys/kernel/debug/$FAILTYPE/space\n    echo 1 > /sys/kernel/debug/$FAILTYPE/verbose\n\n    modprobe xe\n    echo $DEVICE > /sys/bus/pci/drivers/xe/unbind\n\n    grep -oP \"^.* \\[xe\\]\" /sys/kernel/debug/$FAILTYPE/injectable | \\\n    cut -d ' ' -f 1 | while read -r FUNCTION ; do\n        echo \"Injecting fault in $FUNCTION\"\n        echo \"\" > /sys/kernel/debug/$FAILTYPE/inject\n        echo $FUNCTION > /sys/kernel/debug/$FAILTYPE/inject\n        printf %#x $ERRNO > /sys/kernel/debug/$FAILTYPE/$FUNCTION/retval\n        echo $DEVICE > /sys/bus/pci/drivers/xe/bind\n    done\n\n    rmmod xe\n\nIt will also be integrated into IGT for systematic execution by CI.\n\nv2: Wrappers are not needed in the cases covered by this patch, so\n    remove them and use ALLOW_ERROR_INJECTION() directly.\n\nv3: Document the use of fault injection at probe time in xe_pci_probe\n    and refer to it where ALLOW_ERROR_INJECTION() is used.\n\nSigned-off-by: Francois Dugast <francois.dugast@intel.com>\nCc: Lucas De Marchi <lucas.demarchi@intel.com>\nCc: Matthew Brost <matthew.brost@intel.com>\nCc: Rodrigo Vivi <rodrigo.vivi@intel.com>\nCc: Michal Wajdeczko <michal.wajdeczko@intel.com>\nCc: Jani Nikula <jani.nikula@intel.com>\nReviewed-by: Rodrigo Vivi <rodrigo.vivi@intel.com>\nLink: https://patchwork.freedesktop.org/patch/msgid/20240927151207.399354-1-francois.dugast@intel.com\nSigned-off-by: Rodrigo Vivi <rodrigo.vivi@intel.com>",
  "full_message": "drm/xe: Use fault injection infrastructure to find issues at probe time\n\nThe kernel fault injection infrastructure is used to test proper error\nhandling during probe. The return code of the functions using\nALLOW_ERROR_INJECTION() can be conditionnally modified at runtime by\ntuning some debugfs entries. This requires CONFIG_FUNCTION_ERROR_INJECTION\n(among others).\n\nOne way to use fault injection at probe time by making each of those\nfunctions fail one at a time is:\n\n    FAILTYPE=fail_function\n    DEVICE=\"0000:00:08.0\" # depends on the system\n    ERRNO=-12 # -ENOMEM, can depend on the function\n\n    echo N > /sys/kernel/debug/$FAILTYPE/task-filter\n    echo 100 > /sys/kernel/debug/$FAILTYPE/probability\n    echo 0 > /sys/kernel/debug/$FAILTYPE/interval\n    echo -1 > /sys/kernel/debug/$FAILTYPE/times\n    echo 0 > /sys/kernel/debug/$FAILTYPE/space\n    echo 1 > /sys/kernel/debug/$FAILTYPE/verbose\n\n    modprobe xe\n    echo $DEVICE > /sys/bus/pci/drivers/xe/unbind\n\n    grep -oP \"^.* \\[xe\\]\" /sys/kernel/debug/$FAILTYPE/injectable | \\\n    cut -d ' ' -f 1 | while read -r FUNCTION ; do\n        echo \"Injecting fault in $FUNCTION\"\n        echo \"\" > /sys/kernel/debug/$FAILTYPE/inject\n        echo $FUNCTION > /sys/kernel/debug/$FAILTYPE/inject\n        printf %#x $ERRNO > /sys/kernel/debug/$FAILTYPE/$FUNCTION/retval\n        echo $DEVICE > /sys/bus/pci/drivers/xe/bind\n    done\n\n    rmmod xe\n\nIt will also be integrated into IGT for systematic execution by CI.\n\nv2: Wrappers are not needed in the cases covered by this patch, so\n    remove them and use ALLOW_ERROR_INJECTION() directly.\n\nv3: Document the use of fault injection at probe time in xe_pci_probe\n    and refer to it where ALLOW_ERROR_INJECTION() is used.\n\nSigned-off-by: Francois Dugast <francois.dugast@intel.com>\nCc: Lucas De Marchi <lucas.demarchi@intel.com>\nCc: Matthew Brost <matthew.brost@intel.com>\nCc: Rodrigo Vivi <rodrigo.vivi@intel.com>\nCc: Michal Wajdeczko <michal.wajdeczko@intel.com>\nCc: Jani Nikula <jani.nikula@intel.com>\nReviewed-by: Rodrigo Vivi <rodrigo.vivi@intel.com>\nLink: https://patchwork.freedesktop.org/patch/msgid/20240927151207.399354-1-francois.dugast@intel.com\nSigned-off-by: Rodrigo Vivi <rodrigo.vivi@intel.com>",
  "author_name": "Francois Dugast",
  "author_email": "francois.dugast@intel.com",
  "author_date": "Fri Sep 27 17:12:06 2024 +0200",
  "author_date_iso": "2024-09-27T17:12:06+02:00",
  "committer_name": "Rodrigo Vivi",
  "committer_email": "rodrigo.vivi@intel.com",
  "committer_date": "Thu Oct 3 08:58:26 2024 -0400",
  "committer_date_iso": "2024-10-03T08:58:26-04:00",
  "files_changed": [
    "drivers/gpu/drm/xe/xe_device.c",
    "drivers/gpu/drm/xe/xe_ggtt.c",
    "drivers/gpu/drm/xe/xe_guc_ads.c",
    "drivers/gpu/drm/xe/xe_guc_ct.c",
    "drivers/gpu/drm/xe/xe_guc_log.c",
    "drivers/gpu/drm/xe/xe_guc_relay.c",
    "drivers/gpu/drm/xe/xe_pci.c",
    "drivers/gpu/drm/xe/xe_pm.c",
    "drivers/gpu/drm/xe/xe_sriov.c",
    "drivers/gpu/drm/xe/xe_tile.c",
    "drivers/gpu/drm/xe/xe_uc_fw.c",
    "drivers/gpu/drm/xe/xe_wa.c",
    "drivers/gpu/drm/xe/xe_wopcm.c"
  ],
  "files_changed_count": 13,
  "stats": [
    {
      "file": "drivers/gpu/drm/xe/xe_device.c",
      "insertions": 3,
      "deletions": 0
    },
    {
      "file": "drivers/gpu/drm/xe/xe_ggtt.c",
      "insertions": 2,
      "deletions": 0
    },
    {
      "file": "drivers/gpu/drm/xe/xe_guc_ads.c",
      "insertions": 3,
      "deletions": 0
    },
    {
      "file": "drivers/gpu/drm/xe/xe_guc_ct.c",
      "insertions": 2,
      "deletions": 0
    },
    {
      "file": "drivers/gpu/drm/xe/xe_guc_log.c",
      "insertions": 3,
      "deletions": 0
    },
    {
      "file": "drivers/gpu/drm/xe/xe_guc_relay.c",
      "insertions": 2,
      "deletions": 0
    },
    {
      "file": "drivers/gpu/drm/xe/xe_pci.c",
      "insertions": 19,
      "deletions": 0
    },
    {
      "file": "drivers/gpu/drm/xe/xe_pm.c",
      "insertions": 2,
      "deletions": 0
    },
    {
      "file": "drivers/gpu/drm/xe/xe_sriov.c",
      "insertions": 3,
      "deletions": 0
    },
    {
      "file": "drivers/gpu/drm/xe/xe_tile.c",
      "insertions": 3,
      "deletions": 0
    },
    {
      "file": "drivers/gpu/drm/xe/xe_uc_fw.c",
      "insertions": 2,
      "deletions": 0
    },
    {
      "file": "drivers/gpu/drm/xe/xe_wa.c",
      "insertions": 2,
      "deletions": 0
    },
    {
      "file": "drivers/gpu/drm/xe/xe_wopcm.c",
      "insertions": 3,
      "deletions": 0
    }
  ],
  "total_insertions": 49,
  "total_deletions": 0,
  "total_changes": 49,
  "parents": [
    "11bfc4a2cfeaa012113d9b64fc30a5e6e742fc19"
  ],
  "branches": [
    "* development",
    "remotes/origin/HEAD -> origin/master",
    "remotes/origin/master"
  ],
  "tags": [],
  "is_merge": false,
  "security_info": {
    "cve_ids": [],
    "security_keywords": [
      "injection"
    ]
  },
  "fix_type": "security",
  "file_results": [
    {
      "file": "drivers/gpu/drm/xe/xe_guc_log.c",
      "pre_version": false,
      "post_version": true,
      "patch": true
    },
    {
      "file": "drivers/gpu/drm/xe/xe_device.c",
      "pre_version": false,
      "post_version": true,
      "patch": true
    },
    {
      "file": "drivers/gpu/drm/xe/xe_guc_relay.c",
      "pre_version": false,
      "post_version": true,
      "patch": true
    },
    {
      "file": "drivers/gpu/drm/xe/xe_guc_ads.c",
      "pre_version": false,
      "post_version": true,
      "patch": true
    },
    {
      "file": "drivers/gpu/drm/xe/xe_ggtt.c",
      "pre_version": false,
      "post_version": true,
      "patch": true
    },
    {
      "file": "drivers/gpu/drm/xe/xe_guc_ct.c",
      "pre_version": true,
      "post_version": true,
      "patch": true
    },
    {
      "file": "drivers/gpu/drm/xe/xe_pm.c",
      "pre_version": false,
      "post_version": true,
      "patch": true
    },
    {
      "file": "drivers/gpu/drm/xe/xe_pci.c",
      "pre_version": false,
      "post_version": true,
      "patch": true
    },
    {
      "file": "drivers/gpu/drm/xe/xe_tile.c",
      "pre_version": false,
      "post_version": true,
      "patch": true
    },
    {
      "file": "drivers/gpu/drm/xe/xe_wopcm.c",
      "pre_version": false,
      "post_version": true,
      "patch": true
    },
    {
      "file": "drivers/gpu/drm/xe/xe_wa.c",
      "pre_version": false,
      "post_version": true,
      "patch": true
    },
    {
      "file": "drivers/gpu/drm/xe/xe_uc_fw.c",
      "pre_version": false,
      "post_version": true,
      "patch": true
    },
    {
      "file": "drivers/gpu/drm/xe/xe_sriov.c",
      "pre_version": false,
      "post_version": true,
      "patch": true
    }
  ]
}