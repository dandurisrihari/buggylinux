Commit Hash: f331601c65ad217a5c000ce20c26266d3f0aceb3
Subject: KVM: x86/pmu: Don't generate PEBS records for emulated instructions


Security Keywords:
- injection

Full commit message:
KVM: x86/pmu: Don't generate PEBS records for emulated instructions

KVM will accumulate an enabled counter for at least INSTRUCTIONS or
BRANCH_INSTRUCTION hw event from any KVM emulated instructions,
generating emulated overflow interrupt on counter overflow, which
in theory should also happen when the PEBS counter overflows but
it currently lacks this part of the underlying support (e.g. through
software injection of records in the irq context or a lazy approach).

In this case, KVM skips the injection of this BUFFER_OVF PMI (effectively
dropping one PEBS record) and let the overflow counter move on. The loss
of a single sample does not introduce a loss of accuracy, but is easily
noticeable for certain specific instructions.

This issue is expected to be addressed along with the issue
of PEBS cross-mapped counters with a slow-path proposal.

Fixes: 79f3e3b58386 ("KVM: x86/pmu: Reprogram PEBS event to emulate guest PEBS counter")
Signed-off-by: Like Xu <likexu@tencent.com>
Link: https://lore.kernel.org/r/20220831085328.45489-3-likexu@tencent.com
Signed-off-by: Sean Christopherson <seanjc@google.com>

Metadata:
Author: Like Xu <likexu@tencent.com>
Author Date: Wed Aug 31 16:53:23 2022 +0800
Committer: Sean Christopherson <seanjc@google.com>
Commit Date: Wed Sep 28 12:47:21 2022 -0700

Files Changed: 1
Lines Added: 13
Lines Removed: 3
Total Changes: 16
