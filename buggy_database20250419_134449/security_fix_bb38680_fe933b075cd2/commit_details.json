{
  "hash": "bb3868033a4cccff7be57e9145f2117cbdc91c11",
  "hash_short": "bb386803",
  "subject": "btrfs: do not BUG_ON() when freeing tree block after error",
  "body": "When freeing a tree block, at btrfs_free_tree_block(), if we fail to\ncreate a delayed reference we don't deal with the error and just do a\nBUG_ON(). The error most likely to happen is -ENOMEM, and we have a\ncomment mentioning that only -ENOMEM can happen, but that is not true,\nbecause in case qgroups are enabled any error returned from\nbtrfs_qgroup_trace_extent_post() (can be -EUCLEAN or anything returned\nfrom btrfs_search_slot() for example) can be propagated back to\nbtrfs_free_tree_block().\n\nSo stop doing a BUG_ON() and return the error to the callers and make\nthem abort the transaction to prevent leaking space. Syzbot was\ntriggering this, likely due to memory allocation failure injection.\n\nReported-by: syzbot+a306f914b4d01b3958fe@syzkaller.appspotmail.com\nLink: https://lore.kernel.org/linux-btrfs/000000000000fcba1e05e998263c@google.com/\nReviewed-by: Qu Wenruo <wqu@suse.com>\nSigned-off-by: Filipe Manana <fdmanana@suse.com>\nReviewed-by: David Sterba <dsterba@suse.com>\nSigned-off-by: David Sterba <dsterba@suse.com>",
  "full_message": "btrfs: do not BUG_ON() when freeing tree block after error\n\nWhen freeing a tree block, at btrfs_free_tree_block(), if we fail to\ncreate a delayed reference we don't deal with the error and just do a\nBUG_ON(). The error most likely to happen is -ENOMEM, and we have a\ncomment mentioning that only -ENOMEM can happen, but that is not true,\nbecause in case qgroups are enabled any error returned from\nbtrfs_qgroup_trace_extent_post() (can be -EUCLEAN or anything returned\nfrom btrfs_search_slot() for example) can be propagated back to\nbtrfs_free_tree_block().\n\nSo stop doing a BUG_ON() and return the error to the callers and make\nthem abort the transaction to prevent leaking space. Syzbot was\ntriggering this, likely due to memory allocation failure injection.\n\nReported-by: syzbot+a306f914b4d01b3958fe@syzkaller.appspotmail.com\nLink: https://lore.kernel.org/linux-btrfs/000000000000fcba1e05e998263c@google.com/\nReviewed-by: Qu Wenruo <wqu@suse.com>\nSigned-off-by: Filipe Manana <fdmanana@suse.com>\nReviewed-by: David Sterba <dsterba@suse.com>\nSigned-off-by: David Sterba <dsterba@suse.com>",
  "author_name": "Filipe Manana",
  "author_email": "fdmanana@suse.com",
  "author_date": "Fri Jun 14 14:50:47 2024 +0100",
  "author_date_iso": "2024-06-14T14:50:47+01:00",
  "committer_name": "David Sterba",
  "committer_email": "dsterba@suse.com",
  "committer_date": "Thu Jul 11 15:33:26 2024 +0200",
  "committer_date_iso": "2024-07-11T15:33:26+02:00",
  "files_changed": [
    "fs/btrfs/ctree.c",
    "fs/btrfs/extent-tree.c",
    "fs/btrfs/extent-tree.h",
    "fs/btrfs/free-space-tree.c",
    "fs/btrfs/ioctl.c",
    "fs/btrfs/qgroup.c"
  ],
  "files_changed_count": 6,
  "stats": [
    {
      "file": "fs/btrfs/ctree.c",
      "insertions": 42,
      "deletions": 11
    },
    {
      "file": "fs/btrfs/extent-tree.c",
      "insertions": 14,
      "deletions": 10
    },
    {
      "file": "fs/btrfs/extent-tree.h",
      "insertions": 4,
      "deletions": 4
    },
    {
      "file": "fs/btrfs/free-space-tree.c",
      "insertions": 7,
      "deletions": 3
    },
    {
      "file": "fs/btrfs/ioctl.c",
      "insertions": 5,
      "deletions": 1
    },
    {
      "file": "fs/btrfs/qgroup.c",
      "insertions": 4,
      "deletions": 2
    }
  ],
  "total_insertions": 76,
  "total_deletions": 31,
  "total_changes": 107,
  "parents": [
    "b7519157655bba3f885a856c1ec8b6560b51e214"
  ],
  "branches": [
    "* development",
    "remotes/origin/HEAD -> origin/master",
    "remotes/origin/master"
  ],
  "tags": [],
  "is_merge": false,
  "security_info": {
    "cve_ids": [],
    "security_keywords": [
      "injection"
    ]
  },
  "fix_type": "security",
  "file_results": [
    {
      "file": "fs/btrfs/extent-tree.c",
      "pre_version": false,
      "post_version": true,
      "patch": true
    },
    {
      "file": "fs/btrfs/extent-tree.h",
      "pre_version": false,
      "post_version": true,
      "patch": true
    },
    {
      "file": "fs/btrfs/qgroup.c",
      "pre_version": false,
      "post_version": true,
      "patch": true
    },
    {
      "file": "fs/btrfs/free-space-tree.c",
      "pre_version": false,
      "post_version": true,
      "patch": true
    },
    {
      "file": "fs/btrfs/ioctl.c",
      "pre_version": false,
      "post_version": true,
      "patch": true
    },
    {
      "file": "fs/btrfs/ctree.c",
      "pre_version": false,
      "post_version": true,
      "patch": true
    }
  ]
}