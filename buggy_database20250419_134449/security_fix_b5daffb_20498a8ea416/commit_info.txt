Commit Hash: b5daffb120bb60f974ae1a5589160b05c98e00e5
Subject: KVM: arm64: vgic-v3: Optimize affinity-based SGI injection


Security Keywords:
- injection

Full commit message:
KVM: arm64: vgic-v3: Optimize affinity-based SGI injection

Our affinity-based SGI injection code is a bit daft. We iterate
over all the CPUs trying to match the set of affinities that the
guest is trying to reach, leading to some very bad behaviours
if the selected targets are at a high vcpu index.

Instead, we can now use the fact that we have an optimised
MPIDR to vcpu mapping, and only look at the relevant values.

This results in a much faster injection for large VMs, and
in a near constant time, irrespective of the position in the
vcpu index space.

As a bonus, this is mostly deleting a lot of hard-to-read
code. Nobody will complain about that.

Suggested-by: Xu Zhao <zhaoxu.35@bytedance.com>
Tested-by: Joey Gouly <joey.gouly@arm.com>
Tested-by: Shameer Kolothum <shameerali.kolothum.thodi@huawei.com>
Reviewed-by: Zenghui Yu <yuzenghui@huawei.com>
Signed-off-by: Marc Zyngier <maz@kernel.org>
Link: https://lore.kernel.org/r/20230927090911.3355209-11-maz@kernel.org
Signed-off-by: Oliver Upton <oliver.upton@linux.dev>

Metadata:
Author: Marc Zyngier <maz@kernel.org>
Author Date: Wed Sep 27 10:09:10 2023 +0100
Committer: Oliver Upton <oliver.upton@linux.dev>
Commit Date: Sat Sep 30 18:15:44 2023 +0000

Files Changed: 1
Lines Added: 11
Lines Removed: 53
Total Changes: 64
