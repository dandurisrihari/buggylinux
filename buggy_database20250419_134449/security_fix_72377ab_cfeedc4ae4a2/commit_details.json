{
  "hash": "72377ab2d671befd6390a1d5677f5cca61235b65",
  "hash_short": "72377ab2",
  "subject": "mptcp: more conservative check for zero probes",
  "body": "Christoph reported that the MPTCP protocol can find the subflow-level\nwrite queue unexpectedly not empty while crafting a zero-window probe,\nhitting a warning:\n\n------------[ cut here ]------------\nWARNING: CPU: 0 PID: 188 at net/mptcp/protocol.c:1312 mptcp_sendmsg_frag+0xc06/0xe70\nModules linked in:\nCPU: 0 PID: 188 Comm: kworker/0:2 Not tainted 6.6.0-rc2-g1176aa719d7a #47\nHardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.11.0-2.el7 04/01/2014\nWorkqueue: events mptcp_worker\nRIP: 0010:mptcp_sendmsg_frag+0xc06/0xe70 net/mptcp/protocol.c:1312\nRAX: 47d0530de347ff6a RBX: 47d0530de347ff6b RCX: ffff8881015d3c00\nRDX: ffff8881015d3c00 RSI: 47d0530de347ff6b RDI: 47d0530de347ff6b\nRBP: 47d0530de347ff6b R08: ffffffff8243c6a8 R09: ffffffff82042d9c\nR10: 0000000000000002 R11: ffffffff82056850 R12: ffff88812a13d580\nR13: 0000000000000001 R14: ffff88812b375e50 R15: ffff88812bbf3200\nFS:  0000000000000000(0000) GS:ffff88813bc00000(0000) knlGS:0000000000000000\nCS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033\nCR2: 0000000000695118 CR3: 0000000115dfc001 CR4: 0000000000170ef0\nCall Trace:\n <TASK>\n __subflow_push_pending+0xa4/0x420 net/mptcp/protocol.c:1545\n __mptcp_push_pending+0x128/0x3b0 net/mptcp/protocol.c:1614\n mptcp_release_cb+0x218/0x5b0 net/mptcp/protocol.c:3391\n release_sock+0xf6/0x100 net/core/sock.c:3521\n mptcp_worker+0x6e8/0x8f0 net/mptcp/protocol.c:2746\n process_scheduled_works+0x341/0x690 kernel/workqueue.c:2630\n worker_thread+0x3a7/0x610 kernel/workqueue.c:2784\n kthread+0x143/0x180 kernel/kthread.c:388\n ret_from_fork+0x4d/0x60 arch/x86/kernel/process.c:147\n ret_from_fork_asm+0x1b/0x30 arch/x86/entry/entry_64.S:304\n </TASK>\n\nThe root cause of the issue is that expectations are wrong: e.g. due\nto MPTCP-level re-injection we can hit the critical condition.\n\nExplicitly avoid the zero-window probe when the subflow write queue\nis not empty and drop the related warnings.\n\nReported-by: Christoph Paasch <cpaasch@apple.com>\nCloses: https://github.com/multipath-tcp/mptcp_net-next/issues/444\nFixes: f70cad1085d1 (\"mptcp: stop relying on tcp_tx_skb_cache\")\nCc: stable@vger.kernel.org\nReviewed-by: Mat Martineau <martineau@kernel.org>\nSigned-off-by: Paolo Abeni <pabeni@redhat.com>\nSigned-off-by: Mat Martineau <martineau@kernel.org>\nLink: https://lore.kernel.org/r/20231018-send-net-20231018-v1-3-17ecb002e41d@kernel.org\nSigned-off-by: Jakub Kicinski <kuba@kernel.org>",
  "full_message": "mptcp: more conservative check for zero probes\n\nChristoph reported that the MPTCP protocol can find the subflow-level\nwrite queue unexpectedly not empty while crafting a zero-window probe,\nhitting a warning:\n\n------------[ cut here ]------------\nWARNING: CPU: 0 PID: 188 at net/mptcp/protocol.c:1312 mptcp_sendmsg_frag+0xc06/0xe70\nModules linked in:\nCPU: 0 PID: 188 Comm: kworker/0:2 Not tainted 6.6.0-rc2-g1176aa719d7a #47\nHardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.11.0-2.el7 04/01/2014\nWorkqueue: events mptcp_worker\nRIP: 0010:mptcp_sendmsg_frag+0xc06/0xe70 net/mptcp/protocol.c:1312\nRAX: 47d0530de347ff6a RBX: 47d0530de347ff6b RCX: ffff8881015d3c00\nRDX: ffff8881015d3c00 RSI: 47d0530de347ff6b RDI: 47d0530de347ff6b\nRBP: 47d0530de347ff6b R08: ffffffff8243c6a8 R09: ffffffff82042d9c\nR10: 0000000000000002 R11: ffffffff82056850 R12: ffff88812a13d580\nR13: 0000000000000001 R14: ffff88812b375e50 R15: ffff88812bbf3200\nFS:  0000000000000000(0000) GS:ffff88813bc00000(0000) knlGS:0000000000000000\nCS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033\nCR2: 0000000000695118 CR3: 0000000115dfc001 CR4: 0000000000170ef0\nCall Trace:\n <TASK>\n __subflow_push_pending+0xa4/0x420 net/mptcp/protocol.c:1545\n __mptcp_push_pending+0x128/0x3b0 net/mptcp/protocol.c:1614\n mptcp_release_cb+0x218/0x5b0 net/mptcp/protocol.c:3391\n release_sock+0xf6/0x100 net/core/sock.c:3521\n mptcp_worker+0x6e8/0x8f0 net/mptcp/protocol.c:2746\n process_scheduled_works+0x341/0x690 kernel/workqueue.c:2630\n worker_thread+0x3a7/0x610 kernel/workqueue.c:2784\n kthread+0x143/0x180 kernel/kthread.c:388\n ret_from_fork+0x4d/0x60 arch/x86/kernel/process.c:147\n ret_from_fork_asm+0x1b/0x30 arch/x86/entry/entry_64.S:304\n </TASK>\n\nThe root cause of the issue is that expectations are wrong: e.g. due\nto MPTCP-level re-injection we can hit the critical condition.\n\nExplicitly avoid the zero-window probe when the subflow write queue\nis not empty and drop the related warnings.\n\nReported-by: Christoph Paasch <cpaasch@apple.com>\nCloses: https://github.com/multipath-tcp/mptcp_net-next/issues/444\nFixes: f70cad1085d1 (\"mptcp: stop relying on tcp_tx_skb_cache\")\nCc: stable@vger.kernel.org\nReviewed-by: Mat Martineau <martineau@kernel.org>\nSigned-off-by: Paolo Abeni <pabeni@redhat.com>\nSigned-off-by: Mat Martineau <martineau@kernel.org>\nLink: https://lore.kernel.org/r/20231018-send-net-20231018-v1-3-17ecb002e41d@kernel.org\nSigned-off-by: Jakub Kicinski <kuba@kernel.org>",
  "author_name": "Paolo Abeni",
  "author_email": "pabeni@redhat.com",
  "author_date": "Wed Oct 18 11:23:54 2023 -0700",
  "author_date_iso": "2023-10-18T11:23:54-07:00",
  "committer_name": "Jakub Kicinski",
  "committer_email": "kuba@kernel.org",
  "committer_date": "Thu Oct 19 09:10:00 2023 -0700",
  "committer_date_iso": "2023-10-19T09:10:00-07:00",
  "files_changed": [
    "net/mptcp/protocol.c"
  ],
  "files_changed_count": 1,
  "stats": [
    {
      "file": "net/mptcp/protocol.c",
      "insertions": 1,
      "deletions": 7
    }
  ],
  "total_insertions": 1,
  "total_deletions": 7,
  "total_changes": 8,
  "parents": [
    "6db8a37dfc541e059851652cfd4f0bb13b8ff6af"
  ],
  "branches": [
    "* development",
    "remotes/origin/HEAD -> origin/master",
    "remotes/origin/master"
  ],
  "tags": [],
  "is_merge": false,
  "security_info": {
    "cve_ids": [],
    "security_keywords": [
      "injection"
    ]
  },
  "fix_type": "security",
  "file_results": [
    {
      "file": "net/mptcp/protocol.c",
      "pre_version": false,
      "post_version": true,
      "patch": true
    }
  ]
}