diff --cc drivers/block/ublk_drv.c
index 604c1a13c76e,253008b2091d..afbef182820b
--- a/drivers/block/ublk_drv.c
+++ b/drivers/block/ublk_drv.c
@@@ -1261,10 -1254,22 +1259,23 @@@ static void ublk_handle_need_get_data(s
  	ublk_queue_cmd(ubq, req);
  }
  
+ static inline int ublk_check_cmd_op(u32 cmd_op)
+ {
+ 	u32 ioc_type = _IOC_TYPE(cmd_op);
+ 
+ 	if (IS_ENABLED(CONFIG_BLKDEV_UBLK_LEGACY_OPCODES) && ioc_type != 'u')
+ 		return -EOPNOTSUPP;
+ 
+ 	if (ioc_type != 'u' && ioc_type != 0)
+ 		return -EOPNOTSUPP;
+ 
+ 	return 0;
+ }
+ 
 -static int ublk_ch_uring_cmd(struct io_uring_cmd *cmd, unsigned int issue_flags)
 +static int __ublk_ch_uring_cmd(struct io_uring_cmd *cmd,
 +			       unsigned int issue_flags,
 +			       struct ublksrv_io_cmd *ub_cmd)
  {
 -	struct ublksrv_io_cmd *ub_cmd = (struct ublksrv_io_cmd *)cmd->cmd;
  	struct ublk_device *ub = cmd->file->private_data;
  	struct ublk_queue *ubq;
  	struct ublk_io *io;