Commit Hash: c5c354a3a4728045e1342166394c615d75d45377
Subject: drm/udl: Fix inconsistent urbs.count value during udl_free_urb_list()


Security Keywords:
- hardening

Full commit message:
drm/udl: Fix inconsistent urbs.count value during udl_free_urb_list()

In the current design, udl_get_urb() may be called asynchronously
during the driver freeing its URL list via udl_free_urb_list().
The problem is that the sync is determined by comparing the urbs.count
and urbs.available fields, while we clear urbs.count field only once
after udl_free_urb_list() finishes, i.e. during udl_free_urb_list(),
the state becomes inconsistent.

For fixing this inconsistency and also for hardening the locking
scheme, this patch does a slight refactoring of the code around
udl_get_urb() and udl_free_urb_list().  Now urbs.count is updated in
the same spinlock at extracting a URB from the list in
udl_free_url_list().

Acked-by: Thomas Zimmermann <tzimmermann@suse.de>
Signed-off-by: Takashi Iwai <tiwai@suse.de>
Signed-off-by: Thomas Zimmermann <tzimmermann@suse.de>
Link: https://patchwork.freedesktop.org/patch/msgid/20220908095115.23396-11-tiwai@suse.de

Metadata:
Author: Takashi Iwai <tiwai@suse.de>
Author Date: Thu Sep 8 11:51:13 2022 +0200
Committer: Thomas Zimmermann <tzimmermann@suse.de>
Commit Date: Sat Sep 10 21:45:52 2022 +0200

Files Changed: 2
Lines Added: 30
Lines Removed: 20
Total Changes: 50
