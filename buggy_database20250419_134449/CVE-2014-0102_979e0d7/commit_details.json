{
  "hash": "979e0d74651ba5aa533277f2a6423d0f982fb6f6",
  "hash_short": "979e0d74",
  "subject": "KEYS: Make the keyring cycle detector ignore other keyrings of the same name",
  "body": "This fixes CVE-2014-0102.\n\nThe following command sequence produces an oops:\n\n\tkeyctl new_session\n\ti=`keyctl newring _ses @s`\n\tkeyctl link @s $i\n\nThe problem is that search_nested_keyrings() sees two keyrings that have\nmatching type and description, so keyring_compare_object() returns true.\ns_n_k() then passes the key to the iterator function -\nkeyring_detect_cycle_iterator() - which *should* check to see whether this is\nthe keyring of interest, not just one with the same name.\n\nBecause assoc_array_find() will return one and only one match, I assumed that\nthe iterator function would only see an exact match or never be called - but\nthe iterator isn't only called from assoc_array_find()...\n\nThe oops looks something like this:\n\n\tkernel BUG at /data/fs/linux-2.6-fscache/security/keys/keyring.c:1003!\n\tinvalid opcode: 0000 [#1] SMP\n\t...\n\tRIP: keyring_detect_cycle_iterator+0xe/0x1f\n\t...\n\tCall Trace:\n\t  search_nested_keyrings+0x76/0x2aa\n\t  __key_link_check_live_key+0x50/0x5f\n\t  key_link+0x4e/0x85\n\t  keyctl_keyring_link+0x60/0x81\n\t  SyS_keyctl+0x65/0xe4\n\t  tracesys+0xdd/0xe2\n\nThe fix is to make keyring_detect_cycle_iterator() check that the key it\nhas is the key it was actually looking for rather than calling BUG_ON().\n\nA testcase has been included in the keyutils testsuite for this:\n\n\thttp://git.kernel.org/cgit/linux/kernel/git/dhowells/keyutils.git/commit/?id=891f3365d07f1996778ade0e3428f01878a1790b\n\nReported-by: Tommi Rantala <tt.rantala@gmail.com>\nSigned-off-by: David Howells <dhowells@redhat.com>\nAcked-by: James Morris <james.l.morris@oracle.com>\nSigned-off-by: Linus Torvalds <torvalds@linux-foundation.org>",
  "full_message": "KEYS: Make the keyring cycle detector ignore other keyrings of the same name\n\nThis fixes CVE-2014-0102.\n\nThe following command sequence produces an oops:\n\n\tkeyctl new_session\n\ti=`keyctl newring _ses @s`\n\tkeyctl link @s $i\n\nThe problem is that search_nested_keyrings() sees two keyrings that have\nmatching type and description, so keyring_compare_object() returns true.\ns_n_k() then passes the key to the iterator function -\nkeyring_detect_cycle_iterator() - which *should* check to see whether this is\nthe keyring of interest, not just one with the same name.\n\nBecause assoc_array_find() will return one and only one match, I assumed that\nthe iterator function would only see an exact match or never be called - but\nthe iterator isn't only called from assoc_array_find()...\n\nThe oops looks something like this:\n\n\tkernel BUG at /data/fs/linux-2.6-fscache/security/keys/keyring.c:1003!\n\tinvalid opcode: 0000 [#1] SMP\n\t...\n\tRIP: keyring_detect_cycle_iterator+0xe/0x1f\n\t...\n\tCall Trace:\n\t  search_nested_keyrings+0x76/0x2aa\n\t  __key_link_check_live_key+0x50/0x5f\n\t  key_link+0x4e/0x85\n\t  keyctl_keyring_link+0x60/0x81\n\t  SyS_keyctl+0x65/0xe4\n\t  tracesys+0xdd/0xe2\n\nThe fix is to make keyring_detect_cycle_iterator() check that the key it\nhas is the key it was actually looking for rather than calling BUG_ON().\n\nA testcase has been included in the keyutils testsuite for this:\n\n\thttp://git.kernel.org/cgit/linux/kernel/git/dhowells/keyutils.git/commit/?id=891f3365d07f1996778ade0e3428f01878a1790b\n\nReported-by: Tommi Rantala <tt.rantala@gmail.com>\nSigned-off-by: David Howells <dhowells@redhat.com>\nAcked-by: James Morris <james.l.morris@oracle.com>\nSigned-off-by: Linus Torvalds <torvalds@linux-foundation.org>",
  "author_name": "David Howells",
  "author_email": "dhowells@redhat.com",
  "author_date": "Sun Mar 9 08:21:58 2014 +0000",
  "author_date_iso": "2014-03-09T08:21:58+00:00",
  "committer_name": "Linus Torvalds",
  "committer_email": "torvalds@linux-foundation.org",
  "committer_date": "Sun Mar 9 18:57:18 2014 -0700",
  "committer_date_iso": "2014-03-09T18:57:18-07:00",
  "files_changed": [
    "security/keys/keyring.c"
  ],
  "files_changed_count": 1,
  "stats": [
    {
      "file": "security/keys/keyring.c",
      "insertions": 5,
      "deletions": 1
    }
  ],
  "total_insertions": 5,
  "total_deletions": 1,
  "total_changes": 6,
  "parents": [
    "1dc3217dad3e771f2bd12703d6daed6cb818fdd8"
  ],
  "branches": [
    "* development",
    "master",
    "remotes/origin/HEAD -> origin/master",
    "remotes/origin/master"
  ],
  "tags": [
    "v3.14",
    "v3.14-rc6",
    "v3.14-rc7",
    "v3.14-rc8",
    "v3.15",
    "v3.15-rc1",
    "v3.15-rc2",
    "v3.15-rc3",
    "v3.15-rc4",
    "v3.15-rc5"
  ],
  "is_merge": false,
  "security_info": {
    "cve_ids": [
      "CVE-2014-0102"
    ],
    "security_keywords": []
  },
  "fix_type": "cve",
  "file_results": [
    {
      "file": "security/keys/keyring.c",
      "pre_version": false,
      "post_version": true,
      "patch": true
    }
  ]
}