Commit Hash: f4384b3e54ea813868bb81a861bf5b2406e15d8f
Subject: tee: amdtee: fix use-after-free vulnerability in amdtee_close_session


Security Keywords:
- vulnerability

Full commit message:
tee: amdtee: fix use-after-free vulnerability in amdtee_close_session

There is a potential race condition in amdtee_close_session that may
cause use-after-free in amdtee_open_session. For instance, if a session
has refcount == 1, and one thread tries to free this session via:

    kref_put(&sess->refcount, destroy_session);

the reference count will get decremented, and the next step would be to
call destroy_session(). However, if in another thread,
amdtee_open_session() is called before destroy_session() has completed
execution, alloc_session() may return 'sess' that will be freed up
later in destroy_session() leading to use-after-free in
amdtee_open_session.

To fix this issue, treat decrement of sess->refcount and removal of
'sess' from session list in destroy_session() as a critical section, so
that it is executed atomically.

Fixes: 757cc3e9ff1d ("tee: add AMD-TEE driver")
Cc: stable@vger.kernel.org
Signed-off-by: Rijo Thomas <Rijo-john.Thomas@amd.com>
Reviewed-by: Sumit Garg <sumit.garg@linaro.org>
Signed-off-by: Jens Wiklander <jens.wiklander@linaro.org>

Metadata:
Author: Rijo Thomas <Rijo-john.Thomas@amd.com>
Author Date: Fri Sep 29 12:30:24 2023 +0530
Committer: Jens Wiklander <jens.wiklander@linaro.org>
Commit Date: Tue Oct 3 19:13:53 2023 +0200

Files Changed: 1
Lines Added: 6
Lines Removed: 4
Total Changes: 10
