{
  "hash": "f4384b3e54ea813868bb81a861bf5b2406e15d8f",
  "hash_short": "f4384b3e",
  "subject": "tee: amdtee: fix use-after-free vulnerability in amdtee_close_session",
  "body": "There is a potential race condition in amdtee_close_session that may\ncause use-after-free in amdtee_open_session. For instance, if a session\nhas refcount == 1, and one thread tries to free this session via:\n\n    kref_put(&sess->refcount, destroy_session);\n\nthe reference count will get decremented, and the next step would be to\ncall destroy_session(). However, if in another thread,\namdtee_open_session() is called before destroy_session() has completed\nexecution, alloc_session() may return 'sess' that will be freed up\nlater in destroy_session() leading to use-after-free in\namdtee_open_session.\n\nTo fix this issue, treat decrement of sess->refcount and removal of\n'sess' from session list in destroy_session() as a critical section, so\nthat it is executed atomically.\n\nFixes: 757cc3e9ff1d (\"tee: add AMD-TEE driver\")\nCc: stable@vger.kernel.org\nSigned-off-by: Rijo Thomas <Rijo-john.Thomas@amd.com>\nReviewed-by: Sumit Garg <sumit.garg@linaro.org>\nSigned-off-by: Jens Wiklander <jens.wiklander@linaro.org>",
  "full_message": "tee: amdtee: fix use-after-free vulnerability in amdtee_close_session\n\nThere is a potential race condition in amdtee_close_session that may\ncause use-after-free in amdtee_open_session. For instance, if a session\nhas refcount == 1, and one thread tries to free this session via:\n\n    kref_put(&sess->refcount, destroy_session);\n\nthe reference count will get decremented, and the next step would be to\ncall destroy_session(). However, if in another thread,\namdtee_open_session() is called before destroy_session() has completed\nexecution, alloc_session() may return 'sess' that will be freed up\nlater in destroy_session() leading to use-after-free in\namdtee_open_session.\n\nTo fix this issue, treat decrement of sess->refcount and removal of\n'sess' from session list in destroy_session() as a critical section, so\nthat it is executed atomically.\n\nFixes: 757cc3e9ff1d (\"tee: add AMD-TEE driver\")\nCc: stable@vger.kernel.org\nSigned-off-by: Rijo Thomas <Rijo-john.Thomas@amd.com>\nReviewed-by: Sumit Garg <sumit.garg@linaro.org>\nSigned-off-by: Jens Wiklander <jens.wiklander@linaro.org>",
  "author_name": "Rijo Thomas",
  "author_email": "Rijo-john.Thomas@amd.com",
  "author_date": "Fri Sep 29 12:30:24 2023 +0530",
  "author_date_iso": "2023-09-29T12:30:24+05:30",
  "committer_name": "Jens Wiklander",
  "committer_email": "jens.wiklander@linaro.org",
  "committer_date": "Tue Oct 3 19:13:53 2023 +0200",
  "committer_date_iso": "2023-10-03T19:13:53+02:00",
  "files_changed": [
    "drivers/tee/amdtee/core.c"
  ],
  "files_changed_count": 1,
  "stats": [
    {
      "file": "drivers/tee/amdtee/core.c",
      "insertions": 6,
      "deletions": 4
    }
  ],
  "total_insertions": 6,
  "total_deletions": 4,
  "total_changes": 10,
  "parents": [
    "2dde18cd1d8fac735875f2e4987f11817cc0bc2c"
  ],
  "branches": [
    "* development",
    "remotes/origin/HEAD -> origin/master",
    "remotes/origin/master"
  ],
  "tags": [],
  "is_merge": false,
  "security_info": {
    "cve_ids": [],
    "security_keywords": [
      "vulnerability"
    ]
  },
  "fix_type": "security",
  "file_results": [
    {
      "file": "drivers/tee/amdtee/core.c",
      "pre_version": false,
      "post_version": true,
      "patch": true
    }
  ]
}