commit 577bdc496614ced56d999bbb425e85adf2386490
Author: Avi Kivity <avi@qumranet.com>
Date:   Sat Jul 19 08:57:05 2008 +0300

    KVM: Avoid instruction emulation when event delivery is pending
    
    When an event (such as an interrupt) is injected, and the stack is
    shadowed (and therefore write protected), the guest will exit.  The
    current code will see that the stack is shadowed and emulate a few
    instructions, each time postponing the injection.  Eventually the
    injection may succeed, but at that time the guest may be unwilling
    to accept the interrupt (for example, the TPR may have changed).
    
    This occurs every once in a while during a Windows 2008 boot.
    
    Fix by unshadowing the fault address if the fault was due to an event
    injection.
    
    Signed-off-by: Avi Kivity <avi@qumranet.com>

diff --git a/arch/x86/kvm/vmx.c b/arch/x86/kvm/vmx.c
index 0cac63701719..b918fc83435c 100644
--- a/arch/x86/kvm/vmx.c
+++ b/arch/x86/kvm/vmx.c
@@ -2298,6 +2298,8 @@ static int handle_exception(struct kvm_vcpu *vcpu, struct kvm_run *kvm_run)
 		cr2 = vmcs_readl(EXIT_QUALIFICATION);
 		KVMTRACE_3D(PAGE_FAULT, vcpu, error_code, (u32)cr2,
 			    (u32)((u64)cr2 >> 32), handler);
+		if (vect_info & VECTORING_INFO_VALID_MASK)
+			kvm_mmu_unprotect_page_virt(vcpu, cr2);
 		return kvm_mmu_page_fault(vcpu, cr2, error_code);
 	}