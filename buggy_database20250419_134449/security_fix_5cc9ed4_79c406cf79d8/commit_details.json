{
  "hash": "5cc9ed4b9a7ac579362ccebac67f7a4cdb36de06",
  "hash_short": "5cc9ed4b",
  "subject": "drm/i915: Introduce mapping of user pages into video memory (userptr) ioctl",
  "body": "By exporting the ability to map user address and inserting PTEs\nrepresenting their backing pages into the GTT, we can exploit UMA in order\nto utilize normal application data as a texture source or even as a\nrender target (depending upon the capabilities of the chipset). This has\na number of uses, with zero-copy downloads to the GPU and efficient\nreadback making the intermixed streaming of CPU and GPU operations\nfairly efficient. This ability has many widespread implications from\nfaster rendering of client-side software rasterisers (chromium),\nmitigation of stalls due to read back (firefox) and to faster pipelining\nof texture data (such as pixel buffer objects in GL or data blobs in CL).\n\nv2: Compile with CONFIG_MMU_NOTIFIER\nv3: We can sleep while performing invalidate-range, which we can utilise\nto drop our page references prior to the kernel manipulating the vma\n(for either discard or cloning) and so protect normal users.\nv4: Only run the invalidate notifier if the range intercepts the bo.\nv5: Prevent userspace from attempting to GTT mmap non-page aligned buffers\nv6: Recheck after reacquire mutex for lost mmu.\nv7: Fix implicit padding of ioctl struct by rounding to next 64bit boundary.\nv8: Fix rebasing error after forwarding porting the back port.\nv9: Limit the userptr to page aligned entries. We now expect userspace\n    to handle all the offset-in-page adjustments itself.\nv10: Prevent vma from being copied across fork to avoid issues with cow.\nv11: Drop vma behaviour changes -- locking is nigh on impossible.\n     Use a worker to load user pages to avoid lock inversions.\nv12: Use get_task_mm()/mmput() for correct refcounting of mm.\nv13: Use a worker to release the mmu_notifier to avoid lock inversion\nv14: Decouple mmu_notifier from struct_mutex using a custom mmu_notifer\n     with its own locking and tree of objects for each mm/mmu_notifier.\nv15: Prevent overlapping userptr objects, and invalidate all objects\n     within the mmu_notifier range\nv16: Fix a typo for iterating over multiple objects in the range and\n     rearrange error path to destroy the mmu_notifier locklessly.\n     Also close a race between invalidate_range and the get_pages_worker.\nv17: Close a race between get_pages_worker/invalidate_range and fresh\n     allocations of the same userptr range - and notice that\n     struct_mutex was presumed to be held when during creation it wasn't.\nv18: Sigh. Fix the refactor of st_set_pages() to allocate enough memory\n     for the struct sg_table and to clear it before reporting an error.\nv19: Always error out on read-only userptr requests as we don't have the\n     hardware infrastructure to support them at the moment.\nv20: Refuse to implement read-only support until we have the required\n     infrastructure - but reserve the bit in flags for future use.\nv21: use_mm() is not required for get_user_pages(). It is only meant to\n     be used to fix up the kernel thread's current->mm for use with\n     copy_user().\nv22: Use sg_alloc_table_from_pages for that chunky feeling\nv23: Export a function for sanity checking dma-buf rather than encode\n     userptr details elsewhere, and clean up comments based on\n     suggestions by Bradley.\n\nSigned-off-by: Chris Wilson <chris@chris-wilson.co.uk>\nCc: Tvrtko Ursulin <tvrtko.ursulin@linux.intel.com>\nCc: \"Gong, Zhipeng\" <zhipeng.gong@intel.com>\nCc: Akash Goel <akash.goel@intel.com>\nCc: \"Volkin, Bradley D\" <bradley.d.volkin@intel.com>\nReviewed-by: Tvrtko Ursulin <tvrtko.ursulin@linux.intel.com>\nReviewed-by: Brad Volkin <bradley.d.volkin@intel.com>\n[danvet: Frob ioctl allocation to pick the next one - will cause a bit\nof fuss with create2 apparently, but such are the rules.]\n[danvet2: oops, forgot to git add after manual patch application]\n[danvet3: Appease sparse.]\nSigned-off-by: Daniel Vetter <daniel.vetter@ffwll.ch>",
  "full_message": "drm/i915: Introduce mapping of user pages into video memory (userptr) ioctl\n\nBy exporting the ability to map user address and inserting PTEs\nrepresenting their backing pages into the GTT, we can exploit UMA in order\nto utilize normal application data as a texture source or even as a\nrender target (depending upon the capabilities of the chipset). This has\na number of uses, with zero-copy downloads to the GPU and efficient\nreadback making the intermixed streaming of CPU and GPU operations\nfairly efficient. This ability has many widespread implications from\nfaster rendering of client-side software rasterisers (chromium),\nmitigation of stalls due to read back (firefox) and to faster pipelining\nof texture data (such as pixel buffer objects in GL or data blobs in CL).\n\nv2: Compile with CONFIG_MMU_NOTIFIER\nv3: We can sleep while performing invalidate-range, which we can utilise\nto drop our page references prior to the kernel manipulating the vma\n(for either discard or cloning) and so protect normal users.\nv4: Only run the invalidate notifier if the range intercepts the bo.\nv5: Prevent userspace from attempting to GTT mmap non-page aligned buffers\nv6: Recheck after reacquire mutex for lost mmu.\nv7: Fix implicit padding of ioctl struct by rounding to next 64bit boundary.\nv8: Fix rebasing error after forwarding porting the back port.\nv9: Limit the userptr to page aligned entries. We now expect userspace\n    to handle all the offset-in-page adjustments itself.\nv10: Prevent vma from being copied across fork to avoid issues with cow.\nv11: Drop vma behaviour changes -- locking is nigh on impossible.\n     Use a worker to load user pages to avoid lock inversions.\nv12: Use get_task_mm()/mmput() for correct refcounting of mm.\nv13: Use a worker to release the mmu_notifier to avoid lock inversion\nv14: Decouple mmu_notifier from struct_mutex using a custom mmu_notifer\n     with its own locking and tree of objects for each mm/mmu_notifier.\nv15: Prevent overlapping userptr objects, and invalidate all objects\n     within the mmu_notifier range\nv16: Fix a typo for iterating over multiple objects in the range and\n     rearrange error path to destroy the mmu_notifier locklessly.\n     Also close a race between invalidate_range and the get_pages_worker.\nv17: Close a race between get_pages_worker/invalidate_range and fresh\n     allocations of the same userptr range - and notice that\n     struct_mutex was presumed to be held when during creation it wasn't.\nv18: Sigh. Fix the refactor of st_set_pages() to allocate enough memory\n     for the struct sg_table and to clear it before reporting an error.\nv19: Always error out on read-only userptr requests as we don't have the\n     hardware infrastructure to support them at the moment.\nv20: Refuse to implement read-only support until we have the required\n     infrastructure - but reserve the bit in flags for future use.\nv21: use_mm() is not required for get_user_pages(). It is only meant to\n     be used to fix up the kernel thread's current->mm for use with\n     copy_user().\nv22: Use sg_alloc_table_from_pages for that chunky feeling\nv23: Export a function for sanity checking dma-buf rather than encode\n     userptr details elsewhere, and clean up comments based on\n     suggestions by Bradley.\n\nSigned-off-by: Chris Wilson <chris@chris-wilson.co.uk>\nCc: Tvrtko Ursulin <tvrtko.ursulin@linux.intel.com>\nCc: \"Gong, Zhipeng\" <zhipeng.gong@intel.com>\nCc: Akash Goel <akash.goel@intel.com>\nCc: \"Volkin, Bradley D\" <bradley.d.volkin@intel.com>\nReviewed-by: Tvrtko Ursulin <tvrtko.ursulin@linux.intel.com>\nReviewed-by: Brad Volkin <bradley.d.volkin@intel.com>\n[danvet: Frob ioctl allocation to pick the next one - will cause a bit\nof fuss with create2 apparently, but such are the rules.]\n[danvet2: oops, forgot to git add after manual patch application]\n[danvet3: Appease sparse.]\nSigned-off-by: Daniel Vetter <daniel.vetter@ffwll.ch>",
  "author_name": "Chris Wilson",
  "author_email": "chris@chris-wilson.co.uk",
  "author_date": "Fri May 16 14:22:37 2014 +0100",
  "author_date_iso": "2014-05-16T14:22:37+01:00",
  "committer_name": "Daniel Vetter",
  "committer_email": "daniel.vetter@ffwll.ch",
  "committer_date": "Fri May 16 19:31:29 2014 +0200",
  "committer_date_iso": "2014-05-16T19:31:29+02:00",
  "files_changed": [
    "drivers/gpu/drm/i915/Kconfig",
    "drivers/gpu/drm/i915/Makefile",
    "drivers/gpu/drm/i915/i915_dma.c",
    "drivers/gpu/drm/i915/i915_drv.h",
    "drivers/gpu/drm/i915/i915_gem.c",
    "drivers/gpu/drm/i915/i915_gem_dmabuf.c",
    "drivers/gpu/drm/i915/i915_gem_userptr.c",
    "drivers/gpu/drm/i915/i915_gpu_error.c",
    "include/uapi/drm/i915_drm.h"
  ],
  "files_changed_count": 9,
  "stats": [
    {
      "file": "drivers/gpu/drm/i915/Kconfig",
      "insertions": 1,
      "deletions": 0
    },
    {
      "file": "drivers/gpu/drm/i915/Makefile",
      "insertions": 1,
      "deletions": 0
    },
    {
      "file": "drivers/gpu/drm/i915/i915_dma.c",
      "insertions": 1,
      "deletions": 0
    },
    {
      "file": "drivers/gpu/drm/i915/i915_drv.h",
      "insertions": 24,
      "deletions": 1
    },
    {
      "file": "drivers/gpu/drm/i915/i915_gem.c",
      "insertions": 4,
      "deletions": 0
    },
    {
      "file": "drivers/gpu/drm/i915/i915_gem_dmabuf.c",
      "insertions": 8,
      "deletions": 0
    },
    {
      "file": "drivers/gpu/drm/i915/i915_gem_userptr.c",
      "insertions": 711,
      "deletions": 0
    },
    {
      "file": "drivers/gpu/drm/i915/i915_gpu_error.c",
      "insertions": 2,
      "deletions": 0
    },
    {
      "file": "include/uapi/drm/i915_drm.h",
      "insertions": 16,
      "deletions": 0
    }
  ],
  "total_insertions": 768,
  "total_deletions": 1,
  "total_changes": 769,
  "parents": [
    "992f191f2c83f0d1184975a211070dff2a359d3b"
  ],
  "branches": [
    "* development",
    "master",
    "remotes/origin/HEAD -> origin/master",
    "remotes/origin/master"
  ],
  "tags": [
    "v3.16",
    "v3.16-rc1",
    "v3.16-rc2",
    "v3.16-rc3",
    "v3.16-rc4",
    "v3.16-rc5",
    "v3.16-rc6",
    "v3.16-rc7",
    "v3.17",
    "v3.17-rc1"
  ],
  "is_merge": false,
  "security_info": {
    "cve_ids": [],
    "security_keywords": [
      "exploit"
    ]
  },
  "fix_type": "security",
  "file_results": [
    {
      "file": "drivers/gpu/drm/i915/Kconfig",
      "pre_version": false,
      "post_version": true,
      "patch": true
    },
    {
      "file": "drivers/gpu/drm/i915/i915_gem_userptr.c",
      "pre_version": false,
      "post_version": true,
      "patch": true
    },
    {
      "file": "drivers/gpu/drm/i915/Makefile",
      "pre_version": false,
      "post_version": true,
      "patch": true
    },
    {
      "file": "drivers/gpu/drm/i915/i915_dma.c",
      "pre_version": false,
      "post_version": true,
      "patch": true
    },
    {
      "file": "drivers/gpu/drm/i915/i915_drv.h",
      "pre_version": false,
      "post_version": true,
      "patch": true
    },
    {
      "file": "include/uapi/drm/i915_drm.h",
      "pre_version": false,
      "post_version": true,
      "patch": true
    },
    {
      "file": "drivers/gpu/drm/i915/i915_gem_dmabuf.c",
      "pre_version": false,
      "post_version": true,
      "patch": true
    },
    {
      "file": "drivers/gpu/drm/i915/i915_gpu_error.c",
      "pre_version": false,
      "post_version": true,
      "patch": true
    },
    {
      "file": "drivers/gpu/drm/i915/i915_gem.c",
      "pre_version": false,
      "post_version": true,
      "patch": true
    }
  ]
}