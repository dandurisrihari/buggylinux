{
  "hash": "e6f1c0d26a31a09e83d8aa7ed1a1c796bf2685c8",
  "hash_short": "e6f1c0d2",
  "subject": "ath10k: restore tx sk_buff of htt header for SDIO",
  "body": "ieee80211_report_used_skb of mac80211 use the frame_control of\nieee80211_hdr in sk_buff and indicate it to another function\nieee80211_mgd_conn_tx_status, then it queue work ieee80211_sta_work,\nbut ieee80211_is_auth(fc) in ieee80211_sta_work check fail when the\nauthentication has transmitted by ath10k.\n\nWhen the ath10k report it with HTT_TX_COMPL_STATE_DISCARD, it will be\nset without flag IEEE80211_TX_STAT_ACK, then mac80211 should try the\nnext authentication immeditely, but in fact mac80211 wait 1 second for\nit, the reason is ieee80211_is_auth(fc) in ieee80211_sta_work check\nfail for the sk_buff which is not restored, the data of sk_buff is not\nthe begin of ieee80211_hdr, in fact it is the begin of htt_cmd_hdr.\n\ndmesg without this patch, it wait 1 second for the next retry when\nath10k report without IEEE80211_TX_STAT_ACK for authentication:\n[ 6973.883116] wlan0: send auth to 5e:6f:2b:0d:fb:d7 (try 1/3)\n[ 6974.705471] wlan0: send auth to 5e:6f:2b:0d:fb:d7 (try 2/3)\n[ 6975.712962] wlan0: send auth to 5e:6f:2b:0d:fb:d7 (try 3/3)\n\nRestore the sk_buff make mac8011 retry the next authentication\nimmeditely which meet logic of mac80211.\n\ndmesg with this patch, it retry the next immeditely when ath10k\nreport without IEEE80211_TX_STAT_ACK for authentication:\n[  216.734813] wlan0: send auth to 5e:6f:2b:0d:fb:d7 (try 1/3)\n[  216.739914] wlan0: send auth to 5e:6f:2b:0d:fb:d7 (try 2/3)\n[  216.745874] wlan0: send auth to 5e:6f:2b:0d:fb:d7 (try 3/3)\n\nTested-on: QCA6174 hw3.2 SDIO WLAN.RMH.4.4.1-00049\n\nSigned-off-by: Wen Gong <wgong@codeaurora.org>\nSigned-off-by: Kalle Valo <kvalo@codeaurora.org>\nLink: https://lore.kernel.org/r/1612839530-2263-1-git-send-email-wgong@codeaurora.org",
  "full_message": "ath10k: restore tx sk_buff of htt header for SDIO\n\nieee80211_report_used_skb of mac80211 use the frame_control of\nieee80211_hdr in sk_buff and indicate it to another function\nieee80211_mgd_conn_tx_status, then it queue work ieee80211_sta_work,\nbut ieee80211_is_auth(fc) in ieee80211_sta_work check fail when the\nauthentication has transmitted by ath10k.\n\nWhen the ath10k report it with HTT_TX_COMPL_STATE_DISCARD, it will be\nset without flag IEEE80211_TX_STAT_ACK, then mac80211 should try the\nnext authentication immeditely, but in fact mac80211 wait 1 second for\nit, the reason is ieee80211_is_auth(fc) in ieee80211_sta_work check\nfail for the sk_buff which is not restored, the data of sk_buff is not\nthe begin of ieee80211_hdr, in fact it is the begin of htt_cmd_hdr.\n\ndmesg without this patch, it wait 1 second for the next retry when\nath10k report without IEEE80211_TX_STAT_ACK for authentication:\n[ 6973.883116] wlan0: send auth to 5e:6f:2b:0d:fb:d7 (try 1/3)\n[ 6974.705471] wlan0: send auth to 5e:6f:2b:0d:fb:d7 (try 2/3)\n[ 6975.712962] wlan0: send auth to 5e:6f:2b:0d:fb:d7 (try 3/3)\n\nRestore the sk_buff make mac8011 retry the next authentication\nimmeditely which meet logic of mac80211.\n\ndmesg with this patch, it retry the next immeditely when ath10k\nreport without IEEE80211_TX_STAT_ACK for authentication:\n[  216.734813] wlan0: send auth to 5e:6f:2b:0d:fb:d7 (try 1/3)\n[  216.739914] wlan0: send auth to 5e:6f:2b:0d:fb:d7 (try 2/3)\n[  216.745874] wlan0: send auth to 5e:6f:2b:0d:fb:d7 (try 3/3)\n\nTested-on: QCA6174 hw3.2 SDIO WLAN.RMH.4.4.1-00049\n\nSigned-off-by: Wen Gong <wgong@codeaurora.org>\nSigned-off-by: Kalle Valo <kvalo@codeaurora.org>\nLink: https://lore.kernel.org/r/1612839530-2263-1-git-send-email-wgong@codeaurora.org",
  "author_name": "Wen Gong",
  "author_email": "wgong@codeaurora.org",
  "author_date": "Wed Feb 10 09:53:24 2021 +0200",
  "author_date_iso": "2021-02-10T09:53:24+02:00",
  "committer_name": "Kalle Valo",
  "committer_email": "kvalo@codeaurora.org",
  "committer_date": "Thu Feb 11 08:47:53 2021 +0200",
  "committer_date_iso": "2021-02-11T08:47:53+02:00",
  "files_changed": [
    "drivers/net/wireless/ath/ath10k/htt_tx.c"
  ],
  "files_changed_count": 1,
  "stats": [
    {
      "file": "drivers/net/wireless/ath/ath10k/htt_tx.c",
      "insertions": 2,
      "deletions": 0
    }
  ],
  "total_insertions": 2,
  "total_deletions": 0,
  "total_changes": 2,
  "parents": [
    "c202e2ebe1dc454ad54fd0018c023ec553d47284"
  ],
  "branches": [
    "* development",
    "remotes/origin/HEAD -> origin/master",
    "remotes/origin/master"
  ],
  "tags": [],
  "is_merge": false,
  "security_info": {
    "cve_ids": [],
    "security_keywords": [
      "authentication"
    ]
  },
  "fix_type": "security",
  "file_results": [
    {
      "file": "drivers/net/wireless/ath/ath10k/htt_tx.c",
      "pre_version": false,
      "post_version": true,
      "patch": true
    }
  ]
}