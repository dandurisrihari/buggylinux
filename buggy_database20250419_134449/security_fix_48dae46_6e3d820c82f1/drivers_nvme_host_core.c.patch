commit 48dae46676d1acb632a3e1e14d02879d57618b5d
Author: Hannes Reinecke <hare@suse.de>
Date:   Mon Jan 29 07:39:48 2024 +0100

    nvme: enable retries for authentication commands
    
    Authentication commands might trigger a lengthy computation on the
    controller or even a callout to an external entity.
    In these cases the controller might return a status without the DNR
    bit set, indicating that the command should be retried.
    This patch enables retries for authentication commands  by setting
    NVME_SUBMIT_RETRY for __nvme_submit_sync_cmd().
    
    Reported-by: Martin George <marting@netapp.com>
    Signed-off-by: Hannes Reinecke <hare@suse.de>
    Reviewed-by: Chaitanya Kulkarni <kch@nvidia.com>
    Reviewed-by: Christoph Hellwig <hch@lst.de>
    Reviewed-by: Sagi Grimberg <sagi@grimberg.me>
    Signed-off-by: Keith Busch <kbusch@kernel.org>

diff --git a/drivers/nvme/host/core.c b/drivers/nvme/host/core.c
index aed099a45791..8b48b7f7871a 100644
--- a/drivers/nvme/host/core.c
+++ b/drivers/nvme/host/core.c
@@ -1070,6 +1070,8 @@ int __nvme_submit_sync_cmd(struct request_queue *q, struct nvme_command *cmd,
 	if (IS_ERR(req))
 		return PTR_ERR(req);
 	nvme_init_request(req, cmd);
+	if (flags & NVME_SUBMIT_RETRY)
+		req->cmd_flags &= ~REQ_FAILFAST_DRIVER;
 
 	if (buffer && bufflen) {
 		ret = blk_rq_map_kern(q, req, buffer, bufflen, GFP_KERNEL);