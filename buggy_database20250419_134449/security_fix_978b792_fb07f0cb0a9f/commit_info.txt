Commit Hash: 978b7922d3dca672b41bb4b8ce6c06ab77112741
Subject: scsi: core: Fix a race between scsi_done() and scsi_timeout()


Security Keywords:
- injection

Full commit message:
scsi: core: Fix a race between scsi_done() and scsi_timeout()

If there is a race between scsi_done() and scsi_timeout() and if
scsi_timeout() loses the race, scsi_timeout() should not reset the request
timer. Hence change the return value for this case from BLK_EH_RESET_TIMER
into BLK_EH_DONE.

Although the block layer holds a reference on a request (req->ref) while
calling a timeout handler, restarting the timer (blk_add_timer()) while a
request is being completed is racy.

Reviewed-by: Mike Christie <michael.christie@oracle.com>
Cc: Keith Busch <kbusch@kernel.org>
Cc: Christoph Hellwig <hch@lst.de>
Cc: Ming Lei <ming.lei@redhat.com>
Cc: John Garry <john.garry@huawei.com>
Cc: Hannes Reinecke <hare@suse.de>
Reported-by: Adrian Hunter <adrian.hunter@intel.com>
Fixes: 15f73f5b3e59 ("blk-mq: move failure injection out of blk_mq_complete_request")
Signed-off-by: Bart Van Assche <bvanassche@acm.org>
Link: https://lore.kernel.org/r/20221018202958.1902564-2-bvanassche@acm.org
Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>

Metadata:
Author: Bart Van Assche <bvanassche@acm.org>
Author Date: Tue Oct 18 13:29:49 2022 -0700
Committer: Martin K. Petersen <martin.petersen@oracle.com>
Commit Date: Sat Oct 22 03:25:59 2022 +0000

Files Changed: 1
Lines Added: 3
Lines Removed: 11
Total Changes: 14
