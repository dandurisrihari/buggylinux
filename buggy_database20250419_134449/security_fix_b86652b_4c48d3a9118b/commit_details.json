{
  "hash": "b86652be7c83f70bf406bed18ecf55adb9bfb91b",
  "hash_short": "b86652be",
  "subject": "btrfs: fix error handling in btrfs_del_csums",
  "body": "Error injection stress would sometimes fail with checksums on disk that\ndid not have a corresponding extent.  This occurred because the pattern\nin btrfs_del_csums was\n\n\twhile (1) {\n\t\tret = btrfs_search_slot();\n\t\tif (ret < 0)\n\t\t\tbreak;\n\t}\n\tret = 0;\nout:\n\tbtrfs_free_path(path);\n\treturn ret;\n\nIf we got an error from btrfs_search_slot we'd clear the error because\nwe were breaking instead of goto out.  Instead of using goto out, simply\nhandle the cases where we may leave a random value in ret, and get rid\nof the\n\n\tret = 0;\nout:\n\npattern and simply allow break to have the proper error reporting.  With\nthis fix we properly abort the transaction and do not commit thinking we\nsuccessfully deleted the csum.\n\nReviewed-by: Qu Wenruo <wqu@suse.com>\nCC: stable@vger.kernel.org # 4.4+\nSigned-off-by: Josef Bacik <josef@toxicpanda.com>\nReviewed-by: David Sterba <dsterba@suse.com>\nSigned-off-by: David Sterba <dsterba@suse.com>",
  "full_message": "btrfs: fix error handling in btrfs_del_csums\n\nError injection stress would sometimes fail with checksums on disk that\ndid not have a corresponding extent.  This occurred because the pattern\nin btrfs_del_csums was\n\n\twhile (1) {\n\t\tret = btrfs_search_slot();\n\t\tif (ret < 0)\n\t\t\tbreak;\n\t}\n\tret = 0;\nout:\n\tbtrfs_free_path(path);\n\treturn ret;\n\nIf we got an error from btrfs_search_slot we'd clear the error because\nwe were breaking instead of goto out.  Instead of using goto out, simply\nhandle the cases where we may leave a random value in ret, and get rid\nof the\n\n\tret = 0;\nout:\n\npattern and simply allow break to have the proper error reporting.  With\nthis fix we properly abort the transaction and do not commit thinking we\nsuccessfully deleted the csum.\n\nReviewed-by: Qu Wenruo <wqu@suse.com>\nCC: stable@vger.kernel.org # 4.4+\nSigned-off-by: Josef Bacik <josef@toxicpanda.com>\nReviewed-by: David Sterba <dsterba@suse.com>\nSigned-off-by: David Sterba <dsterba@suse.com>",
  "author_name": "Josef Bacik",
  "author_email": "josef@toxicpanda.com",
  "author_date": "Wed May 19 10:52:45 2021 -0400",
  "author_date_iso": "2021-05-19T10:52:45-04:00",
  "committer_name": "David Sterba",
  "committer_email": "dsterba@suse.com",
  "committer_date": "Thu May 27 23:30:49 2021 +0200",
  "committer_date_iso": "2021-05-27T23:30:49+02:00",
  "files_changed": [
    "fs/btrfs/file-item.c"
  ],
  "files_changed_count": 1,
  "stats": [
    {
      "file": "fs/btrfs/file-item.c",
      "insertions": 5,
      "deletions": 5
    }
  ],
  "total_insertions": 5,
  "total_deletions": 5,
  "total_changes": 10,
  "parents": [
    "4c80a97d7b02cf68e169118ef2bda0725fc87f6f"
  ],
  "branches": [
    "* development",
    "remotes/origin/HEAD -> origin/master",
    "remotes/origin/master"
  ],
  "tags": [],
  "is_merge": false,
  "security_info": {
    "cve_ids": [],
    "security_keywords": [
      "injection"
    ]
  },
  "fix_type": "security",
  "file_results": [
    {
      "file": "fs/btrfs/file-item.c",
      "pre_version": false,
      "post_version": true,
      "patch": true
    }
  ]
}