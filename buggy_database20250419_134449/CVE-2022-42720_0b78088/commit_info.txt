Commit Hash: 0b7808818cb9df6680f98996b8e9a439fa7bcc2f
Subject: wifi: cfg80211: fix BSS refcounting bugs

CVE Identifiers:
- CVE-2022-42720

Full commit message:
wifi: cfg80211: fix BSS refcounting bugs

There are multiple refcounting bugs related to multi-BSSID:
 - In bss_ref_get(), if the BSS has a hidden_beacon_bss, then
   the bss pointer is overwritten before checking for the
   transmitted BSS, which is clearly wrong. Fix this by using
   the bss_from_pub() macro.

 - In cfg80211_bss_update() we copy the transmitted_bss pointer
   from tmp into new, but then if we release new, we'll unref
   it erroneously. We already set the pointer and ref it, but
   need to NULL it since it was copied from the tmp data.

 - In cfg80211_inform_single_bss_data(), if adding to the non-
   transmitted list fails, we unlink the BSS and yet still we
   return it, but this results in returning an entry without
   a reference. We shouldn't return it anyway if it was broken
   enough to not get added there.

This fixes CVE-2022-42720.

Reported-by: Sönke Huster <shuster@seemoo.tu-darmstadt.de>
Tested-by: Sönke Huster <shuster@seemoo.tu-darmstadt.de>
Fixes: a3584f56de1c ("cfg80211: Properly track transmitting and non-transmitting BSS")
Signed-off-by: Johannes Berg <johannes.berg@intel.com>

Metadata:
Author: Johannes Berg <johannes.berg@intel.com>
Author Date: Fri Sep 30 23:44:23 2022 +0200
Committer: Johannes Berg <johannes.berg@intel.com>
Commit Date: Mon Oct 10 09:50:51 2022 +0200

Files Changed: 1
Lines Added: 14
Lines Removed: 13
Total Changes: 27
