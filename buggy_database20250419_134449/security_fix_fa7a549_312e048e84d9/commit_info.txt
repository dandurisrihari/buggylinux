Commit Hash: fa7a549d321a4189677b0cea86e58d9db7977f7b
Subject: KVM: x86: accept userspace interrupt only if no event is injected


Security Keywords:
- inject

Full commit message:
KVM: x86: accept userspace interrupt only if no event is injected

Once an exception has been injected, any side effects related to
the exception (such as setting CR2 or DR6) have been taked place.
Therefore, once KVM sets the VM-entry interruption information
field or the AMD EVENTINJ field, the next VM-entry must deliver that
exception.

Pending interrupts are processed after injected exceptions, so
in theory it would not be a problem to use KVM_INTERRUPT when
an injected exception is present.  However, DOSEMU is using
run->ready_for_interrupt_injection to detect interrupt windows
and then using KVM_SET_SREGS/KVM_SET_REGS to inject the
interrupt manually.  For this to work, the interrupt window
must be delayed after the completion of the previous event
injection.

Cc: stable@vger.kernel.org
Reported-by: Stas Sergeev <stsp2@yandex.ru>
Tested-by: Stas Sergeev <stsp2@yandex.ru>
Fixes: 71cc849b7093 ("KVM: x86: Fix split-irqchip vs interrupt injection window request")
Reviewed-by: Sean Christopherson <seanjc@google.com>
Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>

Metadata:
Author: Paolo Bonzini <pbonzini@redhat.com>
Author Date: Wed Jul 14 17:37:49 2021 -0400
Committer: Paolo Bonzini <pbonzini@redhat.com>
Commit Date: Fri Jul 30 07:53:02 2021 -0400

Files Changed: 1
Lines Added: 11
Lines Removed: 2
Total Changes: 13
