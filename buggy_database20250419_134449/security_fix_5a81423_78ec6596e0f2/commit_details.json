{
  "hash": "5a814231ae3d4f248a8ecb668a072a1da471c656",
  "hash_short": "5a814231",
  "subject": "printk/console: Enhance the check for consoles using init memory",
  "body": "printk_late_init() is responsible for disabling boot consoles that\nuse init memory. It checks the address of struct console for this.\n\nBut this is not enough. For example, there are several early\nconsoles that have write() method in the init section and\nstruct console in the normal section. They are not disabled\nand could cause fancy and hard to debug system states.\n\nIt is even more complicated by the macros EARLYCON_DECLARE() and\nOF_EARLYCON_DECLARE() where various struct members are set at\nruntime by the provided setup() function.\n\nI have tried to reproduce this problem and forced the classic uart\nearly console to stay using keep_bootcon parameter. In particular\nI used earlycon=uart,io,0x3f8 keep_bootcon console=ttyS0,115200.\nThe system did not boot:\n\n[    1.570496] PM: Image not found (code -22)\n[    1.570496] PM: Image not found (code -22)\n[    1.571886] PM: Hibernation image not present or could not be loaded.\n[    1.571886] PM: Hibernation image not present or could not be loaded.\n[    1.576407] Freeing unused kernel memory: 2528K\n[    1.577244] kernel tried to execute NX-protected page - exploit attempt? (uid: 0)\n\nThe double lines are caused by having both early uart console and\nttyS0 console enabled at the same time. The early console stopped\nworking when the init memory was freed. Fortunately, the invalid\ncall was caught by the NX-protexted page check and did not cause\nany silent fancy problems.\n\nThis patch adds a check for many other addresses stored in\nstruct console. It omits setup() and match() that are used\nonly when the console is registered. Therefore they have\nalready been used at this point and there is no reason\nto use them again.\n\nLink: http://lkml.kernel.org/r/1500036673-7122-3-git-send-email-pmladek@suse.com\nCc: Steven Rostedt <rostedt@goodmis.org>\nCc: Andrew Morton <akpm@linux-foundation.org>\nCc: Peter Zijlstra <peterz@infradead.org>\nCc: Matt Redfearn <matt.redfearn@imgtec.com>\nCc: Greg Kroah-Hartman <gregkh@linuxfoundation.org>\nCc: Jiri Slaby <jslaby@suse.com>\nCc: \"David S. Miller\" <davem@davemloft.net>\nCc: Alan Cox <gnomes@lxorguk.ukuu.org.uk>\nCc: \"Fabio M. Di Nitto\" <fdinitto@redhat.com>\nCc: linux-serial@vger.kernel.org\nCc: linux-kernel@vger.kernel.org\nReviewed-by: Sergey Senozhatsky <sergey.senozhatsky@gmail.com>\nSigned-off-by: Petr Mladek <pmladek@suse.com>",
  "full_message": "printk/console: Enhance the check for consoles using init memory\n\nprintk_late_init() is responsible for disabling boot consoles that\nuse init memory. It checks the address of struct console for this.\n\nBut this is not enough. For example, there are several early\nconsoles that have write() method in the init section and\nstruct console in the normal section. They are not disabled\nand could cause fancy and hard to debug system states.\n\nIt is even more complicated by the macros EARLYCON_DECLARE() and\nOF_EARLYCON_DECLARE() where various struct members are set at\nruntime by the provided setup() function.\n\nI have tried to reproduce this problem and forced the classic uart\nearly console to stay using keep_bootcon parameter. In particular\nI used earlycon=uart,io,0x3f8 keep_bootcon console=ttyS0,115200.\nThe system did not boot:\n\n[    1.570496] PM: Image not found (code -22)\n[    1.570496] PM: Image not found (code -22)\n[    1.571886] PM: Hibernation image not present or could not be loaded.\n[    1.571886] PM: Hibernation image not present or could not be loaded.\n[    1.576407] Freeing unused kernel memory: 2528K\n[    1.577244] kernel tried to execute NX-protected page - exploit attempt? (uid: 0)\n\nThe double lines are caused by having both early uart console and\nttyS0 console enabled at the same time. The early console stopped\nworking when the init memory was freed. Fortunately, the invalid\ncall was caught by the NX-protexted page check and did not cause\nany silent fancy problems.\n\nThis patch adds a check for many other addresses stored in\nstruct console. It omits setup() and match() that are used\nonly when the console is registered. Therefore they have\nalready been used at this point and there is no reason\nto use them again.\n\nLink: http://lkml.kernel.org/r/1500036673-7122-3-git-send-email-pmladek@suse.com\nCc: Steven Rostedt <rostedt@goodmis.org>\nCc: Andrew Morton <akpm@linux-foundation.org>\nCc: Peter Zijlstra <peterz@infradead.org>\nCc: Matt Redfearn <matt.redfearn@imgtec.com>\nCc: Greg Kroah-Hartman <gregkh@linuxfoundation.org>\nCc: Jiri Slaby <jslaby@suse.com>\nCc: \"David S. Miller\" <davem@davemloft.net>\nCc: Alan Cox <gnomes@lxorguk.ukuu.org.uk>\nCc: \"Fabio M. Di Nitto\" <fdinitto@redhat.com>\nCc: linux-serial@vger.kernel.org\nCc: linux-kernel@vger.kernel.org\nReviewed-by: Sergey Senozhatsky <sergey.senozhatsky@gmail.com>\nSigned-off-by: Petr Mladek <pmladek@suse.com>",
  "author_name": "Petr Mladek",
  "author_email": "pmladek@suse.com",
  "author_date": "Fri Jul 14 14:51:13 2017 +0200",
  "author_date_iso": "2017-07-14T14:51:13+02:00",
  "committer_name": "Petr Mladek",
  "committer_email": "pmladek@suse.com",
  "committer_date": "Thu Jul 27 15:04:22 2017 +0200",
  "committer_date_iso": "2017-07-27T15:04:22+02:00",
  "files_changed": [
    "kernel/printk/printk.c"
  ],
  "files_changed_count": 1,
  "stats": [
    {
      "file": "kernel/printk/printk.c",
      "insertions": 10,
      "deletions": 2
    }
  ],
  "total_insertions": 10,
  "total_deletions": 2,
  "total_changes": 12,
  "parents": [
    "2b1be689f3aadcfe0a768314c80e43483c784659"
  ],
  "branches": [
    "* development",
    "master",
    "remotes/origin/HEAD -> origin/master",
    "remotes/origin/master"
  ],
  "tags": [
    "v4.14",
    "v4.14-rc1",
    "v4.14-rc2",
    "v4.14-rc3",
    "v4.14-rc4",
    "v4.14-rc5",
    "v4.14-rc6",
    "v4.14-rc7",
    "v4.14-rc8",
    "v4.15"
  ],
  "is_merge": false,
  "security_info": {
    "cve_ids": [],
    "security_keywords": [
      "exploit"
    ]
  },
  "fix_type": "security",
  "file_results": [
    {
      "file": "kernel/printk/printk.c",
      "pre_version": true,
      "post_version": true,
      "patch": true
    }
  ]
}