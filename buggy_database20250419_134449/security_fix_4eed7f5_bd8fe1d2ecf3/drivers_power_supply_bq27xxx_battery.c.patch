commit 4eed7f5a8334a179f40b2c78c1ead572b9dd04a0
Author: LI Qingwu <Qing-wu.Li@leica-geosystems.com.cn>
Date:   Fri Mar 19 11:02:36 2021 +0000

    power: supply: bq27xxx: Add support for BQ78Z100
    
    Add support for TI BQ78Z100, I2C interface gas gauge.
    It provides a fully integrated safety protection
    and authentication for 1 to 2-series cell Li-Ion and
    Li-Polymer battery packs.
    
    The patch was tested with BQ78Z100 equipment.
    
    CASE I:  Discharging:
            POWER_SUPPLY_NAME=bq78z100-0
            POWER_SUPPLY_STATUS=Discharging
            POWER_SUPPLY_PRESENT=1
            POWER_SUPPLY_VOLTAGE_NOW=3386000
            POWER_SUPPLY_CURRENT_NOW=-5000
            POWER_SUPPLY_CAPACITY=27
            POWER_SUPPLY_CAPACITY_LEVEL=Normal
            POWER_SUPPLY_TEMP=269
            POWER_SUPPLY_TIME_TO_EMPTY_NOW=1249920
            POWER_SUPPLY_TECHNOLOGY=Li-ion
            POWER_SUPPLY_CHARGE_FULL=6494000
            POWER_SUPPLY_CHARGE_NOW=1736000
            POWER_SUPPLY_CHARGE_FULL_DESIGN=6000000
            POWER_SUPPLY_CYCLE_COUNT=1
            POWER_SUPPLY_POWER_AVG=-20000
            POWER_SUPPLY_HEALTH=Good
            POWER_SUPPLY_MANUFACTURER=Texas Instruments
    
    CASE II : No discharging current:
            POWER_SUPPLY_NAME=bq78z100-0
            POWER_SUPPLY_STATUS=Not charging
            POWER_SUPPLY_PRESENT=1
            POWER_SUPPLY_VOLTAGE_NOW=3386000
            POWER_SUPPLY_CURRENT_NOW=0
            POWER_SUPPLY_CAPACITY=27
            POWER_SUPPLY_CAPACITY_LEVEL=Normal
            POWER_SUPPLY_TEMP=270
            POWER_SUPPLY_TECHNOLOGY=Li-ion
            POWER_SUPPLY_CHARGE_FULL=6494000
            POWER_SUPPLY_CHARGE_NOW=1734000
            POWER_SUPPLY_CHARGE_FULL_DESIGN=6000000
            POWER_SUPPLY_CYCLE_COUNT=1
            POWER_SUPPLY_POWER_AVG=0
            POWER_SUPPLY_HEALTH=Good
            POWER_SUPPLY_MANUFACTURER=Texas Instruments
    
    Signed-off-by: LI Qingwu <Qing-wu.Li@leica-geosystems.com.cn>
    Reviewed-by: Krzysztof Kozlowski <krzk@kernel.org>
    Signed-off-by: Sebastian Reichel <sebastian.reichel@collabora.com>

diff --git a/drivers/power/supply/bq27xxx_battery.c b/drivers/power/supply/bq27xxx_battery.c
index b62a8cfd9d09..7e5e24b585d8 100644
--- a/drivers/power/supply/bq27xxx_battery.c
+++ b/drivers/power/supply/bq27xxx_battery.c
@@ -39,6 +39,7 @@
  * https://www.ti.com/product/bq27z561
  * https://www.ti.com/product/bq28z610
  * https://www.ti.com/product/bq34z100-g1
+ * https://www.ti.com/product/bq78z100
  */
 
 #include <linux/device.h>
@@ -515,6 +516,27 @@ static u8
 		[BQ27XXX_REG_DCAP] = 0x3c,
 		[BQ27XXX_REG_AP] = 0x22,
 		BQ27XXX_DM_REG_ROWS,
+	},
+	bq78z100_regs[BQ27XXX_REG_MAX] = {
+		[BQ27XXX_REG_CTRL] = 0x00,
+		[BQ27XXX_REG_TEMP] = 0x06,
+		[BQ27XXX_REG_INT_TEMP] = 0x28,
+		[BQ27XXX_REG_VOLT] = 0x08,
+		[BQ27XXX_REG_AI] = 0x14,
+		[BQ27XXX_REG_FLAGS] = 0x0a,
+		[BQ27XXX_REG_TTE] = 0x16,
+		[BQ27XXX_REG_TTF] = 0x18,
+		[BQ27XXX_REG_TTES] = 0x1c,
+		[BQ27XXX_REG_TTECP] = INVALID_REG_ADDR,
+		[BQ27XXX_REG_NAC] = INVALID_REG_ADDR,
+		[BQ27XXX_REG_RC] = 0x10,
+		[BQ27XXX_REG_FCC] = 0x12,
+		[BQ27XXX_REG_CYCT] = 0x2a,
+		[BQ27XXX_REG_AE] = INVALID_REG_ADDR,
+		[BQ27XXX_REG_SOC] = 0x2c,
+		[BQ27XXX_REG_DCAP] = 0x3c,
+		[BQ27XXX_REG_AP] = 0x22,
+		BQ27XXX_DM_REG_ROWS,
 	};
 
 static enum power_supply_property bq27000_props[] = {
@@ -813,6 +835,26 @@ static enum power_supply_property bq34z100_props[] = {
 	POWER_SUPPLY_PROP_MANUFACTURER,
 };
 
+static enum power_supply_property bq78z100_props[] = {
+	POWER_SUPPLY_PROP_STATUS,
+	POWER_SUPPLY_PROP_PRESENT,
+	POWER_SUPPLY_PROP_VOLTAGE_NOW,
+	POWER_SUPPLY_PROP_CURRENT_NOW,
+	POWER_SUPPLY_PROP_CAPACITY,
+	POWER_SUPPLY_PROP_CAPACITY_LEVEL,
+	POWER_SUPPLY_PROP_TEMP,
+	POWER_SUPPLY_PROP_TIME_TO_EMPTY_NOW,
+	POWER_SUPPLY_PROP_TIME_TO_FULL_NOW,
+	POWER_SUPPLY_PROP_TECHNOLOGY,
+	POWER_SUPPLY_PROP_CHARGE_FULL,
+	POWER_SUPPLY_PROP_CHARGE_NOW,
+	POWER_SUPPLY_PROP_CHARGE_FULL_DESIGN,
+	POWER_SUPPLY_PROP_CYCLE_COUNT,
+	POWER_SUPPLY_PROP_POWER_AVG,
+	POWER_SUPPLY_PROP_HEALTH,
+	POWER_SUPPLY_PROP_MANUFACTURER,
+};
+
 struct bq27xxx_dm_reg {
 	u8 subclass_id;
 	u8 offset;
@@ -911,6 +953,7 @@ static struct bq27xxx_dm_reg bq27621_dm_regs[] = {
 #define bq27z561_dm_regs 0
 #define bq28z610_dm_regs 0
 #define bq34z100_dm_regs 0
+#define bq78z100_dm_regs 0
 
 #define BQ27XXX_O_ZERO		BIT(0)
 #define BQ27XXX_O_OTDC		BIT(1) /* has OTC/OTD overtemperature flags */
@@ -969,6 +1012,7 @@ static struct {
 	[BQ28Z610]  = BQ27XXX_DATA(bq28z610,  0         , BQ27Z561_O_BITS),
 	[BQ34Z100]  = BQ27XXX_DATA(bq34z100,  0         , BQ27XXX_O_OTDC | BQ27XXX_O_SOC_SI | \
 							  BQ27XXX_O_HAS_CI | BQ27XXX_O_MUL_CHEM),
+	[BQ78Z100]  = BQ27XXX_DATA(bq78z100,  0         , BQ27Z561_O_BITS),
 };
 
 static DEFINE_MUTEX(bq27xxx_list_lock);