{
  "hash": "4b7cfa8b6c28a9fa22b86894166a1a34f6d630ba",
  "hash_short": "4b7cfa8b",
  "subject": "io_uring/sqpoll: zero sqd->thread on tctx errors",
  "body": "Syzkeller reports:\n\nBUG: KASAN: slab-use-after-free in thread_group_cputime+0x409/0x700 kernel/sched/cputime.c:341\nRead of size 8 at addr ffff88803578c510 by task syz.2.3223/27552\n Call Trace:\n  <TASK>\n  ...\n  kasan_report+0x143/0x180 mm/kasan/report.c:602\n  thread_group_cputime+0x409/0x700 kernel/sched/cputime.c:341\n  thread_group_cputime_adjusted+0xa6/0x340 kernel/sched/cputime.c:639\n  getrusage+0x1000/0x1340 kernel/sys.c:1863\n  io_uring_show_fdinfo+0xdfe/0x1770 io_uring/fdinfo.c:197\n  seq_show+0x608/0x770 fs/proc/fd.c:68\n  ...\n\nThat's due to sqd->task not being cleared properly in cases where\nSQPOLL task tctx setup fails, which can essentially only happen with\nfault injection to insert allocation errors.\n\nCc: stable@vger.kernel.org\nFixes: 1251d2025c3e1 (\"io_uring/sqpoll: early exit thread if task_context wasn't allocated\")\nReported-by: syzbot+3d92cfcfa84070b0a470@syzkaller.appspotmail.com\nSigned-off-by: Pavel Begunkov <asml.silence@gmail.com>\nLink: https://lore.kernel.org/r/efc7ec7010784463b2e7466d7b5c02c2cb381635.1736519461.git.asml.silence@gmail.com\nSigned-off-by: Jens Axboe <axboe@kernel.dk>",
  "full_message": "io_uring/sqpoll: zero sqd->thread on tctx errors\n\nSyzkeller reports:\n\nBUG: KASAN: slab-use-after-free in thread_group_cputime+0x409/0x700 kernel/sched/cputime.c:341\nRead of size 8 at addr ffff88803578c510 by task syz.2.3223/27552\n Call Trace:\n  <TASK>\n  ...\n  kasan_report+0x143/0x180 mm/kasan/report.c:602\n  thread_group_cputime+0x409/0x700 kernel/sched/cputime.c:341\n  thread_group_cputime_adjusted+0xa6/0x340 kernel/sched/cputime.c:639\n  getrusage+0x1000/0x1340 kernel/sys.c:1863\n  io_uring_show_fdinfo+0xdfe/0x1770 io_uring/fdinfo.c:197\n  seq_show+0x608/0x770 fs/proc/fd.c:68\n  ...\n\nThat's due to sqd->task not being cleared properly in cases where\nSQPOLL task tctx setup fails, which can essentially only happen with\nfault injection to insert allocation errors.\n\nCc: stable@vger.kernel.org\nFixes: 1251d2025c3e1 (\"io_uring/sqpoll: early exit thread if task_context wasn't allocated\")\nReported-by: syzbot+3d92cfcfa84070b0a470@syzkaller.appspotmail.com\nSigned-off-by: Pavel Begunkov <asml.silence@gmail.com>\nLink: https://lore.kernel.org/r/efc7ec7010784463b2e7466d7b5c02c2cb381635.1736519461.git.asml.silence@gmail.com\nSigned-off-by: Jens Axboe <axboe@kernel.dk>",
  "author_name": "Pavel Begunkov",
  "author_email": "asml.silence@gmail.com",
  "author_date": "Fri Jan 10 14:31:23 2025 +0000",
  "author_date_iso": "2025-01-10T14:31:23+00:00",
  "committer_name": "Jens Axboe",
  "committer_email": "axboe@kernel.dk",
  "committer_date": "Fri Jan 10 14:00:19 2025 -0700",
  "committer_date_iso": "2025-01-10T14:00:19-07:00",
  "files_changed": [
    "io_uring/sqpoll.c"
  ],
  "files_changed_count": 1,
  "stats": [
    {
      "file": "io_uring/sqpoll.c",
      "insertions": 5,
      "deletions": 1
    }
  ],
  "total_insertions": 5,
  "total_deletions": 1,
  "total_changes": 6,
  "parents": [
    "c9a40292a44e78f71258b8522655bffaf5753bdb"
  ],
  "branches": [
    "* development",
    "remotes/origin/HEAD -> origin/master",
    "remotes/origin/master"
  ],
  "tags": [],
  "is_merge": false,
  "security_info": {
    "cve_ids": [],
    "security_keywords": [
      "injection"
    ]
  },
  "fix_type": "security",
  "file_results": [
    {
      "file": "io_uring/sqpoll.c",
      "pre_version": false,
      "post_version": true,
      "patch": true
    }
  ]
}