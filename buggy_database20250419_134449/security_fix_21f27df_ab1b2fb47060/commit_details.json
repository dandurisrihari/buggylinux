{
  "hash": "21f27df854008b86349a203bf97fef79bb11f53e",
  "hash_short": "21f27df8",
  "subject": "KVM: s390: pv: fix external interruption loop not always detected",
  "body": "To determine whether the guest has caused an external interruption loop\nupon code 20 (external interrupt) intercepts, the ext_new_psw needs to\nbe inspected to see whether external interrupts are enabled.\n\nUnder non-PV, ext_new_psw can simply be taken from guest lowcore. Under\nPV, KVM can only access the encrypted guest lowcore and hence the\next_new_psw must not be taken from guest lowcore.\n\nhandle_external_interrupt() incorrectly did that and hence was not able\nto reliably tell whether an external interruption loop is happening or\nnot. False negatives cause spurious failures of my kvm-unit-test\nfor extint loops[1] under PV.\n\nSince code 20 is only caused under PV if and only if the guest's\next_new_psw is enabled for external interrupts, false positive detection\nof a external interruption loop can not happen.\n\nFix this issue by instead looking at the guest PSW in the state\ndescription. Since the PSW swap for external interrupt is done by the\nultravisor before the intercept is caused, this reliably tells whether\nthe guest is enabled for external interrupts in the ext_new_psw.\n\nAlso update the comments to explain better what is happening.\n\n[1] https://lore.kernel.org/kvm/20220812062151.1980937-4-nrb@linux.ibm.com/\n\nSigned-off-by: Nico Boehr <nrb@linux.ibm.com>\nReviewed-by: Janosch Frank <frankja@linux.ibm.com>\nReviewed-by: Christian Borntraeger <borntraeger@linux.ibm.com>\nFixes: 201ae986ead7 (\"KVM: s390: protvirt: Implement interrupt injection\")\nLink: https://lore.kernel.org/r/20230213085520.100756-2-nrb@linux.ibm.com\nMessage-Id: <20230213085520.100756-2-nrb@linux.ibm.com>\nSigned-off-by: Janosch Frank <frankja@linux.ibm.com>",
  "full_message": "KVM: s390: pv: fix external interruption loop not always detected\n\nTo determine whether the guest has caused an external interruption loop\nupon code 20 (external interrupt) intercepts, the ext_new_psw needs to\nbe inspected to see whether external interrupts are enabled.\n\nUnder non-PV, ext_new_psw can simply be taken from guest lowcore. Under\nPV, KVM can only access the encrypted guest lowcore and hence the\next_new_psw must not be taken from guest lowcore.\n\nhandle_external_interrupt() incorrectly did that and hence was not able\nto reliably tell whether an external interruption loop is happening or\nnot. False negatives cause spurious failures of my kvm-unit-test\nfor extint loops[1] under PV.\n\nSince code 20 is only caused under PV if and only if the guest's\next_new_psw is enabled for external interrupts, false positive detection\nof a external interruption loop can not happen.\n\nFix this issue by instead looking at the guest PSW in the state\ndescription. Since the PSW swap for external interrupt is done by the\nultravisor before the intercept is caused, this reliably tells whether\nthe guest is enabled for external interrupts in the ext_new_psw.\n\nAlso update the comments to explain better what is happening.\n\n[1] https://lore.kernel.org/kvm/20220812062151.1980937-4-nrb@linux.ibm.com/\n\nSigned-off-by: Nico Boehr <nrb@linux.ibm.com>\nReviewed-by: Janosch Frank <frankja@linux.ibm.com>\nReviewed-by: Christian Borntraeger <borntraeger@linux.ibm.com>\nFixes: 201ae986ead7 (\"KVM: s390: protvirt: Implement interrupt injection\")\nLink: https://lore.kernel.org/r/20230213085520.100756-2-nrb@linux.ibm.com\nMessage-Id: <20230213085520.100756-2-nrb@linux.ibm.com>\nSigned-off-by: Janosch Frank <frankja@linux.ibm.com>",
  "author_name": "Nico Boehr",
  "author_email": "nrb@linux.ibm.com",
  "author_date": "Mon Feb 13 09:55:20 2023 +0100",
  "author_date_iso": "2023-02-13T09:55:20+01:00",
  "committer_name": "Janosch Frank",
  "committer_email": "frankja@linux.ibm.com",
  "committer_date": "Tue Mar 28 07:16:37 2023 +0000",
  "committer_date_iso": "2023-03-28T07:16:37+00:00",
  "files_changed": [
    "arch/s390/kvm/intercept.c"
  ],
  "files_changed_count": 1,
  "stats": [
    {
      "file": "arch/s390/kvm/intercept.c",
      "insertions": 24,
      "deletions": 8
    }
  ],
  "total_insertions": 24,
  "total_deletions": 8,
  "total_changes": 32,
  "parents": [
    "197b6b60ae7bc51dd0814953c562833143b292aa"
  ],
  "branches": [
    "* development",
    "remotes/origin/HEAD -> origin/master",
    "remotes/origin/master"
  ],
  "tags": [],
  "is_merge": false,
  "security_info": {
    "cve_ids": [],
    "security_keywords": [
      "injection"
    ]
  },
  "fix_type": "security",
  "file_results": [
    {
      "file": "arch/s390/kvm/intercept.c",
      "pre_version": false,
      "post_version": true,
      "patch": true
    }
  ]
}