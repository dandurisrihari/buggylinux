{
  "hash": "844f7315e77a017fe90652b411e88b119c782a1f",
  "hash_short": "844f7315",
  "subject": "selftests/bpf: Use auto-dependencies for test objects",
  "body": "Make use of -M compiler options when building .test.o objects to\ngenerate .d files and avoid re-building all tests every time.\n\nPreviously, if a single test bpf program under selftests/bpf/progs/*.c\nhas changed, make would rebuild all the *.bpf.o, *.skel.h and *.test.o\nobjects, which is a lot of unnecessary work.\n\nA typical dependency chain is:\nprogs/x.c -> x.bpf.o -> x.skel.h -> x.test.o -> trunner_binary\n\nHowever for many tests it's not a 1:1 mapping by name, and so far\n%.test.o have been simply dependent on all %.skel.h files, and\n%.skel.h files on all %.bpf.o objects.\n\nAvoid full rebuilds by instructing the compiler (via -MMD) to\nproduce *.d files with real dependencies, and appropriately including\nthem. Exploit make feature that rebuilds included makefiles if they\nwere changed by setting %.test.d as prerequisite for %.test.o files.\n\nA couple of examples of compilation time speedup (after the first\nclean build):\n\n$ touch progs/verifier_and.c && time make -j8\nBefore: real\t0m16.651s\nAfter:  real\t0m2.245s\n$ touch progs/read_vsyscall.c && time make -j8\nBefore: real\t0m15.743s\nAfter:  real\t0m1.575s\n\nA drawback of this change is that now there is an overhead due to make\nprocessing lots of .d files, which potentially may slow down unrelated\ntargets. However a time to make all from scratch hasn't changed\nsignificantly:\n\n$ make clean && time make -j8\nBefore: real\t1m31.148s\nAfter:  real\t1m30.309s\n\nSuggested-by: Eduard Zingerman <eddyz87@gmail.com>\nSigned-off-by: Ihor Solodrai <ihor.solodrai@pm.me>\nSigned-off-by: Andrii Nakryiko <andrii@kernel.org>\nLink: https://lore.kernel.org/bpf/VJihUTnvtwEgv_mOnpfy7EgD9D2MPNoHO-MlANeLIzLJPGhDeyOuGKIYyKgk0O6KPjfM-MuhtvPwZcngN8WFqbTnTRyCSMc2aMZ1ODm1T_g=@pm.me",
  "full_message": "selftests/bpf: Use auto-dependencies for test objects\n\nMake use of -M compiler options when building .test.o objects to\ngenerate .d files and avoid re-building all tests every time.\n\nPreviously, if a single test bpf program under selftests/bpf/progs/*.c\nhas changed, make would rebuild all the *.bpf.o, *.skel.h and *.test.o\nobjects, which is a lot of unnecessary work.\n\nA typical dependency chain is:\nprogs/x.c -> x.bpf.o -> x.skel.h -> x.test.o -> trunner_binary\n\nHowever for many tests it's not a 1:1 mapping by name, and so far\n%.test.o have been simply dependent on all %.skel.h files, and\n%.skel.h files on all %.bpf.o objects.\n\nAvoid full rebuilds by instructing the compiler (via -MMD) to\nproduce *.d files with real dependencies, and appropriately including\nthem. Exploit make feature that rebuilds included makefiles if they\nwere changed by setting %.test.d as prerequisite for %.test.o files.\n\nA couple of examples of compilation time speedup (after the first\nclean build):\n\n$ touch progs/verifier_and.c && time make -j8\nBefore: real\t0m16.651s\nAfter:  real\t0m2.245s\n$ touch progs/read_vsyscall.c && time make -j8\nBefore: real\t0m15.743s\nAfter:  real\t0m1.575s\n\nA drawback of this change is that now there is an overhead due to make\nprocessing lots of .d files, which potentially may slow down unrelated\ntargets. However a time to make all from scratch hasn't changed\nsignificantly:\n\n$ make clean && time make -j8\nBefore: real\t1m31.148s\nAfter:  real\t1m30.309s\n\nSuggested-by: Eduard Zingerman <eddyz87@gmail.com>\nSigned-off-by: Ihor Solodrai <ihor.solodrai@pm.me>\nSigned-off-by: Andrii Nakryiko <andrii@kernel.org>\nLink: https://lore.kernel.org/bpf/VJihUTnvtwEgv_mOnpfy7EgD9D2MPNoHO-MlANeLIzLJPGhDeyOuGKIYyKgk0O6KPjfM-MuhtvPwZcngN8WFqbTnTRyCSMc2aMZ1ODm1T_g=@pm.me",
  "author_name": "Ihor Solodrai",
  "author_email": "ihor.solodrai@pm.me",
  "author_date": "Thu Jul 18 22:57:43 2024 +0000",
  "author_date_iso": "2024-07-18T22:57:43+00:00",
  "committer_name": "Andrii Nakryiko",
  "committer_email": "andrii@kernel.org",
  "committer_date": "Mon Jul 29 12:53:07 2024 -0700",
  "committer_date_iso": "2024-07-29T12:53:07-07:00",
  "files_changed": [
    "tools/testing/selftests/bpf/.gitignore",
    "tools/testing/selftests/bpf/Makefile"
  ],
  "files_changed_count": 2,
  "stats": [
    {
      "file": "tools/testing/selftests/bpf/.gitignore",
      "insertions": 1,
      "deletions": 0
    },
    {
      "file": "tools/testing/selftests/bpf/Makefile",
      "insertions": 32,
      "deletions": 11
    }
  ],
  "total_insertions": 33,
  "total_deletions": 11,
  "total_changes": 44,
  "parents": [
    "f157f9cb85b49745754f8c301c59c6ca110e865f"
  ],
  "branches": [
    "* development",
    "remotes/origin/HEAD -> origin/master",
    "remotes/origin/master"
  ],
  "tags": [],
  "is_merge": false,
  "security_info": {
    "cve_ids": [],
    "security_keywords": [
      "Exploit"
    ]
  },
  "fix_type": "security",
  "file_results": [
    {
      "file": "tools/testing/selftests/bpf/.gitignore",
      "pre_version": false,
      "post_version": true,
      "patch": true
    },
    {
      "file": "tools/testing/selftests/bpf/Makefile",
      "pre_version": false,
      "post_version": true,
      "patch": true
    }
  ]
}