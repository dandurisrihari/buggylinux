Commit Hash: 9c70c7147ffec31de67d33243570a533b29f9759
Subject: bpf ppc64: Access only if addr is kernel address


Security Keywords:
- exploit

Full commit message:
bpf ppc64: Access only if addr is kernel address

On PPC64 with KUAP enabled, any kernel code which wants to
access userspace needs to be surrounded by disable-enable KUAP.
But that is not happening for BPF_PROBE_MEM load instruction.
So, when BPF program tries to access invalid userspace address,
page-fault handler considers it as bad KUAP fault:

  Kernel attempted to read user page (d0000000) - exploit attempt? (uid: 0)

Considering the fact that PTR_TO_BTF_ID (which uses BPF_PROBE_MEM
mode) could either be a valid kernel pointer or NULL but should
never be a pointer to userspace address, execute BPF_PROBE_MEM load
only if addr is kernel address, otherwise set dst_reg=0 and move on.

This will catch NULL, valid or invalid userspace pointers. Only bad
kernel pointer will be handled by BPF exception table.

[Alexei suggested for x86]

Suggested-by: Alexei Starovoitov <ast@kernel.org>
Signed-off-by: Ravi Bangoria <ravi.bangoria@linux.ibm.com>
Signed-off-by: Hari Bathini <hbathini@linux.ibm.com>
Reviewed-by: Christophe Leroy <christophe.leroy@csgroup.eu>
Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
Link: https://lore.kernel.org/r/20211012123056.485795-7-hbathini@linux.ibm.com

Metadata:
Author: Ravi Bangoria <ravi.bangoria@linux.ibm.com>
Author Date: Tue Oct 12 18:00:54 2021 +0530
Committer: Michael Ellerman <mpe@ellerman.id.au>
Commit Date: Thu Nov 25 11:25:32 2021 +1100

Files Changed: 1
Lines Added: 26
Lines Removed: 0
Total Changes: 26
