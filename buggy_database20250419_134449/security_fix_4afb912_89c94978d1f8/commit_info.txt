Commit Hash: 4afb912f439c4bc4e6a4f3e7547f2e69e354108f
Subject: btrfs: fix abort logic in btrfs_replace_file_extents


Security Keywords:
- injection

Full commit message:
btrfs: fix abort logic in btrfs_replace_file_extents

Error injection testing uncovered a case where we'd end up with a
corrupt file system with a missing extent in the middle of a file.  This
occurs because the if statement to decide if we should abort is wrong.

The only way we would abort in this case is if we got a ret !=
-EOPNOTSUPP and we called from the file clone code.  However the
prealloc code uses this path too.  Instead we need to abort if there is
an error, and the only error we _don't_ abort on is -EOPNOTSUPP and only
if we came from the clone file code.

CC: stable@vger.kernel.org # 5.10+
Reviewed-by: Nikolay Borisov <nborisov@suse.com>
Reviewed-by: Filipe Manana <fdmanana@suse.com>
Signed-off-by: Josef Bacik <josef@toxicpanda.com>
Reviewed-by: David Sterba <dsterba@suse.com>
Signed-off-by: David Sterba <dsterba@suse.com>

Metadata:
Author: Josef Bacik <josef@toxicpanda.com>
Author Date: Tue Oct 5 16:35:27 2021 -0400
Committer: David Sterba <dsterba@suse.com>
Commit Date: Thu Oct 7 22:08:06 2021 +0200

Files Changed: 1
Lines Added: 9
Lines Removed: 7
Total Changes: 16
