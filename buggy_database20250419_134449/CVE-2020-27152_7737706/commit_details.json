{
  "hash": "77377064c3a94911339f13ce113b3abf265e06da",
  "hash_short": "77377064",
  "subject": "KVM: ioapic: break infinite recursion on lazy EOI",
  "body": "During shutdown the IOAPIC trigger mode is reset to edge triggered\nwhile the vfio-pci INTx is still registered with a resampler.\nThis allows us to get into an infinite loop:\n\nioapic_set_irq\n  -> ioapic_lazy_update_eoi\n  -> kvm_ioapic_update_eoi_one\n  -> kvm_notify_acked_irq\n  -> kvm_notify_acked_gsi\n  -> (via irq_acked fn ptr) irqfd_resampler_ack\n  -> kvm_set_irq\n  -> (via set fn ptr) kvm_set_ioapic_irq\n  -> kvm_ioapic_set_irq\n  -> ioapic_set_irq\n\nCommit 8be8f932e3db (\"kvm: ioapic: Restrict lazy EOI update to\nedge-triggered interrupts\", 2020-05-04) acknowledges that this recursion\nloop exists and tries to avoid it at the call to ioapic_lazy_update_eoi,\nbut at this point the scenario is already set, we have an edge interrupt\nwith resampler on the same gsi.\n\nFortunately, the only user of irq ack notifiers (in addition to resamplefd)\nis i8254 timer interrupt reinjection.  These are edge-triggered, so in\nprinciple they would need the call to kvm_ioapic_update_eoi_one from\nioapic_lazy_update_eoi, but they already disable AVIC(*), so they don't\nneed the lazy EOI behavior.  Therefore, remove the call to\nkvm_ioapic_update_eoi_one from ioapic_lazy_update_eoi.\n\nThis fixes CVE-2020-27152.  Note that this issue cannot happen with\nSR-IOV assigned devices because virtual functions do not have INTx,\nonly MSI.\n\nFixes: f458d039db7e (\"kvm: ioapic: Lazy update IOAPIC EOI\")\nSuggested-by: Paolo Bonzini <pbonzini@redhat.com>\nTested-by: Alex Williamson <alex.williamson@redhat.com>\nSigned-off-by: Vitaly Kuznetsov <vkuznets@redhat.com>\nSigned-off-by: Paolo Bonzini <pbonzini@redhat.com>",
  "full_message": "KVM: ioapic: break infinite recursion on lazy EOI\n\nDuring shutdown the IOAPIC trigger mode is reset to edge triggered\nwhile the vfio-pci INTx is still registered with a resampler.\nThis allows us to get into an infinite loop:\n\nioapic_set_irq\n  -> ioapic_lazy_update_eoi\n  -> kvm_ioapic_update_eoi_one\n  -> kvm_notify_acked_irq\n  -> kvm_notify_acked_gsi\n  -> (via irq_acked fn ptr) irqfd_resampler_ack\n  -> kvm_set_irq\n  -> (via set fn ptr) kvm_set_ioapic_irq\n  -> kvm_ioapic_set_irq\n  -> ioapic_set_irq\n\nCommit 8be8f932e3db (\"kvm: ioapic: Restrict lazy EOI update to\nedge-triggered interrupts\", 2020-05-04) acknowledges that this recursion\nloop exists and tries to avoid it at the call to ioapic_lazy_update_eoi,\nbut at this point the scenario is already set, we have an edge interrupt\nwith resampler on the same gsi.\n\nFortunately, the only user of irq ack notifiers (in addition to resamplefd)\nis i8254 timer interrupt reinjection.  These are edge-triggered, so in\nprinciple they would need the call to kvm_ioapic_update_eoi_one from\nioapic_lazy_update_eoi, but they already disable AVIC(*), so they don't\nneed the lazy EOI behavior.  Therefore, remove the call to\nkvm_ioapic_update_eoi_one from ioapic_lazy_update_eoi.\n\nThis fixes CVE-2020-27152.  Note that this issue cannot happen with\nSR-IOV assigned devices because virtual functions do not have INTx,\nonly MSI.\n\nFixes: f458d039db7e (\"kvm: ioapic: Lazy update IOAPIC EOI\")\nSuggested-by: Paolo Bonzini <pbonzini@redhat.com>\nTested-by: Alex Williamson <alex.williamson@redhat.com>\nSigned-off-by: Vitaly Kuznetsov <vkuznets@redhat.com>\nSigned-off-by: Paolo Bonzini <pbonzini@redhat.com>",
  "author_name": "Vitaly Kuznetsov",
  "author_email": "vkuznets@redhat.com",
  "author_date": "Sat Oct 24 04:13:24 2020 -0400",
  "author_date_iso": "2020-10-24T04:13:24-04:00",
  "committer_name": "Paolo Bonzini",
  "committer_email": "pbonzini@redhat.com",
  "committer_date": "Sat Oct 24 04:42:06 2020 -0400",
  "committer_date_iso": "2020-10-24T04:42:06-04:00",
  "files_changed": [
    "arch/x86/kvm/ioapic.c"
  ],
  "files_changed_count": 1,
  "stats": [
    {
      "file": "arch/x86/kvm/ioapic.c",
      "insertions": 1,
      "deletions": 4
    }
  ],
  "total_insertions": 1,
  "total_deletions": 4,
  "total_changes": 5,
  "parents": [
    "a3ff25fc3c52f22b0766bb96c31b87d3c99fbf53"
  ],
  "branches": [
    "* development",
    "remotes/origin/HEAD -> origin/master",
    "remotes/origin/master"
  ],
  "tags": [],
  "is_merge": false,
  "security_info": {
    "cve_ids": [
      "CVE-2020-27152"
    ],
    "security_keywords": []
  },
  "fix_type": "cve",
  "file_results": [
    {
      "file": "arch/x86/kvm/ioapic.c",
      "pre_version": false,
      "post_version": true,
      "patch": true
    }
  ]
}